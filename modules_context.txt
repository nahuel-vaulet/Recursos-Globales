=== REPORTE DE MÓDULOS PHP ===
Origen: C:\xampp\htdocs\APP-Prueba\modules
Total archivos: 66

================================================================================
 MODULE: COMBUSTIBLES
 FILE: combustibles\api\get_form_data.php
================================================================================
<?php
require_once '../../../config/database.php';
header('Content-Type: application/json');

try {
    // 1. Fetch Squads
    $cuadrillas = $pdo->query("SELECT * FROM cuadrillas WHERE estado_operativo = 'Activa' ORDER BY nombre_cuadrilla")->fetchAll(PDO::FETCH_ASSOC);

    // 2. Fetch Personal (Drivers/Responsibles)
    $personal = $pdo->query("SELECT id_personal, nombre_apellido, id_cuadrilla FROM personal ORDER BY nombre_apellido")->fetchAll(PDO::FETCH_ASSOC);

    // 3. Fetch Vehicles
    $vehiculos = $pdo->query("SELECT id_vehiculo, marca, modelo, patente, id_cuadrilla FROM vehiculos ORDER BY marca, modelo")->fetchAll(PDO::FETCH_ASSOC);

    echo json_encode([
        'success' => true,
        'cuadrillas' => $cuadrillas,
        'personal' => $personal,
        'vehiculos' => $vehiculos
    ]);

} catch (Exception $e) {
    http_response_code(500);
    echo json_encode(['success' => false, 'error' => $e->getMessage()]);
}
?>

================================================================================
 MODULE: COMBUSTIBLES
 FILE: combustibles\api\get_stock.php
================================================================================
<?php
require_once '../../../config/database.php';
header('Content-Type: application/json');

try {
    $stmt = $pdo->query("SELECT * FROM combustibles_tanques ORDER BY id_tanque ASC");
    $tanques = $stmt->fetchAll(PDO::FETCH_ASSOC);

    echo json_encode([
        'success' => true,
        'data' => $tanques
    ]);
} catch (Exception $e) {
    http_response_code(500);
    echo json_encode(['success' => false, 'error' => $e->getMessage()]);
}
?>

================================================================================
 MODULE: COMBUSTIBLES
 FILE: combustibles\api\save_carga.php
================================================================================
<?php
require_once '../../../config/database.php';
session_start();

header('Content-Type: application/json');

if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
    echo json_encode(['success' => false, 'error' => 'Method not allowed']);
    exit;
}

try {
    $pdo->beginTransaction();

    $destino_tipo = $_POST['destino_tipo'] ?? 'stock';
    $id_tanque = !empty($_POST['id_tanque']) ? $_POST['id_tanque'] : null;

    // Validation
    if ($destino_tipo === 'stock' && empty($id_tanque)) {
        throw new Exception("Debe seleccionar un tanque de destino para cargas a stock.");
    }

    // For direct vehicle charge, we might not have a tank, so we need fuel type
    $tipo_combustible = $_POST['tipo_combustible'] ?? null;

    $id_cuadrilla = !empty($_POST['id_cuadrilla']) ? $_POST['id_cuadrilla'] : null;
    $id_vehiculo = !empty($_POST['id_vehiculo']) ? $_POST['id_vehiculo'] : null;
    $conductor = !empty($_POST['conductor']) ? $_POST['conductor'] : null;

    $litros = floatval($_POST['litros']);
    $precio = floatval($_POST['precio_unitario'] ?? 0);
    $proveedor = $_POST['proveedor'] ?? '';
    $factura = $_POST['nro_factura'] ?? '';
    $fecha = $_POST['fecha_hora'] ?? date('Y-m-d H:i:s');
    $usuario_id = $_SESSION['usuario_id'] ?? 0;

    // 0. Handle File Upload
    $foto_path = null;
    if (isset($_FILES['foto_ticket']) && $_FILES['foto_ticket']['error'] === UPLOAD_ERR_OK) {
        $uploadDir = '../../../uploads/tickets/';
        if (!is_dir($uploadDir)) {
            mkdir($uploadDir, 0777, true);
        }

        $ext = pathinfo($_FILES['foto_ticket']['name'], PATHINFO_EXTENSION);
        $filename = 'ticket_' . time() . '_' . uniqid() . '.' . $ext;
        $targetFile = $uploadDir . $filename;

        if (move_uploaded_file($_FILES['foto_ticket']['tmp_name'], $targetFile)) {
            $foto_path = 'uploads/tickets/' . $filename;
        }
    }

    // 0.1 Check if column exists and add if not (Self-Healing Schema)
    try {
        $pdo->query("SELECT foto_ticket FROM combustibles_cargas LIMIT 1");
    } catch (Exception $e) {
        $pdo->exec("ALTER TABLE combustibles_cargas ADD COLUMN foto_ticket VARCHAR(255) NULL AFTER nro_factura");
    }

    // 1. Insert Carga
    $stmt = $pdo->prepare("INSERT INTO combustibles_cargas (id_tanque, destino_tipo, tipo_combustible, id_cuadrilla, id_vehiculo, conductor, fecha_hora, litros, precio_unitario, proveedor, nro_factura, foto_ticket, usuario_id) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)");
    $stmt->execute([$id_tanque, $destino_tipo, $tipo_combustible, $id_cuadrilla, $id_vehiculo, $conductor, $fecha, $litros, $precio, $proveedor, $factura, $foto_path, $usuario_id]);

    // 2. Update Tank Stock (ONLY IF DESTINATION IS STOCK)
    if ($destino_tipo === 'stock' && $id_tanque) {
        $stmtUpd = $pdo->prepare("UPDATE combustibles_tanques SET stock_actual = stock_actual + ? WHERE id_tanque = ?");
        $stmtUpd->execute([$litros, $id_tanque]);
    }

    $pdo->commit();
    echo json_encode(['success' => true, 'message' => 'Carga registrada correctamente']);

} catch (Exception $e) {
    $pdo->rollBack();
    http_response_code(500);
    echo json_encode(['success' => false, 'error' => $e->getMessage()]);
}
?>

================================================================================
 MODULE: COMBUSTIBLES
 FILE: combustibles\api\save_despacho.php
================================================================================
<?php
require_once '../../../config/database.php';
session_start();

header('Content-Type: application/json');

if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
    echo json_encode(['success' => false, 'error' => 'Method not allowed']);
    exit;
}

try {
    $pdo->beginTransaction();

    $id_tanque = $_POST['id_tanque'] ?? null;
    $id_vehiculo = $_POST['id_vehiculo'] ?? null;
    $id_cuadrilla = $_POST['id_cuadrilla'] ?? null;
    $litros = floatval($_POST['litros'] ?? 0);
    $odometro = floatval($_POST['odometro_actual'] ?? 0);
    $conductor = $_POST['usuario_conductor'] ?? '';
    $destino = $_POST['destino_obra'] ?? '';
    $fecha = $_POST['fecha_hora'] ?? date('Y-m-d H:i:s');

    // Allow manual selection of dispatcher, fallback to current session user
    $usuario_despacho = !empty($_POST['usuario_despacho']) ? $_POST['usuario_despacho'] : ($_SESSION['usuario_id'] ?? 0);

    if (empty($id_tanque)) {
        throw new Exception("ID de Tanque no recibido.");
    }

    // Validation: Check Stock
    $stmtCheck = $pdo->prepare("SELECT stock_actual, nombre, tipo_combustible FROM combustibles_tanques WHERE id_tanque = ?");
    $stmtCheck->execute([$id_tanque]);
    $tank = $stmtCheck->fetch(PDO::FETCH_ASSOC);

    if (!$tank) {
        throw new Exception("Tanque no encontrado en base de datos (ID: $id_tanque)");
    }

    $stock = floatval($tank['stock_actual']);

    if ($stock < $litros) {
        throw new Exception("Stock insuficiente. Disponible: " . number_format($stock, 2) . " L. Solicitado: " . number_format($litros, 2) . " L");
    }

    // Check if id_cuadrilla column exists in the table
    $columns = $pdo->query("DESCRIBE combustibles_despachos")->fetchAll(PDO::FETCH_COLUMN);
    $hasIdCuadrilla = in_array('id_cuadrilla', $columns);

    // 1. Insert Despacho (adaptive query based on table structure)
    if ($hasIdCuadrilla) {
        $stmt = $pdo->prepare("INSERT INTO combustibles_despachos (id_tanque, id_vehiculo, id_cuadrilla, fecha_hora, litros, odometro_actual, usuario_despacho, usuario_conductor, destino_obra) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)");
        $stmt->execute([$id_tanque, $id_vehiculo, $id_cuadrilla, $fecha, $litros, $odometro, $usuario_despacho, $conductor, $destino]);
    } else {
        $stmt = $pdo->prepare("INSERT INTO combustibles_despachos (id_tanque, id_vehiculo, fecha_hora, litros, odometro_actual, usuario_despacho, usuario_conductor, destino_obra) VALUES (?, ?, ?, ?, ?, ?, ?, ?)");
        $stmt->execute([$id_tanque, $id_vehiculo, $fecha, $litros, $odometro, $usuario_despacho, $conductor, $destino]);
    }

    $id_despacho = $pdo->lastInsertId();

    // 2. Update Tank Stock
    $stmtUpd = $pdo->prepare("UPDATE combustibles_tanques SET stock_actual = stock_actual - ? WHERE id_tanque = ?");
    $stmtUpd->execute([$litros, $id_tanque]);

    $pdo->commit();

    // Get cuadrilla name for remito if available
    $nombre_cuadrilla = '';
    if ($id_cuadrilla) {
        $stmtC = $pdo->prepare("SELECT nombre_cuadrilla FROM cuadrillas WHERE id_cuadrilla = ?");
        $stmtC->execute([$id_cuadrilla]);
        $cuad = $stmtC->fetch(PDO::FETCH_ASSOC);
        $nombre_cuadrilla = $cuad ? $cuad['nombre_cuadrilla'] : '';
    }

    echo json_encode([
        'success' => true,
        'message' => 'Despacho registrado correctamente',
        'id_despacho' => $id_despacho,
        'tank_name' => $tank['nombre'],
        'fuel_type' => $tank['tipo_combustible'],
        'nombre_cuadrilla' => $nombre_cuadrilla
    ]);

} catch (Exception $e) {
    if ($pdo->inTransaction()) {
        $pdo->rollBack();
    }
    http_response_code(500);
    echo json_encode(['success' => false, 'error' => $e->getMessage()]);
}
?>

================================================================================
 MODULE: COMBUSTIBLES
 FILE: combustibles\index.php
================================================================================
<?php
require_once '../../config/database.php';
require_once '../../includes/header.php';

// Check permissions (optional, if handled by header/sidebar logic)
if (!isset($_SESSION['usuario_rol'])) {
    header("Location: ../../index.php");
    exit;
}
?>

<div class="container-fluid" style="padding: 0 20px;">
    <!-- Top Bar -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin: 0;"><i class="fas fa-gas-pump"></i> Gestión de Combustibles</h2>
        <a href="../stock/index.php" class="btn btn-outline-secondary"><i class="fas fa-arrow-left"></i> Volver a
            Stock</a>
    </div>

    <!-- Include Dashboard Partial -->
    <?php include 'views/dashboard.php'; ?>

    <!-- History / Movements (Similar to Stock but filtered for Fuel) -->
    <div class="card" style="margin-top: 30px; padding: 20px;">
        <h3><i class="fas fa-history"></i> Últimos Movimientos de Combustible</h3>
        <?php
        // Self-Healing Schema Check (Ensure 'foto_ticket' exists to prevent crash)
        try {
            $pdo->query("SELECT foto_ticket FROM combustibles_cargas LIMIT 1");
        } catch (Exception $e) {
            try {
                $pdo->exec("ALTER TABLE combustibles_cargas ADD COLUMN foto_ticket VARCHAR(255) NULL AFTER nro_factura");
            } catch (Exception $ex) {
            }
        }

        // Fetch last 50 movements (Union Cargas and Despachos)
        $sql = "
        (SELECT 'Carga' as tipo, c.fecha_hora, c.litros, t.nombre as tanque, c.proveedor as detalle, u.nombre as usuario, c.foto_ticket
         FROM combustibles_cargas c 
         JOIN combustibles_tanques t ON c.id_tanque = t.id_tanque
         LEFT JOIN usuarios u ON c.usuario_id = u.id_usuario)
        UNION
        (SELECT 'Despacho' as tipo, d.fecha_hora, d.litros, t.nombre as tanque, CONCAT(v.patente, ' - ', d.usuario_conductor) as detalle, u.nombre as usuario, NULL as foto_ticket
         FROM combustibles_despachos d
         JOIN combustibles_tanques t ON d.id_tanque = t.id_tanque
         JOIN vehiculos v ON d.id_vehiculo = v.id_vehiculo
         LEFT JOIN usuarios u ON d.usuario_despacho = u.id_usuario)
        ORDER BY fecha_hora DESC LIMIT 50";

        $movs = $pdo->query($sql)->fetchAll(PDO::FETCH_ASSOC);
        ?>

        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>Fecha</th>
                    <th>Tipo</th>
                    <th>Tanque</th>
                    <th>Litros</th>
                    <th>Detalle (Prov / Vehículo)</th>
                    <th>Usuario</th>
                    <th>Ticket</th>
                </tr>
            </thead>
            <tbody>
                <?php foreach ($movs as $m):
                    $color = ($m['tipo'] == 'Carga') ? 'text-success' : 'text-primary';
                    $sign = ($m['tipo'] == 'Carga') ? '+' : '-';
                    ?>
                    <tr>
                        <td>
                            <?php echo date('d/m/Y H:i', strtotime($m['fecha_hora'])); ?>
                        </td>
                        <td class="<?php echo $color; ?>"><strong>
                                <?php echo $m['tipo']; ?>
                            </strong></td>
                        <td>
                            <?php echo $m['tanque']; ?>
                        </td>
                        <td style="font-weight:bold;">
                            <?php echo $sign . number_format($m['litros'], 2); ?>
                        </td>
                        <td>
                            <?php echo $m['detalle']; ?>
                        </td>
                        <td>
                            <?php echo $m['usuario']; ?>
                        </td>
                        <td>
                            <?php if (!empty($m['foto_ticket'])): ?>
                                <a href="../../<?php echo $m['foto_ticket']; ?>" target="_blank"
                                    class="btn btn-sm btn-outline-info">
                                    <i class="fas fa-image"></i> Ver
                                </a>
                            <?php endif; ?>
                        </td>
                    </tr>
                <?php endforeach; ?>
            </tbody>
        </table>
    </div>

</div>

<?php
require_once '../../includes/footer.php';
?>

================================================================================
 MODULE: COMBUSTIBLES
 FILE: combustibles\remito.php
================================================================================
<?php
require_once '../../config/database.php';
require_once '../../includes/header.php';

// Get Tank ID from URL
$id_tanque = isset($_GET['id_tanque']) ? $_GET['id_tanque'] : null;
$tank = null;

if ($id_tanque) {
    $stmt = $pdo->prepare("SELECT * FROM combustibles_tanques WHERE id_tanque = ?");
    $stmt->execute([$id_tanque]);
    $tank = $stmt->fetch(PDO::FETCH_ASSOC);
}

if (!$tank) {
    echo "<div class='alert alert-danger'>Tanque no encontrado.</div>";
    require_once '../../includes/footer.php';
    exit;
}

// Fetch Squads
$cuadrillas = $pdo->query("SELECT * FROM cuadrillas WHERE estado_operativo = 'Activa' ORDER BY nombre_cuadrilla")->fetchAll(PDO::FETCH_ASSOC);
$cuadrillas_json = json_encode($cuadrillas);

// Fetch Personal
$personal = $pdo->query("SELECT id_personal, nombre_apellido, id_cuadrilla FROM personal ORDER BY nombre_apellido")->fetchAll(PDO::FETCH_ASSOC);
$personal_json = json_encode($personal);
?>

<div class="container" style="max-width: 900px; padding-top: 20px;">

    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2><i class="fas fa-file-invoice"></i> Nuevo Remito de Combustible</h2>
        <a href="index.php" class="btn btn-outline-secondary">Volver</a>
    </div>

    <!-- TANK INFO CARD -->
    <div class="card mb-4" style="border-left: 5px solid #007bff;">
        <div class="card-body">
            <h5 class="card-title">Origen:
                <?php echo htmlspecialchars($tank['nombre']); ?> (
                <?php echo $tank['tipo_combustible']; ?>)
            </h5>
            <p class="card-text">
                Stock Disponible: <strong>
                    <?php echo number_format($tank['stock_actual'], 2); ?> L
                </strong>
            </p>
        </div>
    </div>

    <form id="formRemito" onsubmit="submitRemito(event)">
        <input type="hidden" name="id_tanque" value="<?php echo $id_tanque; ?>">
        <input type="hidden" name="tipo_combustible" value="<?php echo $tank['tipo_combustible']; ?>">

        <!-- FLOW PANEL -->
        <div class="card mb-4 p-3">
            <h5 class="mb-3"><i class="fas fa-route"></i> Destinatario</h5>
            <div class="row">
                <div class="col-md-6">
                    <label>Cuadrilla (Destino)</label>
                    <select name="id_cuadrilla" id="select_cuadrilla" class="form-control"
                        onchange="onCuadrillaChange()" required>
                        <option value="">Seleccione Cuadrilla...</option>
                        <?php foreach ($cuadrillas as $c): ?>
                            <option value="<?php echo $c['id_cuadrilla']; ?>">
                                <?php echo htmlspecialchars($c['nombre_cuadrilla']); ?>
                            </option>
                        <?php endforeach; ?>
                    </select>
                </div>
                <div class="col-md-6">
                    <label>Vehículo / Equipo</label>
                    <select name="id_vehiculo" id="select_vehiculo" class="form-control" required>
                        <option value="">-- Pendiente de Cuadrilla --</option>
                    </select>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-md-6">
                    <label>Conductor / Responsable</label>
                    <select name="usuario_conductor" id="select_conductor" class="form-control" required>
                        <option value="">-- Pendiente de Cuadrilla --</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label>Destino / Obra (Opcional)</label>
                    <input type="text" name="destino_obra" class="form-control" placeholder="Ej: Obra Centro">
                </div>
            </div>
        </div>

        <!-- DETAILS PANEL -->
        <div class="card mb-4 p-3">
            <h5 class="mb-3"><i class="fas fa-gas-pump"></i> Detalle de Carga</h5>
            <div class="row">
                <div class="col-md-4">
                    <div class="form-group">
                        <label>Cantidad (Litros)</label>
                        <input type="number" step="0.01" name="litros" class="form-control form-control-lg" required
                            placeholder="0.00" style="font-weight: bold;">
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label>Odómetro (Km/Hs)</label>
                        <input type="number" step="1" name="odometro_actual" class="form-control" required
                            placeholder="Ej: 15000">
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label>Fecha y Hora</label>
                        <input type="datetime-local" name="fecha_hora" class="form-control"
                            value="<?php echo date('Y-m-d\TH:i'); ?>" required>
                    </div>
                </div>
            </div>
        </div>

        <button type="submit" class="btn btn-primary btn-lg btn-block" style="height: 60px; font-size: 1.25em;">
            <i class="fas fa-save"></i> Generar Remito
        </button>

    </form>
</div>

<!-- DATA ISLAND -->
<div id="server-data" data-cuadrillas='<?php echo htmlspecialchars($cuadrillas_json, ENT_QUOTES, 'UTF-8'); ?>'
    data-personal='
    <?php echo htmlspecialchars($personal_json, ENT_QUOTES, 'UTF-8'); ?>'
    style="display:none;">
</div>

<script>
    function onCuadrillaChange() {
        const idCuadrilla = document.getElementById('select_cuadrilla').value;
        const serverDataEl = document.getElementById('server-data');
        const cuadrillas = JSON.parse(serverDataEl.dataset.cuadrillas || '[]');
        const personal = JSON.parse(serverDataEl.dataset.personal || '[]');

        // Update Vehicle
        const selectVehiculo = document.getElementById('select_vehiculo');
        selectVehiculo.innerHTML = '<option value="">-- Seleccione --</option>';

        const squad = cuadrillas.find(c => c.id_cuadrilla == idCuadrilla);
        if (squad && squad.id_vehiculo) {
            const opt = document.createElement('option');
            opt.value = squad.id_vehiculo;
            opt.textContent = `${squad.marca} ${squad.modelo} (${squad.patente})`;
            opt.selected = true;
            selectVehiculo.appendChild(opt);
        }

        // Update Driver
        const selectConductor = document.getElementById('select_conductor');
        selectConductor.innerHTML = '<option value="">-- Seleccione conductor --</option>';

        const drivers = personal.filter(p => p.id_cuadrilla == idCuadrilla);
        drivers.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p.nombre_apellido;
            opt.textContent = p.nombre_apellido;
            selectConductor.appendChild(opt);
        });
    }

    function submitRemito(event) {
        event.preventDefault();
        if (!confirm('¿Confirma la generación del remito? Esto descontará stock.')) return;

        const form = event.target;
        const formData = new FormData(form);

        fetch('api/save_despacho.php', { // Reusing logic
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Redirect to success / print page or dashboard
                    alert('Remito generado exitosamente.');
                    window.location.href = 'index.php';
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error de conexión.');
            });
    }
</script>

<?php require_once '../../includes/footer.php'; ?>

================================================================================
 MODULE: COMBUSTIBLES
 FILE: combustibles\views\dashboard.php
================================================================================
<?php
// Retrieve Tank Data
try {
    $stmtTanques = $pdo->query("SELECT * FROM combustibles_tanques ORDER BY id_tanque ASC");
    $tanques = $stmtTanques->fetchAll(PDO::FETCH_ASSOC);
} catch (Exception $e) {
    $tanques = [];
}

// Fetch Data for Dropdowns (Dashboard Context)
try {
    $cuadrillas = $pdo->query("SELECT * FROM cuadrillas WHERE estado_operativo = 'Activa' ORDER BY nombre_cuadrilla")->fetchAll(PDO::FETCH_ASSOC);
} catch (Exception $e) {
    $cuadrillas = [];
}

try {
    $personal = $pdo->query("SELECT id_personal, nombre_apellido, id_cuadrilla FROM personal ORDER BY nombre_apellido")->fetchAll(PDO::FETCH_ASSOC);
} catch (Exception $e) {
    $personal = [];
}

try {
    $vehiculos = $pdo->query("SELECT id_vehiculo, marca, modelo, patente FROM vehiculos ORDER BY marca, modelo")->fetchAll(PDO::FETCH_ASSOC);
} catch (Exception $e) {
    $vehiculos = [];
}

?>

<script>
    window.FUEL_DATA = {
        cuadrillas: <?php echo json_encode($cuadrillas, JSON_HEX_TAG | JSON_HEX_APOS | JSON_HEX_QUOT | JSON_HEX_AMP) ?: '[]'; ?>,
        personal: <?php echo json_encode($personal, JSON_HEX_TAG | JSON_HEX_APOS | JSON_HEX_QUOT | JSON_HEX_AMP) ?: '[]'; ?>,
        vehiculos: <?php echo json_encode($vehiculos, JSON_HEX_TAG | JSON_HEX_APOS | JSON_HEX_QUOT | JSON_HEX_AMP) ?: '[]'; ?>
    };
</script>

<!-- Fuel Dashboard Panel -->
<div class="card panel-fuel" style="margin-top: 20px; border-top: 4px solid #ff9800;">
    <div class="panel-header" style="display: flex; justify-content: space-between; align-items: center;">
        <h3><i class="fas fa-gas-pump"></i> Control de Combustibles</h3>
        <div class="fuel-actions">
            <button onclick="openCombustibleModal('carga')" class="btn btn-sm btn-success">
                <i class="fas fa-plus"></i> Ingreso (Compra)
            </button>
            <button onclick="openCombustibleModal('despacho')" class="btn btn-sm btn-primary">
                <i class="fas fa-truck-moving"></i> Despacho (Surtidor)
            </button>
        </div>
    </div>

    <div class="fuel-tanks-container" style="display: flex; gap: 20px; padding: 15px; overflow-x: auto;">
        <?php foreach ($tanques as $t):
            $percent = ($t['capacidad_maxima'] > 0) ? ($t['stock_actual'] / $t['capacidad_maxima']) * 100 : 0;
            $color = ($percent < 20) ? '#dc3545' : (($percent < 50) ? '#ffc107' : '#28a745');
            ?>
            <div class="card h-100 shadow-sm panel-tank" style="min-width: 200px; position: relative; overflow: hidden;">
                <div class="tank-level"
                    style="position: absolute; bottom: 0; left: 0; width: 100%; height: <?php echo $percent; ?>%; background: <?php echo $color; ?>; opacity: 0.15; z-index: 0;">
                </div>

                <div class="card-body p-3" style="position: relative; z-index: 1;">
                    <div class="font-weight-bold opacity-75">
                        <?php echo htmlspecialchars($t['nombre']); ?>
                    </div>
                    <div class="text-muted small mb-2">
                        <?php echo htmlspecialchars($t['tipo_combustible']); ?>
                    </div>

                    <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                        <div style="font-size: 1.5em; font-weight: bold;">
                            <?php echo number_format($t['stock_actual'], 0); ?> <span style="font-size: 0.5em;">L</span>
                        </div>
                        <div class="text-muted small">
                            / <?php echo number_format($t['capacidad_maxima'], 0); ?> L
                        </div>
                    </div>

                    <div class="progress" style="height: 6px; margin-top: 8px;">
                        <div class="progress-bar" role="progressbar"
                            style="width: <?php echo $percent; ?>%; background-color: <?php echo $color; ?>;">
                        </div>
                    </div>

                    <button class="btn btn-primary btn-sm btn-block mt-3 btn-mover-tank"
                        data-tank-id="<?php echo $t['id_tanque']; ?>"
                        data-tank-name="<?php echo htmlspecialchars($t['nombre'], ENT_QUOTES); ?>"
                        data-tank-max="<?php echo $t['stock_actual']; ?>"
                        style="width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <i class="fas fa-share"></i> Mover
                    </button>
                </div>
            </div>
        <?php endforeach; ?>
    </div>
</div>

<!-- Modal Combustibles (Loader) -->
<div id="modalCombustibles" class="modal-overlay">
    <div class="modal-content" style="width: 500px; max-width: 95%;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
            <h3 id="modalCombTitle">Registrar Operación</h3>
            <button onclick="closeCombustibleModal()" style="background:none; border:none; cursor:pointer;"><i
                    class="fas fa-times"></i></button>
        </div>
        <div id="modalCombBody">
            <p>Cargando formulario...</p>
        </div>
    </div>
</div>

<!-- TRANSFER MODAL -->
<div id="fuelTransferModal" class="modal-overlay" data-active-tank-id="">
    <div class="modal-content"
        style="width: 450px; background: var(--bg-card); color: var(--text-primary); padding: 25px; border-radius: 12px; border: 1px solid rgba(100, 181, 246, 0.2);">

        <h3
            style="margin-top: 0; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; margin-bottom: 20px;">
            <i class="fas fa-share" style="color: var(--accent-primary);"></i> Transferencia Rápida
        </h3>

        <form id="formFuelTransfer">
            <input type="hidden" name="fecha_hora" value="<?php echo date('Y-m-d\TH:i'); ?>">
            <input type="hidden" name="odometro_actual" value="0">

            <div class="row" style="display:flex; gap:10px; margin-bottom: 10px;">
                <div class="col" style="flex:1;">
                    <label style="font-size:0.85em; color:var(--text-secondary);">Origen</label>
                    <div style="font-weight:bold; padding: 8px; background: rgba(0,0,0,0.05); border-radius: 6px;">
                        Oficina Central</div>
                </div>
                <div class="col" style="flex:1;">
                    <label style="font-size:0.85em; color:var(--text-secondary);">Tanque Salida</label>
                    <div id="fuelModalTankName"
                        style="font-weight:bold; color: var(--accent-primary); padding: 8px; background: rgba(0,0,0,0.05); border-radius: 6px;">
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label>Destino (Cuadrilla)</label>
                <select name="id_cuadrilla" id="fuelModalCuadrilla" required class="form-control"
                    onchange="onFuelModalCuadrillaChange()">
                    <option value="">Seleccione Cuadrilla...</option>
                    <?php foreach ($cuadrillas as $c): ?>
                        <option value="<?php echo $c['id_cuadrilla']; ?>">
                            <?php echo htmlspecialchars($c['nombre_cuadrilla']); ?></option>
                    <?php endforeach; ?>
                </select>
            </div>

            <div class="form-group">
                <label>Vehículo</label>
                <select name="id_vehiculo" id="fuelModalVehiculo" required class="form-control">
                    <option value="">Seleccione Vehículo...</option>
                    <?php foreach ($vehiculos as $v): ?>
                        <option value="<?php echo $v['id_vehiculo']; ?>">
                            <?php echo htmlspecialchars($v['marca'] . ' ' . $v['modelo'] . ' (' . $v['patente'] . ')'); ?>
                        </option>
                    <?php endforeach; ?>
                </select>
            </div>

            <div class="form-group">
                <label>Chofer / Responsable</label>
                <select name="usuario_conductor" id="fuelModalConductor" required class="form-control">
                    <option value="">Seleccione Chofer...</option>
                    <?php foreach ($personal as $p): ?>
                        <option value="<?php echo htmlspecialchars($p['nombre_apellido']); ?>">
                            <?php echo htmlspecialchars($p['nombre_apellido']); ?></option>
                    <?php endforeach; ?>
                </select>
            </div>

            <div class="form-group">
                <label>Quien Entrega (Despachante)</label>
                <select name="usuario_despacho" id="fuelModalDespachante" class="form-control">
                    <option value="<?php echo $_SESSION['usuario_id'] ?? ''; ?>">Yo
                        (<?php echo $_SESSION['usuario_nombre'] ?? 'Usuario'; ?>)</option>
                    <?php foreach ($personal as $p): ?>
                        <option value="<?php echo $p['id_personal']; ?>">
                            <?php echo htmlspecialchars($p['nombre_apellido']); ?></option>
                    <?php endforeach; ?>
                </select>
            </div>

            <div class="form-group">
                <label>Cantidad (Máx: <span id="fuelModalMaxQty"></span> L)</label>
                <input type="number" step="0.01" name="litros" id="fuelModalQty" required class="form-control"
                    placeholder="0.00">
            </div>

            <div class="modal-actions" style="display: flex; justify-content: flex-end; gap: 10px; margin-top:20px;">
                <button type="button" class="btn btn-outline-secondary" onclick="closeFuelTransferModal()">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btnConfirmFuelTransfer">Confirmar</button>
            </div>
        </form>
    </div>
</div>

<script>
    (function () {
        // Wait for DOM to be ready
        document.addEventListener('DOMContentLoaded', function () {
            initTransferButtons();
        });

        // Also try immediately in case DOM is already loaded
        if (document.readyState !== 'loading') {
            initTransferButtons();
        }

        function initTransferButtons() {
            // Attach click handlers to all "Mover" buttons
            var buttons = document.querySelectorAll('.btn-mover-tank');
            buttons.forEach(function (btn) {
                btn.addEventListener('click', function () {
                    var tankId = this.getAttribute('data-tank-id');
                    var tankName = this.getAttribute('data-tank-name');
                    var tankMax = this.getAttribute('data-tank-max');

                    console.log('Mover clicked:', tankId, tankName, tankMax);
                    openFuelTransferModalWithData(tankId, tankName, tankMax);
                });
            });

            // Attach confirm button handler
            var confirmBtn = document.getElementById('btnConfirmFuelTransfer');
            if (confirmBtn) {
                confirmBtn.addEventListener('click', function () {
                    submitFuelTransferForm();
                });
            }
        }

        window.openFuelTransferModalWithData = function (id, name, max) {
            if (!id) {
                alert('Error: No se pudo obtener el ID del tanque.');
                return;
            }

            var modal = document.getElementById('fuelTransferModal');
            var form = document.getElementById('formFuelTransfer');

            // Store the Tank ID in the modal's data attribute
            modal.setAttribute('data-active-tank-id', id);

            // Reset Form
            form.reset();

            // Update UI
            document.getElementById('fuelModalTankName').textContent = name;
            document.getElementById('fuelModalMaxQty').textContent = max;
            document.getElementById('fuelModalQty').max = max;

            // Show Modal
            modal.style.display = 'block';

            console.log('Fuel Modal opened with Tank ID:', modal.getAttribute('data-active-tank-id'));
        };

        window.closeFuelTransferModal = function () {
            var modal = document.getElementById('fuelTransferModal');
            modal.style.display = 'none';
            modal.setAttribute('data-active-tank-id', '');
        };

        window.submitFuelTransferForm = function () {
            var form = document.getElementById('formFuelTransfer');
            var modal = document.getElementById('fuelTransferModal');

            // Validate form
            if (!form.reportValidity()) {
                return;
            }

            // Get the Tank ID from the modal's data attribute
            var tankId = modal.getAttribute('data-active-tank-id');

            console.log('Submitting Fuel with Tank ID:', tankId);

            if (!tankId) {
                alert('Error: No se puede identificar el tanque de origen. Por favor cierre y vuelva a intentar.');
                return;
            }

            var formData = new FormData(form);
            formData.append('id_tanque', tankId);

            var btn = document.getElementById('btnConfirmFuelTransfer');
            var originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Procesando...';

            fetch('/APP-Prueba/modules/combustibles/api/save_despacho.php', {
                method: 'POST',
                body: formData
            })
                .then(function (response) { return response.json(); })
                .then(function (data) {
                    btn.disabled = false;
                    btn.textContent = originalText;

                    if (data.success) {
                        closeFuelTransferModal();
                        // Open printable remito in new window
                        if (data.id_despacho) {
                            window.open('/APP-Prueba/modules/combustibles/views/print_remito.php?id=' + data.id_despacho, '_blank');
                        }
                        alert('Transferencia Exitosa. Se ha generado el remito.');
                        location.reload();
                    } else {
                        alert('Error del Servidor: ' + data.error);
                    }
                })
                .catch(function (error) {
                    console.error('Error:', error);
                    btn.disabled = false;
                    btn.textContent = originalText;
                    alert('Error de conexión.');
                });
        };

        window.onFuelModalCuadrillaChange = function () {
            var idCuadrilla = document.getElementById('fuelModalCuadrilla').value;
            var data = window.FUEL_DATA || { cuadrillas: [], personal: [], vehiculos: [] };

            var squad = data.cuadrillas.find(function (c) { return c.id_cuadrilla == idCuadrilla; });

            if (squad) {
                var val = squad.id_vehiculo_asignado || squad.id_vehiculo;
                var sel = document.getElementById('fuelModalVehiculo');
                if (val && sel && sel.querySelector('option[value="' + val + '"]')) {
                    sel.value = val;
                }
            }
            var driver = data.personal.find(function (p) { return p.id_cuadrilla == idCuadrilla; });
            if (driver) {
                var sel = document.getElementById('fuelModalConductor');
                if (sel && sel.querySelector('option[value="' + driver.nombre_apellido + '"]')) {
                    sel.value = driver.nombre_apellido;
                }
            }
        };

        // Close on outside click
        window.addEventListener('click', function (event) {
            var modal = document.getElementById('fuelTransferModal');
            if (event.target === modal) {
                closeFuelTransferModal();
            }
        });
    })();
</script>

<script>
    function openCombustibleModal(type) {
        var modal = document.getElementById('modalCombustibles');
        var title = document.getElementById('modalCombTitle');
        var body = document.getElementById('modalCombBody');

        modal.style.display = 'block';

        if (type === 'carga') {
            title.innerHTML = '<i class="fas fa-cart-plus"></i> Nueva Carga de Combustible';
            fetch('../combustibles/views/form_carga.php').then(function (res) { return res.text(); }).then(function (html) {
                body.innerHTML = html;
            });
        } else {
            title.innerHTML = '<i class="fas fa-gas-pump"></i> Nuevo Despacho';
            fetch('../combustibles/views/form_despacho.php').then(function (res) { return res.text(); }).then(function (html) {
                body.innerHTML = html;
            });
        }
    }

    function closeCombustibleModal() {
        document.getElementById('modalCombustibles').style.display = 'none';
        location.reload();
    }

    function setMode(mode) {
        var btnStock = document.getElementById('btnStock');
        var btnVehicle = document.getElementById('btnVehicle');

        if (mode === 'stock') {
            btnStock.classList.remove('btn-light');
            btnStock.classList.add('btn-primary');
            btnStock.style = 'flex: 1; border-radius: 0;';

            btnVehicle.classList.remove('btn-primary');
            btnVehicle.classList.add('btn-light');
            btnVehicle.style = 'flex: 1; border-radius: 0;';

            document.getElementById('sectionStock').style.display = 'block';
            document.getElementById('sectionVehicle').style.display = 'none';
        } else {
            btnVehicle.classList.remove('btn-light');
            btnVehicle.classList.add('btn-primary');
            btnVehicle.style = 'flex: 1; border-radius: 0;';

            btnStock.classList.remove('btn-primary');
            btnStock.classList.add('btn-light');
            btnStock.style = 'flex: 1; border-radius: 0;';

            document.getElementById('sectionStock').style.display = 'none';
            document.getElementById('sectionVehicle').style.display = 'block';
        }
        document.getElementById('inputDestinoTipo').value = mode;
    }

    function onCuadrillaCargaChange() {
        var idCuadrilla = document.getElementById('select_cuadrilla_carga').value;
        var serverDataEl = document.getElementById('server-data');
        if (!serverDataEl) return;

        var cuadrillas = JSON.parse(serverDataEl.dataset.cuadrillas || '[]');
        var personal = JSON.parse(serverDataEl.dataset.personal || '[]');

        var selectVehiculo = document.getElementById('select_vehiculo_carga');
        selectVehiculo.innerHTML = '<option value="">-- Sin Vehículo --</option>';

        var squad = cuadrillas.find(function (c) { return c.id_cuadrilla == idCuadrilla; });
        if (squad && (squad.id_vehiculo || squad.id_vehiculo_asignado)) {
            var vid = squad.id_vehiculo || squad.id_vehiculo_asignado;
            var vlabel = squad.patente ? squad.marca + ' ' + squad.modelo + ' (' + squad.patente + ')' : 'Vehiculo Asignado';
            var opt = document.createElement('option');
            opt.value = vid;
            opt.textContent = vlabel;
            opt.selected = true;
            selectVehiculo.appendChild(opt);
        }

        var selectConductor = document.getElementById('select_conductor_carga');
        selectConductor.innerHTML = '<option value="">-- Seleccione --</option>';

        var drivers = personal.filter(function (p) { return p.id_cuadrilla == idCuadrilla; });
        drivers.forEach(function (p) {
            var opt = document.createElement('option');
            opt.value = p.nombre_apellido;
            opt.textContent = p.nombre_apellido;
            selectConductor.appendChild(opt);
        });
    }

    function submitCarga(event) {
        event.preventDefault();
        var form = event.target;
        var formData = new FormData(form);

        fetch('../combustibles/api/save_carga.php', {
            method: 'POST',
            body: formData
        })
            .then(function (response) { return response.json(); })
            .then(function (data) {
                if (data.success) {
                    alert('Carga registrada correctamente.');
                    closeCombustibleModal();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(function (error) {
                console.error('Error:', error);
                alert('Error de conexión al guardar.');
            });
    }

    function onCuadrillaChange() {
        var idCuadrilla = document.getElementById('select_cuadrilla').value;
        var serverDataEl = document.getElementById('server-data');
        if (!serverDataEl) return;

        var cuadrillas = JSON.parse(serverDataEl.dataset.cuadrillas || '[]');
        var personal = JSON.parse(serverDataEl.dataset.personal || '[]');

        var selectVehiculo = document.getElementById('select_vehiculo');
        selectVehiculo.innerHTML = '<option value="">-- Seleccione --</option>';

        var squad = cuadrillas.find(function (c) { return c.id_cuadrilla == idCuadrilla; });
        if (squad && (squad.id_vehiculo || squad.id_vehiculo_asignado)) {
            var vid = squad.id_vehiculo || squad.id_vehiculo_asignado;
            var vlabel = squad.patente ? squad.marca + ' ' + squad.modelo + ' (' + squad.patente + ')' : 'Vehiculo Asignado';

            var opt = document.createElement('option');
            opt.value = vid;
            opt.textContent = vlabel;
            opt.selected = true;
            selectVehiculo.appendChild(opt);
        }

        var selectConductor = document.getElementById('select_conductor');
        selectConductor.innerHTML = '<option value="">-- Seleccione conductor --</option>';

        var drivers = personal.filter(function (p) { return p.id_cuadrilla == idCuadrilla; });
        drivers.forEach(function (p) {
            var opt = document.createElement('option');
            opt.value = p.nombre_apellido;
            opt.textContent = p.nombre_apellido;
            selectConductor.appendChild(opt);
        });
    }

    function submitDespacho(event) {
        event.preventDefault();
        var form = event.target;
        var formData = new FormData(form);

        fetch('../combustibles/api/save_despacho.php', {
            method: 'POST',
            body: formData
        })
            .then(function (response) { return response.json(); })
            .then(function (data) {
                if (data.success) {
                    alert('Despacho registrado correctamente.');
                    closeCombustibleModal();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(function (error) {
                console.error('Error:', error);
                alert('Error de conexión al guardar.');
            });
    }
</script>

================================================================================
 MODULE: COMBUSTIBLES
 FILE: combustibles\views\form_carga.php
================================================================================
<?php
// Load necessary data for the form
require_once '../../../config/database.php';
$tanques = $pdo->query("SELECT * FROM combustibles_tanques WHERE estado='Activo'")->fetchAll(PDO::FETCH_ASSOC);

// Fetch Active Squads with their assigned Vehicle
$sql_cuadrillas = "SELECT c.id_cuadrilla, c.nombre_cuadrilla, c.id_vehiculo_asignado,  
                          v.id_vehiculo, v.marca, v.modelo, v.patente
                   FROM cuadrillas c
                   LEFT JOIN vehiculos v ON c.id_vehiculo_asignado = v.id_vehiculo
                   WHERE c.estado_operativo = 'Activa'
                   ORDER BY c.nombre_cuadrilla";
$cuadrillas = $pdo->query($sql_cuadrillas)->fetchAll(PDO::FETCH_ASSOC);

$personal = $pdo->query("SELECT id_personal, nombre_apellido, id_cuadrilla FROM personal ORDER BY nombre_apellido")->fetchAll(PDO::FETCH_ASSOC);

$json_cuadrillas = json_encode($cuadrillas);
$json_personal = json_encode($personal);
?>

<form id="formCarga" onsubmit="submitCarga(event)">

    <!-- TIPO DE CARGA TOGGLE -->
    <div class="form-group" style="text-align: center; margin-bottom: 20px;">
        <div
            style="display: flex; border: 1px solid #ddd; border-radius: 6px; overflow: hidden; justify-content: center;">
            <button type="button" id="btnStock" class="btn btn-light active"
                style="flex: 1; border-radius: 0; background: #e6f7ff; color: #0073A8; font-weight: bold;"
                onclick="setMode('stock')">
                <i class="fas fa-warehouse"></i> Carga a Stock
            </button>
            <button type="button" id="btnVehicle" class="btn btn-light" style="flex: 1; border-radius: 0;"
                onclick="setMode('vehiculo')">
                <i class="fas fa-gas-pump"></i> Carga Directa (Estación)
            </button>
        </div>
        <!-- Hidden input to store value -->
        <input type="hidden" name="destino_tipo" id="inputDestinoTipo" value="stock">
    </div>

    <!-- SECCION STOCK (Tanque) -->
    <div id="sectionStock">
        <div class="form-group">
            <label>Tanque de Destino</label>
            <select name="id_tanque" class="form-control">
                <?php foreach ($tanques as $t): ?>
                    <option value="<?php echo $t['id_tanque']; ?>">
                        <?php echo $t['nombre']; ?> (<?php echo $t['tipo_combustible']; ?>)
                    </option>
                <?php endforeach; ?>
            </select>
        </div>
    </div>

    <!-- SECCION VEHICULO DIRECTO -->
    <div id="sectionVehicle" class="p-3 mb-3 border rounded" style="display: none;">
        <div class="form-group">
            <label>Tipo de Combustible</label>
            <select name="tipo_combustible" class="form-control">
                <option value="Gasoil">Gasoil / Diesel</option>
                <option value="Nafta">Nafta</option>
                <option value="GNC">GNC</option>
            </select>
        </div>

        <div class="form-group">
            <label>Cuadrilla</label>
            <select name="id_cuadrilla" id="select_cuadrilla_carga" class="form-control"
                onchange="onCuadrillaCargaChange()">
                <option value="">Seleccione Cuadrilla...</option>
                <?php foreach ($cuadrillas as $c): ?>
                    <option value="<?php echo $c['id_cuadrilla']; ?>"><?php echo $c['nombre_cuadrilla']; ?></option>
                <?php endforeach; ?>
            </select>
        </div>

        <div class="form-group">
            <label>Vehículo</label>
            <select name="id_vehiculo" id="select_vehiculo_carga" class="form-control">
                <option value="">-- Sin Vehículo --</option>
            </select>
        </div>

        <div class="form-group">
            <label>Responsable (Chofer)</label>
            <select name="conductor" id="select_conductor_carga" class="form-control">
                <option value="">-- Seleccione --</option>
            </select>
        </div>
    </div>

    <!-- CAMPOS COMUNES -->
    <div class="row" style="display: flex; gap: 10px;">
        <div class="col" style="flex: 1;">
            <div class="form-group">
                <label>Litros / M3</label>
                <input type="number" step="0.01" name="litros" class="form-control" required placeholder="0.00">
            </div>
        </div>
        <div class="col" style="flex: 1;">
            <div class="form-group">
                <label>Precio Total ($)</label>
                <input type="number" step="0.01" name="precio_unitario" class="form-control" placeholder="Opcional">
            </div>
        </div>
    </div>

    <div class="form-group">
        <label>Proveedor / Factura</label>
        <div style="display: flex; gap: 5px;">
            <input type="text" name="proveedor" class="form-control" placeholder="Proveedor" style="flex: 1;">
            <input type="text" name="nro_factura" class="form-control" placeholder="N° Factura" style="flex: 1;"
                required>
        </div>
    </div>

    <div class="form-group">
        <label><i class="fas fa-camera"></i> Foto del Ticket (Opcional)</label>
        <input type="file" name="foto_ticket" class="form-control" accept="image/*" capture="environment">
    </div>

    <div class="form-group" style="margin-top: 10px;">
        <label>Fecha</label>
        <input type="datetime-local" name="fecha_hora" class="form-control" value="<?php echo date('Y-m-d\TH:i'); ?>"
            required>
    </div>

    <div class="modal-actions" style="margin-top: 20px;">
        <button type="button" class="btn btn-outline" onclick="closeCombustibleModal()">Cancelar</button>
        <button type="submit" class="btn btn-primary">Guardar Ingreso</button>
    </div>

    <!-- HIDDEN DATA PAYLOAD -->
    <div id="server-data" data-cuadrillas='<?php echo htmlspecialchars($json_cuadrillas, ENT_QUOTES, 'UTF-8'); ?>'
        data-personal='<?php echo htmlspecialchars($json_personal, ENT_QUOTES, 'UTF-8'); ?>' style="display:none;">
    </div>
</form>

================================================================================
 MODULE: COMBUSTIBLES
 FILE: combustibles\views\form_despacho.php
================================================================================
<?php
// Load necessary data for the form
require_once '../../../config/database.php';

// Fetch Tanks
$tanques = $pdo->query("SELECT * FROM combustibles_tanques WHERE estado='Activo'")->fetchAll(PDO::FETCH_ASSOC);

// Fetch Active Squads with their assigned Vehicle
$sql_cuadrillas = "SELECT c.id_cuadrilla, c.nombre_cuadrilla, c.id_vehiculo_asignado,  
                          v.id_vehiculo, v.marca, v.modelo, v.patente
                   FROM cuadrillas c
                   LEFT JOIN vehiculos v ON c.id_vehiculo_asignado = v.id_vehiculo
                   WHERE c.estado_operativo = 'Activa'
                   ORDER BY c.nombre_cuadrilla";
$cuadrillas = $pdo->query($sql_cuadrillas)->fetchAll(PDO::FETCH_ASSOC);

// Fetch Personnel for Drivers list
$personal = $pdo->query("SELECT id_personal, nombre_apellido, id_cuadrilla FROM personal ORDER BY nombre_apellido")->fetchAll(PDO::FETCH_ASSOC);

// Prepare JSON for JS
$json_cuadrillas = json_encode($cuadrillas);
$json_personal = json_encode($personal);
?>

<form id="formDespacho" onsubmit="submitDespacho(event)">

    <!-- 1. Select Tank (unchanged) -->
    <div class="form-group">
        <label>Tanque de Origen</label>
        <select name="id_tanque" class="form-control" required>
            <?php foreach ($tanques as $t): ?>
                <option value="<?php echo $t['id_tanque']; ?>">
                    <?php echo $t['nombre']; ?> (Disp: <?php echo $t['stock_actual']; ?> L)
                </option>
            <?php endforeach; ?>
        </select>
    </div>

    <!-- 2. Select Squad (New Parent) -->
    <div class="form-group">
        <label>Cuadrilla Asignada</label>
        <select id="select_cuadrilla" class="form-control" onchange="onCuadrillaChange()" required>
            <option value="">Seleccione Cuadrilla...</option>
            <?php foreach ($cuadrillas as $c): ?>
                <option value="<?php echo $c['id_cuadrilla']; ?>">
                    <?php echo $c['nombre_cuadrilla']; ?>
                </option>
            <?php endforeach; ?>
        </select>
    </div>

    <!-- 3. Auto-Select Vehicle -->
    <div class="form-group">
        <label>Vehículo / Maquinaria</label>
        <select name="id_vehiculo" id="select_vehiculo" class="form-control" required>
            <option value="">Seleccione primero una cuadrilla...</option>
            <!-- Auto-filled by JS -->
        </select>
    </div>

    <div class="row" style="display: flex; gap: 10px;">
        <div class="col" style="flex:1;">
            <div class="form-group">
                <label>Litros Despachados</label>
                <input type="number" step="0.01" name="litros" class="form-control" required placeholder="0.00">
            </div>
        </div>
        <div class="col" style="flex:1;">
            <div class="form-group">
                <label>Odómetro Actual (km/hs)</label>
                <input type="number" step="0.1" name="odometro_actual" class="form-control" required
                    placeholder="Ej: 150000">
            </div>
        </div>
    </div>

    <!-- 4. Select Driver (Filtered) -->
    <div class="form-group">
        <label>Conductor / Responsable</label>
        <select name="usuario_conductor" id="select_conductor" class="form-control" required>
            <option value="">Seleccione conductor...</option>
            <!-- Auto-filled by JS -->
        </select>
    </div>

    <div class="form-group">
        <label>Destino / Obra (Opcional)</label>
        <input type="text" name="destino_obra" class="form-control" placeholder="Ej: Obra Centro">
    </div>

    <div class="form-group">
        <label>Fecha Hora</label>
        <input type="datetime-local" name="fecha_hora" class="form-control" value="<?php echo date('Y-m-d\TH:i'); ?>"
            required>
    </div>

    <div class="modal-actions">
        <button type="button" class="btn btn-outline" onclick="closeCombustibleModal()">Cancelar</button>
        <button type="submit" class="btn btn-primary">Registrar Salida</button>
    </div>

    <!-- HIDDEN DATA PAYLOAD -->
    <div id="server-data" data-cuadrillas='<?php echo htmlspecialchars($json_cuadrillas, ENT_QUOTES, 'UTF-8'); ?>'
        data-personal='<?php echo htmlspecialchars($json_personal, ENT_QUOTES, 'UTF-8'); ?>' style="display:none;">
    </div>
</form>

================================================================================
 MODULE: COMBUSTIBLES
 FILE: combustibles\views\print_remito.php
================================================================================
<?php
require_once '../../../config/database.php';
session_start();

$id_despacho = isset($_GET['id']) ? intval($_GET['id']) : 0;

if (!$id_despacho) {
    die("ID de despacho no válido.");
}

// Fetch dispatch with related data (without id_cuadrilla dependency)
$stmt = $pdo->prepare("
    SELECT 
        d.*,
        t.nombre AS tanque_nombre,
        t.tipo_combustible,
        v.marca AS vehiculo_marca,
        v.modelo AS vehiculo_modelo,
        v.patente AS vehiculo_patente
    FROM combustibles_despachos d
    LEFT JOIN combustibles_tanques t ON d.id_tanque = t.id_tanque
    LEFT JOIN vehiculos v ON d.id_vehiculo = v.id_vehiculo
    WHERE d.id_despacho = ?
");
$stmt->execute([$id_despacho]);
$despacho = $stmt->fetch(PDO::FETCH_ASSOC);

// Set default cuadrilla name (column doesn't exist in despachos table)
$despacho['nombre_cuadrilla'] = $despacho['nombre_cuadrilla'] ?? 'No especificada';

if (!$despacho) {
    die("Despacho no encontrado.");
}

// Format date
$fecha_formateada = date('d/m/Y H:i', strtotime($despacho['fecha_hora']));

// Get dispatcher name
$despachante = $despacho['usuario_despacho'];
if (is_numeric($despachante)) {
    $stmtUser = $pdo->prepare("SELECT nombre_apellido FROM personal WHERE id_personal = ?");
    $stmtUser->execute([$despachante]);
    $user = $stmtUser->fetch(PDO::FETCH_ASSOC);
    if ($user)
        $despachante = $user['nombre_apellido'];
}

// Company info (could be fetched from settings)
$empresa = "Recursos Globales Business Company";
$empresa_direccion = "Oficina Central";
?>
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Remito de Combustible #
        <?php echo $id_despacho; ?>
    </title>
    <style>
        @media print {
            .no-print {
                display: none !important;
            }

            body {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .remito-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border: 2px solid #333;
            padding: 30px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            border-bottom: 2px solid #333;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        .header-left h1 {
            font-size: 1.5em;
            color: #333;
            margin-bottom: 5px;
        }

        .header-left p {
            font-size: 0.9em;
            color: #666;
        }

        .header-right {
            text-align: right;
        }

        .remito-number {
            font-size: 1.8em;
            font-weight: bold;
            color: #007bff;
        }

        .remito-type {
            background: #007bff;
            color: white;
            padding: 5px 15px;
            border-radius: 4px;
            font-weight: bold;
            display: inline-block;
            margin-top: 5px;
        }

        .section {
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 0.85em;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .info-item {
            padding: 10px;
            background: #f9f9f9;
            border-radius: 4px;
        }

        .info-item label {
            display: block;
            font-size: 0.75em;
            color: #888;
            text-transform: uppercase;
            margin-bottom: 3px;
        }

        .info-item span {
            font-size: 1.1em;
            font-weight: 500;
            color: #333;
        }

        .highlight-box {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            margin: 20px 0;
        }

        .highlight-box .amount {
            font-size: 3em;
            font-weight: bold;
        }

        .highlight-box .unit {
            font-size: 1.5em;
        }

        .highlight-box .fuel-type {
            font-size: 1em;
            opacity: 0.9;
            margin-top: 5px;
        }

        .signatures {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            margin-top: 40px;
            padding-top: 20px;
        }

        .signature-box {
            text-align: center;
        }

        .signature-line {
            border-top: 1px solid #333;
            margin-top: 60px;
            padding-top: 10px;
            font-size: 0.9em;
        }

        .footer {
            margin-top: 30px;
            padding-top: 15px;
            border-top: 1px dashed #ccc;
            font-size: 0.8em;
            color: #888;
            text-align: center;
        }

        .actions {
            text-align: center;
            margin-bottom: 20px;
        }

        .btn {
            padding: 10px 25px;
            font-size: 1em;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 0 5px;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn:hover {
            opacity: 0.9;
        }
    </style>
</head>

<body>

    <div class="actions no-print">
        <button class="btn btn-primary" onclick="window.print()">
            <i class="fas fa-print"></i> Imprimir Remito
        </button>
        <button class="btn btn-secondary" onclick="window.location.href='/APP-Prueba/modules/stock/index.php'">
            Volver al Dashboard
        </button>
    </div>

    <div class="remito-container">
        <div class="header">
            <div class="header-left">
                <h1>
                    <?php echo htmlspecialchars($empresa); ?>
                </h1>
                <p>
                    <?php echo htmlspecialchars($empresa_direccion); ?>
                </p>
            </div>
            <div class="header-right">
                <div class="remito-number">#
                    <?php echo str_pad($id_despacho, 6, '0', STR_PAD_LEFT); ?>
                </div>
                <div class="remito-type">REMITO DE COMBUSTIBLE</div>
            </div>
        </div>

        <div class="section">
            <div class="section-title">Fecha y Hora</div>
            <div class="info-grid">
                <div class="info-item">
                    <label>Fecha de Emisión</label>
                    <span>
                        <?php echo $fecha_formateada; ?>
                    </span>
                </div>
                <div class="info-item">
                    <label>Tanque de Origen</label>
                    <span>
                        <?php echo htmlspecialchars($despacho['tanque_nombre'] ?? 'N/A'); ?>
                    </span>
                </div>
            </div>
        </div>

        <div class="highlight-box">
            <div class="amount">
                <?php echo number_format($despacho['litros'], 2); ?>
            </div>
            <div class="unit">LITROS</div>
            <div class="fuel-type">
                <?php echo htmlspecialchars($despacho['tipo_combustible'] ?? 'Combustible'); ?>
            </div>
        </div>

        <div class="section">
            <div class="section-title">Destinatario</div>
            <div class="info-grid">
                <div class="info-item">
                    <label>Cuadrilla</label>
                    <span>
                        <?php echo htmlspecialchars($despacho['nombre_cuadrilla'] ?? 'N/A'); ?>
                    </span>
                </div>
                <div class="info-item">
                    <label>Vehículo</label>
                    <span>
                        <?php
                        if ($despacho['vehiculo_marca']) {
                            echo htmlspecialchars($despacho['vehiculo_marca'] . ' ' . $despacho['vehiculo_modelo'] . ' (' . $despacho['vehiculo_patente'] . ')');
                        } else {
                            echo 'N/A';
                        }
                        ?>
                    </span>
                </div>
                <div class="info-item">
                    <label>Conductor / Responsable</label>
                    <span>
                        <?php echo htmlspecialchars($despacho['usuario_conductor'] ?? 'N/A'); ?>
                    </span>
                </div>
                <div class="info-item">
                    <label>Odómetro Registrado</label>
                    <span>
                        <?php echo number_format($despacho['odometro_actual'], 0); ?> km
                    </span>
                </div>
            </div>
        </div>

        <?php if (!empty($despacho['destino_obra'])): ?>
            <div class="section">
                <div class="section-title">Destino / Obra</div>
                <div class="info-item" style="background: #fff3cd;">
                    <span>
                        <?php echo htmlspecialchars($despacho['destino_obra']); ?>
                    </span>
                </div>
            </div>
        <?php endif; ?>

        <div class="signatures">
            <div class="signature-box">
                <div class="signature-line">
                    <strong>Entregó:</strong>
                    <?php echo htmlspecialchars($despachante); ?>
                </div>
            </div>
            <div class="signature-box">
                <div class="signature-line">
                    <strong>Recibió:</strong>
                    <?php echo htmlspecialchars($despacho['usuario_conductor'] ?? ''); ?>
                </div>
            </div>
        </div>

        <div class="footer">
            Documento generado automáticamente por el Sistema de Gestión de Combustibles.<br>
            Remito ID:
            <?php echo $id_despacho; ?> | Generado:
            <?php echo date('d/m/Y H:i:s'); ?>
        </div>
    </div>

</body>

</html>

================================================================================
 MODULE: CUADRILLAS
 FILE: cuadrillas\asistencia.php
================================================================================
<?php
require_once '../../config/database.php';
require_once '../../includes/header.php';

// Get cuadrilla info
if (!isset($_GET['id']) || !is_numeric($_GET['id'])) {
    header("Location: index.php");
    exit;
}

$id_cuadrilla = intval($_GET['id']);
$fecha = $_GET['fecha'] ?? date('Y-m-d');

// Get cuadrilla data
$stmtC = $pdo->prepare("SELECT * FROM cuadrillas WHERE id_cuadrilla = ?");
$stmtC->execute([$id_cuadrilla]);
$cuadrilla = $stmtC->fetch(PDO::FETCH_ASSOC);

if (!$cuadrilla) {
    header("Location: index.php?msg=not_found");
    exit;
}

// Get personal of this cuadrilla
$stmtP = $pdo->prepare("SELECT * FROM personal WHERE id_cuadrilla = ? ORDER BY nombre_apellido");
$stmtP->execute([$id_cuadrilla]);
$personal = $stmtP->fetchAll(PDO::FETCH_ASSOC);

// Get existing attendance for this date
$stmtA = $pdo->prepare("SELECT * FROM asistencia WHERE fecha = ? AND id_personal IN (SELECT id_personal FROM personal WHERE id_cuadrilla = ?)");
$stmtA->execute([$fecha, $id_cuadrilla]);
$asistenciaData = [];
foreach ($stmtA->fetchAll(PDO::FETCH_ASSOC) as $a) {
    $asistenciaData[$a['id_personal']] = $a;
}

// Options
$estados_dia = ['Presente', 'Falta Justificada', 'Injustificada', 'Dia Lluvia'];

// Handle form submission
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    try {
        $pdo->beginTransaction();

        foreach ($_POST['asistencia'] as $id_personal => $data) {
            // Check if record exists
            $stmtCheck = $pdo->prepare("SELECT id_asistencia FROM asistencia WHERE id_personal = ? AND fecha = ?");
            $stmtCheck->execute([$id_personal, $fecha]);
            $existing = $stmtCheck->fetchColumn();

            $hora_entrada = !empty($data['hora_entrada']) ? $data['hora_entrada'] : null;
            $hora_salida = !empty($data['hora_salida']) ? $data['hora_salida'] : null;
            $estado_dia = $data['estado_dia'] ?? 'Presente';
            $horas_emergencia = !empty($data['horas_emergencia']) ? floatval($data['horas_emergencia']) : 0;

            if ($existing) {
                // UPDATE
                $stmtU = $pdo->prepare("UPDATE asistencia SET hora_entrada = ?, hora_salida = ?, estado_dia = ?, horas_emergencia = ? WHERE id_asistencia = ?");
                $stmtU->execute([$hora_entrada, $hora_salida, $estado_dia, $horas_emergencia, $existing]);
            } else {
                // INSERT
                $stmtI = $pdo->prepare("INSERT INTO asistencia (id_personal, fecha, hora_entrada, hora_salida, estado_dia, horas_emergencia) VALUES (?, ?, ?, ?, ?, ?)");
                $stmtI->execute([$id_personal, $fecha, $hora_entrada, $hora_salida, $estado_dia, $horas_emergencia]);
            }
        }

        $pdo->commit();
        header("Location: asistencia.php?id=$id_cuadrilla&fecha=$fecha&msg=saved");
        exit;

    } catch (Exception $e) {
        $pdo->rollBack();
        $error = $e->getMessage();
    }
}
?>

<div class="container-fluid" style="padding: 0 20px;">

    <!-- Header -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
        <div>
            <h2 style="margin: 0;">
                <i class="fas fa-clipboard-check"></i> Asistencia -
                <?php echo htmlspecialchars($cuadrilla['nombre_cuadrilla']); ?>
            </h2>
            <p style="margin: 5px 0 0; color: #666;">Control de Horas y Asistencia del Personal</p>
        </div>
        <a href="index.php" class="btn btn-outline"><i class="fas fa-arrow-left"></i> Volver a Cuadrillas</a>
    </div>

    <?php if (isset($_GET['msg']) && $_GET['msg'] == 'saved'): ?>
        <div class="alert alert-success"
            style="background: #d4edda; color: #155724; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <i class="fas fa-check-circle"></i> Asistencia guardada correctamente
        </div>
    <?php endif; ?>

    <?php if (isset($error)): ?>
        <div class="alert alert-danger"
            style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <strong>Error:</strong>
            <?php echo htmlspecialchars($error); ?>
        </div>
    <?php endif; ?>

    <!-- Date Selector -->
    <div class="card" style="margin-bottom: 20px;">
        <form method="GET" style="display: flex; gap: 15px; align-items: center;">
            <input type="hidden" name="id" value="<?php echo $id_cuadrilla; ?>">
            <label style="font-weight: 600;"><i class="fas fa-calendar-alt"></i> Fecha:</label>
            <input type="date" name="fecha" value="<?php echo $fecha; ?>" class="form-control" style="width: auto;">
            <button type="submit" class="btn btn-primary btn-sm"><i class="fas fa-search"></i> Ver</button>

            <!-- Quick date buttons -->
            <div style="margin-left: auto; display: flex; gap: 5px;">
                <a href="?id=<?php echo $id_cuadrilla; ?>&fecha=<?php echo date('Y-m-d', strtotime('-1 day', strtotime($fecha))); ?>"
                    class="btn btn-outline btn-sm"><i class="fas fa-chevron-left"></i></a>
                <a href="?id=<?php echo $id_cuadrilla; ?>&fecha=<?php echo date('Y-m-d'); ?>"
                    class="btn btn-outline btn-sm">Hoy</a>
                <a href="?id=<?php echo $id_cuadrilla; ?>&fecha=<?php echo date('Y-m-d', strtotime('+1 day', strtotime($fecha))); ?>"
                    class="btn btn-outline btn-sm"><i class="fas fa-chevron-right"></i></a>
            </div>
        </form>
    </div>

    <!-- Attendance Form -->
    <div class="card" style="border-top: 4px solid var(--color-primary);">
        <?php if (empty($personal)): ?>
            <div style="text-align: center; padding: 40px; color: #999;">
                <i class="fas fa-users-slash" style="font-size: 2em; margin-bottom: 10px;"></i><br>
                Esta cuadrilla no tiene personal asignado.<br>
                <a href="../personal/index.php" style="margin-top: 10px; display: inline-block;">Ir a Gestión de
                    Personal</a>
            </div>
        <?php else: ?>
            <form method="POST">
                <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                    <span class="badge"
                        style="background: #e3f2fd; color: #1565c0; padding: 8px 15px; border-radius: 20px;">
                        <i class="fas fa-users"></i>
                        <?php echo count($personal); ?> integrantes
                    </span>
                    <span style="color: #666; font-weight: 500;">
                        <?php echo strftime('%A %d de %B, %Y', strtotime($fecha)); ?>
                    </span>
                </div>

                <table class="table" style="width: 100%;">
                    <thead>
                        <tr>
                            <th>Personal</th>
                            <th>Rol</th>
                            <th style="width: 130px;">Entrada</th>
                            <th style="width: 130px;">Salida</th>
                            <th style="width: 180px;">Estado</th>
                            <th style="width: 100px;">Hs Extra</th>
                        </tr>
                    </thead>
                    <tbody>
                        <?php foreach ($personal as $p):
                            $a = $asistenciaData[$p['id_personal']] ?? [];
                            ?>
                            <tr>
                                <td>
                                    <strong>
                                        <?php echo htmlspecialchars($p['nombre_apellido']); ?>
                                    </strong>
                                </td>
                                <td>
                                    <span class="badge-rol <?php echo strtolower($p['rol']); ?>">
                                        <?php echo $p['rol']; ?>
                                    </span>
                                </td>
                                <td>
                                    <input type="time" name="asistencia[<?php echo $p['id_personal']; ?>][hora_entrada]"
                                        value="<?php echo $a['hora_entrada'] ?? '08:00'; ?>" class="form-control-sm">
                                </td>
                                <td>
                                    <input type="time" name="asistencia[<?php echo $p['id_personal']; ?>][hora_salida]"
                                        value="<?php echo $a['hora_salida'] ?? '17:00'; ?>" class="form-control-sm">
                                </td>
                                <td>
                                    <select name="asistencia[<?php echo $p['id_personal']; ?>][estado_dia]"
                                        class="form-control-sm estado-select" onchange="updateRowStyle(this)">
                                        <?php foreach ($estados_dia as $e): ?>
                                            <option value="<?php echo $e; ?>" <?php echo ($a['estado_dia'] ?? 'Presente') == $e ? 'selected' : ''; ?>>
                                                <?php echo $e; ?>
                                            </option>
                                        <?php endforeach; ?>
                                    </select>
                                </td>
                                <td>
                                    <input type="number" step="0.5" min="0" max="24"
                                        name="asistencia[<?php echo $p['id_personal']; ?>][horas_emergencia]"
                                        value="<?php echo $a['horas_emergencia'] ?? '0'; ?>" class="form-control-sm"
                                        style="width: 80px;">
                                </td>
                            </tr>
                        <?php endforeach; ?>
                    </tbody>
                </table>

                <div style="display: flex; justify-content: flex-end; margin-top: 20px; gap: 10px;">
                    <button type="button" class="btn btn-outline" onclick="marcarTodosPresentes()">
                        <i class="fas fa-check-double"></i> Todos Presentes
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Guardar Asistencia
                    </button>
                </div>
            </form>
        <?php endif; ?>
    </div>
</div>

<style>
    .form-control-sm {
        padding: 6px 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 0.9em;
        width: 100%;
    }

    .badge-rol {
        padding: 3px 10px;
        border-radius: 12px;
        font-size: 0.8em;
        font-weight: 500;
    }

    .badge-rol.oficial {
        background: #e8f5e9;
        color: #2e7d32;
    }

    .badge-rol.ayudante {
        background: #fff3e0;
        color: #ef6c00;
    }

    .badge-rol.chofer {
        background: #e8eaf6;
        color: #3949ab;
    }

    .table tbody tr {
        transition: background 0.2s;
    }

    .table tbody tr:hover {
        background: #f5f5f5;
    }

    .estado-select {
        font-weight: 500;
    }
</style>

<script>
    function marcarTodosPresentes() {
        document.querySelectorAll('.estado-select').forEach(select => {
            select.value = 'Presente';
        });
    }

    function updateRowStyle(select) {
        const row = select.closest('tr');
        row.style.background = '';

        if (select.value === 'Falta Justificada' || select.value === 'Injustificada') {
            row.style.background = '#fff8e1';
        } else if (select.value === 'Dia Lluvia') {
            row.style.background = '#e3f2fd';
        }
    }

    // Apply initial styles
    document.querySelectorAll('.estado-select').forEach(select => updateRowStyle(select));
</script>

<?php require_once '../../includes/footer.php'; ?>

================================================================================
 MODULE: CUADRILLAS
 FILE: cuadrillas\delete.php
================================================================================
<?php
require_once '../../config/database.php';
require_once '../../includes/auth.php';

// Verificar sesión
verificarSesion();

if (!isset($_GET['id']) || !is_numeric($_GET['id'])) {
    header("Location: index.php?msg=error");
    exit;
}

$id = intval($_GET['id']);

try {
    // Obtener nombre antes de eliminar para el log
    $nameStmt = $pdo->prepare("SELECT nombre_cuadrilla FROM cuadrillas WHERE id_cuadrilla = ?");
    $nameStmt->execute([$id]);
    $cuadrillaNombre = $nameStmt->fetchColumn();

    // Check if cuadrilla has personal assigned
    $checkStmt = $pdo->prepare("SELECT COUNT(*) FROM personal WHERE id_cuadrilla = ?");
    $checkStmt->execute([$id]);
    $personalCount = $checkStmt->fetchColumn();

    if ($personalCount > 0) {
        $error = urlencode("No se puede eliminar: la cuadrilla tiene $personalCount integrante(s) asignados");
        header("Location: index.php?msg=error&details=$error");
        exit;
    }

    // Delete
    $stmt = $pdo->prepare("DELETE FROM cuadrillas WHERE id_cuadrilla = ?");
    $stmt->execute([$id]);

    // Registrar auditoría
    registrarAccion('ELIMINAR', 'cuadrillas', "Cuadrilla eliminada: $cuadrillaNombre", $id);

    header("Location: index.php?msg=deleted");

} catch (PDOException $e) {
    $error = urlencode($e->getMessage());
    header("Location: index.php?msg=error&details=$error");
}
?>

================================================================================
 MODULE: CUADRILLAS
 FILE: cuadrillas\form.php
================================================================================
<?php
require_once '../../config/database.php';
require_once '../../includes/header.php';

// Check if editing
$isEdit = isset($_GET['id']) && is_numeric($_GET['id']);
$cuadrilla = null;

if ($isEdit) {
    $stmt = $pdo->prepare("SELECT * FROM cuadrillas WHERE id_cuadrilla = ?");
    $stmt->execute([$_GET['id']]);
    $cuadrilla = $stmt->fetch(PDO::FETCH_ASSOC);

    if (!$cuadrilla) {
        header("Location: index.php?msg=not_found");
        exit;
    }
}

// Options
$especialidades = ['Veredas', 'Hidráulicos', 'Medidores', 'Calzada', 'Emergencias'];
$estados = ['Activa', 'Mantenimiento', 'Baja'];

// Get available vehicles (not assigned or assigned to this cuadrilla)
$sqlVehiculos = "SELECT v.* FROM vehiculos v 
                 WHERE v.estado = 'Operativo' 
                 AND (v.id_vehiculo NOT IN (SELECT id_vehiculo_asignado FROM cuadrillas WHERE id_vehiculo_asignado IS NOT NULL)
                      OR v.id_vehiculo = ?)";
$stmtV = $pdo->prepare($sqlVehiculos);
$stmtV->execute([$cuadrilla['id_vehiculo_asignado'] ?? 0]);
$vehiculos = $stmtV->fetchAll(PDO::FETCH_ASSOC);

// Get personal assigned to this cuadrilla (for viewing)
$personal = [];
if ($isEdit) {
    $stmtP = $pdo->prepare("SELECT * FROM personal WHERE id_cuadrilla = ? ORDER BY nombre_apellido");
    $stmtP->execute([$cuadrilla['id_cuadrilla']]);
    $personal = $stmtP->fetchAll(PDO::FETCH_ASSOC);
}
?>

<div class="card" style="max-width: 900px; margin: 0 auto;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
        <h2 style="margin: 0;">
            <i class="fas fa-<?php echo $isEdit ? 'edit' : 'plus-circle'; ?>"></i>
            <?php echo $isEdit ? 'Editar Cuadrilla' : 'Nueva Cuadrilla'; ?>
        </h2>
        <a href="index.php" class="btn btn-outline"><i class="fas fa-arrow-left"></i> Volver</a>
    </div>

    <?php if (isset($_GET['msg']) && $_GET['msg'] == 'error'): ?>
        <div class="alert alert-danger"
            style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <strong>Error:</strong>
            <?php echo htmlspecialchars($_GET['details'] ?? 'No se pudo guardar'); ?>
        </div>
    <?php endif; ?>

    <form action="save.php" method="POST" id="cuadrillaForm">
        <input type="hidden" name="id_cuadrilla" value="<?php echo $cuadrilla['id_cuadrilla'] ?? ''; ?>">

        <!-- SECCIÓN 1: INFORMACIÓN BÁSICA -->
        <div class="form-section">
            <h3><i class="fas fa-info-circle"></i> 1. Información Básica</h3>
            <div class="form-grid">
                <div class="form-group" style="grid-column: span 2;">
                    <label>Nombre de la Cuadrilla *</label>
                    <input type="text" name="nombre_cuadrilla" required
                        value="<?php echo htmlspecialchars($cuadrilla['nombre_cuadrilla'] ?? ''); ?>"
                        placeholder="Ej: Cuadrilla Hidráulica 1">
                </div>
                <div class="form-group">
                    <label>Tipo de Especialidad</label>
                    <select name="tipo_especialidad">
                        <option value="">Sin definir</option>
                        <?php foreach ($especialidades as $e): ?>
                            <option value="<?php echo $e; ?>" <?php echo ($cuadrilla['tipo_especialidad'] ?? '') == $e ? 'selected' : ''; ?>>
                                <?php echo $e; ?>
                            </option>
                        <?php endforeach; ?>
                    </select>
                </div>
                <div class="form-group">
                    <label>Estado Operativo</label>
                    <select name="estado_operativo">
                        <?php foreach ($estados as $e): ?>
                            <option value="<?php echo $e; ?>" <?php echo ($cuadrilla['estado_operativo'] ?? 'Activa') == $e ? 'selected' : ''; ?>>
                                <?php echo $e; ?>
                            </option>
                        <?php endforeach; ?>
                    </select>
                </div>
            </div>
        </div>

        <!-- SECCIÓN 2: RECURSOS ASIGNADOS -->
        <div class="form-section">
            <h3><i class="fas fa-truck"></i> 2. Recursos Asignados</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label>Vehículo Asignado</label>
                    <select name="id_vehiculo_asignado">
                        <option value="">Sin vehículo</option>
                        <?php foreach ($vehiculos as $v): ?>
                            <option value="<?php echo $v['id_vehiculo']; ?>" <?php echo ($cuadrilla['id_vehiculo_asignado'] ?? '') == $v['id_vehiculo'] ? 'selected' : ''; ?>>
                                <?php echo $v['patente'] . ' - ' . $v['marca'] . ' ' . $v['modelo']; ?>
                            </option>
                        <?php endforeach; ?>
                    </select>
                </div>
                <div class="form-group">
                    <label>Celular Asignado</label>
                    <input type="text" name="id_celular_asignado"
                        value="<?php echo htmlspecialchars($cuadrilla['id_celular_asignado'] ?? ''); ?>"
                        placeholder="Ej: 3492-123456">
                </div>
            </div>
        </div>

        <!-- SECCIÓN 3: ZONA Y COMUNICACIÓN -->
        <div class="form-section">
            <h3><i class="fas fa-map-marker-alt"></i> 3. Zona y Comunicación</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label>Zona Asignada</label>
                    <input type="text" name="zona_asignada"
                        value="<?php echo htmlspecialchars($cuadrilla['zona_asignada'] ?? ''); ?>"
                        placeholder="Ej: Zona Norte, Centro">
                </div>
                <div class="form-group">
                    <label>URL Grupo WhatsApp</label>
                    <input type="url" name="url_grupo_whatsapp"
                        value="<?php echo htmlspecialchars($cuadrilla['url_grupo_whatsapp'] ?? ''); ?>"
                        placeholder="https://chat.whatsapp.com/...">
                </div>
            </div>
        </div>

        <?php if ($isEdit && !empty($personal)): ?>
            <!-- SECCIÓN 4: INTEGRANTES (Solo lectura) -->
            <div class="form-section success">
                <h3><i class="fas fa-users"></i> 4. Integrantes (
                    <?php echo count($personal); ?>)
                </h3>
                <div class="personal-list">
                    <?php foreach ($personal as $p): ?>
                        <div class="personal-item">
                            <span class="personal-name">
                                <?php echo htmlspecialchars($p['nombre_apellido']); ?>
                            </span>
                            <span class="personal-rol">
                                <?php echo $p['rol']; ?>
                            </span>
                        </div>
                    <?php endforeach; ?>
                </div>
                <p style="margin-top: 10px; font-size: 0.85em; color: #666;">
                    <i class="fas fa-info-circle"></i> Para asignar personal, vaya a <a href="../personal/index.php">Gestión
                        de Personal</a>
                </p>
            </div>
        <?php endif; ?>

        <!-- BOTONES -->
        <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 25px;">
            <a href="index.php" class="btn btn-outline">Cancelar</a>
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i>
                <?php echo $isEdit ? 'Guardar Cambios' : 'Crear Cuadrilla'; ?>
            </button>
        </div>
    </form>
</div>

<style>
    /* Container for sections */
    .form-section {
        background: var(--bg-card);
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        border: 1px solid rgba(100, 181, 246, 0.15);
        border-left: 4px solid var(--color-primary);
        box-shadow: var(--shadow-sm);
    }

    [data-theme="light"] .form-section {
        background: #f8f9fa;
        border: 1px solid #e2e8f0;
        border-left: 4px solid var(--color-primary);
    }

    /* Success Section Override */
    .form-section.success {
        background: rgba(76, 175, 80, 0.1);
        border-left-color: #4caf50;
        border-color: rgba(76, 175, 80, 0.3);
    }

    [data-theme="light"] .form-section.success {
        background: #e8f5e9;
        border-left-color: #4caf50;
        border-color: #c8e6c9;
    }

    .form-section h3 {
        margin: 0 0 15px 0;
        font-size: 1.1em;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 10px;
    }

    [data-theme="light"] .form-section h3 {
        color: #2c3e50;
    }

    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
    }

    .form-group {
        display: flex;
        flex-direction: column;
    }

    .form-group label {
        font-size: 0.85em;
        font-weight: 600;
        color: var(--text-secondary);
        margin-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    [data-theme="light"] .form-group label {
        color: #555;
    }

    .form-group input,
    .form-group select {
        padding: 12px 14px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        font-size: 0.95em;
        background: var(--bg-tertiary);
        color: var(--text-primary);
        transition: all 0.2s;
    }

    .form-group input:focus,
    .form-group select:focus {
        outline: none;
        border-color: var(--color-primary);
        box-shadow: 0 0 0 3px rgba(100, 181, 246, 0.2);
        background: var(--bg-secondary);
    }

    /* Light Mode Overrides for Inputs */
    [data-theme="light"] .form-group input,
    [data-theme="light"] .form-group select {
        background: #ffffff;
        border: 1px solid #d1d5db;
        color: #333;
    }

    [data-theme="light"] .form-group input:focus,
    [data-theme="light"] .form-group select:focus {
        border-color: var(--accent-primary);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
    }

    .personal-list {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
    }

    .personal-item {
        background: var(--bg-tertiary);
        padding: 8px 15px;
        border-radius: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
        box-shadow: var(--shadow-sm);
        border: 1px solid rgba(255, 255, 255, 0.05);
        color: var(--text-primary);
    }

    [data-theme="light"] .personal-item {
        background: #ffffff;
        border: 1px solid #e0e0e0;
        color: #333;
    }

    .personal-name {
        font-weight: 500;
    }

    .personal-rol {
        background: rgba(33, 150, 243, 0.2);
        color: #90caf9;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 0.8em;
    }

    [data-theme="light"] .personal-rol {
        background: #e3f2fd;
        color: #1565c0;
    }
</style>

<?php require_once '../../includes/footer.php'; ?>

================================================================================
 MODULE: CUADRILLAS
 FILE: cuadrillas\index.php
================================================================================
<?php
require_once '../../config/database.php';
require_once '../../includes/header.php';

// Verificar permiso para este módulo
verificarPermiso('cuadrillas');

// Obtener usuario actual
$usuarioActual = obtenerUsuarioActual();
$esJefeCuadrilla = ($usuarioActual['rol'] === 'JefeCuadrilla');
$idCuadrillaUsuario = $usuarioActual['id_cuadrilla'];

// Fetch Cuadrillas with Vehicle and Member count
// Si es Jefe de Cuadrilla, solo mostrar su cuadrilla
if ($esJefeCuadrilla && $idCuadrillaUsuario) {
    $sql = "SELECT c.*, 
            v.patente, v.marca, v.modelo,
            (SELECT COUNT(*) FROM personal p WHERE p.id_cuadrilla = c.id_cuadrilla) as total_personal
            FROM cuadrillas c
            LEFT JOIN vehiculos v ON c.id_vehiculo_asignado = v.id_vehiculo
            WHERE c.id_cuadrilla = ?
            ORDER BY c.nombre_cuadrilla ASC";
    $stmt = $pdo->prepare($sql);
    $stmt->execute([$idCuadrillaUsuario]);
    $cuadrillas = $stmt->fetchAll(PDO::FETCH_ASSOC);
} else {
    $sql = "SELECT c.*, 
            v.patente, v.marca, v.modelo,
            (SELECT COUNT(*) FROM personal p WHERE p.id_cuadrilla = c.id_cuadrilla) as total_personal
            FROM cuadrillas c
            LEFT JOIN vehiculos v ON c.id_vehiculo_asignado = v.id_vehiculo
            ORDER BY c.nombre_cuadrilla ASC";
    $cuadrillas = $pdo->query($sql)->fetchAll(PDO::FETCH_ASSOC);
}

// Options
$especialidades = ['Veredas', 'Hidráulicos', 'Medidores', 'Calzada', 'Emergencias'];
$estados = ['Activa', 'Mantenimiento', 'Baja'];

// Metrics
$total = count($cuadrillas);
$activas = 0;
$mantenimiento = 0;
$sin_vehiculo = 0;

foreach ($cuadrillas as $c) {
    if ($c['estado_operativo'] === 'Activa')
        $activas++;
    if ($c['estado_operativo'] === 'Mantenimiento')
        $mantenimiento++;
    if (empty($c['id_vehiculo_asignado']))
        $sin_vehiculo++;
}
?>

<div class="container-fluid" style="padding: 0 20px;">

    <!-- Header -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
        <div>
            <h2 style="margin: 0;"><i class="fas fa-hard-hat"></i> Gestión de Cuadrillas</h2>
            <p style="margin: 5px 0 0; color: #666;">Estructura de Trabajo y Equipos</p>
        </div>
        <?php if (!$esJefeCuadrilla): ?>
            <a href="form.php" class="btn btn-primary"><i class="fas fa-plus-circle"></i> Nueva Cuadrilla</a>
        <?php endif; ?>
    </div>

    <!-- KPI Cards con Glow -->
    <div class="metrics-row">
        <div class="metric-mini">
            <div class="metric-icon primary">
                <i class="fas fa-users"></i>
            </div>
            <div class="metric-content">
                <span class="metric-val"><?php echo $total; ?></span>
                <span class="metric-lbl">Total Cuadrillas</span>
            </div>
        </div>
        <div class="metric-mini">
            <div class="metric-icon success">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="metric-content">
                <span class="metric-val"><?php echo $activas; ?></span>
                <span class="metric-lbl">Activas</span>
            </div>
        </div>
        <div class="metric-mini">
            <div class="metric-icon warning">
                <i class="fas fa-wrench"></i>
            </div>
            <div class="metric-content">
                <span class="metric-val"><?php echo $mantenimiento; ?></span>
                <span class="metric-lbl">En Mantenimiento</span>
            </div>
        </div>
        <?php if ($sin_vehiculo > 0): ?>
            <div class="metric-mini">
                <div class="metric-icon danger">
                    <i class="fas fa-truck"></i>
                </div>
                <div class="metric-content">
                    <span class="metric-val"><?php echo $sin_vehiculo; ?></span>
                    <span class="metric-lbl">Sin Vehículo</span>
                </div>
            </div>
        <?php endif; ?>
    </div>

    <!-- Main Card -->
    <div class="card" style="border-top: 4px solid var(--color-primary);">

        <!-- Filters -->
        <div class="filter-bar"
            style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; gap: 15px; flex-wrap: wrap;">
            <div class="filter-group">
                <label>Buscar</label>
                <input type="text" id="searchInput" onkeyup="filterTable()" placeholder="Nombre..."
                    class="form-control-sm">
            </div>
            <div class="filter-group">
                <label>Especialidad</label>
                <select id="filterEsp" onchange="filterTable()" class="form-control-sm">
                    <option value="">Todas</option>
                    <?php foreach ($especialidades as $e): ?>
                        <option value="<?php echo $e; ?>"><?php echo $e; ?></option>
                    <?php endforeach; ?>
                </select>
            </div>
            <div class="filter-group">
                <label>Estado</label>
                <select id="filterEstado" onchange="filterTable()" class="form-control-sm">
                    <option value="">Todos</option>
                    <?php foreach ($estados as $e): ?>
                        <option value="<?php echo $e; ?>"><?php echo $e; ?></option>
                    <?php endforeach; ?>
                </select>
            </div>
            <div class="filter-group" style="display: flex; align-items: flex-end;">
                <button onclick="resetFilters()" class="btn btn-outline btn-sm" title="Limpiar Filtros">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </div>

        <!-- Cards Grid -->
        <div class="cuadrillas-grid" id="cuadrillasGrid">
            <?php if (empty($cuadrillas)): ?>
                <div class="empty-state" style="grid-column: 1/-1; text-align: center; padding: 60px; color: #999;">
                    <i class="fas fa-hard-hat" style="font-size: 3em; margin-bottom: 15px;"></i><br>
                    No hay cuadrillas registradas
                </div>
            <?php else: ?>
                <?php foreach ($cuadrillas as $c): ?>
                    <div class="cuadrilla-card <?php echo strtolower($c['estado_operativo']); ?>"
                        data-nombre="<?php echo strtolower($c['nombre_cuadrilla']); ?>"
                        data-especialidad="<?php echo $c['tipo_especialidad']; ?>"
                        data-estado="<?php echo $c['estado_operativo']; ?>">

                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-hard-hat"></i>
                                <?php echo htmlspecialchars($c['nombre_cuadrilla']); ?>
                            </div>
                            <span class="badge-estado <?php echo strtolower($c['estado_operativo']); ?>">
                                <?php echo $c['estado_operativo']; ?>
                            </span>
                        </div>

                        <div class="card-body">
                            <!-- Especialidad -->
                            <?php if ($c['tipo_especialidad']): ?>
                                <div class="info-row">
                                    <i class="fas fa-tools"></i>
                                    <span class="badge-esp"><?php echo $c['tipo_especialidad']; ?></span>
                                </div>
                            <?php endif; ?>

                            <!-- Zona -->
                            <?php if ($c['zona_asignada']): ?>
                                <div class="info-row">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <?php echo htmlspecialchars($c['zona_asignada']); ?>
                                </div>
                            <?php endif; ?>

                            <!-- Vehículo -->
                            <div class="info-row">
                                <i class="fas fa-truck"></i>
                                <?php if ($c['patente']): ?>
                                    <span class="badge-vehiculo">
                                        <?php echo $c['patente']; ?>
                                        <small>(<?php echo $c['marca'] . ' ' . $c['modelo']; ?>)</small>
                                    </span>
                                <?php else: ?>
                                    <span class="text-muted">Sin vehículo asignado</span>
                                <?php endif; ?>
                            </div>

                            <!-- Personal -->
                            <div class="info-row">
                                <i class="fas fa-users"></i>
                                <strong><?php echo $c['total_personal']; ?></strong> integrantes
                            </div>

                            <!-- WhatsApp -->
                            <?php if ($c['url_grupo_whatsapp']): ?>
                                <div class="info-row">
                                    <a href="<?php echo htmlspecialchars($c['url_grupo_whatsapp']); ?>" target="_blank"
                                        class="whatsapp-link">
                                        <i class="fab fa-whatsapp"></i> Grupo WhatsApp
                                    </a>
                                </div>
                            <?php endif; ?>
                        </div>

                        <div class="card-footer">
                            <a href="asistencia.php?id=<?php echo $c['id_cuadrilla']; ?>" class="btn-action" title="Asistencia">
                                <i class="fas fa-clipboard-check"></i>
                            </a>
                            <?php if (!$esJefeCuadrilla): ?>
                                <a href="form.php?id=<?php echo $c['id_cuadrilla']; ?>" class="btn-action" title="Editar">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <button
                                    onclick="confirmDelete(<?php echo $c['id_cuadrilla']; ?>, '<?php echo addslashes($c['nombre_cuadrilla']); ?>', <?php echo $c['total_personal']; ?>)"
                                    class="btn-action btn-danger" title="Eliminar">
                                    <i class="fas fa-trash"></i>
                                </button>
                            <?php endif; ?>
                        </div>
                    </div>
                <?php endforeach; ?>
            <?php endif; ?>
        </div>

        <div id="noResults" style="display:none; padding: 40px; text-align: center; color: #999;">
            No se encontraron cuadrillas con los filtros aplicados.
        </div>
    </div>
</div>

<style>
    /* ============================================
       ESTILOS PREMIUM - CUADRILLAS
       ============================================ */

    /* Métricas Premium con Iconos Circulares */
    .metrics-row {
        display: flex;
        gap: 16px;
        margin-bottom: 24px;
        flex-wrap: wrap;
    }

    .metric-mini {
        background: white;
        border-radius: 16px;
        padding: 16px 20px;
        display: flex;
        align-items: center;
        gap: 14px;
        box-shadow: 0 4px 12px rgba(0, 74, 127, 0.08);
        min-width: 150px;
        transition: all 0.3s ease;
        border: 1px solid rgba(0, 74, 127, 0.04);
    }

    .metric-mini:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 24px rgba(0, 74, 127, 0.12);
    }

    .metric-icon {
        width: 46px;
        height: 46px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
    }

    .metric-icon.primary {
        background: #e6f4fa;
        color: #0073A8;
    }

    .metric-icon.success {
        background: #d1fae5;
        color: #10b981;
    }

    .metric-icon.warning {
        background: #fef3c7;
        color: #f59e0b;
    }

    .metric-icon.danger {
        background: #fee2e2;
        color: #ef4444;
    }

    .metric-content {
        display: flex;
        flex-direction: column;
    }

    .metric-val {
        font-size: 1.6rem;
        font-weight: 700;
        color: #1a1a2e;
        line-height: 1.2;
    }

    .metric-lbl {
        font-size: 0.75rem;
        color: #8a8a9a;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.03em;
    }

    /* Filtros Premium */
    .filter-group {
        display: flex;
        flex-direction: column;
        min-width: 150px;
    }

    .filter-group label {
        font-size: 0.75rem;
        font-weight: 600;
        color: #4a4a5a;
        margin-bottom: 6px;
        text-transform: uppercase;
        letter-spacing: 0.02em;
    }

    .form-control-sm {
        padding: 10px 14px;
        border: 1px solid rgba(0, 74, 127, 0.15);
        border-radius: 12px;
        font-size: 0.9rem;
        background: white;
        transition: all 0.2s ease;
    }

    .form-control-sm:focus {
        outline: none;
        border-color: #0073A8;
        box-shadow: 0 0 0 3px rgba(0, 115, 168, 0.1);
    }

    /* Cards Grid Premium */
    .cuadrillas-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 20px;
    }

    .cuadrilla-card {
        background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
        border-radius: 20px;
        box-shadow: 0 4px 12px rgba(0, 74, 127, 0.08);
        overflow: hidden;
        border-left: 5px solid #10b981;
        transition: all 0.3s ease;
        border: 1px solid rgba(0, 74, 127, 0.04);
    }

    .cuadrilla-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 32px rgba(0, 74, 127, 0.15);
    }

    .cuadrilla-card.mantenimiento {
        border-left-color: #f59e0b;
    }

    .cuadrilla-card.baja {
        border-left-color: #8a8a9a;
        opacity: 0.75;
    }

    /* === MODO OSCURO PARA CARDS (default) === */
    .cuadrilla-card {
        background: linear-gradient(145deg, #1b263b 0%, #0d1b2a 100%) !important;
        border: 1px solid rgba(100, 181, 246, 0.15) !important;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3) !important;
    }

    .cuadrilla-card:hover {
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4) !important;
        border-color: rgba(100, 181, 246, 0.3) !important;
    }

    .card-header {
        background: linear-gradient(135deg, rgba(27, 38, 59, 0.8) 0%, rgba(13, 27, 42, 0.9) 100%) !important;
        border-bottom: 1px solid rgba(100, 181, 246, 0.1) !important;
    }

    .card-title {
        color: #ffffff !important;
    }

    .card-body {
        background: transparent !important;
    }

    .info-row {
        color: rgba(255, 255, 255, 0.7) !important;
        border-bottom-color: rgba(255, 255, 255, 0.08) !important;
    }

    .info-row i {
        color: var(--accent-primary) !important;
    }

    .badge-esp {
        background: rgba(100, 181, 246, 0.15) !important;
        color: #64b5f6 !important;
    }

    .badge-vehiculo {
        background: rgba(156, 39, 176, 0.15) !important;
        color: #ce93d8 !important;
    }

    .card-footer {
        background: rgba(13, 27, 42, 0.5) !important;
        border-top: 1px solid rgba(100, 181, 246, 0.1) !important;
    }

    /* === MODO CLARO === */
    [data-theme="light"] .cuadrilla-card {
        background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%) !important;
        border: 1px solid rgba(0, 74, 127, 0.08) !important;
        box-shadow: 0 4px 12px rgba(0, 74, 127, 0.08) !important;
    }

    [data-theme="light"] .cuadrilla-card:hover {
        box-shadow: 0 12px 32px rgba(0, 74, 127, 0.15) !important;
    }

    [data-theme="light"] .card-header {
        background: linear-gradient(135deg, #f8fafc 0%, #f0f4f8 100%) !important;
        border-bottom: 1px solid #e2e8f0 !important;
    }

    [data-theme="light"] .card-title {
        color: #333 !important;
    }

    [data-theme="light"] .info-row {
        color: #555 !important;
        border-bottom-color: #f0f0f0 !important;
    }

    [data-theme="light"] .info-row i {
        color: #888 !important;
    }

    [data-theme="light"] .badge-esp {
        background: #e3f2fd !important;
        color: #1565c0 !important;
    }

    [data-theme="light"] .badge-vehiculo {
        background: #f3e5f5 !important;
        color: #7b1fa2 !important;
    }

    [data-theme="light"] .card-footer {
        background: #fafafa !important;
        border-top: 1px solid #f0f0f0 !important;
    }

    .card-header {
        padding: 18px 22px;
        background: linear-gradient(135deg, #f8fafc 0%, #f0f4f8 100%);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .card-title {
        font-weight: 600;
        font-size: 1.1em;
        color: #333;
    }

    .card-title i {
        color: #5dade2;
        margin-right: 8px;
    }

    .badge-estado {
        padding: 4px 10px;
        border-radius: 15px;
        font-size: 0.75em;
        font-weight: 500;
    }

    .badge-estado.activa {
        background: #e8f5e9;
        color: #2e7d32;
    }

    .badge-estado.mantenimiento {
        background: #fff3e0;
        color: #ef6c00;
    }

    .badge-estado.baja {
        background: #f5f5f5;
        color: #757575;
    }

    .card-body {
        padding: 15px 20px;
    }

    .info-row {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 0;
        border-bottom: 1px solid #f5f5f5;
        font-size: 0.9em;
        color: #555;
    }

    .info-row:last-child {
        border-bottom: none;
    }

    .info-row i {
        width: 20px;
        color: #888;
    }

    .badge-esp {
        background: #e3f2fd;
        color: #1565c0;
        padding: 3px 10px;
        border-radius: 10px;
        font-size: 0.85em;
    }

    .badge-vehiculo {
        background: #f3e5f5;
        color: #7b1fa2;
        padding: 3px 10px;
        border-radius: 10px;
        font-size: 0.85em;
    }

    .badge-vehiculo small {
        opacity: 0.7;
    }

    .text-muted {
        color: #999;
        font-style: italic;
    }

    .whatsapp-link {
        color: #25d366;
        text-decoration: none;
        font-weight: 500;
    }

    .whatsapp-link:hover {
        text-decoration: underline;
    }

    .card-footer {
        padding: 12px 20px;
        background: #fafafa;
        display: flex;
        justify-content: flex-end;
        gap: 8px;
    }

    .btn-action {
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        padding: 8px 12px;
        color: var(--color-primary);
        cursor: pointer;
        text-decoration: none;
        transition: all 0.2s;
    }

    .btn-action:hover {
        background: var(--color-primary);
        color: white;
        border-color: var(--color-primary);
    }

    .btn-action.btn-danger {
        color: #dc3545;
    }

    .btn-action.btn-danger:hover {
        background: #dc3545;
        color: white;
        border-color: #dc3545;
    }

    /* ==========================================
       RESPONSIVE CUADRILLAS - MÓVIL ULTRA COMPACTO
       ========================================== */
    @media (max-width: 767px) {

        /* Métricas ultra compactas en 4 columnas */
        .metrics-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
            margin-bottom: 15px !important;
        }

        .metric-mini {
            min-width: auto;
            padding: 8px 4px;
            flex-direction: column;
            text-align: center;
            gap: 2px;
            border-radius: 6px;
        }

        .metric-mini i {
            font-size: 0.9em;
        }

        .metric-val {
            font-size: 1em;
        }

        .metric-lbl {
            font-size: 0.6em;
        }

        /* Filtros en fila compacta */
        .filter-bar {
            flex-direction: row !important;
            flex-wrap: wrap !important;
            gap: 8px !important;
            padding: 10px !important;
            margin-bottom: 12px !important;
        }

        .filter-group {
            flex: 1;
            min-width: 45%;
        }

        .filter-group label {
            font-size: 0.7em;
            margin-bottom: 2px;
        }

        .form-control-sm {
            width: 100%;
            padding: 8px;
            font-size: 14px;
        }

        /* Cards de cuadrilla compactas */
        .cuadrillas-grid {
            grid-template-columns: 1fr;
            gap: 10px;
        }

        .cuadrilla-card {
            border-radius: 6px;
        }

        .card-header {
            padding: 10px 12px;
        }

        .card-title {
            font-size: 0.9em;
        }

        .card-body {
            padding: 10px 12px;
        }

        .info-row {
            font-size: 0.8em;
            padding: 5px 0;
        }

        .card-footer {
            padding: 8px 12px;
        }

        .btn-action {
            padding: 8px 10px;
            min-height: 36px;
        }

        /* Header de página compacto */
        .container-fluid>div:first-child {
            flex-direction: row !important;
            justify-content: space-between !important;
            align-items: center !important;
            margin-bottom: 12px !important;
        }

        .container-fluid h2 {
            font-size: 1.1rem;
            margin: 0;
        }

        .container-fluid p {
            font-size: 0.75em;
            margin: 2px 0 0;
        }

        /* Card principal sin padding extra */
        .card {
            padding: 10px !important;
            margin-bottom: 10px !important;
        }
    }
</style>

<script>
    function filterTable() {
        const search = document.getElementById('searchInput').value.toLowerCase();
        const esp = document.getElementById('filterEsp').value;
        const estado = document.getElementById('filterEstado').value;

        const cards = document.querySelectorAll('.cuadrilla-card');
        let visible = 0;

        cards.forEach(card => {
            const matchSearch = card.dataset.nombre.includes(search);
            const matchEsp = !esp || card.dataset.especialidad === esp;
            const matchEstado = !estado || card.dataset.estado === estado;

            const show = matchSearch && matchEsp && matchEstado;
            card.style.display = show ? '' : 'none';
            if (show) visible++;
        });

        document.getElementById('noResults').style.display = visible === 0 ? 'block' : 'none';
    }

    function resetFilters() {
        document.getElementById('searchInput').value = '';
        document.getElementById('filterEsp').value = '';
        document.getElementById('filterEstado').value = '';
        filterTable();
    }

    function confirmDelete(id, nombre, personal) {
        if (personal > 0) {
            alert('No se puede eliminar: la cuadrilla tiene ' + personal + ' integrante(s) asignados.\n\nReasigne el personal primero.');
            return;
        }
        if (confirm('¿Eliminar cuadrilla "' + nombre + '"?\n\nEsta acción no se puede deshacer.')) {
            window.location.href = 'delete.php?id=' + id;
        }
    }
</script>

<?php require_once '../../includes/footer.php'; ?>

================================================================================
 MODULE: CUADRILLAS
 FILE: cuadrillas\save.php
================================================================================
<?php
require_once '../../config/database.php';
require_once '../../includes/auth.php';

// Verificar sesión
verificarSesion();

if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
    header("Location: index.php");
    exit;
}

try {
    $isEdit = !empty($_POST['id_cuadrilla']);

    // Prepare data
    $data = [
        'nombre_cuadrilla' => trim($_POST['nombre_cuadrilla']),
        'tipo_especialidad' => !empty($_POST['tipo_especialidad']) ? $_POST['tipo_especialidad'] : null,
        'estado_operativo' => $_POST['estado_operativo'] ?? 'Activa',
        'id_vehiculo_asignado' => !empty($_POST['id_vehiculo_asignado']) ? intval($_POST['id_vehiculo_asignado']) : null,
        'id_celular_asignado' => !empty($_POST['id_celular_asignado']) ? trim($_POST['id_celular_asignado']) : null,
        'zona_asignada' => !empty($_POST['zona_asignada']) ? trim($_POST['zona_asignada']) : null,
        'url_grupo_whatsapp' => !empty($_POST['url_grupo_whatsapp']) ? trim($_POST['url_grupo_whatsapp']) : null
    ];

    if ($isEdit) {
        // UPDATE
        $sql = "UPDATE cuadrillas SET 
                nombre_cuadrilla = :nombre_cuadrilla,
                tipo_especialidad = :tipo_especialidad,
                estado_operativo = :estado_operativo,
                id_vehiculo_asignado = :id_vehiculo_asignado,
                id_celular_asignado = :id_celular_asignado,
                zona_asignada = :zona_asignada,
                url_grupo_whatsapp = :url_grupo_whatsapp
                WHERE id_cuadrilla = :id_cuadrilla";

        $data['id_cuadrilla'] = $_POST['id_cuadrilla'];

        $stmt = $pdo->prepare($sql);
        $stmt->execute($data);

        // Registrar auditoría - Edición
        registrarAccion('EDITAR', 'cuadrillas', "Cuadrilla editada: " . $data['nombre_cuadrilla'], $_POST['id_cuadrilla']);

    } else {
        // INSERT
        $sql = "INSERT INTO cuadrillas (
                    nombre_cuadrilla, tipo_especialidad, estado_operativo,
                    id_vehiculo_asignado, id_celular_asignado,
                    zona_asignada, url_grupo_whatsapp
                ) VALUES (
                    :nombre_cuadrilla, :tipo_especialidad, :estado_operativo,
                    :id_vehiculo_asignado, :id_celular_asignado,
                    :zona_asignada, :url_grupo_whatsapp
                )";

        $stmt = $pdo->prepare($sql);
        $stmt->execute($data);

        $newId = $pdo->lastInsertId();

        // Registrar auditoría - Creación
        registrarAccion('CREAR', 'cuadrillas', "Cuadrilla creada: " . $data['nombre_cuadrilla'], $newId);
    }

    header("Location: index.php?msg=success");

} catch (PDOException $e) {
    $error = urlencode($e->getMessage());

    $redirect = isset($_POST['id_cuadrilla']) && $_POST['id_cuadrilla']
        ? "form.php?id=" . $_POST['id_cuadrilla']
        : "form.php";

    header("Location: $redirect&msg=error&details=$error");
}
?>

================================================================================
 MODULE: GASTOS
 FILE: gastos\api\delete_gasto.php
================================================================================
<?php
/**
 * API: Eliminar Gasto
 * 
 * Elimina un gasto pendiente y su comprobante asociado.
 * Solo permite eliminar gastos en estado 'Pendiente'.
 * 
 * @method POST
 * @body JSON {id: int}
 * @return JSON {success: bool, error?: string}
 */

require_once '../../../config/database.php';
session_start();

header('Content-Type: application/json');

if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
    echo json_encode(['success' => false, 'error' => 'Método no permitido']);
    exit;
}

try {
    // Leer JSON del body
    $input = json_decode(file_get_contents('php://input'), true);
    $id_gasto = isset($input['id']) ? intval($input['id']) : 0;

    if ($id_gasto <= 0) {
        throw new Exception('ID de gasto inválido');
    }

    // Verificar que el gasto existe y está pendiente
    $stmt = $pdo->prepare("
        SELECT id_gasto, comprobante_path, estado 
        FROM Administracion_Gastos 
        WHERE id_gasto = ?
    ");
    $stmt->execute([$id_gasto]);
    $gasto = $stmt->fetch(PDO::FETCH_ASSOC);

    if (!$gasto) {
        throw new Exception('Gasto no encontrado');
    }

    if ($gasto['estado'] !== 'Pendiente') {
        throw new Exception('Solo se pueden eliminar gastos en estado Pendiente');
    }

    $pdo->beginTransaction();

    // Eliminar registro
    $stmtDel = $pdo->prepare("DELETE FROM Administracion_Gastos WHERE id_gasto = ?");
    $stmtDel->execute([$id_gasto]);

    // Eliminar archivo de comprobante
    if (!empty($gasto['comprobante_path'])) {
        $filePath = __DIR__ . '/../../../uploads/comprobantes/' . $gasto['comprobante_path'];
        if (file_exists($filePath)) {
            unlink($filePath);
        }
    }

    $pdo->commit();

    echo json_encode([
        'success' => true,
        'message' => 'Gasto eliminado correctamente'
    ]);

} catch (Exception $e) {
    if ($pdo->inTransaction()) {
        $pdo->rollBack();
    }

    echo json_encode([
        'success' => false,
        'error' => $e->getMessage()
    ]);
}


================================================================================
 MODULE: GASTOS
 FILE: gastos\api\rendicion.php
================================================================================
<?php
/**
 * API: Rendición de Gastos
 * 
 * Marca un lote de gastos como "Rendidos" y genera un resumen.
 * Crea un registro de rendición para tracking.
 * 
 * @method POST
 * @body JSON {ids: int[]}
 * @return JSON {success: bool, id_rendicion?: int, pdf_url?: string, error?: string}
 */

require_once '../../../config/database.php';
session_start();

header('Content-Type: application/json');

if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
    echo json_encode(['success' => false, 'error' => 'Método no permitido']);
    exit;
}

try {
    // Leer JSON del body
    $input = json_decode(file_get_contents('php://input'), true);
    $ids = isset($input['ids']) && is_array($input['ids']) ? $input['ids'] : [];

    if (empty($ids)) {
        throw new Exception('Debe seleccionar al menos un gasto para rendir');
    }

    // Sanitizar IDs
    $ids = array_map('intval', $ids);
    $ids = array_filter($ids, function ($id) {
        return $id > 0; });

    if (empty($ids)) {
        throw new Exception('IDs inválidos');
    }

    $placeholders = implode(',', array_fill(0, count($ids), '?'));

    // Verificar que todos los gastos existen y están pendientes
    $stmt = $pdo->prepare("
        SELECT id_gasto, monto, estado 
        FROM Administracion_Gastos 
        WHERE id_gasto IN ($placeholders)
    ");
    $stmt->execute($ids);
    $gastos = $stmt->fetchAll(PDO::FETCH_ASSOC);

    if (count($gastos) !== count($ids)) {
        throw new Exception('Algunos gastos no fueron encontrados');
    }

    $montoTotal = 0;
    foreach ($gastos as $g) {
        if ($g['estado'] !== 'Pendiente') {
            throw new Exception('Solo se pueden rendir gastos en estado Pendiente');
        }
        $montoTotal += floatval($g['monto']);
    }

    $pdo->beginTransaction();

    // 1. Crear registro de rendición
    $stmtRend = $pdo->prepare("
        INSERT INTO Administracion_Rendiciones 
        (monto_total, cantidad_comprobantes, usuario_rendicion, estado)
        VALUES (?, ?, ?, 'Pendiente_Reposicion')
    ");

    $usuario_id = $_SESSION['usuario_id'] ?? null;
    $stmtRend->execute([$montoTotal, count($ids), $usuario_id]);
    $id_rendicion = $pdo->lastInsertId();

    // 2. Actualizar gastos como rendidos
    $stmtUpdate = $pdo->prepare("
        UPDATE Administracion_Gastos 
        SET estado = 'Rendido', id_rendicion = ?
        WHERE id_gasto IN ($placeholders)
    ");
    $stmtUpdate->execute(array_merge([$id_rendicion], $ids));

    $pdo->commit();

    // Generar resumen (simplificado - en producción se generaría PDF)
    $resumen = [
        'id_rendicion' => $id_rendicion,
        'fecha' => date('Y-m-d H:i:s'),
        'cantidad' => count($ids),
        'monto_total' => $montoTotal
    ];

    echo json_encode([
        'success' => true,
        'message' => 'Rendición realizada correctamente',
        'id_rendicion' => $id_rendicion,
        'resumen' => $resumen,
        // En producción: 'pdf_url' => 'api/generate_pdf.php?id=' . $id_rendicion
    ]);

} catch (Exception $e) {
    if ($pdo->inTransaction()) {
        $pdo->rollBack();
    }

    echo json_encode([
        'success' => false,
        'error' => $e->getMessage()
    ]);
}


================================================================================
 MODULE: GASTOS
 FILE: gastos\api\save_gasto.php
================================================================================
<?php
/**
 * API: Guardar Gasto
 * 
 * Recibe datos del formulario de gasto y los guarda en la base de datos.
 * Incluye:
 * - Validación de saldo disponible
 * - Detección de duplicados
 * - Subida de comprobante (imagen)
 * 
 * @method POST
 * @return JSON {success: bool, error?: string, id_gasto?: int}
 */

require_once '../../../config/database.php';
session_start();

header('Content-Type: application/json');

if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
    echo json_encode(['success' => false, 'error' => 'Método no permitido']);
    exit;
}

try {
    // ========================================================================
    // RECOGER DATOS
    // ========================================================================

    $monto = isset($_POST['monto']) ? floatval($_POST['monto']) : 0;
    $tipo_gasto = $_POST['tipo_gasto'] ?? '';
    $id_responsable = isset($_POST['id_responsable']) ? intval($_POST['id_responsable']) : 0;
    $fecha_gasto = $_POST['fecha_gasto'] ?? date('Y-m-d');
    $descripcion = $_POST['descripcion'] ?? '';

    // ========================================================================
    // VALIDACIONES BÁSICAS
    // ========================================================================

    if ($monto <= 0) {
        throw new Exception('El monto debe ser mayor a cero');
    }

    $tiposValidos = ['Ferreteria', 'Comida', 'Peajes', 'Combustible_Emergencia', 'Insumos_Oficina', 'Otros'];
    if (!in_array($tipo_gasto, $tiposValidos)) {
        throw new Exception('Tipo de gasto inválido');
    }

    if ($id_responsable <= 0) {
        throw new Exception('Debe seleccionar un responsable');
    }

    // Validar fecha
    $fechaObj = DateTime::createFromFormat('Y-m-d', $fecha_gasto);
    if (!$fechaObj) {
        throw new Exception('Fecha inválida');
    }

    // ========================================================================
    // VALIDAR SALDO DISPONIBLE
    // ========================================================================

    // Obtener fondo fijo
    $stmtFondo = $pdo->query("SELECT monto_fondo FROM Administracion_Fondo_Fijo LIMIT 1");
    $montoFondo = floatval($stmtFondo->fetchColumn() ?: 100000);

    // Calcular gastos pendientes
    $stmtPendientes = $pdo->query("
        SELECT COALESCE(SUM(monto), 0) as total 
        FROM Administracion_Gastos 
        WHERE estado = 'Pendiente'
    ");
    $gastosPendientes = floatval($stmtPendientes->fetchColumn());

    $saldoDisponible = $montoFondo - $gastosPendientes;

    if ($monto > $saldoDisponible) {
        throw new Exception(
            "El monto ($" . number_format($monto, 2) . ") supera el saldo disponible " .
            "($" . number_format($saldoDisponible, 2) . "). " .
            "Se requiere realizar una rendición para reponer el fondo."
        );
    }

    // ========================================================================
    // DETECTAR DUPLICADOS
    // ========================================================================

    // Buscar gastos similares en los últimos 3 días
    $stmtDup = $pdo->prepare("
        SELECT id_gasto, fecha_gasto 
        FROM Administracion_Gastos 
        WHERE monto = ? 
          AND tipo_gasto = ? 
          AND fecha_gasto BETWEEN DATE_SUB(?, INTERVAL 3 DAY) AND DATE_ADD(?, INTERVAL 1 DAY)
        LIMIT 1
    ");
    $stmtDup->execute([$monto, $tipo_gasto, $fecha_gasto, $fecha_gasto]);
    $duplicado = $stmtDup->fetch(PDO::FETCH_ASSOC);

    if ($duplicado) {
        throw new Exception(
            "Posible duplicado detectado: Ya existe un gasto de $" .
            number_format($monto, 2) . " del tipo '" . $tipo_gasto .
            "' con fecha " . date('d/m/Y', strtotime($duplicado['fecha_gasto'])) .
            ". Si es un gasto diferente, modifique el monto ligeramente o use otra categoría."
        );
    }

    // ========================================================================
    // PROCESAR COMPROBANTE (IMAGEN)
    // ========================================================================

    $comprobante_path = '';

    if (!isset($_FILES['comprobante']) || $_FILES['comprobante']['error'] !== UPLOAD_ERR_OK) {
        throw new Exception('Debe adjuntar una imagen del comprobante');
    }

    $file = $_FILES['comprobante'];

    // Validar tipo de archivo
    $allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
    $finfo = new finfo(FILEINFO_MIME_TYPE);
    $mimeType = $finfo->file($file['tmp_name']);

    if (!in_array($mimeType, $allowedTypes)) {
        throw new Exception('El archivo debe ser una imagen (JPG, PNG, GIF o WebP)');
    }

    // Validar tamaño (max 10MB)
    if ($file['size'] > 10 * 1024 * 1024) {
        throw new Exception('El archivo es demasiado grande (máximo 10MB)');
    }

    // Generar nombre único
    $extension = pathinfo($file['name'], PATHINFO_EXTENSION);
    if (empty($extension)) {
        $extension = 'jpg';
    }
    $filename = 'gasto_' . date('Ymd_His') . '_' . uniqid() . '.' . $extension;

    // Ruta de destino
    $uploadDir = __DIR__ . '/../../../uploads/comprobantes/';
    if (!is_dir($uploadDir)) {
        mkdir($uploadDir, 0755, true);
    }

    $destPath = $uploadDir . $filename;

    if (!move_uploaded_file($file['tmp_name'], $destPath)) {
        throw new Exception('Error al guardar el comprobante');
    }

    $comprobante_path = $filename;

    // ========================================================================
    // GUARDAR EN BASE DE DATOS
    // ========================================================================

    $pdo->beginTransaction();

    $stmt = $pdo->prepare("
        INSERT INTO Administracion_Gastos 
        (monto, tipo_gasto, id_responsable, comprobante_path, fecha_gasto, descripcion, estado, usuario_creacion)
        VALUES (?, ?, ?, ?, ?, ?, 'Pendiente', ?)
    ");

    $usuario_id = $_SESSION['usuario_id'] ?? null;

    $stmt->execute([
        $monto,
        $tipo_gasto,
        $id_responsable,
        $comprobante_path,
        $fecha_gasto,
        $descripcion,
        $usuario_id
    ]);

    $id_gasto = $pdo->lastInsertId();

    $pdo->commit();

    echo json_encode([
        'success' => true,
        'message' => 'Gasto registrado correctamente',
        'id_gasto' => $id_gasto,
        'nuevo_saldo' => $saldoDisponible - $monto
    ]);

} catch (Exception $e) {
    if ($pdo->inTransaction()) {
        $pdo->rollBack();
    }

    // Eliminar archivo si se subió pero falló el guardado en BD
    if (!empty($comprobante_path) && isset($destPath) && file_exists($destPath)) {
        unlink($destPath);
    }

    echo json_encode([
        'success' => false,
        'error' => $e->getMessage()
    ]);
}


================================================================================
 MODULE: GASTOS
 FILE: gastos\detalle.php
================================================================================
<?php
/**
 * Vista: Detalle de Gasto
 * 
 * Muestra información completa de un gasto individual.
 * Usa las variables de tema globales de la aplicación.
 */

require_once '../../config/database.php';
require_once '../../includes/header.php';

$id_gasto = isset($_GET['id']) ? intval($_GET['id']) : 0;

if (!$id_gasto) {
    header('Location: index.php');
    exit;
}

// Obtener datos del gasto
$stmt = $pdo->prepare("
    SELECT g.*, 
           p.nombre_apellido as responsable_nombre,
           r.fecha_rendicion
    FROM Administracion_Gastos g
    LEFT JOIN personal p ON g.id_responsable = p.id_personal
    LEFT JOIN Administracion_Rendiciones r ON g.id_rendicion = r.id_rendicion
    WHERE g.id_gasto = ?
");
$stmt->execute([$id_gasto]);
$gasto = $stmt->fetch(PDO::FETCH_ASSOC);

if (!$gasto) {
    header('Location: index.php');
    exit;
}

$tiposGasto = [
    'Ferreteria' => '🔧 Ferretería',
    'Comida' => '🍔 Comida',
    'Peajes' => '🛣️ Peajes',
    'Combustible_Emergencia' => '⛽ Combustible Emergencia',
    'Insumos_Oficina' => '📎 Insumos Oficina',
    'Otros' => '📦 Otros'
];
?>

<style>
    /* Detalle Gasto - Usa variables de tema global */
    .detalle-container {
        max-width: 800px;
        margin: 0 auto;
        padding: var(--spacing-lg);
    }

    .back-link {
        display: inline-flex;
        align-items: center;
        gap: var(--spacing-sm);
        color: var(--accent-primary);
        text-decoration: none;
        margin-bottom: var(--spacing-lg);
        font-weight: 500;
        transition: all 0.2s;
    }

    .back-link:hover {
        color: var(--text-primary);
    }

    .detail-card {
        background: var(--bg-card);
        border-radius: var(--border-radius-md);
        border: 1px solid rgba(100, 181, 246, 0.15);
        overflow: hidden;
    }

    .detail-header {
        background: linear-gradient(135deg, #004A7F 0%, #0073A8 100%);
        color: white;
        padding: var(--spacing-lg);
        text-align: center;
    }

    .detail-header h1 {
        font-size: 1.5rem;
        margin-bottom: var(--spacing-sm);
        color: white;
    }

    .amount {
        font-size: 3rem;
        font-weight: 700;
    }

    .detail-body {
        padding: var(--spacing-lg);
    }

    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: var(--spacing-md);
        margin-bottom: var(--spacing-lg);
    }

    .info-item {
        padding: var(--spacing-md);
        background: var(--bg-tertiary);
        border-radius: var(--border-radius-md);
        border: 1px solid rgba(100, 181, 246, 0.1);
    }

    [data-theme="light"] .info-item {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
    }

    .info-label {
        font-size: 0.8rem;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 4px;
    }

    .info-value {
        font-size: 1.1rem;
        font-weight: 500;
        color: var(--text-primary);
    }

    .status-badge {
        display: inline-block;
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
    }

    .status-Pendiente {
        background: rgba(245, 158, 11, 0.15);
        color: #f59e0b;
    }

    .status-Rendido {
        background: rgba(16, 185, 129, 0.15);
        color: #10b981;
    }

    .status-Rechazado {
        background: rgba(239, 68, 68, 0.15);
        color: #ef4444;
    }

    .type-badge {
        display: inline-block;
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 500;
    }

    .type-Ferreteria {
        background: rgba(0, 188, 212, 0.15);
        color: #00bcd4;
    }

    .type-Comida {
        background: rgba(255, 152, 0, 0.15);
        color: #ff9800;
    }

    .type-Peajes {
        background: rgba(156, 39, 176, 0.15);
        color: #9c27b0;
    }

    .type-Combustible_Emergencia {
        background: rgba(244, 67, 54, 0.15);
        color: #f44336;
    }

    .type-Insumos_Oficina {
        background: rgba(76, 175, 80, 0.15);
        color: #4caf50;
    }

    .type-Otros {
        background: rgba(158, 158, 158, 0.15);
        color: #9e9e9e;
    }

    .comprobante-section {
        text-align: center;
        margin-top: var(--spacing-lg);
        padding-top: var(--spacing-lg);
        border-top: 1px solid rgba(100, 181, 246, 0.1);
    }

    [data-theme="light"] .comprobante-section {
        border-top-color: #e2e8f0;
    }

    .comprobante-section h3 {
        margin-bottom: var(--spacing-md);
        color: var(--text-primary);
    }

    .comprobante-img {
        max-width: 100%;
        max-height: 500px;
        border-radius: var(--border-radius-md);
        border: 1px solid rgba(100, 181, 246, 0.2);
    }

    .description-section {
        margin-top: var(--spacing-lg);
        padding: var(--spacing-md);
        background: var(--bg-tertiary);
        border-radius: var(--border-radius-md);
        border-left: 4px solid var(--accent-primary);
    }

    [data-theme="light"] .description-section {
        background: #f8fafc;
    }

    .description-section h4 {
        font-size: 0.9rem;
        color: var(--text-secondary);
        margin-bottom: var(--spacing-sm);
    }

    .description-section p {
        color: var(--text-primary);
    }

    .actions {
        display: flex;
        gap: var(--spacing-md);
        margin-top: var(--spacing-lg);
        padding-top: var(--spacing-lg);
        border-top: 1px solid rgba(100, 181, 246, 0.1);
    }

    [data-theme="light"] .actions {
        border-top-color: #e2e8f0;
    }

    .btn {
        display: inline-flex;
        align-items: center;
        gap: var(--spacing-sm);
        padding: 12px var(--spacing-lg);
        font-size: 1rem;
        font-weight: 500;
        border: none;
        border-radius: var(--border-radius-sm);
        cursor: pointer;
        text-decoration: none;
        transition: all 0.2s;
    }

    .btn-primary {
        background: linear-gradient(145deg, var(--accent-primary) 0%, #1d4ed8 100%);
        color: white;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
    }

    .btn-danger {
        background: linear-gradient(145deg, #ef4444 0%, #dc2626 100%);
        color: white;
    }

    .btn-outline {
        background: transparent;
        border: 1px solid var(--accent-primary);
        color: var(--accent-primary);
    }

    .btn-outline:hover {
        background: rgba(100, 181, 246, 0.1);
    }

    @media print {
        .no-print {
            display: none !important;
        }

        .detail-card {
            box-shadow: none;
            border: none;
        }
    }
</style>

<div class="detalle-container">
    <a href="index.php" class="back-link no-print">
        <i class="fas fa-arrow-left"></i> Volver a la lista
    </a>

    <div class="detail-card">
        <div class="detail-header">
            <h1>Gasto #<?php echo str_pad($id_gasto, 5, '0', STR_PAD_LEFT); ?></h1>
            <div class="amount">$<?php echo number_format($gasto['monto'], 2, ',', '.'); ?></div>
        </div>

        <div class="detail-body">
            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">Fecha del Gasto</div>
                    <div class="info-value">
                        <?php echo date('d/m/Y', strtotime($gasto['fecha_gasto'])); ?>
                    </div>
                </div>

                <div class="info-item">
                    <div class="info-label">Tipo de Gasto</div>
                    <div class="info-value">
                        <span class="type-badge type-<?php echo $gasto['tipo_gasto']; ?>">
                            <?php echo $tiposGasto[$gasto['tipo_gasto']] ?? $gasto['tipo_gasto']; ?>
                        </span>
                    </div>
                </div>

                <div class="info-item">
                    <div class="info-label">Responsable</div>
                    <div class="info-value">
                        <?php echo htmlspecialchars($gasto['responsable_nombre'] ?? 'N/A'); ?>
                    </div>
                </div>

                <div class="info-item">
                    <div class="info-label">Estado</div>
                    <div class="info-value">
                        <span class="status-badge status-<?php echo $gasto['estado']; ?>">
                            <?php echo $gasto['estado']; ?>
                        </span>
                    </div>
                </div>

                <div class="info-item">
                    <div class="info-label">Fecha de Registro</div>
                    <div class="info-value">
                        <?php echo date('d/m/Y H:i', strtotime($gasto['fecha_creacion'])); ?>
                    </div>
                </div>

                <?php if ($gasto['fecha_rendicion']): ?>
                    <div class="info-item">
                        <div class="info-label">Fecha de Rendición</div>
                        <div class="info-value">
                            <?php echo date('d/m/Y H:i', strtotime($gasto['fecha_rendicion'])); ?>
                        </div>
                    </div>
                <?php endif; ?>
            </div>

            <?php if (!empty($gasto['descripcion'])): ?>
                <div class="description-section">
                    <h4>Descripción</h4>
                    <p><?php echo nl2br(htmlspecialchars($gasto['descripcion'])); ?></p>
                </div>
            <?php endif; ?>

            <?php if (!empty($gasto['comprobante_path'])): ?>
                <div class="comprobante-section">
                    <h3><i class="fas fa-receipt"></i> Comprobante</h3>
                    <img src="/APP-Prueba/uploads/comprobantes/<?php echo $gasto['comprobante_path']; ?>" alt="Comprobante"
                        class="comprobante-img">
                </div>
            <?php endif; ?>

            <div class="actions no-print">
                <button class="btn btn-outline" onclick="window.print()">
                    <i class="fas fa-print"></i> Imprimir
                </button>

                <?php if ($gasto['estado'] === 'Pendiente'): ?>
                    <button class="btn btn-danger" onclick="deleteGasto(<?php echo $id_gasto; ?>)">
                        <i class="fas fa-trash"></i> Eliminar
                    </button>
                <?php endif; ?>
            </div>
        </div>
    </div>
</div>

<script>
    async function deleteGasto(id) {
        if (!confirm('¿Está seguro de eliminar este gasto?')) return;

        try {
            const response = await fetch('api/delete_gasto.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: id })
            });

            const data = await response.json();

            if (data.success) {
                showToast('Gasto eliminado', 'success');
                window.location.href = 'index.php';
            } else {
                showToast('Error: ' + data.error, 'error');
            }
        } catch (error) {
            showToast('Error de conexión', 'error');
        }
    }
</script>

<?php require_once '../../includes/footer.php'; ?>

================================================================================
 MODULE: GASTOS
 FILE: gastos\index.php
================================================================================
<?php
/**
 * Módulo: Administración de Gastos - Fondos Fijos y Gastos Menores
 * 
 * CRUD completo para gestión de caja chica y gastos menores.
 * Usa las variables de tema globales de la aplicación.
 * 
 * @author Sistema ERP - Recursos Globales
 * @version 2.0
 */

require_once '../../config/database.php';
require_once '../../includes/header.php';

// ============================================================================
// CONSULTAS DE DATOS
// ============================================================================

// 1. Obtener configuración del fondo fijo
$stmtFondo = $pdo->query("SELECT monto_fondo FROM Administracion_Fondo_Fijo LIMIT 1");
$fondo = $stmtFondo->fetch(PDO::FETCH_ASSOC);
$montoFondo = $fondo ? floatval($fondo['monto_fondo']) : 100000.00;

// 2. Calcular gastos no rendidos (pendientes)
$stmtGastosPendientes = $pdo->query("
    SELECT COALESCE(SUM(monto), 0) as total 
    FROM Administracion_Gastos 
    WHERE estado = 'Pendiente'
");
$gastosPendientes = floatval($stmtGastosPendientes->fetch(PDO::FETCH_ASSOC)['total']);

// 3. Calcular saldo disponible
$saldoDisponible = $montoFondo - $gastosPendientes;

// 4. Obtener lista de personal para dropdown
$stmtPersonal = $pdo->query("SELECT id_personal, nombre_apellido FROM personal ORDER BY nombre_apellido");
$personal = $stmtPersonal->fetchAll(PDO::FETCH_ASSOC);

// 5. Obtener últimos gastos (con datos del responsable)
$stmtGastos = $pdo->query("
    SELECT g.*, p.nombre_apellido as responsable_nombre
    FROM Administracion_Gastos g
    LEFT JOIN personal p ON g.id_responsable = p.id_personal
    ORDER BY g.fecha_gasto DESC, g.id_gasto DESC
    LIMIT 100
");
$gastos = $stmtGastos->fetchAll(PDO::FETCH_ASSOC);

// 6. Tipos de gasto para filtro
$tiposGasto = [
    'Ferreteria' => '🔧 Ferretería',
    'Comida' => '🍔 Comida',
    'Peajes' => '🛣️ Peajes',
    'Combustible_Emergencia' => '⛽ Combustible Emergencia',
    'Insumos_Oficina' => '📎 Insumos Oficina',
    'Otros' => '📦 Otros'
];
?>

<style>
    /* ========================================
       MÓDULO GASTOS - Estilos específicos
       Usa variables globales del tema
       ======================================== */

    .gastos-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: var(--spacing-md);
    }

    /* Header del módulo */
    .module-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-lg);
        padding: var(--spacing-lg);
        background: var(--bg-card);
        border-radius: var(--border-radius-md);
        border: 1px solid rgba(100, 181, 246, 0.15);
    }

    .module-header-left {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
    }

    .module-title {
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--text-primary);
    }

    .module-subtitle {
        font-size: 0.9rem;
        color: var(--text-secondary);
    }

    /* Panel de Saldo */
    .balance-panel {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: var(--spacing-md);
        margin-bottom: var(--spacing-lg);
    }

    .balance-card {
        padding: var(--spacing-lg);
        border-radius: var(--border-radius-md);
        text-align: center;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .balance-card.fondo {
        background: linear-gradient(135deg, #004A7F 0%, #0073A8 100%);
        color: white;
    }

    .balance-card.gastado {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        color: white;
    }

    .balance-card.disponible {
        background: linear-gradient(135deg, #28A745 0%, #20c997 100%);
        color: white;
    }

    .balance-card.warning {
        background: linear-gradient(135deg, #FFC107 0%, #e0a800 100%);
        color: #333;
    }

    .balance-label {
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        opacity: 0.9;
        margin-bottom: var(--spacing-xs);
    }

    .balance-amount {
        font-size: 2rem;
        font-weight: 700;
    }

    .balance-icon {
        font-size: 1.5rem;
        margin-bottom: var(--spacing-sm);
    }

    /* Layout principal */
    .main-layout {
        display: grid;
        grid-template-columns: 400px 1fr;
        gap: var(--spacing-lg);
    }

    @media (max-width: 1024px) {
        .main-layout {
            grid-template-columns: 1fr;
        }
    }

    /* Formulario de gasto - Usa variables de tema */
    .form-card {
        background: var(--bg-card);
        padding: var(--spacing-lg);
        border-radius: var(--border-radius-md);
        border: 1px solid rgba(100, 181, 246, 0.15);
        position: sticky;
        top: 80px;
    }

    .form-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--accent-primary);
        margin-bottom: var(--spacing-lg);
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
    }

    .form-group {
        margin-bottom: var(--spacing-md);
    }

    .form-group label {
        display: block;
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--text-secondary);
        margin-bottom: var(--spacing-xs);
    }

    .form-control {
        width: 100%;
        padding: 12px var(--spacing-md);
        background: var(--bg-tertiary);
        border: 1px solid rgba(100, 181, 246, 0.2);
        border-radius: var(--border-radius-sm);
        font-size: 1rem;
        font-family: inherit;
        color: var(--text-primary);
        transition: border-color 0.2s, box-shadow 0.2s;
    }

    .form-control:focus {
        outline: none;
        border-color: var(--accent-primary);
        box-shadow: 0 0 0 3px rgba(100, 181, 246, 0.15);
    }

    .form-control[type="number"] {
        font-size: 1.5rem;
        font-weight: 600;
        text-align: center;
    }

    /* Modo Claro - Formulario */
    [data-theme="light"] .form-control {
        background: #ffffff;
        border: 1px solid #d1d5db;
        color: var(--text-primary);
    }

    [data-theme="light"] .form-control:focus {
        border-color: var(--accent-primary);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
    }

    /* File upload area */
    .file-upload-area {
        border: 2px dashed rgba(100, 181, 246, 0.3);
        border-radius: var(--border-radius-md);
        padding: var(--spacing-lg);
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
        position: relative;
        background: var(--bg-tertiary);
    }

    .file-upload-area:hover {
        border-color: var(--accent-primary);
        background: rgba(100, 181, 246, 0.05);
    }

    .file-upload-area.dragover {
        border-color: var(--accent-primary);
        background: rgba(100, 181, 246, 0.1);
    }

    .file-upload-area input[type="file"] {
        position: absolute;
        inset: 0;
        opacity: 0;
        cursor: pointer;
    }

    .file-upload-icon {
        font-size: 2.5rem;
        color: var(--accent-primary);
        margin-bottom: var(--spacing-sm);
    }

    .file-upload-text {
        color: var(--text-secondary);
        font-size: 0.9rem;
    }

    .file-upload-text strong {
        color: var(--accent-primary);
    }

    .file-preview {
        max-width: 100%;
        max-height: 150px;
        border-radius: var(--border-radius-sm);
        margin-top: var(--spacing-sm);
        display: none;
    }

    /* Modo Claro - File Upload */
    [data-theme="light"] .file-upload-area {
        border-color: #d1d5db;
        background: #f8fafc;
    }

    [data-theme="light"] .file-upload-area:hover {
        border-color: var(--accent-primary);
        background: rgba(37, 99, 235, 0.05);
    }

    /* Botones */
    .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: var(--spacing-sm);
        padding: 12px var(--spacing-lg);
        font-size: 1rem;
        font-weight: 500;
        font-family: inherit;
        border: none;
        border-radius: var(--border-radius-sm);
        cursor: pointer;
        transition: all 0.2s;
        text-decoration: none;
    }

    .btn-primary {
        background: linear-gradient(145deg, var(--accent-primary) 0%, #1d4ed8 100%);
        color: white;
        border: 1px solid rgba(100, 181, 246, 0.3);
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(100, 181, 246, 0.3);
    }

    .btn-success {
        background: linear-gradient(145deg, #10b981 0%, #059669 100%);
        color: white;
    }

    .btn-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    .btn-outline {
        background: transparent;
        border: 1px solid var(--accent-primary);
        color: var(--accent-primary);
    }

    .btn-outline:hover {
        background: rgba(100, 181, 246, 0.1);
    }

    .btn-block {
        width: 100%;
    }

    .btn-lg {
        padding: 16px var(--spacing-xl);
        font-size: 1.1rem;
    }

    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    /* Tabla de gastos - Usa estilos globales de tabla */
    .table-card {
        background: var(--bg-card);
        border-radius: var(--border-radius-md);
        border: 1px solid rgba(100, 181, 246, 0.15);
        overflow: hidden;
    }

    .table-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--spacing-lg);
        border-bottom: 1px solid rgba(100, 181, 246, 0.1);
        flex-wrap: wrap;
        gap: var(--spacing-md);
    }

    .table-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--accent-primary);
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
    }

    .filters {
        display: flex;
        gap: var(--spacing-sm);
        flex-wrap: wrap;
    }

    .filter-select {
        padding: 8px 12px;
        background: var(--bg-tertiary);
        border: 1px solid rgba(100, 181, 246, 0.2);
        border-radius: var(--border-radius-sm);
        font-size: 0.9rem;
        color: var(--text-primary);
    }

    [data-theme="light"] .filter-select {
        background: #ffffff;
        border-color: #d1d5db;
    }

    .table-container {
        overflow-x: auto;
        /* Scrollbar personalizado estilo app */
        scrollbar-width: thin;
        scrollbar-color: rgba(100, 181, 246, 0.3) transparent;
    }

    .table-container::-webkit-scrollbar {
        height: 6px;
    }

    .table-container::-webkit-scrollbar-track {
        background: transparent;
        border-radius: 3px;
    }

    .table-container::-webkit-scrollbar-thumb {
        background: rgba(100, 181, 246, 0.3);
        border-radius: 3px;
    }

    .table-container::-webkit-scrollbar-thumb:hover {
        background: rgba(100, 181, 246, 0.5);
    }

    [data-theme="light"] .table-container {
        scrollbar-color: rgba(37, 99, 235, 0.3) transparent;
    }

    [data-theme="light"] .table-container::-webkit-scrollbar-thumb {
        background: rgba(37, 99, 235, 0.3);
    }

    [data-theme="light"] .table-container::-webkit-scrollbar-thumb:hover {
        background: rgba(37, 99, 235, 0.5);
    }

    /* Usa estilos globales de tabla del CSS principal */
    .data-table {
        width: 100%;
        border-collapse: collapse;
    }

    .amount-cell {
        font-weight: 600;
        font-size: 1.1rem;
        color: var(--color-danger) !important;
    }

    .type-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 500;
    }

    .type-Ferreteria {
        background: rgba(0, 188, 212, 0.15);
        color: #00bcd4;
    }

    .type-Comida {
        background: rgba(255, 152, 0, 0.15);
        color: #ff9800;
    }

    .type-Peajes {
        background: rgba(156, 39, 176, 0.15);
        color: #9c27b0;
    }

    .type-Combustible_Emergencia {
        background: rgba(244, 67, 54, 0.15);
        color: #f44336;
    }

    .type-Insumos_Oficina {
        background: rgba(76, 175, 80, 0.15);
        color: #4caf50;
    }

    .type-Otros {
        background: rgba(158, 158, 158, 0.15);
        color: #9e9e9e;
    }

    .status-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .status-Pendiente {
        background: rgba(245, 158, 11, 0.15);
        color: #f59e0b;
    }

    .status-Rendido {
        background: rgba(16, 185, 129, 0.15);
        color: #10b981;
    }

    .status-Rechazado {
        background: rgba(239, 68, 68, 0.15);
        color: #ef4444;
    }

    .thumb-img {
        width: 50px;
        height: 50px;
        object-fit: cover;
        border-radius: var(--border-radius-sm);
        cursor: pointer;
        transition: transform 0.2s;
        border: 1px solid rgba(100, 181, 246, 0.2);
    }

    .thumb-img:hover {
        transform: scale(1.1);
    }

    .checkbox-cell {
        width: 40px;
        text-align: center;
    }

    .checkbox-cell input {
        width: 18px;
        height: 18px;
        cursor: pointer;
        accent-color: var(--accent-primary);
    }

    .actions-cell {
        display: flex;
        gap: var(--spacing-xs);
    }

    .btn-icon {
        width: 32px;
        height: 32px;
        border: none;
        border-radius: var(--border-radius-sm);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        background: rgba(100, 181, 246, 0.1);
        color: var(--accent-primary);
    }

    .btn-icon.view {
        background: rgba(59, 130, 246, 0.15);
        color: #3b82f6;
    }

    .btn-icon.delete {
        background: rgba(239, 68, 68, 0.15);
        color: #ef4444;
    }

    .btn-icon:hover {
        transform: scale(1.1);
    }

    /* Panel de rendición */
    .rendicion-panel {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--spacing-md) var(--spacing-lg);
        background: var(--bg-tertiary);
        border-top: 1px solid rgba(100, 181, 246, 0.1);
    }

    [data-theme="light"] .rendicion-panel {
        background: #f8fafc;
    }

    .selected-count {
        font-weight: 500;
        color: var(--text-secondary);
    }

    .selected-count strong {
        color: var(--accent-primary);
    }

    /* Modal de imagen */
    .modal-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.85);
        z-index: 2000;
        justify-content: center;
        align-items: center;
    }

    .modal-overlay.active {
        display: flex;
    }

    .modal-content {
        max-width: 90%;
        max-height: 90%;
    }

    .modal-content img {
        max-width: 100%;
        max-height: 85vh;
        border-radius: var(--border-radius-md);
    }

    .modal-close {
        position: absolute;
        top: 20px;
        right: 20px;
        background: white;
        border: none;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        font-size: 1.5rem;
        cursor: pointer;
        z-index: 2001;
    }

    /* Alertas */
    .alert {
        padding: var(--spacing-md);
        border-radius: var(--border-radius-sm);
        margin-bottom: var(--spacing-md);
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
    }

    .alert-warning {
        background: rgba(245, 158, 11, 0.15);
        color: #f59e0b;
        border: 1px solid rgba(245, 158, 11, 0.3);
    }

    /* Empty state */
    .empty-state {
        text-align: center;
        padding: var(--spacing-xl);
        color: var(--text-muted);
    }

    .empty-state i {
        font-size: 3rem;
        margin-bottom: var(--spacing-md);
        opacity: 0.5;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .module-header {
            flex-direction: column;
            text-align: center;
            gap: var(--spacing-md);
        }

        .balance-panel {
            grid-template-columns: 1fr 1fr;
        }

        .form-card {
            position: static;
        }

        .table-header {
            flex-direction: column;
            align-items: stretch;
        }

        .filters {
            width: 100%;
        }

        .filter-select {
            flex: 1;
        }
    }
</style>

<div class="gastos-container">
    <!-- Header del módulo -->
    <div class="module-header">
        <div class="module-header-left">
            <div>
                <h1 class="module-title">Administración de Gastos</h1>
                <p class="module-subtitle">Fondos Fijos y Gastos Menores</p>
            </div>
        </div>
        <div>
            <button class="btn btn-success" onclick="openRendicionModal()">
                <i class="fas fa-file-invoice-dollar"></i> Realizar Rendición
            </button>
        </div>
    </div>

    <!-- Panel de Saldo -->
    <div class="balance-panel">
        <div class="balance-card fondo">
            <div class="balance-icon"><i class="fas fa-piggy-bank"></i></div>
            <div class="balance-label">Fondo Fijo Total</div>
            <div class="balance-amount">$<?php echo number_format($montoFondo, 2, ',', '.'); ?></div>
        </div>

        <div class="balance-card gastado">
            <div class="balance-icon"><i class="fas fa-receipt"></i></div>
            <div class="balance-label">Gastos Pendientes</div>
            <div class="balance-amount">$<?php echo number_format($gastosPendientes, 2, ',', '.'); ?></div>
        </div>

        <div class="balance-card <?php echo $saldoDisponible < ($montoFondo * 0.2) ? 'warning' : 'disponible'; ?>">
            <div class="balance-icon"><i class="fas fa-wallet"></i></div>
            <div class="balance-label">Saldo Disponible</div>
            <div class="balance-amount">$<?php echo number_format($saldoDisponible, 2, ',', '.'); ?></div>
        </div>
    </div>

    <?php if ($saldoDisponible < ($montoFondo * 0.2)): ?>
        <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i>
            <span><strong>Atención:</strong> El saldo disponible es menor al 20% del fondo. Se recomienda realizar una
                rendición para solicitar reposición.</span>
        </div>
    <?php endif; ?>

    <!-- Layout Principal -->
    <div class="main-layout">
        <!-- Formulario de Gasto -->
        <div class="form-card">
            <h2 class="form-title">
                <i class="fas fa-plus-circle"></i> Registrar Nuevo Gasto
            </h2>

            <form id="formGasto" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="monto">Monto ($) *</label>
                    <input type="number" id="monto" name="monto" class="form-control" step="0.01" min="0.01"
                        max="<?php echo $saldoDisponible; ?>" placeholder="0.00" required>
                </div>

                <div class="form-group">
                    <label for="tipo_gasto">Tipo de Gasto *</label>
                    <select id="tipo_gasto" name="tipo_gasto" class="form-control" required>
                        <option value="">Seleccione...</option>
                        <?php foreach ($tiposGasto as $key => $label): ?>
                            <option value="<?php echo $key; ?>"><?php echo $label; ?></option>
                        <?php endforeach; ?>
                    </select>
                </div>

                <div class="form-group">
                    <label for="id_responsable">Responsable *</label>
                    <select id="id_responsable" name="id_responsable" class="form-control" required>
                        <option value="">Seleccione...</option>
                        <?php foreach ($personal as $p): ?>
                            <option value="<?php echo $p['id_personal']; ?>">
                                <?php echo htmlspecialchars($p['nombre_apellido']); ?>
                            </option>
                        <?php endforeach; ?>
                    </select>
                </div>

                <div class="form-group">
                    <label for="fecha_gasto">Fecha *</label>
                    <input type="date" id="fecha_gasto" name="fecha_gasto" class="form-control"
                        value="<?php echo date('Y-m-d'); ?>" required>
                </div>

                <div class="form-group">
                    <label>Comprobante (Ticket/Factura) *</label>
                    <div class="file-upload-area" id="uploadArea">
                        <input type="file" id="comprobante" name="comprobante" accept="image/*" capture="environment"
                            required>
                        <div class="file-upload-icon">
                            <i class="fas fa-camera"></i>
                        </div>
                        <div class="file-upload-text">
                            <strong>Toca para tomar foto</strong><br>
                            o arrastra una imagen aquí
                        </div>
                        <img id="filePreview" class="file-preview" alt="Preview">
                    </div>
                </div>

                <div class="form-group">
                    <label for="descripcion">Descripción (Opcional)</label>
                    <textarea id="descripcion" name="descripcion" class="form-control" rows="2"
                        placeholder="Detalle adicional del gasto..."></textarea>
                </div>

                <button type="submit" class="btn btn-primary btn-block btn-lg" id="btnSubmit">
                    <i class="fas fa-save"></i> Guardar Gasto
                </button>
            </form>
        </div>

        <!-- Tabla de Gastos -->
        <div class="table-card">
            <div class="table-header">
                <h2 class="table-title">
                    <i class="fas fa-list-alt"></i> Últimos Gastos
                </h2>
                <div class="filters">
                    <select id="filterTipo" class="filter-select" onchange="applyFilters()">
                        <option value="">Todos los tipos</option>
                        <?php foreach ($tiposGasto as $key => $label): ?>
                            <option value="<?php echo $key; ?>"><?php echo $label; ?></option>
                        <?php endforeach; ?>
                    </select>
                    <select id="filterResponsable" class="filter-select" onchange="applyFilters()">
                        <option value="">Todos los responsables</option>
                        <?php foreach ($personal as $p): ?>
                            <option value="<?php echo $p['id_personal']; ?>">
                                <?php echo htmlspecialchars($p['nombre_apellido']); ?>
                            </option>
                        <?php endforeach; ?>
                    </select>
                    <select id="filterEstado" class="filter-select" onchange="applyFilters()">
                        <option value="">Todos los estados</option>
                        <option value="Pendiente">Pendiente</option>
                        <option value="Rendido">Rendido</option>
                    </select>
                </div>
            </div>

            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th class="checkbox-cell">
                                <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                            </th>
                            <th>Fecha</th>
                            <th>Monto</th>
                            <th>Tipo</th>
                            <th>Responsable</th>
                            <th>Ticket</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <?php if (empty($gastos)): ?>
                            <tr>
                                <td colspan="8">
                                    <div class="empty-state">
                                        <i class="fas fa-receipt"></i>
                                        <p>No hay gastos registrados</p>
                                    </div>
                                </td>
                            </tr>
                        <?php else: ?>
                            <?php foreach ($gastos as $g): ?>
                                <tr data-id="<?php echo $g['id_gasto']; ?>" data-tipo="<?php echo $g['tipo_gasto']; ?>"
                                    data-responsable="<?php echo $g['id_responsable']; ?>"
                                    data-estado="<?php echo $g['estado']; ?>">
                                    <td class="checkbox-cell">
                                        <?php if ($g['estado'] == 'Pendiente'): ?>
                                            <input type="checkbox" class="gasto-check" value="<?php echo $g['id_gasto']; ?>">
                                        <?php endif; ?>
                                    </td>
                                    <td><?php echo date('d/m/Y', strtotime($g['fecha_gasto'])); ?></td>
                                    <td class="amount-cell">$<?php echo number_format($g['monto'], 2, ',', '.'); ?></td>
                                    <td>
                                        <span class="type-badge type-<?php echo $g['tipo_gasto']; ?>">
                                            <?php echo $tiposGasto[$g['tipo_gasto']] ?? $g['tipo_gasto']; ?>
                                        </span>
                                    </td>
                                    <td><?php echo htmlspecialchars($g['responsable_nombre'] ?? 'N/A'); ?></td>
                                    <td>
                                        <?php if ($g['comprobante_path']): ?>
                                            <img src="/APP-Prueba/uploads/comprobantes/<?php echo $g['comprobante_path']; ?>"
                                                class="thumb-img"
                                                onclick="openImageModal('/APP-Prueba/uploads/comprobantes/<?php echo $g['comprobante_path']; ?>')"
                                                alt="Ticket">
                                        <?php else: ?>
                                            <span style="color: var(--text-muted);">Sin imagen</span>
                                        <?php endif; ?>
                                    </td>
                                    <td>
                                        <span class="status-badge status-<?php echo $g['estado']; ?>">
                                            <?php echo $g['estado']; ?>
                                        </span>
                                    </td>
                                    <td class="actions-cell">
                                        <button class="btn-icon view" onclick="viewGasto(<?php echo $g['id_gasto']; ?>)"
                                            title="Ver detalle">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <?php if ($g['estado'] == 'Pendiente'): ?>
                                            <button class="btn-icon delete" onclick="deleteGasto(<?php echo $g['id_gasto']; ?>)"
                                                title="Eliminar">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        <?php endif; ?>
                                    </td>
                                </tr>
                            <?php endforeach; ?>
                        <?php endif; ?>
                    </tbody>
                </table>
            </div>

            <div class="rendicion-panel">
                <div class="selected-count">
                    Seleccionados: <strong id="selectedCount">0</strong> |
                    Total: <strong id="selectedTotal">$0,00</strong>
                </div>
                <button class="btn btn-success" onclick="realizarRendicion()" id="btnRendicion" disabled>
                    <i class="fas fa-check-circle"></i> Rendir Seleccionados
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Imagen -->
<div class="modal-overlay" id="imageModal" onclick="closeImageModal()">
    <button class="modal-close" onclick="closeImageModal()">&times;</button>
    <div class="modal-content">
        <img id="modalImage" src="" alt="Comprobante">
    </div>
</div>

<script>
    // ============================================================================
    // JAVASCRIPT - Módulo de Gastos
    // ============================================================================

    // Saldo disponible (desde PHP)
    const saldoDisponible = <?php echo $saldoDisponible; ?>;

    // ============================================================================
    // FORMULARIO DE GASTO
    // ============================================================================

    // Preview de imagen
    document.getElementById('comprobante').addEventListener('change', function (e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                const preview = document.getElementById('filePreview');
                preview.src = e.target.result;
                preview.style.display = 'block';
                document.querySelector('.file-upload-icon').style.display = 'none';
                document.querySelector('.file-upload-text').style.display = 'none';
            };
            reader.readAsDataURL(file);
        }
    });

    // Drag and drop
    const uploadArea = document.getElementById('uploadArea');
    ['dragenter', 'dragover'].forEach(eventName => {
        uploadArea.addEventListener(eventName, () => uploadArea.classList.add('dragover'));
    });
    ['dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, () => uploadArea.classList.remove('dragover'));
    });

    // Validación de monto
    document.getElementById('monto').addEventListener('input', function (e) {
        const monto = parseFloat(e.target.value) || 0;
        if (monto > saldoDisponible) {
            e.target.setCustomValidity('El monto supera el saldo disponible ($' + saldoDisponible.toFixed(2) + ')');
        } else {
            e.target.setCustomValidity('');
        }
    });

    // Submit del formulario
    document.getElementById('formGasto').addEventListener('submit', async function (e) {
        e.preventDefault();

        const formData = new FormData(this);
        const btn = document.getElementById('btnSubmit');
        const originalText = btn.innerHTML;

        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';

        try {
            const response = await fetch('api/save_gasto.php', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (data.success) {
                showToast('Gasto registrado correctamente', 'success');
                location.reload();
            } else {
                showToast('Error: ' + data.error, 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            showToast('Error de conexión', 'error');
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    });

    // ============================================================================
    // FILTROS
    // ============================================================================

    function applyFilters() {
        const tipo = document.getElementById('filterTipo').value;
        const responsable = document.getElementById('filterResponsable').value;
        const estado = document.getElementById('filterEstado').value;

        const rows = document.querySelectorAll('#tableBody tr[data-id]');

        rows.forEach(row => {
            const matchTipo = !tipo || row.dataset.tipo === tipo;
            const matchResp = !responsable || row.dataset.responsable === responsable;
            const matchEstado = !estado || row.dataset.estado === estado;

            row.style.display = (matchTipo && matchResp && matchEstado) ? '' : 'none';
        });
    }

    // ============================================================================
    // SELECCIÓN Y RENDICIÓN
    // ============================================================================

    function toggleSelectAll() {
        const checked = document.getElementById('selectAll').checked;
        document.querySelectorAll('.gasto-check').forEach(cb => {
            if (cb.closest('tr').style.display !== 'none') {
                cb.checked = checked;
            }
        });
        updateSelectedCount();
    }

    document.querySelectorAll('.gasto-check').forEach(cb => {
        cb.addEventListener('change', updateSelectedCount);
    });

    function updateSelectedCount() {
        const checked = document.querySelectorAll('.gasto-check:checked');
        let total = 0;

        checked.forEach(cb => {
            const row = cb.closest('tr');
            const amountText = row.querySelector('.amount-cell').textContent;
            const amount = parseFloat(amountText.replace('$', '').replace('.', '').replace(',', '.'));
            total += amount;
        });

        document.getElementById('selectedCount').textContent = checked.length;
        document.getElementById('selectedTotal').textContent = '$' + total.toLocaleString('es-AR', { minimumFractionDigits: 2 });
        document.getElementById('btnRendicion').disabled = checked.length === 0;
    }

    async function realizarRendicion() {
        const checked = document.querySelectorAll('.gasto-check:checked');
        if (checked.length === 0) {
            showToast('Seleccione al menos un gasto para rendir', 'warning');
            return;
        }

        const ids = Array.from(checked).map(cb => cb.value);
        const total = document.getElementById('selectedTotal').textContent;

        if (!confirm(`¿Confirma rendir ${checked.length} gastos por un total de ${total}?\n\nSe generará un resumen de la rendición.`)) {
            return;
        }

        try {
            const response = await fetch('api/rendicion.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ids: ids })
            });

            const data = await response.json();

            if (data.success) {
                showToast('Rendición realizada correctamente. ID: ' + data.id_rendicion, 'success');
                location.reload();
            } else {
                showToast('Error: ' + data.error, 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            showToast('Error de conexión', 'error');
        }
    }

    // ============================================================================
    // MODAL DE IMAGEN
    // ============================================================================

    function openImageModal(src) {
        document.getElementById('modalImage').src = src;
        document.getElementById('imageModal').classList.add('active');
    }

    function closeImageModal() {
        document.getElementById('imageModal').classList.remove('active');
    }

    document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') closeImageModal();
    });

    // ============================================================================
    // ACCIONES
    // ============================================================================

    function viewGasto(id) {
        window.location.href = 'detalle.php?id=' + id;
    }

    async function deleteGasto(id) {
        if (!confirm('¿Está seguro de eliminar este gasto?')) return;

        try {
            const response = await fetch('api/delete_gasto.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: id })
            });

            const data = await response.json();

            if (data.success) {
                showToast('Gasto eliminado', 'success');
                location.reload();
            } else {
                showToast('Error: ' + data.error, 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            showToast('Error de conexión', 'error');
        }
    }
</script>

<?php require_once '../../includes/footer.php'; ?>

================================================================================
 MODULE: MATERIALES
 FILE: materiales\delete.php
================================================================================
<?php
require_once '../../config/database.php';
require_once '../../includes/auth.php';

// Verificar sesión
verificarSesion();

$id = $_GET['id'] ?? null;

if ($id) {
    try {
        // Obtener nombre antes de eliminar para el log
        $nameStmt = $pdo->prepare("SELECT nombre FROM maestro_materiales WHERE id_material = ?");
        $nameStmt->execute([$id]);
        $materialNombre = $nameStmt->fetchColumn();

        // Eliminar
        $stmt = $pdo->prepare("DELETE FROM maestro_materiales WHERE id_material = ?");
        $stmt->execute([$id]);

        // Registrar auditoría
        registrarAccion('ELIMINAR', 'materiales', "Material eliminado: $materialNombre", $id);

        header("Location: index.php?msg=deleted");
    } catch (PDOException $e) {
        header("Location: index.php?msg=error");
    }
} else {
    header("Location: index.php");
}
exit();
?>

================================================================================
 MODULE: MATERIALES
 FILE: materiales\form.php
================================================================================
<?php
require_once '../../config/database.php';
require_once '../../includes/header.php';

$id = $_GET['id'] ?? null;
$material = null;

if ($id) {
    $stmt = $pdo->prepare("SELECT * FROM maestro_materiales WHERE id_material = ?");
    $stmt->execute([$id]);
    $material = $stmt->fetch(PDO::FETCH_ASSOC);
}

// Fetch Contacts for Dropdowns
$contactos = $pdo->query("SELECT c.id_contacto, c.nombre_vendedor, p.razon_social 
                          FROM proveedores_contactos c 
                          JOIN proveedores p ON c.id_proveedor = p.id_proveedor 
                          ORDER BY p.razon_social")->fetchAll(PDO::FETCH_ASSOC);
?>

<div class="card" style="max-width: 900px; margin: 0 auto;">
    <h1><?php echo $id ? 'Editar' : 'Nuevo'; ?> Material</h1>

    <form action="save.php" method="POST">
        <?php if ($id): ?>
            <input type="hidden" name="id_material" value="<?php echo $id; ?>">
        <?php endif; ?>

        <!-- Sección 1: Básico -->
        <h3 style="border-bottom: 1px solid #eee; padding-bottom: 5px;">Detalles Generales</h3>
        <div
            style="display: grid; grid-template-columns: 2fr 1fr; gap: var(--spacing-md); margin-bottom: var(--spacing-md);">
            <div>
                <label style="display: block; font-weight: 500;">Nombre del Material *</label>
                <input type="text" name="nombre" required value="<?php echo $material['nombre'] ?? ''; ?>"
                    class="form-control-sm" style="width: 100%;">
            </div>
            <div>
                <label style="display: block; font-weight: 500;">Código (Opcional)</label>
                <input type="text" name="codigo" disabled placeholder="Autogenerado" class="form-control-sm"
                    style="width: 100%; opacity: 0.7;">
            </div>
        </div>

        <div style="margin-bottom: var(--spacing-md);">
            <label style="display: block; font-weight: 500;">Descripción</label>
            <textarea name="descripcion" rows="2" placeholder="Ej: Arena fina lavada..." class="form-control-sm"
                style="width: 100%; height: auto;"><?php echo $material['descripcion'] ?? ''; ?></textarea>
        </div>

        <div
            style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md); margin-bottom: var(--spacing-lg);">
            <div>
                <label style="display: block; font-weight: 500;">Unidad de Medida *</label>
                <select name="unidad_medida" required class="form-control-sm" style="width: 100%;">
                    <option value="">Seleccione...</option>
                    <?php
                    $unidades = ['M3', 'M2', 'ML', 'Bolsas', 'Unidades', 'Kg', 'Litros'];
                    foreach ($unidades as $u) {
                        $sel = ($material['unidad_medida'] ?? '') == $u ? 'selected' : '';
                        echo "<option value='$u' $sel>$u</option>";
                    }
                    ?>
                </select>
            </div>
            <div>
                <label style="display: block; font-weight: 500;">Punto de Pedido (Alerta)</label>
                <input type="number" step="0.01" name="punto_pedido" class="form-control-sm"
                    value="<?php echo $material['punto_pedido'] ?? ''; ?>" style="width: 100%;">
            </div>
        </div>

        <!-- Sección 2: Costos y Proveedores -->
        <h3 style="border-bottom: 1px solid #eee; padding-bottom: 5px;">Proveedores y Costos</h3>

        <div
            style="background: var(--bg-secondary); padding: 15px; border: 1px solid rgba(100, 181, 246, 0.15); border-radius: 8px; margin-bottom: 15px;">
            <label style="display: block; font-weight: bold; color: var(--color-primary);">Proveedor Primario</label>
            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px;">
                <select name="id_contacto_primario" class="form-control-sm" style="width: 100%;">
                    <option value="">-- Seleccionar Contacto --</option>
                    <?php foreach ($contactos as $c): ?>
                        <option value="<?php echo $c['id_contacto']; ?>" <?php echo ($material['id_contacto_primario'] ?? '') == $c['id_contacto'] ? 'selected' : ''; ?>>
                            <?php echo $c['razon_social'] . ' (' . $c['nombre_vendedor'] . ')'; ?>
                        </option>
                    <?php endforeach; ?>
                </select>
                <input type="number" step="0.01" name="costo_primario" placeholder="$ Costo"
                    value="<?php echo $material['costo_primario'] ?? ''; ?>" class="form-control-sm"
                    style="width: 100%;">
            </div>
        </div>

        <div
            style="background: var(--bg-secondary); padding: 15px; border: 1px solid rgba(100, 181, 246, 0.15); border-radius: 8px; margin-bottom: 15px;">
            <label style="display: block; font-weight: bold; color: var(--text-secondary);">Proveedor Secundario</label>
            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px;">
                <select name="id_contacto_secundario" class="form-control-sm" style="width: 100%;">
                    <option value="">-- Seleccionar Contacto --</option>
                    <?php foreach ($contactos as $c): ?>
                        <option value="<?php echo $c['id_contacto']; ?>" <?php echo ($material['id_contacto_secundario'] ?? '') == $c['id_contacto'] ? 'selected' : ''; ?>>
                            <?php echo $c['razon_social'] . ' (' . $c['nombre_vendedor'] . ')'; ?>
                        </option>
                    <?php endforeach; ?>
                </select>
                <input type="number" step="0.01" name="costo_secundario" placeholder="$ Costo"
                    value="<?php echo $material['costo_secundario'] ?? ''; ?>" class="form-control-sm"
                    style="width: 100%;">
            </div>
        </div>

        <?php if ($id): ?>
            <div style="text-align: right; color: #666; font-size: 0.8em; margin-bottom: 10px;">
                Última Cotización: <?php echo $material['fecha_ultima_cotizacion'] ?? '-'; ?>
            </div>
        <?php endif; ?>

        <div style="margin-top: var(--spacing-lg); text-align: right;">
            <a href="index.php" class="btn btn-outline" style="margin-right: var(--spacing-md);">Cancelar</a>
            <button type="submit" class="btn btn-primary">Guardar Cambios</button>
        </div>
    </form>
</div>

<?php require_once '../../includes/footer.php'; ?>

================================================================================
 MODULE: MATERIALES
 FILE: materiales\index.php
================================================================================
<?php
require_once '../../config/database.php';
require_once '../../includes/header.php';

// Fetch materials
$query = "SELECT * FROM maestro_materiales ORDER BY nombre ASC";
$stmt = $pdo->query($query);
$materiales = $stmt->fetchAll(PDO::FETCH_ASSOC);
?>

<div class="container-fluid" style="padding: 0 20px;">
    <div class="card">
        <div
            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-lg);">
            <h1><i class="fas fa-box"></i> Maestro de Materiales</h1>
            <a href="form.php" class="btn btn-primary"><i class="fas fa-plus"></i> Nuevo Material</a>
        </div>

        <!-- Feedback Messages -->
        <?php if (isset($_GET['msg'])): ?>
            <div style="padding: var(--spacing-md); margin-bottom: var(--spacing-md); border-radius: var(--border-radius-md); 
                background: <?php echo $_GET['msg'] == 'saved' ? '#d4edda' : '#f8d7da'; ?>; 
                color: <?php echo $_GET['msg'] == 'saved' ? '#155724' : '#721c24'; ?>;">
                <?php
                if ($_GET['msg'] == 'saved')
                    echo "Material guardado correctamente.";
                if ($_GET['msg'] == 'deleted')
                    echo "Material eliminado.";
                if ($_GET['msg'] == 'error')
                    echo "Ha ocurrido un error.";
                ?>
            </div>
        <?php endif; ?>

        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: var(--color-primary-dark); color: white;">
                        <th style="padding: var(--spacing-md); text-align: left;">Nombre</th>
                        <th style="padding: var(--spacing-md); text-align: left;">Descripción</th>
                        <th style="padding: var(--spacing-md); text-align: center;">Unidad</th>
                        <th style="padding: var(--spacing-md); text-align: right;">Costo Primario</th>
                        <th style="padding: var(--spacing-md); text-align: center;">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <?php foreach ($materiales as $mat): ?>
                        <tr style="border-bottom: 1px solid var(--color-neutral-light);">
                            <td style="padding: var(--spacing-md);">
                                <?php echo htmlspecialchars($mat['nombre']); ?>
                            </td>
                            <td style="padding: var(--spacing-md);">
                                <?php echo htmlspecialchars($mat['descripcion']); ?>
                            </td>
                            <td style="padding: var(--spacing-md); text-align: center;">
                                <?php echo htmlspecialchars($mat['unidad_medida']); ?>
                            </td>
                            <td style="padding: var(--spacing-md); text-align: right;">$
                                <?php echo number_format($mat['costo_primario'], 2); ?>
                            </td>
                            <td style="padding: var(--spacing-md); text-align: center;">
                                <a href="form.php?id=<?php echo $mat['id_material']; ?>" class="btn btn-outline"
                                    style="padding: 4px 8px; font-size: 0.9em;"><i class="fas fa-edit"></i></a>
                                <a href="delete.php?id=<?php echo $mat['id_material']; ?>"
                                    onclick="return confirm('¿Está seguro de eliminar este material?');"
                                    class="btn btn-outline"
                                    style="padding: 4px 8px; font-size: 0.9em; border-color: var(--color-danger); color: var(--color-danger);"><i
                                        class="fas fa-trash"></i></a>
                            </td>
                        </tr>
                    <?php endforeach; ?>
                    <?php if (empty($materiales)): ?>
                        <tr>
                            <td colspan="5"
                                style="padding: var(--spacing-lg); text-align: center; color: var(--color-neutral);">No hay
                                materiales registrados.</td>
                        </tr>
                    <?php endif; ?>
                </tbody>
            </table>
        </div>
    </div>
</div>

<?php require_once '../../includes/footer.php'; ?>

================================================================================
 MODULE: MATERIALES
 FILE: materiales\save.php
================================================================================
<?php
require_once '../../config/database.php';
require_once '../../includes/auth.php';

// Verificar sesión
verificarSesion();

if ($_SERVER['REQUEST_METHOD'] == 'POST') {
    $id = $_POST['id_material'] ?? null;
    $nombre = $_POST['nombre'];
    $descripcion = $_POST['descripcion'];
    $unidad_medida = $_POST['unidad_medida'];
    $punto_pedido = !empty($_POST['punto_pedido']) ? $_POST['punto_pedido'] : null;

    $id_primario = !empty($_POST['id_contacto_primario']) ? $_POST['id_contacto_primario'] : null;
    $costo_primario = !empty($_POST['costo_primario']) ? $_POST['costo_primario'] : null;

    $id_secundario = !empty($_POST['id_contacto_secundario']) ? $_POST['id_contacto_secundario'] : null;
    $costo_secundario = !empty($_POST['costo_secundario']) ? $_POST['costo_secundario'] : null;

    // Always update date on save for now
    $fecha_cotizacion = date('Y-m-d');

    try {
        if ($id) {
            // Update
            $sql = "UPDATE maestro_materiales SET 
                    nombre = ?, descripcion = ?, unidad_medida = ?, punto_pedido = ?, 
                    id_contacto_primario = ?, costo_primario = ?,
                    id_contacto_secundario = ?, costo_secundario = ?,
                    fecha_ultima_cotizacion = ?
                    WHERE id_material = ?";
            $stmt = $pdo->prepare($sql);
            $stmt->execute([
                $nombre,
                $descripcion,
                $unidad_medida,
                $punto_pedido,
                $id_primario,
                $costo_primario,
                $id_secundario,
                $costo_secundario,
                $fecha_cotizacion,
                $id
            ]);

            // Registrar auditoría - Edición
            registrarAccion('EDITAR', 'materiales', "Material editado: $nombre", $id);
        } else {
            // Insert
            $sql = "INSERT INTO maestro_materiales 
                    (nombre, descripcion, unidad_medida, punto_pedido, 
                    id_contacto_primario, costo_primario, 
                    id_contacto_secundario, costo_secundario, 
                    fecha_ultima_cotizacion) 
                    VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)";
            $stmt = $pdo->prepare($sql);
            $stmt->execute([
                $nombre,
                $descripcion,
                $unidad_medida,
                $punto_pedido,
                $id_primario,
                $costo_primario,
                $id_secundario,
                $costo_secundario,
                $fecha_cotizacion
            ]);

            $newId = $pdo->lastInsertId();

            // Registrar auditoría - Creación
            registrarAccion('CREAR', 'materiales', "Material creado: $nombre", $newId);
        }

        header("Location: index.php?msg=saved");
        exit();

    } catch (PDOException $e) {
        // [!] ARQUITECTURA: No exponer errores SQL al usuario
        error_log("Error en materiales/save.php: " . $e->getMessage());
        header("Location: index.php?msg=error");
        exit();
    }
}
?>

================================================================================
 MODULE: MOVIMIENTOS
 FILE: movimientos\form.php
================================================================================
<?php
require_once '../../config/database.php';
require_once '../../includes/header.php';

// Fetch Data for Dropdowns
$materiales = $pdo->query("SELECT * FROM maestro_materiales ORDER BY nombre")->fetchAll(PDO::FETCH_ASSOC);
$cuadrillas = $pdo->query("SELECT * FROM cuadrillas WHERE estado_operativo = 'Activa'")->fetchAll(PDO::FETCH_ASSOC);
$proveedores = $pdo->query("SELECT * FROM proveedores ORDER BY razon_social")->fetchAll(PDO::FETCH_ASSOC);
$contactos = $pdo->query("SELECT * FROM proveedores_contactos ORDER BY nombre_vendedor")->fetchAll(PDO::FETCH_ASSOC);

// Serialize for JS
$contactos_json = json_encode($contactos);
$materiales_json = json_encode($materiales);
$proveedores_json = json_encode($proveedores);
?>

<style>
    /* Panel de Flujo Visual */
    .flow-panel {
        background: var(--bg-secondary);
        border: 1px solid rgba(100, 181, 246, 0.15);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        display: none;
        box-shadow: var(--shadow-sm);
    }

    [data-theme="light"] .flow-panel {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border: none;
    }

    .flow-panel.visible {
        display: block;
        animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .flow-container {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 20px;
    }

    .flow-box {
        background: var(--bg-card);
        border-radius: 10px;
        padding: 15px 25px;
        min-width: 200px;
        text-align: center;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
        border: 2px solid transparent;
        transition: all 0.3s ease;
        color: var(--text-primary);
    }

    [data-theme="light"] .flow-box {
        background: white;
        color: #333;
    }

    .flow-box.origin {
        border-color: #28a745;
    }

    .flow-box.destination {
        border-color: #007bff;
    }

    .flow-box label {
        display: block;
        font-size: 0.75em;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: var(--text-secondary);
        margin-bottom: 8px;
        font-weight: bold;
    }

    .flow-box .value {
        font-size: 1.1em;
        font-weight: 600;
        color: var(--text-primary);
    }

    .flow-box .value.fixed {
        color: var(--text-muted);
    }

    .flow-box select {
        width: 100%;
        padding: 8px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        background: var(--bg-secondary);
        color: var(--text-primary);
        border-radius: 6px;
        font-size: 0.95em;
    }

    [data-theme="light"] .flow-box select {
        border: 1px solid #ddd;
        background: white;
        color: #333;
    }

    .flow-arrow {
        font-size: 2em;
        color: var(--text-muted);
    }

    /* Indicador de estado bloqueado */
    .locked-indicator {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: rgba(255, 255, 255, 0.05);
        padding: 8px 15px;
        border-radius: 20px;
        color: var(--text-secondary);
    }

    [data-theme="light"] .locked-indicator {
        background: #f1f3f5;
        color: #495057;
    }

    .locked-indicator i {
        color: var(--text-muted);
        font-size: 0.9em;
    }

    /* Tipo Operación Cards */
    .operation-type-cards {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 10px;
        margin-bottom: 20px;
    }

    .op-card {
        background: var(--bg-card);
        border: 2px solid rgba(255, 255, 255, 0.05);
        border-radius: 10px;
        padding: 15px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s ease;
        color: var(--text-primary);
    }

    [data-theme="light"] .op-card {
        background: white;
        border: 2px solid #e9ecef;
        color: #333;
    }

    .op-card:hover {
        border-color: var(--color-primary);
        transform: translateY(-2px);
    }

    .op-card.selected {
        border-color: var(--color-primary);
        background: rgba(100, 181, 246, 0.1);
    }

    [data-theme="light"] .op-card.selected {
        background: linear-gradient(135deg, #f0f7ff 0%, #e6f0ff 100%);
    }

    .op-card .icon {
        font-size: 1.8em;
        margin-bottom: 8px;
    }

    .op-card .label {
        font-size: 0.85em;
        font-weight: 600;
        color: var(--text-primary);
    }

    [data-theme="light"] .op-card .label {
        color: #333;
    }

    .op-card .sublabel {
        font-size: 0.75em;
        color: var(--text-muted);
        margin-top: 4px;
    }
</style>

<div class="card" style="max-width: 1000px; margin: 0 auto;">
    <h1><i class="fas fa-exchange-alt"></i> Nuevo Movimiento (Carga por Lote)</h1>

    <?php if (isset($_GET['msg']) && $_GET['msg'] == 'error'): ?>
        <div
            style="background: #f8d7da; color: #721c24; padding: 15px; margin-bottom: 20px; border-radius: 5px; border: 1px solid #f5c6cb;">
            <strong>Error:</strong> <?php echo htmlspecialchars($_GET['details']); ?>
        </div>
    <?php endif; ?>

    <form action="save.php" method="POST" id="moveForm">

        <!-- PASO 1: Selección de Tipo de Operación -->
        <div style="margin-bottom: 25px;">
            <label style="font-weight: bold; font-size: 1.1em; margin-bottom: 15px; display: block;">
                <i class="fas fa-hand-pointer"></i> 1. Seleccione el Tipo de Operación
            </label>

            <div class="operation-type-cards">
                <div class="op-card" data-value="Compra_Material" onclick="selectOperation(this)">
                    <div class="icon">🛒</div>
                    <div class="label">Compra de Material</div>
                    <div class="sublabel">Proveedor → Oficina</div>
                </div>
                <div class="op-card" data-value="Recepcion_ASSA_Oficina" onclick="selectOperation(this)">
                    <div class="icon">🏢</div>
                    <div class="label">Recepción ASSA</div>
                    <div class="sublabel">ASSA → Oficina</div>
                </div>
                <div class="op-card" data-value="Devolucion_ASSA" onclick="selectOperation(this)">
                    <div class="icon">↩️</div>
                    <div class="label">Devolución a ASSA</div>
                    <div class="sublabel">Oficina → ASSA</div>
                </div>
                <div class="op-card" data-value="Devolucion_Compra" onclick="selectOperation(this)">
                    <div class="icon">🔄</div>
                    <div class="label">Devolución de Compra</div>
                    <div class="sublabel">Oficina → Proveedor</div>
                </div>
            </div>

            <!-- Hidden input for form submission -->
            <input type="hidden" name="tipo_movimiento" id="tipo" required>
        </div>

        <!-- PASO 2: Panel de Flujo Visual (Origen / Destino) -->
        <div class="flow-panel" id="flowPanel">
            <label style="font-weight: bold; margin-bottom: 15px; display: block;">
                <i class="fas fa-route"></i> 2. Flujo del Movimiento
            </label>
            <div class="flow-container">
                <div class="flow-box origin" id="originBox">
                    <label>Origen</label>
                    <div class="value" id="originValue">--</div>
                    <select id="originSelect" name="id_proveedor_origen" style="display:none;"></select>
                </div>
                <div class="flow-arrow">→</div>
                <div class="flow-box destination" id="destBox">
                    <label>Destino</label>
                    <div class="value" id="destValue">--</div>
                    <select id="destSelect" name="id_proveedor" style="display:none;"></select>
                </div>
            </div>
        </div>

        <!-- PASO 3: Datos de Operación -->
        <div class="card"
            style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <div>
                <label style="font-weight: bold;">3.1 Fecha de Operación</label>
                <input type="date" name="fecha_movimiento" value="<?php echo date('Y-m-d'); ?>" required
                    class="form-control-sm" style="width: 100%;">
            </div>
            <div>
                <label style="font-weight: bold;">3.2 Nº Documento / Remito</label>
                <input type="text" name="nro_documento" placeholder="Remito / Factura" class="form-control-sm"
                    style="width: 100%;">
            </div>
        </div>

        <!-- Usuarios -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px;">
            <div>
                <label>Despachado Por</label>
                <input type="text" name="usuario_despacho" placeholder="Responsable de Entrega" value="Almacén"
                    class="form-control-sm" style="width: 100%;">
            </div>
            <div>
                <label>Recibido Por</label>
                <input type="text" name="usuario_recepcion" placeholder="Responsable de Recepción"
                    class="form-control-sm" style="width: 100%;">
            </div>
        </div>

        <!-- GRILLA DE MATERIALES -->
        <div style="margin-bottom: 20px;">
            <h3><i class="fas fa-list"></i> 4. Detalle de Materiales</h3>
            <table class="table" style="width: 100%; border-collapse: separate; border-spacing: 0;" id="gridMateriales">
                <thead>
                    <tr>
                        <th style="padding: 10px; width: 15%;">Código</th>
                        <th style="padding: 10px; width: 45%;">Material (Descripción)</th>
                        <th style="padding: 10px; width: 20%;">Cantidad</th>
                        <th style="padding: 10px; width: 10%;">Unidad</th>
                        <th style="padding: 10px; width: 10%;"></th>
                    </tr>
                </thead>
                <tbody id="gridBody">
                    <!-- Rows added via JS -->
                </tbody>
            </table>
            <button type="button" class="btn btn-outline" onclick="addRow()"
                style="margin-top: 10px; width: 100%; border-style: dashed;">
                <i class="fas fa-plus"></i> Agregar Línea
            </button>
        </div>

        <button type="submit" class="btn btn-primary" style="width: 100%; padding: 15px; font-size: 1.2em;">
            <i class="fas fa-check-circle"></i> Procesar Movimiento
        </button>
    </form>
</div>

<!-- DATA ISLANDS -->
<script>
    const contactosDB = <?php echo $contactos_json; ?>;
    const materialesDB = <?php echo $materiales_json; ?>;
    const proveedoresDB = <?php echo $proveedores_json; ?>;

    // Reglas de Negocio para cada Tipo de Operación
    const OPERATION_RULES = {
        'Compra_Material': {
            origin: { type: 'dropdown', source: 'proveedores', label: 'Proveedor' },
            destination: { type: 'fixed', value: 'Oficina Central' }
        },
        'Recepcion_ASSA_Oficina': {
            origin: { type: 'fixed', value: 'ASSA' },
            destination: { type: 'fixed', value: 'Oficina Central' }
        },
        'Devolucion_ASSA': {
            origin: { type: 'fixed', value: 'Oficina Central' },
            destination: { type: 'fixed', value: 'ASSA' }
        },
        'Devolucion_Compra': {
            origin: { type: 'fixed', value: 'Oficina Central' },
            destination: { type: 'dropdown', source: 'proveedores', label: 'Proveedor' }
        }
    };

    // Selección de Tipo de Operación (Cards)
    function selectOperation(card) {
        // Deseleccionar todas
        document.querySelectorAll('.op-card').forEach(c => c.classList.remove('selected'));
        // Seleccionar la clickeada
        card.classList.add('selected');

        const tipo = card.dataset.value;
        document.getElementById('tipo').value = tipo;

        // Aplicar reglas de flujo
        applyFlowRules(tipo);
    }

    // Aplicar Reglas de Flujo según Tipo
    function applyFlowRules(tipo) {
        const rules = OPERATION_RULES[tipo];
        if (!rules) return;

        const flowPanel = document.getElementById('flowPanel');
        const originValue = document.getElementById('originValue');
        const originSelect = document.getElementById('originSelect');
        const destValue = document.getElementById('destValue');
        const destSelect = document.getElementById('destSelect');

        // Mostrar panel
        flowPanel.classList.add('visible');

        // --- ORIGEN ---
        if (rules.origin.type === 'fixed') {
            originValue.innerHTML = `<span class="locked-indicator"><i class="fas fa-lock"></i> ${rules.origin.value}</span>`;
            originValue.style.display = 'block';
            originSelect.style.display = 'none';
            originSelect.name = ''; // No enviar en form
        } else if (rules.origin.type === 'dropdown') {
            originValue.style.display = 'none';
            originSelect.style.display = 'block';
            originSelect.name = 'id_proveedor'; // Provider for Compra
            populateDropdown(originSelect, rules.origin.source);
        }

        // --- DESTINO ---
        if (rules.destination.type === 'fixed') {
            destValue.innerHTML = `<span class="locked-indicator"><i class="fas fa-lock"></i> ${rules.destination.value}</span>`;
            destValue.style.display = 'block';
            destSelect.style.display = 'none';
            destSelect.name = '';
        } else if (rules.destination.type === 'dropdown') {
            destValue.style.display = 'none';
            destSelect.style.display = 'block';
            destSelect.name = 'id_proveedor'; // Provider for Devolución
            populateDropdown(destSelect, rules.destination.source);
        }
    }

    // Poblar Dropdown según fuente de datos
    function populateDropdown(selectEl, source) {
        selectEl.innerHTML = '<option value="">-- Seleccione --</option>';

        if (source === 'proveedores') {
            proveedoresDB.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.id_proveedor;
                opt.text = p.razon_social;
                selectEl.appendChild(opt);
            });
        }
    }

    // Grid de Materiales
    function addRow() {
        const tbody = document.getElementById('gridBody');

        let optionsCode = '<option value="">Cod</option>';
        let optionsName = '<option value="">Seleccionar Material...</option>';

        materialesDB.forEach(m => {
            optionsCode += `<option value="${m.id_material}">${m.codigo || m.id_material}</option>`;
            optionsName += `<option value="${m.id_material}">${m.nombre}</option>`;
        });

        const row = document.createElement('tr');
        row.innerHTML = `
        <td style="padding: 5px;">
            <select name="id_material[]" class="sync-code form-control-sm" onchange="syncRow(this, 'code')" style="width:100%;">${optionsCode}</select>
        </td>
        <td style="padding: 5px;">
            <select name="id_material_dummy[]" class="sync-name form-control-sm" onchange="syncRow(this, 'name')" style="width:100%;">${optionsName}</select>
        </td>
        <td style="padding: 5px;">
            <input type="number" step="0.01" name="cantidad[]" required placeholder="0.00" class="form-control-sm" style="width:100%;">
        </td>
        <td style="padding: 5px; text-align: center;">
            <span class="unit-label text-muted">-</span>
        </td>
        <td style="padding: 5px; text-align: center;">
            <button type="button" onclick="this.closest('tr').remove()" style="color:red; background:none; border:none; cursor:pointer;"><i class="fas fa-trash"></i></button>
        </td>
    `;
        tbody.appendChild(row);
    }

    function syncRow(el, source) {
        const row = el.closest('tr');
        const selCode = row.querySelector('.sync-code');
        const selName = row.querySelector('.sync-name');
        const unitLabel = row.querySelector('.unit-label');
        const val = el.value;

        if (source === 'code') {
            selName.value = val;
        } else {
            selCode.value = val;
        }

        const mat = materialesDB.find(m => m.id_material == val);
        if (mat) {
            unitLabel.innerText = mat.unidad_medida;
        } else {
            unitLabel.innerText = '-';
        }
    }

    // Inicialización
    window.onload = function () {
        addRow();
    };
</script>

<?php require_once '../../includes/footer.php'; ?>

================================================================================
 MODULE: MOVIMIENTOS
 FILE: movimientos\index.php
================================================================================
<?php
require_once '../../config/database.php';
require_once '../../includes/header.php';

// Fetch ALL Data for Client-Side Filtering (Limit increased for history depth)
$sql = "SELECT mov.*, m.nombre as material, c.nombre_cuadrilla, p.razon_social as proveedor, o.nro_odt_assa 
        FROM movimientos mov
        JOIN maestro_materiales m ON mov.id_material = m.id_material
        LEFT JOIN cuadrillas c ON mov.id_cuadrilla = c.id_cuadrilla
        LEFT JOIN proveedores p ON mov.id_proveedor = p.id_proveedor
        LEFT JOIN odt_maestro o ON mov.id_odt = o.id_odt
        ORDER BY mov.fecha_hora DESC LIMIT 1000";
$movimientos = $pdo->query($sql)->fetchAll(PDO::FETCH_ASSOC);

// Unique Lists for Dropdown Filters
$types = array_unique(array_column($movimientos, 'tipo_movimiento'));

// Derivar Orígenes y Destinos únicos para el Filtro
$origins = [];
$destinations = [];

foreach ($movimientos as $m) {
    if ($m['tipo_movimiento'] == 'Compra_Material') {
        $origins[] = $m['proveedor'];
        $destinations[] = 'Oficina Central';
    } elseif ($m['tipo_movimiento'] == 'Recepcion_ASSA_Oficina') {
        $origins[] = 'ASSA';
        $destinations[] = 'Oficina Central';
    } elseif ($m['tipo_movimiento'] == 'Entrega_Oficina_Cuadrilla') {
        $origins[] = 'Oficina Central';
        $destinations[] = $m['nombre_cuadrilla'];
    } elseif ($m['tipo_movimiento'] == 'Consumo_Cuadrilla_Obra') {
        $origins[] = $m['nombre_cuadrilla'];
        $destinations[] = 'Obra / Consumo';
    }
}
$origins = array_unique(array_filter($origins));
$destinations = array_unique(array_filter($destinations));
?>

<!-- SheetJS for Excel Export -->
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<div class="container-fluid" style="padding: 0 20px;">
    <div class="card" style="box-shadow: var(--box-shadow-medium); border-radius: var(--border-radius-lg);">

        <!-- HEADER & ACTIONS -->
        <div
            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #f0f0f0; padding-bottom: 15px;">
            <h1 style="margin: 0; color: var(--color-neutral-dark);"><i class="fas fa-history"></i> Historial de
                Movimientos
            </h1>
            <div style="display: flex; gap: 10px;">
                <a href="form.php" class="btn btn-primary"><i class="fas fa-plus-circle"></i> Nueva Operación</a>
                <button onclick="exportTable()" class="btn btn-outline" style="color: #217346; border-color: #217346;">
                    <i class="fas fa-file-excel"></i> Exportar a Excel
                </button>
            </div>
        </div>

        <!-- FILTERS BAR -->
        <div class="filter-bar">
            <!-- Filter: Date Range -->
            <div class="filter-group">
                <label>Fecha Desde</label>
                <input type="date" id="f_date_from" onchange="applyFilters()" class="form-control-sm">
            </div>
            <div class="filter-group">
                <label>Fecha Hasta</label>
                <input type="date" id="f_date_to" onchange="applyFilters()" class="form-control-sm">
            </div>

            <!-- Filter: Type -->
            <div class="filter-group">
                <label>Tipo Operación</label>
                <select id="f_type" onchange="applyFilters()" class="form-control-sm">
                    <option value="">Todos</option>
                    <option value="Compra_Material">🛒 Compra Material</option>
                    <option value="Recepcion_ASSA_Oficina">🏢 Recepción ASSA</option>
                    <option value="Entrega_Oficina_Cuadrilla">🚚 Entrega Cuadrilla</option>
                    <option value="Consumo_Cuadrilla_Obra">📉 Consumo (C. -&gt; Obra)</option>
                </select>
            </div>

            <!-- Filter: Origin -->
            <div class="filter-group">
                <label>Origen</label>
                <select id="f_origin" onchange="applyFilters()" class="form-control-sm">
                    <option value="">Todos</option>
                    <?php foreach ($origins as $o): ?>
                        <option value="<?php echo htmlspecialchars($o); ?>"><?php echo htmlspecialchars($o); ?></option>
                    <?php endforeach; ?>
                </select>
            </div>

            <!-- Filter: Destination -->
            <div class="filter-group">
                <label>Destino</label>
                <select id="f_dest" onchange="applyFilters()" class="form-control-sm">
                    <option value="">Todos</option>
                    <?php foreach ($destinations as $d): ?>
                        <option value="<?php echo htmlspecialchars($d); ?>"><?php echo htmlspecialchars($d); ?></option>
                    <?php endforeach; ?>
                </select>
            </div>

            <div class="filter-group" style="flex: 0 0 auto;">
                <button onclick="resetFilters()" class="btn btn-outline btn-sm" title="Limpiar Filtros">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </div>

        <!-- TABLE -->
        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; font-size: 0.85em;" id="movesTable">
                <thead>
                    <tr style="background: var(--color-primary-dark); color: white;">
                        <th style="padding: 12px; text-align: left;">Fecha</th>
                        <th style="padding: 12px; text-align: left;">Tipo</th>
                        <th style="padding: 12px; text-align: left;">Material</th>
                        <th style="padding: 12px; text-align: right;">Cant</th>
                        <th style="padding: 12px; text-align: left;">Origen / Destino</th>
                        <th style="padding: 12px; text-align: left;">Doc / Usuarios</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <?php foreach ($movimientos as $mov):
                        // Formatting Data Attributes for JS Filtering
                        $dateRaw = date('Y-m-d', strtotime($mov['fecha_hora']));
                        $typeRaw = $mov['tipo_movimiento'];

                        // Derivar Origen/Destino para esta fila
                        $rowOrigin = '';
                        $rowDest = '';
                        if ($typeRaw == 'Compra_Material') {
                            $rowOrigin = $mov['proveedor'];
                            $rowDest = 'Oficina Central';
                        } elseif ($typeRaw == 'Recepcion_ASSA_Oficina') {
                            $rowOrigin = 'ASSA';
                            $rowDest = 'Oficina Central';
                        } elseif ($typeRaw == 'Entrega_Oficina_Cuadrilla') {
                            $rowOrigin = 'Oficina Central';
                            $rowDest = $mov['nombre_cuadrilla'];
                        } elseif ($typeRaw == 'Consumo_Cuadrilla_Obra') {
                            $rowOrigin = $mov['nombre_cuadrilla'];
                            $rowDest = 'Obra / Consumo';
                        }
                        // Display Vars
                        $color = '#333';
                        $icon = '';
                        $typeName = '';

                        if ($typeRaw == 'Compra_Material') {
                            $color = '#28a745';
                            $icon = '🛒';
                            $typeName = 'Compra';
                        } elseif ($typeRaw == 'Recepcion_ASSA_Oficina') {
                            $color = '#17a2b8';
                            $icon = '🏢';
                            $typeName = 'Recepción ASSA';
                        } elseif ($typeRaw == 'Entrega_Oficina_Cuadrilla') {
                            $color = '#007bff';
                            $icon = '🚚';
                            $typeName = 'Entrega';
                        } else {
                            $color = '#666';
                            $icon = '🔧';
                            $typeName = str_replace('_', ' ', $typeRaw);
                        }
                        ?>
                        <tr style="border-bottom: 1px solid #efefef;" data-date="<?php echo $dateRaw; ?>"
                            data-type="<?php echo $typeRaw; ?>" data-origin="<?php echo htmlspecialchars($rowOrigin); ?>"
                            data-dest="<?php echo htmlspecialchars($rowDest); ?>">

                            <td style="padding: 12px; color: #555;">
                                <?php echo date('d/m/Y H:i', strtotime($mov['fecha_hora'])); ?>
                            </td>
                            <td style="padding: 12px; font-weight: 600; color: <?php echo $color; ?>;">
                                <?php echo $icon . ' ' . $typeName; ?>
                            </td>
                            <td style="padding: 12px;">
                                <strong><?php echo $mov['material']; ?></strong>
                            </td>
                            <td
                                style="padding: 12px; text-align: right; font-weight: bold; font-family: monospace; font-size: 1.1em;">
                                <?php echo $mov['cantidad']; ?>
                            </td>
                            <td style="padding: 12px;">
                                <?php
                                if ($mov['proveedor'])
                                    echo "<span class='badge-prov'>Prov: " . $mov['proveedor'] . "</span>";
                                if ($mov['nombre_cuadrilla'])
                                    echo "<span class='badge-squad'>Dest: " . $mov['nombre_cuadrilla'] . "</span>";
                                if ($mov['nro_odt_assa'])
                                    echo "<br><span class='badge-odt'>ODT: " . $mov['nro_odt_assa'] . "</span>";
                                ?>
                            </td>
                            <td style="padding: 12px; coloe: #777;">
                                <?php if ($mov['nro_documento'])
                                    echo "<div><i class='fas fa-file-alt'></i> " . $mov['nro_documento'] . "</div>"; ?>
                                <div style="font-size: 0.85em; margin-top: 4px;">
                                    <span title="Despachó"><i class="fas fa-user-tag"></i>
                                        <?php echo $mov['usuario_despacho']; ?></span>
                                    <?php if ($mov['usuario_recepcion']): ?>
                                        <span title="Recibió">➜ <i class="fas fa-user-check"></i>
                                            <?php echo $mov['usuario_recepcion']; ?></span>
                                    <?php endif; ?>
                                </div>
                            </td>
                        </tr>
                    <?php endforeach; ?>
                </tbody>
            </table>
            <div id="noResults" style="display:none; padding: 20px; text-align: center; color: #999;">
                No se encontraron movimientos con los filtros aplicados.
            </div>
        </div>
    </div>
</div>

<script>
    function applyFilters() {
        const fDateFrom = document.getElementById('f_date_from').value;
        const fDateTo = document.getElementById('f_date_to').value;
        const fType = document.getElementById('f_type').value;
        const fOrigin = document.getElementById('f_origin').value;
        const fDest = document.getElementById('f_dest').value;

        const rows = document.querySelectorAll('#tableBody tr');
        let visibleCount = 0;

        rows.forEach(row => {
            const rowDate = row.dataset.date;
            const rowType = row.dataset.type;
            const rowOrigin = row.dataset.origin;
            const rowDest = row.dataset.dest;

            // Conditions
            let show = true;

            if (fDateFrom && rowDate < fDateFrom) show = false;
            if (fDateTo && rowDate > fDateTo) show = false;
            if (fType && rowType !== fType) show = false;
            if (fOrigin && rowOrigin !== fOrigin) show = false;
            if (fDest && rowDest !== fDest) show = false;

            row.style.display = show ? '' : 'none';
            if (show) visibleCount++;
        });

        document.getElementById('noResults').style.display = visibleCount === 0 ? 'block' : 'none';
    }

    function resetFilters() {
        document.getElementById('f_date_from').value = '';
        document.getElementById('f_date_to').value = '';
        document.getElementById('f_type').value = '';
        document.getElementById('f_origin').value = '';
        document.getElementById('f_dest').value = '';
        applyFilters();
    }

    function exportTable() {
        // We clone the table to clean it up for export (remove HTML tags in cells if needed, or SheetJS logic handles it)
        // SheetJS table_to_book is easiest but exports hidden rows too unless we filter data manually.
        // Better: Construct data array from VISIBLE rows.

        const rows = document.querySelectorAll('#tableBody tr');
        const data = [];

        // Header
        data.push(["Fecha", "Tipo Movimiento", "Material", "Cantidad", "Origen/Destino", "Documento", "Despacho", "Recepción"]);

        rows.forEach(row => {
            if (row.style.display !== 'none') {
                const cells = row.querySelectorAll('td');
                // Parse cell text content cleanly
                data.push([
                    cells[0].innerText.trim(),
                    cells[1].innerText.trim(),
                    cells[2].innerText.trim(),
                    cells[3].innerText.trim(), // Quantity
                    cells[4].innerText.replace(/\n/g, ' ').trim(), // Clean newlines
                    cells[5].innerText.split('\n')[0].trim(), // Doc
                    cells[5].innerText.includes('Desp:') ? cells[5].innerText.split('Desp:')[1].split('\n')[0].trim() : '',
                    cells[5].innerText.includes('Rec:') ? cells[5].innerText.split('Rec:')[1].trim() : ''
                ]);
            }
        });

        const ws = XLSX.utils.aoa_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Movimientos");

        // Filename: Movimientos_ERP_YYYY-MM-DD.xlsx
        const dateStr = new Date().toISOString().split('T')[0];
        XLSX.writeFile(wb, `Movimientos_ERP_${dateStr}.xlsx`);
    }
</script>

<?php require_once '../../includes/footer.php'; ?>

================================================================================
 MODULE: MOVIMIENTOS
 FILE: movimientos\remito.php
================================================================================
<?php
require_once '../../config/database.php';

// Validate ID
if (!isset($_GET['id']) || !is_numeric($_GET['id'])) {
    header("Location: ../stock/index.php?msg=error");
    exit;
}

$id_remito = intval($_GET['id']);

// Fetch Remito Header
$sql = "SELECT r.*, c.nombre_cuadrilla 
        FROM remitos r 
        LEFT JOIN cuadrillas c ON r.id_cuadrilla = c.id_cuadrilla 
        WHERE r.id_remito = ?";
$stmt = $pdo->prepare($sql);
$stmt->execute([$id_remito]);
$remito = $stmt->fetch(PDO::FETCH_ASSOC);

if (!$remito) {
    header("Location: ../stock/index.php?msg=error&details=Remito+no+encontrado");
    exit;
}

// Fetch Remito Details
$sqlDet = "SELECT rd.*, m.nombre as material, m.codigo, m.unidad_medida 
           FROM remitos_detalle rd 
           JOIN maestro_materiales m ON rd.id_material = m.id_material 
           WHERE rd.id_remito = ?";
$stmtDet = $pdo->prepare($sqlDet);
$stmtDet->execute([$id_remito]);
$detalles = $stmtDet->fetchAll(PDO::FETCH_ASSOC);
?>
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Remito
        <?php echo htmlspecialchars($remito['numero_remito']); ?>
    </title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --color-primary: #0077b6;
            --color-dark: #1a1a2e;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fa;
            padding: 20px;
        }

        .remito-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .remito-header {
            background: linear-gradient(135deg, var(--color-dark) 0%, #16213e 100%);
            color: white;
            padding: 30px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .company-info h1 {
            font-size: 1.8em;
            margin-bottom: 5px;
        }

        .company-info p {
            opacity: 0.8;
            font-size: 0.9em;
        }

        .remito-number {
            text-align: right;
        }

        .remito-number .number {
            font-size: 1.5em;
            font-weight: bold;
            color: #00d4ff;
            letter-spacing: 1px;
        }

        .remito-number .date {
            opacity: 0.8;
            margin-top: 5px;
        }

        .remito-body {
            padding: 30px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .info-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid var(--color-primary);
        }

        .info-box label {
            display: block;
            font-size: 0.75em;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #666;
            margin-bottom: 5px;
        }

        .info-box .value {
            font-size: 1.1em;
            font-weight: 600;
            color: #333;
        }

        .materials-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
        }

        .materials-table thead {
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
        }

        .materials-table th {
            padding: 12px 15px;
            text-align: left;
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #495057;
        }

        .materials-table td {
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
        }

        .materials-table tr:hover {
            background: #f8f9fa;
        }

        .materials-table .qty {
            font-family: 'Consolas', monospace;
            font-size: 1.2em;
            font-weight: bold;
            color: var(--color-primary);
        }

        .materials-table .unit {
            color: #888;
            font-size: 0.85em;
        }

        .signatures {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            margin-top: 50px;
            padding-top: 30px;
            border-top: 2px dashed #dee2e6;
        }

        .signature-box {
            text-align: center;
        }

        .signature-line {
            border-bottom: 2px solid #333;
            height: 60px;
            margin-bottom: 10px;
        }

        .signature-label {
            font-size: 0.9em;
            color: #666;
        }

        .actions {
            padding: 20px 30px;
            background: #f8f9fa;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: var(--color-primary);
            color: white;
        }

        .btn-primary:hover {
            background: #005b8f;
            transform: translateY(-2px);
        }

        .btn-outline {
            background: white;
            border: 2px solid #dee2e6;
            color: #333;
        }

        .btn-outline:hover {
            border-color: var(--color-primary);
            color: var(--color-primary);
        }

        .success-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: #d4edda;
            color: #155724;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
        }

        @media print {
            body {
                background: white;
                padding: 0;
            }

            .actions {
                display: none;
            }

            .remito-container {
                box-shadow: none;
                border-radius: 0;
            }

            .remito-header {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }
    </style>
</head>

<body>
    <div class="remito-container">
        <div class="remito-header">
            <div class="company-info">
                <h1><i class="fas fa-building"></i> Recursos Globales S.A.</h1>
                <p>Sistema de Gestión de Stock</p>
            </div>
            <div class="remito-number">
                <div class="number">
                    <?php echo htmlspecialchars($remito['numero_remito']); ?>
                </div>
                <div class="date">
                    <i class="fas fa-calendar"></i>
                    <?php echo date('d/m/Y H:i', strtotime($remito['fecha_emision'])); ?>
                </div>
            </div>
        </div>

        <div class="remito-body">
            <div class="info-grid">
                <div class="info-box">
                    <label>Origen</label>
                    <div class="value"><i class="fas fa-building"></i> Oficina Central</div>
                </div>
                <div class="info-box">
                    <label>Destino</label>
                    <div class="value"><i class="fas fa-hard-hat"></i>
                        <?php echo htmlspecialchars($remito['nombre_cuadrilla']); ?>
                    </div>
                </div>
            </div>

            <table class="materials-table">
                <thead>
                    <tr>
                        <th style="width: 15%;">Código</th>
                        <th style="width: 55%;">Material</th>
                        <th style="width: 15%; text-align: right;">Cantidad</th>
                        <th style="width: 15%;">Unidad</th>
                    </tr>
                </thead>
                <tbody>
                    <?php foreach ($detalles as $item): ?>
                        <tr>
                            <td><code><?php echo htmlspecialchars($item['codigo'] ?: '-'); ?></code></td>
                            <td><strong>
                                    <?php echo htmlspecialchars($item['material']); ?>
                                </strong></td>
                            <td style="text-align: right;">
                                <span class="qty">
                                    <?php echo number_format($item['cantidad'], 2); ?>
                                </span>
                            </td>
                            <td><span class="unit">
                                    <?php echo htmlspecialchars($item['unidad_medida']); ?>
                                </span></td>
                        </tr>
                    <?php endforeach; ?>
                </tbody>
            </table>

            <?php if (!empty($remito['observaciones'])): ?>
                <div class="info-box" style="margin-bottom: 20px;">
                    <label>Observaciones</label>
                    <div class="value">
                        <?php echo htmlspecialchars($remito['observaciones']); ?>
                    </div>
                </div>
            <?php endif; ?>

            <div class="signatures">
                <div class="signature-box">
                    <div class="signature-line"></div>
                    <div class="signature-label">
                        <strong>Entregó</strong><br>
                        <?php echo htmlspecialchars($remito['usuario_emision'] ?: 'Almacén'); ?>
                    </div>
                </div>
                <div class="signature-box">
                    <div class="signature-line"></div>
                    <div class="signature-label">
                        <strong>Recibió</strong><br>
                        Responsable de Cuadrilla
                    </div>
                </div>
            </div>
        </div>

        <div class="actions">
            <a href="../stock/index.php" class="btn btn-outline">
                <i class="fas fa-arrow-left"></i> Volver al Stock
            </a>
            <div>
                <span class="success-badge">
                    <i class="fas fa-check-circle"></i> Transferencia completada
                </span>
                <button onclick="window.print()" class="btn btn-primary" style="margin-left: 10px;">
                    <i class="fas fa-print"></i> Imprimir Remito
                </button>
            </div>
        </div>
    </div>
</body>

</html>

================================================================================
 MODULE: MOVIMIENTOS
 FILE: movimientos\save.php
================================================================================
<?php
// [!] ARQUITECTURA: Endpoint de movimientos de stock con seguridad
// [→] EDITAR AQUÍ: Rutas de inclusión si cambia la estructura
require_once '../../config/database.php';
require_once '../../includes/auth.php';

// [✓] AUDITORÍA CRUD: Verificación de sesión obligatoria
verificarSesion();

if ($_SERVER['REQUEST_METHOD'] == 'POST') {
    require_once '../../includes/classes/StockMover.php';

    $mover = new StockMover($pdo);

    try {
        $result = $mover->processBatch($_POST);

        // Check if a remito was generated and redirect requested
        if (is_array($result) && isset($result['id_remito']) && !empty($_POST['redirect_to_remito'])) {
            header("Location: remito.php?id=" . $result['id_remito']);
        } else {
            header("Location: ../stock/index.php?msg=success_bulk");
        }
    } catch (Exception $e) {
        // Log Error?
        $error = urlencode($e->getMessage());
        header("Location: form.php?msg=error&details=$error");
    }
}

?>

================================================================================
 MODULE: ODT
 FILE: odt\bulk_action.php
================================================================================
<?php
/**
 * [!] ARCH: Handler para acciones masivas en ODTs
 * [✓] AUDIT: Recepción de JSON, validación y ejecución por lotes
 */
require_once '../../includes/auth.php';

// [✓] AUDIT: Verificar permisos y sesión
if (!verificarSesion(false) || !tienePermiso('odt')) {
    echo json_encode(['success' => false, 'message' => 'Sesión expirada o sin permisos']);
    exit();
}

// Recibir datos JSON
$input = file_get_contents('php://input');
$data = json_decode($input, true);

if (!$data || empty($data['ids']) || empty($data['estado'])) {
    echo json_encode(['success' => false, 'message' => 'Datos insuficientes']);
    exit();
}

$ids = $data['ids'];
$nuevoEstado = $data['estado'];
$validEstados = ['Sin Programar', 'Programación Solicitada', 'Programado', 'Ejecución', 'Ejecutado', 'Precertificada', 'Finalizado'];

if (!in_array($nuevoEstado, $validEstados)) {
    echo json_encode(['success' => false, 'message' => 'Estado inválido']);
    exit();
}

try {
    $pdo->beginTransaction();

    // Preparar la consulta
    $placeholders = str_repeat('?,', count($ids) - 1) . '?';

    // [!] LOGICA DE NEGOCIO: Si el estado es 'Programado', calculamos fecha de vencimiento
    if ($nuevoEstado === 'Programado') {
        // Update con JOIN para obtener tiempo límite de la tipología
        // Se asume MySQL/MariaDB
        $sql = "UPDATE odt_maestro o
                LEFT JOIN tipos_trabajos t ON o.id_tipologia = t.id_tipologia
                SET o.estado_gestion = ?,
                    o.fecha_vencimiento = CASE 
                        WHEN t.tiempo_limite_dias > 0 THEN DATE_ADD(CURRENT_DATE, INTERVAL t.tiempo_limite_dias DAY)
                        ELSE o.fecha_vencimiento -- Si no hay límite definido, mantenemos (o podríamos poner hoy)
                    END
                WHERE o.id_odt IN ($placeholders)";
    } else {
        // Update simple para otros estados
        $sql = "UPDATE odt_maestro SET estado_gestion = ? WHERE id_odt IN ($placeholders)";
    }

    $stmt = $pdo->prepare($sql);

    // Ejecutar con el estado y los IDs
    $params = array_merge([$nuevoEstado], $ids);
    $stmt->execute($params);

    $pdo->commit();
    echo json_encode(['success' => true, 'count' => $stmt->rowCount()]);

} catch (Exception $e) {
    if ($pdo->inTransaction()) {
        $pdo->rollBack();
    }
    echo json_encode(['success' => false, 'message' => 'Error de base de datos: ' . $e->getMessage()]);
}
?>

================================================================================
 MODULE: ODT
 FILE: odt\create_table_odt_fotos.php
================================================================================
<?php
require_once '../../config/database.php';

try {
    $sql = "CREATE TABLE IF NOT EXISTS odt_fotos (
        id_foto INT AUTO_INCREMENT PRIMARY KEY,
        id_odt INT NOT NULL,
        tipo VARCHAR(50) NOT NULL,
        ruta VARCHAR(255) NOT NULL,
        fecha_subida DATETIME DEFAULT CURRENT_TIMESTAMP,
        INDEX (id_odt)
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;";

    $pdo->exec($sql);
    echo "Table 'odt_fotos' created successfully (or already exists).";
} catch (PDOException $e) {
    echo "Error creating table: " . $e->getMessage();
}
?>

================================================================================
 MODULE: ODT
 FILE: odt\delete.php
================================================================================
<?php
/**
 * [!] ARCH: Endpoint para eliminar ODT
 * [→] EDITAR: Cambiar a borrado lógico si es necesario
 * [✓] AUDIT: Confirmación requerida en frontend + verificación de existencia
 */
require_once '../../config/database.php';
require_once '../../includes/auth.php';

// [✓] AUDIT: Verificar sesión
verificarSesion();

$id = $_GET['id'] ?? null;

if (!$id || !is_numeric($id)) {
    header('Location: index.php?msg=error');
    exit;
}

$id = intval($id);

try {
    // [!] ARCH: Obtener datos antes de eliminar para auditoría
    $infoStmt = $pdo->prepare("SELECT nro_odt_assa FROM odt_maestro WHERE id_odt = ?");
    $infoStmt->execute([$id]);
    $nro_odt = $infoStmt->fetchColumn();

    if (!$nro_odt) {
        $_SESSION['error'] = 'ODT no encontrada.';
        header('Location: index.php?msg=error');
        exit;
    }

    // [!] ARCH: Verificar integridad referencial
    // (Agregar verificaciones si hay tablas relacionadas como partes diarios, materiales asignados, etc.)

    // [✓] AUDIT: Eliminar ODT
    $stmt = $pdo->prepare("DELETE FROM odt_maestro WHERE id_odt = ?");
    $stmt->execute([$id]);

    // [✓] AUDIT: Registrar eliminación
    registrarAccion('ELIMINAR', 'odt_maestro', "ODT eliminada: $nro_odt", $id);

    header('Location: index.php?msg=deleted');

} catch (PDOException $e) {
    // [!] ARCH: No exponer errores SQL
    error_log("Error en odt/delete.php: " . $e->getMessage());
    $_SESSION['error'] = 'Error al eliminar la ODT.';
    header('Location: index.php?msg=error');
}

exit;
?>

================================================================================
 MODULE: ODT
 FILE: odt\form.php
================================================================================
<?php
/**
 * [!] ARCH: Formulario de ODT para Inspector ASSA
 * [→] EDITAR: Campos y validaciones según necesidad
 * [✓] AUDIT: Mobile-first con botones táctiles grandes
 */
require_once '../../config/database.php';
require_once '../../includes/header.php';

// [✓] AUDIT: Verificar permisos
if (!tienePermiso('odt')) {
    header("Location: /APP-Prueba/index.php?msg=forbidden");
    exit();
}

$id = $_GET['id'] ?? null;
$odt = null;

if ($id) {
    $stmt = $pdo->prepare("SELECT * FROM odt_maestro WHERE id_odt = ?");
    $stmt->execute([$id]);
    $odt = $stmt->fetch(PDO::FETCH_ASSOC);

    if (!$odt) {
        header("Location: index.php?msg=error");
        exit();
    }
}

// [→] EDITAR: Obtener tipos de trabajo activos
$tipos = $pdo->query("SELECT id_tipologia, nombre, codigo_trabajo, tiempo_limite_dias FROM tipos_trabajos WHERE estado = 1 ORDER BY codigo_trabajo, nombre")->fetchAll(PDO::FETCH_ASSOC);
?>

<!-- [!] PWA-OFFLINE: Indicador de estado -->
<div id="offlineIndicator" class="offline-indicator">
    📶 Sin conexión - Los cambios se guardarán localmente
</div>

<div style="max-width: 600px; margin: 0 auto; padding: 15px;">
    <div class="card" style="padding: 20px;">

        <!-- Header -->
        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 25px;">
            <a href="index.php" class="btn"
                style="min-height: 48px; min-width: 48px; display: flex; align-items: center; justify-content: center; background: var(--bg-secondary); border: 1px solid rgba(255,255,255,0.1); color: var(--text-primary);">
                <i class="fas fa-arrow-left" style="font-size: 1.2em;"></i>
            </a>
            <div>
                <h1 style="margin: 0; font-size: 1.3em; color: var(--text-primary);">
                    <i class="fas fa-clipboard-list" style="color: var(--accent-primary);"></i>
                    <?php echo $id ? 'Editar' : 'Nueva'; ?> ODT
                </h1>
                <p style="margin: 5px 0 0; color: var(--text-secondary); font-size: 0.85em;">
                    <?php echo $id ? 'Modificar orden de trabajo' : 'Registrar nueva orden de trabajo'; ?>
                </p>
            </div>
        </div>

        <!-- [!] PWA-OFFLINE: Formulario con data-offline para sync -->
        <form id="odtForm" action="save.php" method="POST" enctype="multipart/form-data" data-offline="true">
            <?php if ($id): ?>
                <input type="hidden" name="id_odt" value="<?php echo $id; ?>">
            <?php endif; ?>

            <!-- Datos Principales -->
            <h3
                style="border-bottom: 2px solid var(--color-primary); padding-bottom: 8px; color: var(--color-primary); font-size: 1em; margin-bottom: 15px;">
                <i class="fas fa-clipboard"></i> Datos de la ODT
            </h3>

            <!-- Nro ODT ASSA -->
            <div style="margin-bottom: 20px;">
                <label class="input-label">Número ODT ASSA *</label>
                <input type="text" name="nro_odt_assa" required
                    value="<?php echo htmlspecialchars($odt['nro_odt_assa'] ?? ''); ?>"
                    placeholder="Ej: ODT-2026-001234" class="input-inspector">
            </div>

            <!-- Dirección -->
            <div style="margin-bottom: 20px;">
                <label class="input-label">Dirección del Trabajo *</label>
                <input type="text" name="direccion" required
                    value="<?php echo htmlspecialchars($odt['direccion'] ?? ''); ?>"
                    placeholder="Ej: Av. Corrientes 1234, CABA" class="input-inspector">
            </div>

            <!-- Tipo de Trabajo -->
            <div style="margin-bottom: 20px;">
                <label class="input-label">Tipo de Trabajo</label>
                <select name="id_tipologia" id="selectTipologia" class="input-inspector">
                    <option value="">-- Seleccionar --</option>
                    <?php foreach ($tipos as $t): ?>
                        <option value="<?php echo $t['id_tipologia']; ?>"
                            data-limit="<?php echo $t['tiempo_limite_dias'] ?? 0; ?>" <?php echo ($odt['id_tipologia'] ?? '') == $t['id_tipologia'] ? 'selected' : ''; ?>>
                            <?php echo $t['codigo_trabajo'] ? "[{$t['codigo_trabajo']}] " : ''; ?>
                            <?php echo $t['nombre']; ?>
                        </option>
                    <?php endforeach; ?>
                </select>
            </div>

            <!-- Prioridad y Estado -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                <div>
                    <label class="input-label">Prioridad</label>
                    <select name="prioridad" class="input-inspector">
                        <option value="Normal" <?php echo ($odt['prioridad'] ?? '') === 'Normal' ? 'selected' : ''; ?>>
                            Normal</option>
                        <option value="Urgente" <?php echo ($odt['prioridad'] ?? '') === 'Urgente' ? 'selected' : ''; ?>>
                            🔴
                            Urgente</option>
                    </select>
                </div>
                <div>
                    <label class="input-label">Estado</label>
                    <?php
                    // [!] ARCH: El Inspector ASSA tiene prohibido cambiar el estado
                    $readOnlyStatus = ($_SESSION['usuario_rol'] === 'Inspector ASSA' && !$id) ? 'disabled' : '';
                    if ($readOnlyStatus)
                        echo '<input type="hidden" name="estado_gestion" value="Sin Programar">';
                    ?>
                    <select name="estado_gestion" id="selectEstado" class="input-inspector" <?php echo $readOnlyStatus; ?>>
                        <option value="Sin Programar" <?php echo ($odt['estado_gestion'] ?? 'Sin Programar') === 'Sin Programar' ? 'selected' : ''; ?>>Sin Programar</option>
                        <option value="Programación Solicitada" <?php echo ($odt['estado_gestion'] ?? '') === 'Programación Solicitada' ? 'selected' : ''; ?>>Programación Solicitada</option>
                        <option value="Programado" <?php echo ($odt['estado_gestion'] ?? '') === 'Programado' ? 'selected' : ''; ?>>Programado</option>
                        <option value="Ejecución" <?php echo ($odt['estado_gestion'] ?? '') === 'Ejecución' ? 'selected' : ''; ?>>Ejecución</option>
                        <option value="Ejecutado" <?php echo ($odt['estado_gestion'] ?? '') === 'Ejecutado' ? 'selected' : ''; ?>>Ejecutado</option>
                        <option value="Precertificada" <?php echo ($odt['estado_gestion'] ?? '') === 'Precertificada' ? 'selected' : ''; ?>>Precertificada</option>
                        <option value="Finalizado" <?php echo ($odt['estado_gestion'] ?? '') === 'Finalizado' ? 'selected' : ''; ?>>Finalizado</option>
                    </select>
                    <?php if ($readOnlyStatus): ?>
                        <small style="color: var(--color-info); font-size: 0.75em;"><i class="fas fa-info-circle"></i>
                            Estado forzado por rol.</small>
                    <?php endif; ?>
                </div>
            </div>

            <!-- Fechas -->
            <h3
                style="border-bottom: 2px solid #666; padding-bottom: 8px; color: #666; font-size: 1em; margin: 25px 0 15px;">
                <i class="fas fa-calendar-alt"></i> Plazos
            </h3>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                <div>
                    <label class="input-label">Fecha Inicio Plazo</label>
                    <!-- [!] AUTO: Se establece hoy por defecto si nueva -->
                    <input type="date" name="fecha_inicio_plazo" id="fechaInicio"
                        value="<?php echo $odt['fecha_inicio_plazo'] ?? date('Y-m-d'); ?>" class="input-inspector">
                </div>
                <div>
                    <label class="input-label">Fecha Vencimiento</label>
                    <input type="date" name="fecha_vencimiento" id="fechaVencimiento"
                        value="<?php echo $odt['fecha_vencimiento'] ?? ''; ?>" class="input-inspector">
                    <small style="color: var(--text-secondary); font-size: 0.75em; display: block; margin-top: 5px;">
                        <i class="fas fa-magic"></i> Se calcula autom. al pasar a 'Programado'
                    </small>
                </div>
            </div>

            <!-- Avance -->
            <div style="margin-bottom: 20px;">
                <label class="input-label">Avance / Descripción</label>
                <textarea name="avance" rows="3"
                    placeholder="Descripción del trabajo realizado o porcentaje de avance..."
                    class="input-inspector"><?php echo htmlspecialchars($odt['avance'] ?? ''); ?></textarea>
            </div>

            <!-- Fotos -->
            <h3
                style="border-bottom: 2px solid var(--accent-primary); padding-bottom: 8px; color: var(--accent-primary); font-size: 1em; margin: 25px 0 15px;">
                <i class="fas fa-camera"></i> Registro Fotográfico
            </h3>

            <!-- Fotos Existentes (si hay) -->
            <?php if ($id): ?>
                <?php
                $stmtFoto = $pdo->prepare("SELECT * FROM odt_fotos WHERE id_odt = ?");
                $stmtFoto->execute([$id]);
                $fotosExistentes = $stmtFoto->fetchAll(PDO::FETCH_ASSOC);
                ?>
                <?php if ($fotosExistentes): ?>
                    <div
                        style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; margin-bottom: 20px;">
                        <?php foreach ($fotosExistentes as $f): ?>
                            <div style="position: relative;">
                                <img src="../../<?php echo $f['ruta']; ?>"
                                    style="width: 100%; height: 80px; object-fit: cover; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1);">
                                <span
                                    style="position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.6); color: white; font-size: 8px; text-align: center; padding: 2px; border-bottom-left-radius: 8px; border-bottom-right-radius: 8px;">
                                    <?php echo strtoupper($f['tipo']); ?>
                                </span>
                            </div>
                        <?php endforeach; ?>
                    </div>
                <?php endif; ?>
            <?php endif; ?>

            <div style="margin-bottom: 20px;">
                <label class="input-label">Foto de la ODT *</label>
                <input type="file" name="foto_odt" accept="image/*" class="input-inspector" <?php echo !$id ? 'required' : ''; ?>>
            </div>

            <div style="margin-bottom: 20px;">
                <label class="input-label">Foto del Trabajo *</label>
                <input type="file" name="foto_trabajo" accept="image/*" class="input-inspector" <?php echo !$id ? 'required' : ''; ?>>
            </div>

            <!-- Fotos Extras -->
            <div id="extraPhotosContainer">
                <!-- Aquí se agregarán dinámicamente -->
            </div>

            <button type="button" onclick="addExtraPhoto()" class="btn-inspector-secondary"
                style="margin-bottom: 25px; border-style: dashed;">
                <i class="fas fa-plus-circle"></i> Agregar más fotos
            </button>

            <!-- Inspector -->
            <div style="margin-bottom: 25px;">
                <label class="input-label">Inspector ASSA</label>
                <input type="text" name="inspector"
                    value="<?php echo htmlspecialchars($odt['inspector'] ?? ($_SESSION['user_name'] ?? '')); ?>"
                    placeholder="Nombre del inspector" class="input-inspector">
            </div>

            <!-- Botones -->
            <div style="display: flex; flex-direction: column; gap: 12px;">
                <button type="submit" class="btn-inspector-primary">
                    <span class="online-text">💾 Guardar ODT</span>
                    <span class="offline-text">📱 Guardar Local</span>
                </button>
                <a href="index.php" class="btn-inspector-secondary">
                    Cancelar
                </a>
            </div>
        </form>
    </div>
</div>

<style>
    /* [→] EDITAR INTERFAZ: Estilos Mobile-First para Inspector */
    .offline-indicator {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        padding: 10px;
        background: #f39c12;
        color: white;
        text-align: center;
        font-weight: bold;
        z-index: 9999;
        display: none;
    }

    body.offline .offline-indicator {
        display: block;
    }

    body.offline {
        padding-top: 45px;
    }

    body.offline .online-text {
        display: none;
    }

    body.offline .offline-text {
        display: inline !important;
    }

    .offline-text {
        display: none;
    }

    .input-label {
        display: block;
        font-weight: 600;
        margin-bottom: 8px;
        color: var(--text-secondary);
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    /* [✓] AUDIT: Inputs grandes para uso táctil */
    .input-inspector {
        width: 100%;
        padding: 16px;
        font-size: 1.1rem;
        /* Evita zoom en Android */
        border: 1px solid rgba(255, 255, 255, 0.1);
        background: var(--bg-tertiary);
        color: var(--text-primary);
        border-radius: var(--border-radius-md);
        transition: all 0.2s ease;
    }

    .input-inspector:focus {
        border-color: var(--accent-primary);
        outline: none;
        background: var(--bg-secondary);
        box-shadow: 0 0 0 3px var(--accent-glow);
    }

    /* [✓] AUDIT: Botones extra grandes 60px para calle */
    .btn-inspector-primary {
        width: 100%;
        min-height: 60px;
        padding: 18px;
        font-size: 18px;
        font-weight: 700;
        text-transform: uppercase;
        background: var(--accent-primary);
        color: var(--color-primary-dark);
        border: none;
        border-radius: var(--border-radius-md);
        cursor: pointer;
        letter-spacing: 1px;
        box-shadow: var(--shadow-md);
        transition: all 0.2s ease;
    }

    .btn-inspector-primary:hover {
        transform: translateY(-2px);
        background: var(--accent-secondary);
        box-shadow: var(--glow-primary);
    }

    .btn-inspector-secondary {
        width: 100%;
        min-height: 50px;
        padding: 15px;
        font-size: 16px;
        background: transparent;
        color: var(--text-secondary);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: var(--border-radius-md);
        text-align: center;
        text-decoration: none;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
    }

    .btn-inspector-secondary:hover {
        background: rgba(255, 255, 255, 0.05);
        color: var(--text-primary);
    }
</style>

<script>
    // [!] ARCH: Detección de conexión
    function updateConnectionStatus() {
        document.body.classList.toggle('offline', !navigator.onLine);
    }
    window.addEventListener('online', updateConnectionStatus);
    window.addEventListener('offline', updateConnectionStatus);
    updateConnectionStatus();

    let extraPhotoCount = 0;
    function addExtraPhoto() {
        extraPhotoCount++;
        const container = document.getElementById('extraPhotosContainer');
        const div = document.createElement('div');
        div.style.marginBottom = '20px';
        div.innerHTML = `
            <div style="display: flex; gap: 10px; align-items: flex-end;">
                <div style="flex: 1;">
                    <label class="input-label">Foto Extra #${extraPhotoCount}</label>
                    <input type="file" name="fotos_extras[]" accept="image/*" class="input-inspector">
                </div>
                <button type="button" onclick="this.parentElement.parentElement.remove()" class="btn" style="height: 54px; background: #e74c3c; color: white; border-radius: 8px; width: 50px;">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
        container.appendChild(div);
    }

    // [!] AUTO-FILL: Calcular Vencimiento
    const selectEstado = document.getElementById('selectEstado');
    const selectTipologia = document.getElementById('selectTipologia');
    const inputVencimiento = document.getElementById('fechaVencimiento');

    function checkAutoFillDate() {
        const estado = selectEstado.value;
        const tipoOption = selectTipologia.options[selectTipologia.selectedIndex];

        // Solo si cambiamos a Programado y tenemos un tipo seleccionado
        if (estado === 'Programado' && tipoOption && tipoOption.dataset.limit) {
            const diasLimite = parseInt(tipoOption.dataset.limit) || 0;
            if (diasLimite > 0) {
                const hoy = new Date();
                const venci = new Date(hoy);
                venci.setDate(hoy.getDate() + diasLimite);

                // Formato YYYY-MM-DD
                const yyyy = venci.getFullYear();
                const mm = String(venci.getMonth() + 1).padStart(2, '0');
                const dd = String(venci.getDate()).padStart(2, '0');

                inputVencimiento.value = `${yyyy}-${mm}-${dd}`;

                // Visual feedback
                inputVencimiento.style.borderColor = 'var(--accent-primary)';
                setTimeout(() => {
                    inputVencimiento.style.borderColor = 'rgba(255, 255, 255, 0.1)';
                }, 1000);
            }
        }
    }

    if (selectEstado && selectTipologia) {
        selectEstado.addEventListener('change', checkAutoFillDate);
        selectTipologia.addEventListener('change', () => {
            // Si ya está en programado y cambio el tipo, recalcular
            if (selectEstado.value === 'Programado') checkAutoFillDate();
        });
    }

    // [!] PWA-OFFLINE: Interceptar submit para modo offline
    document.getElementById('odtForm').addEventListener('submit', async function (e) {
        if (!navigator.onLine) {
            e.preventDefault();

            const formData = new FormData(this);
            const datos = Object.fromEntries(formData);

            // Validación cliente
            if (!datos.nro_odt_assa || !datos.direccion) {
                alert('❌ Número ODT y Dirección son obligatorios');
                return;
            }

            // [!] FALLBACK: Guardar para sincronizar después
            const pending = JSON.parse(localStorage.getItem('odt_pending_sync') || '[]');
            pending.push({
                ...datos,
                _timestamp: Date.now(),
                _action: datos.id_odt ? 'UPDATE' : 'CREATE'
            });
            localStorage.setItem('odt_pending_sync', JSON.stringify(pending));

            alert('📱 ODT guardada localmente.\nSe sincronizará al recuperar conexión.');
            window.location.href = 'index.php';
        }
    });
</script>

<?php require_once '../../includes/footer.php'; ?>

================================================================================
 MODULE: ODT
 FILE: odt\index.php
================================================================================
<?php
/**
 * [!] ARCH: Módulo de Gestión de ODTs para Inspector ASSA
 * [→] EDITAR: Configurar permisos según roles
 * [✓] AUDIT: Lista con filtros, métricas y alerta de vencimiento
 */
require_once '../../config/database.php';
require_once '../../includes/header.php';

// [✓] AUDIT: Verificar permisos
if (!tienePermiso('odt')) {
    header("Location: /APP-Prueba/index.php?msg=forbidden");
    exit();
}

// [!] ARCH: Obtener Rol Actual
$rolActual = $_SESSION['usuario_rol'] ?? '';

// [!] ARCH: Obtener ODTs con info de tipología
$sql = "SELECT o.*, t.nombre as tipo_trabajo, t.codigo_trabajo
        FROM odt_maestro o
        LEFT JOIN tipos_trabajos t ON o.id_tipologia = t.id_tipologia
        ORDER BY 
            CASE o.prioridad WHEN 'Urgente' THEN 0 ELSE 1 END,
            o.fecha_vencimiento ASC";
$odts = $pdo->query($sql)->fetchAll(PDO::FETCH_ASSOC);

// [→] EDITAR: Tipos de trabajo para filtro
$tipos = $pdo->query("SELECT id_tipologia, nombre, codigo_trabajo FROM tipos_trabajos WHERE estado = 1 ORDER BY nombre")->fetchAll(PDO::FETCH_ASSOC);

// Métricas
$total = count($odts);
$sinProgramar = count(array_filter($odts, fn($o) => $o['estado_gestion'] === 'Sin Programar'));
$progSolicitada = count(array_filter($odts, fn($o) => $o['estado_gestion'] === 'Programación Solicitada'));
$programados = count(array_filter($odts, fn($o) => $o['estado_gestion'] === 'Programado'));
$ejecucion = count(array_filter($odts, fn($o) => $o['estado_gestion'] === 'Ejecución'));
$ejecutados = count(array_filter($odts, fn($o) => $o['estado_gestion'] === 'Ejecutado'));
$precertificada = count(array_filter($odts, fn($o) => $o['estado_gestion'] === 'Precertificada'));
$urgentes = count(array_filter($odts, fn($o) => $o['prioridad'] === 'Urgente'));

// [!] ARCH: Calcular ODTs próximas a vencer (7 días)
$hoy = new DateTime();
$proximasVencer = count(array_filter($odts, function ($o) use ($hoy) {
    if (empty($o['fecha_vencimiento']) || $o['estado_gestion'] === 'Finalizado')
        return false;
    $venc = new DateTime($o['fecha_vencimiento']);
    $diff = $hoy->diff($venc)->days;
    return $venc >= $hoy && $diff <= 7;
}));
?>

<!-- [!] PWA-OFFLINE: Indicador de estado de conexión -->
<div id="offlineIndicator" class="offline-indicator">
    📶 Sin conexión - Los cambios se guardarán localmente
</div>

<div class="container-fluid" style="padding: 0 20px;">

    <!-- Header -->
    <div
        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
        <div>
            <h2 style="margin: 0; font-size: 1.4em; color: var(--text-primary);"><i class="fas fa-clipboard-list"
                    style="color: var(--accent-primary);"></i> Gestión de ODTs</h2>
            <p style="margin: 5px 0 0; color: var(--text-secondary); font-size: 0.9em;">
                <?php echo ($rolActual === 'Inspector ASSA') ? 'Modo de Carga Directa - Inspector' : 'Control de Órdenes de Trabajo ASSA'; ?>
            </p>
        </div>
        <div style="display: flex; gap: 10px; align-items: center;">
            <!-- [!] PWA-OFFLINE: Badge de pendientes -->
            <div id="pendingBadge" class="pending-badge" style="display: none;">
                📱 <span id="pendingCount">0</span> pendientes
            </div>

            <!-- [!] ARCH: Botón "Nueva ODT" prominente para Inspector -->
            <?php if (tienePermiso('odt')): ?>
                <a href="form.php" class="btn btn-primary"
                    style="min-height: 55px; min-width: 140px; display: flex; align-items: center; gap: 10px; font-weight: 600; box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);">
                    <i class="fas fa-plus-circle" style="font-size: 1.2em;"></i> Nueva ODT
                </a>
            <?php endif; ?>
        </div>
    </div>

    <!-- Métricas -->
    <div class="metrics-row">
        <!-- Total -->
        <div class="metric-mini" onclick="setQuickFilter('estado', '')">
            <div class="metric-icon primary">
                <i class="fas fa-layer-group"></i>
            </div>
            <div class="metric-content">
                <span class="metric-val"><?php echo $total; ?></span>
                <span class="metric-lbl">Total</span>
            </div>
        </div>

        <!-- Sin Programar -->
        <div class="metric-mini" onclick="setQuickFilter('estado', 'Sin Programar')">
            <div class="metric-icon warning">
                <i class="fas fa-stopwatch"></i>
            </div>
            <div class="metric-content">
                <span class="metric-val"><?php echo $sinProgramar; ?></span>
                <span class="metric-lbl">Sin Prog.</span>
            </div>
        </div>

        <!-- Programación Solicitada -->
        <div class="metric-mini" onclick="setQuickFilter('estado', 'Programación Solicitada')">
            <div class="metric-icon info">
                <i class="fas fa-paper-plane"></i>
            </div>
            <div class="metric-content">
                <span class="metric-val"><?php echo $progSolicitada; ?></span>
                <span class="metric-lbl">Prog. Solicit.</span>
            </div>
        </div>

        <!-- Programados -->
        <div class="metric-mini" onclick="setQuickFilter('estado', 'Programado')">
            <div class="metric-icon info">
                <i class="fas fa-calendar-check"></i>
            </div>
            <div class="metric-content">
                <span class="metric-val"><?php echo $programados; ?></span>
                <span class="metric-lbl">Programados</span>
            </div>
        </div>

        <!-- Ejecución -->
        <div class="metric-mini" onclick="setQuickFilter('estado', 'Ejecución')">
            <div class="metric-icon success">
                <i class="fas fa-running"></i>
            </div>
            <div class="metric-content">
                <span class="metric-val"><?php echo $ejecucion; ?></span>
                <span class="metric-lbl">Ejecución</span>
            </div>
        </div>

        <!-- Ejecutados -->
        <div class="metric-mini" onclick="setQuickFilter('estado', 'Ejecutado')">
            <div class="metric-icon success">
                <i class="fas fa-check-double"></i>
            </div>
            <div class="metric-content">
                <span class="metric-val"><?php echo $ejecutados; ?></span>
                <span class="metric-lbl">Ejecutados</span>
            </div>
        </div>

        <!-- Precertificada -->
        <div class="metric-mini" onclick="setQuickFilter('estado', 'Precertificada')">
            <div class="metric-icon" style="background: rgba(0, 150, 136, 0.15); color: #009688;">
                <i class="fas fa-certificate"></i>
            </div>
            <div class="metric-content">
                <span class="metric-val"><?php echo $precertificada; ?></span>
                <span class="metric-lbl">Precertif.</span>
            </div>
        </div>

        <!-- Urgentes -->
        <?php if ($urgentes > 0): ?>
            <div class="metric-mini" onclick="setQuickFilter('prioridad', 'Urgente')">
                <div class="metric-icon danger">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="metric-content">
                    <span class="metric-val"><?php echo $urgentes; ?></span>
                    <span class="metric-lbl">Urgentes</span>
                </div>
            </div>
        <?php endif; ?>
    </div>


    <!-- Mensajes -->
    <?php if (isset($_GET['msg'])): ?>
        <div class="card"
            style="padding: 15px; margin-bottom: 20px; border-left: 4px solid <?php echo $_GET['msg'] == 'saved' ? 'var(--color-success)' : ($_GET['msg'] == 'deleted' ? 'var(--color-warning)' : 'var(--color-danger)'); ?>; 
            background: var(--bg-secondary); color: var(--text-primary); display: flex; align-items: center; gap: 12px;">
            <?php
            if ($_GET['msg'] == 'saved')
                echo "<i class='fas fa-check-circle' style='color: var(--color-success)'></i> ODT guardada correctamente.";
            if ($_GET['msg'] == 'deleted')
                echo "<i class='fas fa-trash' style='color: var(--color-warning)'></i> ODT eliminada.";
            if ($_GET['msg'] == 'error')
                echo "<i class='fas fa-exclamation-circle' style='color: var(--color-danger)'></i> Error en la operación.";
            ?>
        </div>
    <?php endif; ?>

    <!-- Filtros -->
    <div class="card" style="margin-bottom: 25px; padding: 15px;">
        <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
            <!-- Búsqueda Principal -->
            <div style="flex: 2; min-width: 250px;">
                <input type="text" id="searchInput" onkeyup="filterODTs()"
                    placeholder="🔍 Buscar por Nro ODT, Dirección o Inspector..." class="filter-select"
                    style="margin-bottom: 0;">
            </div>

            <!-- Filtro por Estado -->
            <div style="flex: 1; min-width: 180px;">
                <select id="filterEstado" onchange="handleFilterChange()" class="filter-select">
                    <option value="">Estado: Todos</option>
                    <option value="Sin Programar">Sin Programar</option>
                    <option value="Programación Solicitada">Programación Solicitada</option>
                    <option value="Programado">Programado</option>
                    <option value="Ejecución">Ejecución</option>
                    <option value="Ejecutado">Ejecutado</option>
                    <option value="Precertificada">Precertificada</option>
                    <option value="Finalizado">Finalizado</option>
                </select>
            </div>

            <!-- Filtro por Trabajos -->
            <div style="flex: 1; min-width: 200px;">
                <select id="filterTrabajo" onchange="handleFilterChange()" class="filter-select">
                    <option value="">Trabajo: Todos</option>
                    <?php foreach ($tipos as $t): ?>
                        <option value="<?php echo htmlspecialchars($t['nombre']); ?>">
                            <?php echo $t['codigo_trabajo'] ? "[{$t['codigo_trabajo']}] " : ""; ?>
                            <?php echo htmlspecialchars($t['nombre']); ?>
                        </option>
                    <?php endforeach; ?>
                </select>
            </div>
        </div>

        <!-- Bulk Actions Toolbar (Themed) -->
        <div id="bulkActions" class="card"
            style="display: none; margin-bottom: 20px; padding: 15px; background: var(--bg-secondary); border: 1px solid var(--accent-primary); align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 15px; border-radius: var(--border-radius-md);">
            <div style="display: flex; align-items: center; gap: 10px;">
                <span style="font-weight: bold; color: var(--accent-primary);"><i class="fas fa-check-double"></i>
                    Seleccionados:
                    <span id="selectedCount">0</span></span>
            </div>
            <div style="display: flex; gap: 10px; align-items: center;">
                <select id="bulkStatus" class="form-control-sm" style="min-width: 150px; padding: 8px;">
                    <option value="">-- Cambiar Estado --</option>
                    <option value="Sin Programar">Sin Programar</option>
                    <option value="Programación Solicitada">Programación Solicitada</option>
                    <option value="Programado">Programado</option>
                    <option value="Ejecución">Ejecución</option>
                    <option value="Ejecutado">Ejecutado</option>
                    <option value="Precertificada">Precertificada</option>
                    <option value="Finalizado">Finalizado</option>
                </select>
                <button onclick="applyBulkStatus()" class="btn btn-primary" style="min-height: 40px;">Aplicar</button>
            </div>
        </div>

        <!-- Tabla de ODTs -->
        <div class="card" style="padding: 15px; overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; min-width: 800px;">
                <thead>
                    <tr style="background: var(--color-primary-dark); color: white;">
                        <th style="padding: 12px; text-align: center; width: 40px;">
                            <input type="checkbox" id="selectAll" onclick="toggleAllCheckboxes()"
                                style="transform: scale(1.3);">
                        </th>
                        <th style="padding: 12px; text-align: left; width: 120px;">Nro ODT</th>
                        <th style="padding: 12px; text-align: left;">Dirección</th>
                        <th style="padding: 12px; text-align: left;">Tipo de Trabajo</th>
                        <th style="padding: 12px; text-align: center; width: 120px;">Estado</th>
                        <th style="padding: 12px; text-align: center; width: 100px;">Prioridad</th>
                        <th style="padding: 12px; text-align: left; width: 110px;">Vencimiento</th>
                        <th style="padding: 12px; text-align: center; width: 100px;">Acciones</th>
                    </tr>
                </thead>
                <tbody id="odtTableBody">
                    <?php if (empty($odts)): ?>
                        <tr>
                            <td colspan="8" style="padding: 40px; text-align: center; color: #999;">
                                <i class="fas fa-clipboard"
                                    style="font-size: 3em; margin-bottom: 15px; display: block;"></i>
                                No hay ODTs registradas
                            </td>
                        </tr>
                    <?php else: ?>
                        <?php foreach ($odts as $o):
                            // [!] ARCH: Calcular alerta de vencimiento
                            $alertaVenc = '';
                            $vencClass = '';
                            if (!empty($o['fecha_vencimiento']) && $o['estado_gestion'] !== 'Finalizado') {
                                $venc = new DateTime($o['fecha_vencimiento']);
                                $diff = $hoy->diff($venc);
                                $diasRestantes = $venc < $hoy ? -$diff->days : $diff->days;

                                if ($diasRestantes < 0) {
                                    $alertaVenc = '🔴';
                                    $vencClass = 'vencida';
                                } elseif ($diasRestantes <= 3) {
                                    $alertaVenc = '🟠';
                                    $vencClass = 'por-vencer';
                                } elseif ($diasRestantes <= 7) {
                                    $alertaVenc = '🟡';
                                    $vencClass = 'proxima';
                                }
                            }

                            // Colores por estado
                            $estadoColors = [
                                'Sin Programar' => ['bg' => '#fff3e0', 'color' => '#e65100'],
                                'Programación Solicitada' => ['bg' => '#e3f2fd', 'color' => '#1565c0'],
                                'Programado' => ['bg' => '#f3e5f5', 'color' => '#7b1fa2'],
                                'Ejecución' => ['bg' => '#e8f5e9', 'color' => '#2e7d32'],
                                'Ejecutado' => ['bg' => '#f1f8e9', 'color' => '#33691e'],
                                'Precertificada' => ['bg' => '#e0f2f1', 'color' => '#00796b'],
                                'Finalizado' => ['bg' => '#f5f5f5', 'color' => '#616161']
                            ];
                            $ec = $estadoColors[$o['estado_gestion']] ?? ['bg' => '#eee', 'color' => '#666'];
                            ?>
                            <tr class="odt-row <?php echo $vencClass; ?>"
                                data-search="<?php echo strtolower($o['nro_odt_assa'] . ' ' . $o['direccion'] . ' ' . ($o['inspector'] ?? '')); ?>"
                                data-estado="<?php echo $o['estado_gestion']; ?>"
                                data-prioridad="<?php echo $o['prioridad']; ?>"
                                data-trabajo="<?php echo htmlspecialchars($o['tipo_trabajo'] ?: ''); ?>"
                                style="border-bottom: 1px solid #eee;">
                                <td style="padding: 12px; text-align: center;">
                                    <input type="checkbox" class="odt-checkbox" value="<?php echo $o['id_odt']; ?>"
                                        onclick="updateBulkActionUI()" style="transform: scale(1.3);">
                                </td>
                                <td style="padding: 12px; font-weight: bold;">
                                    <?php echo htmlspecialchars($o['nro_odt_assa']); ?>
                                </td>
                                <td style="padding: 12px;">
                                    <div style="font-size: 0.95em;"><?php echo htmlspecialchars($o['direccion'] ?: '-'); ?>
                                    </div>
                                </td>
                                <td style="padding: 12px;">
                                    <div class="work-pill">
                                        <?php echo $o['codigo_trabajo'] ? "<strong>[{$o['codigo_trabajo']}]</strong> " : ""; ?>
                                        <?php echo htmlspecialchars($o['tipo_trabajo'] ?: '-'); ?>
                                    </div>
                                </td>
                                <td style="padding: 12px; text-align: center;">
                                    <span class="status-pill"
                                        style="background: <?php echo $ec['bg']; ?>; color: <?php echo $ec['color']; ?>;">
                                        <?php echo $o['estado_gestion']; ?>
                                    </span>
                                </td>
                                <td style="padding: 12px; text-align: center;">
                                    <?php if ($o['prioridad'] === 'Urgente'): ?>
                                        <span style="color: #d32f2f; font-weight: bold; font-size: 0.85em;">🔴 Urgente</span>
                                    <?php else: ?>
                                        <span style="color: #666; font-size: 0.85em;">Normal</span>
                                    <?php endif; ?>
                                </td>
                                <td style="padding: 12px;">
                                    <?php if ($o['fecha_vencimiento']): ?>
                                        <div style="font-size: 0.85em; display: flex; align-items: center; gap: 5px;">
                                            <?php echo $alertaVenc; ?>
                                            <?php echo date('d/m/Y', strtotime($o['fecha_vencimiento'])); ?>
                                        </div>
                                    <?php else: ?>
                                        -
                                    <?php endif; ?>
                                </td>
                                <td style="padding: 12px; text-align: center;">
                                    <div style="display: flex; gap: 5px; justify-content: center;">
                                        <a href="form.php?id=<?php echo $o['id_odt']; ?>" class="btn btn-outline"
                                            style="min-height: 35px; min-width: 35px; padding: 0; display: flex; align-items: center; justify-content: center;"
                                            title="Editar">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <button
                                            onclick="confirmDelete(<?php echo $o['id_odt']; ?>, '<?php echo addslashes($o['nro_odt_assa']); ?>')"
                                            class="btn"
                                            style="min-height: 35px; min-width: 35px; padding: 0; background: #fee; color: #d32f2f; border: 1px solid #fcc;"
                                            title="Eliminar">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        <?php endforeach; ?>
                    <?php endif; ?>
                </tbody>
            </table>
        </div>

        <div id="noResults" style="display:none; padding: 30px; text-align: center; color: #999;">
            No se encontraron ODTs con los filtros aplicados.
        </div>
    </div>

    <style>
        /* [→] EDITAR INTERFAZ: Estilos PWA Mobile-First */
        .offline-indicator {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 10px;
            background: #f39c12;
            color: white;
            text-align: center;
            font-weight: bold;
            z-index: 9999;
            display: none;
        }

        body.offline .offline-indicator {
            display: block;
        }

        body.offline {
            padding-top: 45px;
        }

        .pending-badge {
            background: #d32f2f;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
        }

        /* Alertas de vencimiento */
        .odt-card.vencida {
            background: #ffebee !important;
        }

        .odt-card.por-vencer {
            background: #fff8e1 !important;
        }

        .odt-card .vencida {
            color: #d32f2f;
            font-weight: bold;
        }

        .odt-card .por-vencer {
            color: #f57c00;
            font-weight: bold;
        }

        .odt-card .proxima {
            color: #fbc02d;
        }

        /* Botones táctiles */
        .btn {
            min-height: 44px;
        }

        /* [✓] NEW: Estilos para Pastillas en Tabla */
        .work-pill {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 6px;
            background: #eef2ff;
            color: #4338ca;
            font-size: 0.8em;
            font-weight: 500;
            border: 1px solid #c7d2fe;
            white-space: normal;
            max-width: 250px;
            line-height: 1.4;
        }

        .status-pill {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            white-space: nowrap;
            font-weight: 500;
            display: inline-block;
        }

        /* Estilos para Selects de Filtro (Modo Oscuro optimizado) */
        .filter-select {
            width: 100%;
            height: 46px;
            /* Altura fija para consistencia táctil y visual */
            padding: 0 14px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            font-size: 15px;
            background-color: var(--bg-tertiary) !important;
            color: var(--text-primary) !important;
            transition: all 0.2s ease;
            cursor: pointer;
            outline: none;
            box-shadow: var(--shadow-sm);
            box-sizing: border-box;
        }

        .filter-select:focus {
            border-color: var(--accent-primary) !important;
            box-shadow: 0 0 0 3px rgba(100, 181, 246, 0.15);
        }

        /* Ajuste para el placeholder del input */
        .filter-select::placeholder {
            color: var(--text-muted) !important;
            opacity: 0.8;
        }

        /* [!] ARCH: Reset select arrow for dark mode visibility */
        select.filter-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2364b5f6' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 14px center;
            padding-right: 40px;
        }

        /* Métricas en una sola fila compacta (Sin scroll) */
        /* Métricas en 2 filas (4 y 4) */
        .metrics-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .metric-mini {
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            padding: 18px !important;
            display: flex;
            align-items: center;
            gap: 15px;
            background: var(--bg-card);
            border: 1px solid rgba(100, 181, 246, 0.1);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-sm);
        }

        .metric-mini:hover {
            transform: translateY(-4px);
            background: var(--bg-secondary);
            border-color: var(--accent-primary);
            box-shadow: var(--glow-primary);
        }

        .metric-icon {
            width: 45px !important;
            height: 45px !important;
            min-width: 45px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25em !important;
        }

        .metric-content {
            display: flex;
            flex-direction: column;
        }

        .metric-val {
            font-size: 1.5em !important;
            font-weight: 700;
            line-height: 1;
            color: var(--text-primary);
        }

        .metric-lbl {
            font-size: 0.75rem !important;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 2px;
        }
    </style>

    <script>
        // [!] ARCH: Detección de conexión
        function updateConnectionStatus() {
            document.body.classList.toggle('offline', !navigator.onLine);
        }
        window.addEventListener('online', updateConnectionStatus);
        window.addEventListener('offline', updateConnectionStatus);
        updateConnectionStatus();

        // [!] PWA-OFFLINE: Mostrar pendientes
        function updatePendingBadge() {
            const pending = JSON.parse(localStorage.getItem('odt_pending_sync') || '[]');
            const badge = document.getElementById('pendingBadge');
            const count = document.getElementById('pendingCount');
            if (pending.length > 0) {
                badge.style.display = 'block';
                count.textContent = pending.length;
            } else {
                badge.style.display = 'none';
            }
        }
        updatePendingBadge();

        // Variables globales de filtro
        let currentFilters = {
            search: '',
            estado: '',
            trabajo: '',
            prioridad: ''
        };

        // [✓] AUDIT: Filtrar ODTs
        function filterODTs() {
            currentFilters.search = document.getElementById('searchInput').value.toLowerCase();
            currentFilters.estado = document.getElementById('filterEstado').value;
            currentFilters.trabajo = document.getElementById('filterTrabajo').value;

            const rows = document.querySelectorAll('.odt-row');
            let visible = 0;

            rows.forEach(row => {
                const matchSearch = row.dataset.search.includes(currentFilters.search);
                const matchEstado = !currentFilters.estado || row.dataset.estado === currentFilters.estado;
                const matchTrabajo = !currentFilters.trabajo || row.dataset.trabajo === currentFilters.trabajo;
                const matchPrioridad = !currentFilters.prioridad || row.dataset.prioridad === currentFilters.prioridad;

                const show = matchSearch && matchEstado && matchTrabajo && matchPrioridad;
                row.style.display = show ? '' : 'none';
                if (show) visible++;
            });

            document.getElementById('noResults').style.display = visible === 0 ? 'block' : 'none';
        }

        // [✓] NEW: Manejo de cambios en dropdowns
        function handleFilterChange() {
            // Al interactuar con dropdowns manuales, limpiamos la prioridad de métrica si se desea
            // (En este caso lo mantendremos para permitir combinaciones si el usuario lo hizo adrede)
            filterODTs();
        }

        // [✓] NEW: Filtro rápido desde métricas
        function setQuickFilter(type, value) {
            if (type === 'estado') {
                const select = document.getElementById('filterEstado');
                select.value = value;
                currentFilters.prioridad = ''; // Limpiar prioridad al filtrar por un estado específico
            } else if (type === 'prioridad') {
                currentFilters.prioridad = value;
                document.getElementById('filterEstado').value = ''; // Reset estado
            }

            filterODTs();
        }

        // [✓] BULK ACTIONS: Checkbox logic
        function toggleAllCheckboxes() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.odt-checkbox');
            checkboxes.forEach(cb => {
                if (cb.closest('.odt-row').style.display !== 'none') {
                    cb.checked = selectAll.checked;
                }
            });
            updateBulkActionUI();
        }

        function updateBulkActionUI() {
            const checkboxes = document.querySelectorAll('.odt-checkbox:checked');
            const bulkDiv = document.getElementById('bulkActions');
            const countSpan = document.getElementById('selectedCount');

            if (checkboxes.length > 0) {
                bulkDiv.style.display = 'flex';
                countSpan.textContent = checkboxes.length;
            } else {
                bulkDiv.style.display = 'none';
                document.getElementById('selectAll').checked = false;
            }
        }

        async function applyBulkStatus() {
            const checkboxes = document.querySelectorAll('.odt-checkbox:checked');
            const newStatus = document.getElementById('bulkStatus').value;

            if (!newStatus) {
                alert('Por favor selecciona un nuevo estado.');
                return;
            }

            if (!confirm(`¿Estás seguro de cambiar el estado de ${checkboxes.length} ODTs a "${newStatus}"?`)) {
                return;
            }

            const ids = Array.from(checkboxes).map(cb => cb.value);

            try {
                const response = await fetch('bulk_action.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        ids: ids,
                        estado: newStatus
                    })
                });

                const result = await response.json();

                if (result.success) {
                    alert('Estados actualizados correctamente.');
                    location.reload();
                } else {
                    alert('Error al actualizar: ' + result.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Ocurrió un error al procesar la solicitud.');
            }
        }

        // [✓] AUDIT: Confirmación triple para eliminar
        function confirmDelete(id, nro) {
            if (!confirm('¿Eliminar ODT "' + nro + '"?')) return;
            if (!confirm('⚠️ Esta acción no se puede deshacer. ¿Confirmar eliminación?')) return;

            window.location.href = 'delete.php?id=' + id;
        }
    </script>

    <?php require_once '../../includes/footer.php'; ?>

================================================================================
 MODULE: ODT
 FILE: odt\save.php
================================================================================
<?php
/**
 * [!] ARCH: Endpoint para guardar ODT (CREATE/UPDATE)
 * [→] EDITAR: Validaciones y campos según necesidad
 * [✓] AUDIT: Valida nro_odt_assa único, registra en auditoría
 */
require_once '../../config/database.php';
require_once '../../includes/auth.php';

// [✓] AUDIT: Verificar sesión
verificarSesion();

if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
    header('Location: index.php');
    exit;
}

// [→] EDITAR: Obtener datos del formulario
$id = $_POST['id_odt'] ?? null;
$nro_odt_assa = trim($_POST['nro_odt_assa'] ?? '');
$direccion = trim($_POST['direccion'] ?? '');
$id_tipologia = !empty($_POST['id_tipologia']) ? $_POST['id_tipologia'] : null;
$prioridad = $_POST['prioridad'] ?? 'Normal';
$estado_gestion = $_POST['estado_gestion'] ?? 'Sin Programar';
$fecha_inicio_plazo = !empty($_POST['fecha_inicio_plazo']) ? $_POST['fecha_inicio_plazo'] : null;
$fecha_vencimiento = !empty($_POST['fecha_vencimiento']) ? $_POST['fecha_vencimiento'] : null;
$avance = trim($_POST['avance'] ?? '');
$inspector = trim($_POST['inspector'] ?? '');

// [✓] ARCH: Lógica de Negocio RBAC
// [✓] ARCH: Lógica de Negocio RBAC
// El Inspector ASSA no puede elegir el estado inicial, siempre es 'Sin Programar'
// Pero SÍ puede modificar el estado de ODTs ya existentes.
if ($_SESSION['usuario_rol'] === 'Inspector ASSA' && empty($id)) {
    $estado_gestion = 'Sin Programar';
    // // AUDIT: Log de forzado de integridad
}

// [✓] AUDIT: Validación de campos obligatorios
if (empty($nro_odt_assa) || empty($direccion)) {
    $_SESSION['error'] = 'Número ODT y Dirección son obligatorios.';
    header('Location: form.php' . ($id ? "?id=$id" : ''));
    exit;
}

// [✓] AUDIT: Validar que nro_odt_assa sea único
try {
    $checkSql = "SELECT id_odt FROM odt_maestro WHERE nro_odt_assa = ?";
    if ($id) {
        $checkSql .= " AND id_odt != ?";
        $checkStmt = $pdo->prepare($checkSql);
        $checkStmt->execute([$nro_odt_assa, $id]);
    } else {
        $checkStmt = $pdo->prepare($checkSql);
        $checkStmt->execute([$nro_odt_assa]);
    }

    if ($checkStmt->fetch()) {
        $_SESSION['error'] = 'El número de ODT ya existe en el sistema.';
        header('Location: form.php' . ($id ? "?id=$id" : ''));
        exit;
    }

    if ($id) {
        // [✓] AUDIT: UPDATE con WHERE específico
        $sql = "UPDATE odt_maestro SET 
                nro_odt_assa = ?, direccion = ?, id_tipologia = ?,
                prioridad = ?, estado_gestion = ?,
                fecha_inicio_plazo = ?, fecha_vencimiento = ?,
                avance = ?, inspector = ?
                WHERE id_odt = ?";
        $stmt = $pdo->prepare($sql);
        $stmt->execute([
            $nro_odt_assa,
            $direccion,
            $id_tipologia,
            $prioridad,
            $estado_gestion,
            $fecha_inicio_plazo,
            $fecha_vencimiento,
            $avance,
            $inspector,
            $id
        ]);

        // [✓] AUDIT: Registrar edición
        registrarAccion('EDITAR', 'odt_maestro', "ODT editada: $nro_odt_assa", $id);

    } else {
        // [✓] AUDIT: INSERT
        $sql = "INSERT INTO odt_maestro 
                (nro_odt_assa, direccion, id_tipologia, prioridad, estado_gestion,
                 fecha_inicio_plazo, fecha_vencimiento, avance, inspector)
                VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)";
        $stmt = $pdo->prepare($sql);
        $stmt->execute([
            $nro_odt_assa,
            $direccion,
            $id_tipologia,
            $prioridad,
            $estado_gestion,
            $fecha_inicio_plazo,
            $fecha_vencimiento,
            $avance,
            $inspector
        ]);

        $newId = $pdo->lastInsertId();

        // [NEW] Manejo de Fotos
        $uploadDir = '../../uploads/odt_photos/';
        if (!is_dir($uploadDir)) {
            mkdir($uploadDir, 0777, true);
        }

        // Función helper para procesar uploads
        function procesarFoto($fileInputName, $tipo, $odtId, $pdo, $uploadDir) {
            if (!empty($_FILES[$fileInputName]['name'])) {
                // Si es array (fotos_extras)
                if (is_array($_FILES[$fileInputName]['name'])) {
                    foreach ($_FILES[$fileInputName]['name'] as $key => $name) {
                        if ($_FILES[$fileInputName]['error'][$key] === UPLOAD_ERR_OK) {
                            $tmpName = $_FILES[$fileInputName]['tmp_name'][$key];
                            $fileName = time() . '_' . uniqid() . '_' . basename($name);
                            $targetPath = $uploadDir . $fileName;
                            
                            if (move_uploaded_file($tmpName, $targetPath)) {
                                $stmt = $pdo->prepare("INSERT INTO odt_fotos (id_odt, tipo, ruta) VALUES (?, ?, ?)");
                                $stmt->execute([$odtId, $tipo, 'uploads/odt_photos/' . $fileName]);
                            }
                        }
                    }
                } 
                // Si es archivo único
                else {
                    if ($_FILES[$fileInputName]['error'] === UPLOAD_ERR_OK) {
                        $tmpName = $_FILES[$fileInputName]['tmp_name'];
                        $fileName = time() . '_' . uniqid() . '_' . basename($_FILES[$fileInputName]['name']);
                        $targetPath = $uploadDir . $fileName;
                        
                        if (move_uploaded_file($tmpName, $targetPath)) {
                            $stmt = $pdo->prepare("INSERT INTO odt_fotos (id_odt, tipo, ruta) VALUES (?, ?, ?)");
                            $stmt->execute([$odtId, $tipo, 'uploads/odt_photos/' . $fileName]);
                        }
                    }
                }
            }
        }

        // ID a usar para las fotos
        $targetOdtId = $id ? $id : $newId;

        // Procesar subidas
        procesarFoto('foto_odt', 'ODT', $targetOdtId, $pdo, $uploadDir);
        procesarFoto('foto_trabajo', 'TRABAJO', $targetOdtId, $pdo, $uploadDir);
        procesarFoto('fotos_extras', 'EXTRA', $targetOdtId, $pdo, $uploadDir);

        if ($id) {
            registrarAccion('EDITAR', 'odt_fotos', "Fotos actualizadas para ODT: $nro_odt_assa", $id);
        } else {
            registrarAccion('CREAR', 'odt_fotos', "Fotos agregadas para ODT: $nro_odt_assa", $newId);
        }

    header('Location: index.php?msg=saved');

} catch (PDOException $e) {
    // [!] ARCH: No exponer errores SQL
    error_log("Error en odt/save.php: " . $e->getMessage());
    $_SESSION['error'] = 'Error al guardar la ODT.';
    header('Location: form.php' . ($id ? "?id=$id" : ''));
}

exit;
?>

================================================================================
 MODULE: ODT
 FILE: odt\setup_photos_table.php
================================================================================
<?php
require_once '../../config/database.php';

try {
    $sql = file_get_contents('../../sql/create_odt_fotos.sql');
    $pdo->exec($sql);
    echo "Table 'odt_fotos' created successfully.";
} catch (PDOException $e) {
    echo "Error creating table: " . $e->getMessage();
}
?>


================================================================================
 MODULE: PARTES
 FILE: partes\api\save_parte.php
================================================================================
<?php
/**
 * API: Guardar Parte Diario
 * 
 * Guarda un parte de trabajo con materiales, personal y fotos.
 * Actualiza automáticamente el estado de la ODT y descuenta stock.
 * 
 * @method POST
 * @body FormData
 * @return JSON {success: bool, id_parte?: int, error?: string}
 */

require_once '../../../config/database.php';
session_start();

header('Content-Type: application/json');

if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
    echo json_encode(['success' => false, 'error' => 'Método no permitido']);
    exit;
}

try {
    // ========================================================================
    // VALIDACIÓN DE DATOS
    // ========================================================================

    $id_parte = isset($_POST['id_parte']) && !empty($_POST['id_parte']) ? intval($_POST['id_parte']) : null;
    $id_odt = intval($_POST['id_odt'] ?? 0);
    $id_cuadrilla = intval($_POST['id_cuadrilla'] ?? 0);
    $id_tipologia = intval($_POST['id_tipologia'] ?? 0);
    $fecha_ejecucion = $_POST['fecha_ejecucion'] ?? '';
    $hora_inicio = $_POST['hora_inicio'] ?? '';
    $hora_fin = $_POST['hora_fin'] ?? '';
    $largo = floatval($_POST['largo'] ?? 0);
    $ancho = floatval($_POST['ancho'] ?? 0);
    $profundidad = floatval($_POST['profundidad'] ?? 0);
    $id_vehiculo = !empty($_POST['id_vehiculo']) ? intval($_POST['id_vehiculo']) : null;
    $observaciones = trim($_POST['observaciones'] ?? '');
    $estado = $_POST['estado'] ?? 'Borrador';

    // Validaciones básicas
    if ($id_odt <= 0) {
        throw new Exception('Debe seleccionar una ODT');
    }

    if ($id_cuadrilla <= 0) {
        throw new Exception('Cuadrilla no válida');
    }

    if ($id_tipologia <= 0) {
        throw new Exception('Debe seleccionar un tipo de trabajo');
    }

    if (empty($fecha_ejecucion) || empty($hora_inicio) || empty($hora_fin)) {
        throw new Exception('Debe completar fecha y horarios');
    }

    // Validar estado
    $estadosValidos = ['Borrador', 'Enviado', 'Aprobado', 'Rechazado'];
    if (!in_array($estado, $estadosValidos)) {
        $estado = 'Borrador';
    }

    // ========================================================================
    // INICIO DE TRANSACCIÓN
    // ========================================================================

    $pdo->beginTransaction();

    // ========================================================================
    // GUARDAR PARTE PRINCIPAL
    // ========================================================================

    if ($id_parte) {
        // Actualizar parte existente
        $stmt = $pdo->prepare("
            UPDATE partes_diarios SET
                id_odt = ?,
                id_cuadrilla = ?,
                id_tipologia = ?,
                fecha_ejecucion = ?,
                hora_inicio = ?,
                hora_fin = ?,
                largo = ?,
                ancho = ?,
                profundidad = ?,
                id_vehiculo = ?,
                observaciones = ?,
                estado = ?
            WHERE id_parte = ?
        ");
        $stmt->execute([
            $id_odt,
            $id_cuadrilla,
            $id_tipologia,
            $fecha_ejecucion,
            $hora_inicio,
            $hora_fin,
            $largo,
            $ancho,
            $profundidad,
            $id_vehiculo,
            $observaciones,
            $estado,
            $id_parte
        ]);
    } else {
        // Crear nuevo parte
        $stmt = $pdo->prepare("
            INSERT INTO partes_diarios 
            (id_odt, id_cuadrilla, id_tipologia, fecha_ejecucion, hora_inicio, hora_fin,
             largo, ancho, profundidad, id_vehiculo, observaciones, estado, usuario_creacion)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
        ");
        $stmt->execute([
            $id_odt,
            $id_cuadrilla,
            $id_tipologia,
            $fecha_ejecucion,
            $hora_inicio,
            $hora_fin,
            $largo,
            $ancho,
            $profundidad,
            $id_vehiculo,
            $observaciones,
            $estado,
            $_SESSION['usuario_id'] ?? null
        ]);
        $id_parte = $pdo->lastInsertId();
    }

    // ========================================================================
    // GUARDAR PERSONAL INTERVINIENTE
    // ========================================================================

    // Eliminar personal anterior
    $pdo->prepare("DELETE FROM partes_personal WHERE id_parte = ?")->execute([$id_parte]);

    // Insertar nuevo personal
    if (!empty($_POST['personal']) && is_array($_POST['personal'])) {
        $stmtPersonal = $pdo->prepare("INSERT INTO partes_personal (id_parte, id_personal) VALUES (?, ?)");
        foreach ($_POST['personal'] as $id_personal) {
            $stmtPersonal->execute([$id_parte, intval($id_personal)]);
        }
    }

    // ========================================================================
    // GUARDAR MATERIALES CONSUMIDOS
    // ========================================================================

    // Nota: El trigger se encarga de revertir el stock si se eliminan materiales
    // Primero eliminar materiales anteriores (el trigger revertirá el stock)
    $pdo->prepare("DELETE FROM partes_materiales WHERE id_parte = ?")->execute([$id_parte]);

    // Insertar nuevos materiales (el trigger descontará del stock)
    if (!empty($_POST['materiales']) && is_array($_POST['materiales'])) {
        $stmtMaterial = $pdo->prepare("INSERT INTO partes_materiales (id_parte, id_material, cantidad) VALUES (?, ?, ?)");
        foreach ($_POST['materiales'] as $mat) {
            if (!empty($mat['id']) && !empty($mat['cantidad']) && floatval($mat['cantidad']) > 0) {
                $stmtMaterial->execute([
                    $id_parte,
                    intval($mat['id']),
                    floatval($mat['cantidad'])
                ]);
            }
        }
    }

    // ========================================================================
    // GUARDAR FOTOS
    // ========================================================================

    $uploadDir = __DIR__ . '/../../../uploads/partes/' . $id_parte . '/';
    if (!is_dir($uploadDir)) {
        mkdir($uploadDir, 0755, true);
    }

    $tiposFoto = ['foto_inicio' => 'Inicio', 'foto_proceso' => 'Proceso', 'foto_fin' => 'Fin'];

    foreach ($tiposFoto as $inputName => $tipoFoto) {
        if (isset($_FILES[$inputName]) && $_FILES[$inputName]['error'] === UPLOAD_ERR_OK) {
            $file = $_FILES[$inputName];

            // Validar tipo de archivo
            $finfo = new finfo(FILEINFO_MIME_TYPE);
            $mimeType = $finfo->file($file['tmp_name']);
            $allowedTypes = ['image/jpeg', 'image/png', 'image/webp'];

            if (!in_array($mimeType, $allowedTypes)) {
                continue; // Saltar archivos no válidos
            }

            // Generar nombre único
            $extension = pathinfo($file['name'], PATHINFO_EXTENSION);
            $filename = strtolower($tipoFoto) . '_' . time() . '.' . $extension;
            $filepath = $uploadDir . $filename;

            if (move_uploaded_file($file['tmp_name'], $filepath)) {
                // Guardar referencia en BD (usar REPLACE para actualizar si ya existe)
                $stmtFoto = $pdo->prepare("
                    REPLACE INTO partes_fotos (id_parte, tipo_foto, ruta_archivo, fecha_captura)
                    VALUES (?, ?, ?, NOW())
                ");
                $stmtFoto->execute([
                    $id_parte,
                    $tipoFoto,
                    $id_parte . '/' . $filename
                ]);
            }
        }
    }

    // ========================================================================
    // ACTUALIZAR ESTADO DE ODT (si el parte fue enviado)
    // ========================================================================

    if ($estado === 'Enviado') {
        $pdo->prepare("
            UPDATE ODT_Maestro 
            SET estado_gestion = 'Ejecutado' 
            WHERE id_odt = ? AND estado_gestion != 'Finalizado'
        ")->execute([$id_odt]);
    }

    // ========================================================================
    // COMMIT
    // ========================================================================

    $pdo->commit();

    echo json_encode([
        'success' => true,
        'id_parte' => $id_parte,
        'message' => $estado === 'Borrador' ? 'Borrador guardado' : 'Parte enviado correctamente'
    ]);

} catch (Exception $e) {
    if ($pdo->inTransaction()) {
        $pdo->rollBack();
    }

    echo json_encode([
        'success' => false,
        'error' => $e->getMessage()
    ]);
}


================================================================================
 MODULE: PARTES
 FILE: partes\index.php
================================================================================
<?php
/**
 * Módulo: Partes Diarios y Consumo
 * 
 * Sistema de registro de ejecución de ODTs para Jefes de Cuadrilla.
 * Incluye: tiempos, trabajos, consumo de materiales, personal y evidencia fotográfica.
 * 
 * @author Sistema ERP - Recursos Globales
 * @version 1.0
 */

require_once '../../config/database.php';
require_once '../../includes/header.php';

// ============================================================================
// OBTENER DATOS DEL USUARIO
// ============================================================================
$usuarioActual = obtenerUsuarioActual();
$esJefeCuadrilla = ($usuarioActual['rol'] ?? '') === 'JefeCuadrilla';
$idCuadrillaUsuario = $usuarioActual['id_cuadrilla'] ?? null;

// ============================================================================
// CONSULTAS DE DATOS
// ============================================================================

// 1. Obtener ODTs programadas para la cuadrilla del usuario (o todas si es admin)
$sqlOdts = "
    SELECT o.id_odt, o.nro_odt_assa, o.direccion, o.estado_gestion, 
           t.nombre AS tipologia, ps.fecha_programada, ps.id_cuadrilla
    FROM ODT_Maestro o
    LEFT JOIN tipologias t ON o.id_tipologia = t.id_tipologia
    LEFT JOIN programacion_semanal ps ON o.id_odt = ps.id_odt
    WHERE o.estado_gestion IN ('Programado', 'Sin Programar')
";
if ($esJefeCuadrilla && $idCuadrillaUsuario) {
    $sqlOdts .= " AND ps.id_cuadrilla = " . intval($idCuadrillaUsuario);
}
$sqlOdts .= " ORDER BY ps.fecha_programada DESC, o.nro_odt_assa ASC";
$odts = $pdo->query($sqlOdts)->fetchAll(PDO::FETCH_ASSOC);

// 2. Obtener cuadrillas
$cuadrillas = $pdo->query("SELECT id_cuadrilla, nombre_cuadrilla FROM cuadrillas WHERE estado_operativo = 'Activa' ORDER BY nombre_cuadrilla")->fetchAll(PDO::FETCH_ASSOC);

// 3. Obtener tipologías de trabajo
$tipologias = $pdo->query("SELECT id_tipologia, nombre, codigo_trabajo, unidad_medida FROM tipologias ORDER BY nombre")->fetchAll(PDO::FETCH_ASSOC);

// 4. Obtener personal (filtrado por cuadrilla si es jefe)
$sqlPersonal = "SELECT id_personal, nombre_apellido, rol, id_cuadrilla FROM personal";
if ($esJefeCuadrilla && $idCuadrillaUsuario) {
    $sqlPersonal .= " WHERE id_cuadrilla = " . intval($idCuadrillaUsuario);
}
$sqlPersonal .= " ORDER BY nombre_apellido";
$personal = $pdo->query($sqlPersonal)->fetchAll(PDO::FETCH_ASSOC);

// 5. Obtener vehículos
$vehiculos = $pdo->query("SELECT id_vehiculo, patente, marca, modelo, tipo FROM vehiculos WHERE estado = 'Operativo' ORDER BY patente")->fetchAll(PDO::FETCH_ASSOC);

// 6. Obtener materiales con stock de cuadrilla
$sqlMateriales = "
    SELECT m.id_material, m.codigo, m.nombre, m.unidad_medida,
           COALESCE(sc.cantidad, 0) AS stock_disponible
    FROM maestro_materiales m
    LEFT JOIN stock_cuadrilla sc ON m.id_material = sc.id_material
";
if ($esJefeCuadrilla && $idCuadrillaUsuario) {
    $sqlMateriales .= " AND sc.id_cuadrilla = " . intval($idCuadrillaUsuario);
}
$sqlMateriales .= " ORDER BY m.nombre";
$materiales = $pdo->query($sqlMateriales)->fetchAll(PDO::FETCH_ASSOC);

// 7. Obtener partes recientes
$sqlPartes = "
    SELECT pd.*, o.nro_odt_assa, c.nombre_cuadrilla, t.nombre AS tipologia_nombre,
           (SELECT COUNT(*) FROM partes_fotos pf WHERE pf.id_parte = pd.id_parte) AS cant_fotos
    FROM partes_diarios pd
    LEFT JOIN ODT_Maestro o ON pd.id_odt = o.id_odt
    LEFT JOIN cuadrillas c ON pd.id_cuadrilla = c.id_cuadrilla
    LEFT JOIN tipologias t ON pd.id_tipologia = t.id_tipologia
";
if ($esJefeCuadrilla && $idCuadrillaUsuario) {
    $sqlPartes .= " WHERE pd.id_cuadrilla = " . intval($idCuadrillaUsuario);
}
$sqlPartes .= " ORDER BY pd.fecha_ejecucion DESC, pd.id_parte DESC LIMIT 50";
$partes = $pdo->query($sqlPartes)->fetchAll(PDO::FETCH_ASSOC);
?>

<style>
    /* ========================================
       MÓDULO PARTES DIARIOS - Estilos
       Usa variables globales del tema
       ======================================== */

    .partes-container {
        max-width: 1600px;
        margin: 0 auto;
        padding: var(--spacing-md);
    }

    .module-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-lg);
        padding: var(--spacing-lg);
        background: var(--bg-card);
        border-radius: var(--border-radius-md);
        border: 1px solid rgba(100, 181, 246, 0.15);
        box-shadow: var(--shadow-sm);
    }

    [data-theme="light"] .module-header {
        border-color: #e2e8f0;
    }

    .module-title {
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--text-primary);
    }

    .module-subtitle {
        font-size: 0.9rem;
        color: var(--text-secondary);
    }

    /* Layout principal - Flujo vertical */
    .form-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: var(--spacing-lg);
        margin-bottom: var(--spacing-lg);
    }

    .form-grid .card {
        margin-bottom: 0;
    }

    /* Sección de fotos y observaciones - ancho completo */
    .form-bottom {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: var(--spacing-lg);
        margin-bottom: var(--spacing-lg);
    }

    .form-bottom .card {
        margin-bottom: 0;
    }

    @media (max-width: 1400px) {
        .form-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 1024px) {
        .form-grid {
            grid-template-columns: 1fr;
        }

        .form-bottom {
            grid-template-columns: 1fr;
        }
    }

    /* Cards genéricas - Tema adaptativo */
    .card {
        background: var(--bg-card);
        border-radius: var(--border-radius-md);
        border: 1px solid rgba(100, 181, 246, 0.15);
        margin-bottom: var(--spacing-lg);
        box-shadow: var(--shadow-sm);
    }

    [data-theme="light"] .card {
        background: #ffffff;
        border-color: #e2e8f0;
        box-shadow: var(--shadow-md);
    }

    .card-header {
        padding: var(--spacing-md) var(--spacing-lg);
        border-bottom: 1px solid rgba(100, 181, 246, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    [data-theme="light"] .card-header {
        border-bottom-color: #e2e8f0;
    }

    .card-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--accent-primary);
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
    }

    .card-body {
        padding: var(--spacing-lg);
    }

    /* Formulario */
    .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
        gap: var(--spacing-md);
        margin-bottom: var(--spacing-md);
    }

    .form-group {
        margin-bottom: var(--spacing-md);
    }

    .form-group label {
        display: block;
        font-size: 0.85rem;
        font-weight: 500;
        color: var(--text-secondary);
        margin-bottom: var(--spacing-xs);
    }

    .form-group label .required {
        color: var(--color-danger);
    }

    .form-control {
        width: 100%;
        padding: 10px var(--spacing-md);
        background: var(--bg-tertiary);
        border: 1px solid rgba(100, 181, 246, 0.2);
        border-radius: var(--border-radius-sm);
        font-size: 0.95rem;
        font-family: inherit;
        color: var(--text-primary);
        transition: border-color 0.2s, box-shadow 0.2s;
    }

    .form-control:focus {
        outline: none;
        border-color: var(--accent-primary);
        box-shadow: 0 0 0 3px rgba(100, 181, 246, 0.15);
    }

    /* Modo Claro - Formularios */
    [data-theme="light"] .form-control {
        background: #ffffff;
        border: 1px solid #d1d5db;
        color: var(--text-primary);
    }

    [data-theme="light"] .form-control:focus {
        border-color: var(--accent-primary);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
    }

    /* Métricas */
    .metrics-section {
        background: var(--bg-tertiary);
        border-radius: var(--border-radius-sm);
        padding: var(--spacing-md);
        margin-bottom: var(--spacing-md);
    }

    [data-theme="light"] .metrics-section {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
    }

    .metrics-title {
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: var(--spacing-sm);
    }

    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: var(--spacing-sm);
    }

    .metric-input {
        text-align: center;
    }

    .metric-input label {
        font-size: 0.75rem !important;
        color: var(--text-muted) !important;
    }

    .volume-result {
        padding: var(--spacing-md);
        background: linear-gradient(135deg, var(--accent-primary), #1d4ed8);
        border-radius: var(--border-radius-sm);
        text-align: center;
        color: white;
        margin-top: var(--spacing-sm);
    }

    .volume-value {
        font-size: 1.5rem;
        font-weight: 700;
    }

    .volume-unit {
        font-size: 0.9rem;
        opacity: 0.9;
    }

    /* Selector múltiple de personal */
    .multi-select {
        display: flex;
        flex-wrap: wrap;
        gap: var(--spacing-sm);
        max-height: 200px;
        overflow-y: auto;
        padding: var(--spacing-sm);
        background: var(--bg-tertiary);
        border-radius: var(--border-radius-sm);
        border: 1px solid rgba(100, 181, 246, 0.2);
    }

    [data-theme="light"] .multi-select {
        background: #f8fafc;
        border-color: #d1d5db;
    }

    .multi-select-item {
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
        padding: 6px 12px;
        background: var(--bg-secondary);
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.85rem;
        color: var(--text-primary);
        border: 1px solid transparent;
    }

    [data-theme="light"] .multi-select-item {
        background: #ffffff;
        border-color: #e2e8f0;
    }

    .multi-select-item:hover {
        background: rgba(100, 181, 246, 0.15);
    }

    .multi-select-item.selected {
        background: var(--accent-primary);
        color: white;
        border-color: var(--accent-primary);
    }

    .multi-select-item input {
        display: none;
    }

    /* Grilla de materiales */
    .materials-grid {
        border: 1px solid rgba(100, 181, 246, 0.2);
        border-radius: var(--border-radius-sm);
        overflow: hidden;
    }

    [data-theme="light"] .materials-grid {
        border-color: #e2e8f0;
    }

    .materials-header {
        display: grid;
        grid-template-columns: 1fr 100px 80px 50px;
        gap: var(--spacing-sm);
        padding: var(--spacing-sm) var(--spacing-md);
        background: var(--bg-tertiary);
        font-size: 0.8rem;
        font-weight: 600;
        color: var(--text-secondary);
        text-transform: uppercase;
    }

    [data-theme="light"] .materials-header {
        background: #f1f5f9;
    }

    .material-row {
        display: grid;
        grid-template-columns: 1fr 100px 80px 50px;
        gap: var(--spacing-sm);
        padding: var(--spacing-sm) var(--spacing-md);
        align-items: center;
        border-top: 1px solid rgba(100, 181, 246, 0.1);
        background: var(--bg-card);
    }

    [data-theme="light"] .material-row {
        border-top-color: #e2e8f0;
        background: #ffffff;
    }

    .material-row select,
    .material-row input {
        padding: 8px;
        font-size: 0.9rem;
    }

    .btn-remove {
        width: 32px;
        height: 32px;
        background: rgba(239, 68, 68, 0.15);
        color: #ef4444;
        border: none;
        border-radius: var(--border-radius-sm);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .btn-add-row {
        width: 100%;
        padding: var(--spacing-sm);
        background: rgba(100, 181, 246, 0.1);
        border: 1px dashed var(--accent-primary);
        color: var(--accent-primary);
        border-radius: 0;
        cursor: pointer;
        font-size: 0.9rem;
        font-family: inherit;
    }

    .btn-add-row:hover {
        background: rgba(100, 181, 246, 0.2);
    }

    /* Upload de fotos */
    .photos-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: var(--spacing-md);
    }

    .photo-slot {
        aspect-ratio: 4/3;
        border: 2px dashed rgba(100, 181, 246, 0.3);
        border-radius: var(--border-radius-md);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
        position: relative;
        overflow: hidden;
        background: var(--bg-tertiary);
    }

    [data-theme="light"] .photo-slot {
        background: #f8fafc;
        border-color: #cbd5e1;
    }

    .photo-slot:hover {
        border-color: var(--accent-primary);
        background: rgba(100, 181, 246, 0.05);
    }

    .photo-slot.has-image {
        border-style: solid;
        border-color: var(--color-success);
    }

    .photo-slot input {
        position: absolute;
        inset: 0;
        opacity: 0;
        cursor: pointer;
    }

    .photo-slot i {
        font-size: 2rem;
        color: var(--accent-primary);
        margin-bottom: var(--spacing-xs);
    }

    .photo-slot .label {
        font-size: 0.85rem;
        font-weight: 500;
        color: var(--text-secondary);
    }

    .photo-slot .sublabel {
        font-size: 0.75rem;
        color: var(--text-muted);
    }

    .photo-slot img {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .photo-slot .remove-photo {
        position: absolute;
        top: 5px;
        right: 5px;
        width: 24px;
        height: 24px;
        background: rgba(239, 68, 68, 0.9);
        color: white;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        z-index: 10;
        display: none;
    }

    .photo-slot.has-image .remove-photo {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* Tiempo calculado */
    .time-result {
        padding: var(--spacing-md);
        background: var(--bg-tertiary);
        border-radius: var(--border-radius-sm);
        text-align: center;
        border-left: 4px solid var(--accent-primary);
    }

    [data-theme="light"] .time-result {
        background: #f8fafc;
    }

    .time-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--accent-primary);
    }

    .time-label {
        font-size: 0.85rem;
        color: var(--text-secondary);
    }

    /* Tabla de partes */
    .table-container {
        overflow-x: auto;
        scrollbar-width: thin;
        scrollbar-color: rgba(100, 181, 246, 0.3) transparent;
    }

    .table-container::-webkit-scrollbar {
        height: 6px;
    }

    .table-container::-webkit-scrollbar-thumb {
        background: rgba(100, 181, 246, 0.3);
        border-radius: 3px;
    }

    [data-theme="light"] .table-container {
        scrollbar-color: rgba(37, 99, 235, 0.3) transparent;
    }

    [data-theme="light"] .table-container::-webkit-scrollbar-thumb {
        background: rgba(37, 99, 235, 0.3);
    }

    /* Estilos de tabla */
    .data-table {
        width: 100%;
        border-collapse: collapse;
    }

    .data-table thead {
        background: var(--bg-tertiary);
    }

    [data-theme="light"] .data-table thead {
        background: #f1f5f9;
    }

    .data-table th {
        padding: 12px var(--spacing-md);
        text-align: left;
        font-weight: 600;
        font-size: 0.8rem;
        text-transform: uppercase;
        color: var(--text-secondary);
        border-bottom: 1px solid rgba(100, 181, 246, 0.1);
    }

    [data-theme="light"] .data-table th {
        border-bottom-color: #e2e8f0;
        color: #64748b;
    }

    .data-table td {
        padding: 12px var(--spacing-md);
        border-bottom: 1px solid rgba(100, 181, 246, 0.05);
        color: var(--text-primary);
        font-size: 0.9rem;
    }

    [data-theme="light"] .data-table td {
        border-bottom-color: #f1f5f9;
    }

    .data-table tbody tr:hover {
        background: rgba(100, 181, 246, 0.05);
    }

    [data-theme="light"] .data-table tbody tr:hover {
        background: #f8fafc;
    }

    .status-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .status-Borrador {
        background: rgba(158, 158, 158, 0.15);
        color: #9e9e9e;
    }

    .status-Enviado {
        background: rgba(59, 130, 246, 0.15);
        color: #3b82f6;
    }

    .status-Aprobado {
        background: rgba(16, 185, 129, 0.15);
        color: #10b981;
    }

    .status-Rechazado {
        background: rgba(239, 68, 68, 0.15);
        color: #ef4444;
    }

    /* Botones */
    .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: var(--spacing-sm);
        padding: 12px var(--spacing-lg);
        font-size: 1rem;
        font-weight: 500;
        font-family: inherit;
        border: none;
        border-radius: var(--border-radius-sm);
        cursor: pointer;
        transition: all 0.2s;
        text-decoration: none;
    }

    .btn-primary {
        background: linear-gradient(145deg, var(--accent-primary) 0%, #1d4ed8 100%);
        color: white;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(100, 181, 246, 0.3);
    }

    .btn-success {
        background: linear-gradient(145deg, #10b981 0%, #059669 100%);
        color: white;
    }

    .btn-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    .btn-outline {
        background: transparent;
        border: 1px solid var(--accent-primary);
        color: var(--accent-primary);
    }

    .btn-outline:hover {
        background: rgba(100, 181, 246, 0.1);
    }

    .btn-block {
        width: 100%;
    }

    .btn-lg {
        padding: 16px var(--spacing-xl);
        font-size: 1.1rem;
    }

    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .btn-icon {
        width: 32px;
        height: 32px;
        padding: 0;
        border: none;
        border-radius: var(--border-radius-sm);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(59, 130, 246, 0.15);
        color: #3b82f6;
        transition: all 0.2s;
    }

    .btn-icon:hover {
        transform: scale(1.1);
    }

    /* Responsive */
    @media (max-width: 768px) {
        .photos-grid {
            grid-template-columns: 1fr;
        }

        .materials-header,
        .material-row {
            grid-template-columns: 1fr 80px 60px 40px;
            font-size: 0.8rem;
        }

        .module-header {
            flex-direction: column;
            gap: var(--spacing-md);
            text-align: center;
        }
    }
</style>

<div class="partes-container">
    <!-- Header -->
    <div class="module-header">
        <div>
            <h1 class="module-title">Partes Diarios</h1>
            <p class="module-subtitle">Registro de Ejecución y Consumo de Recursos</p>
        </div>
        <div>
            <button class="btn btn-primary" onclick="resetForm()">
                <i class="fas fa-plus"></i> Nuevo Parte
            </button>
        </div>
    </div>

    <form id="formParte" enctype="multipart/form-data">
        <input type="hidden" name="id_parte" id="id_parte" value="">
        
        <!-- Fila 1: 3 columnas principales -->
        <div class="form-grid">
            <!-- Columna 1: ODT y Jornada -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-file-alt"></i> ODT y Jornada
                    </h3>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label>ODT Asignada <span class="required">*</span></label>
                        <select name="id_odt" id="id_odt" class="form-control" required>
                            <option value="">Seleccione ODT...</option>
                            <?php foreach ($odts as $odt): ?>
                                    <option value="<?php echo $odt['id_odt']; ?>"
                                        data-tipologia="<?php echo $odt['tipologia']; ?>">
                                        <?php echo htmlspecialchars($odt['nro_odt_assa']); ?> -
                                        <?php echo htmlspecialchars($odt['direccion'] ?? 'Sin dirección'); ?>
                                    </option>
                            <?php endforeach; ?>
                        </select>
                    </div>

                    <?php if (!$esJefeCuadrilla): ?>
                            <div class="form-group">
                                <label>Cuadrilla <span class="required">*</span></label>
                                <select name="id_cuadrilla" id="id_cuadrilla" class="form-control" required>
                                    <option value="">Seleccione Cuadrilla...</option>
                                    <?php foreach ($cuadrillas as $c): ?>
                                            <option value="<?php echo $c['id_cuadrilla']; ?>">
                                                <?php echo htmlspecialchars($c['nombre_cuadrilla']); ?>
                                            </option>
                                    <?php endforeach; ?>
                                </select>
                            </div>
                    <?php else: ?>
                            <input type="hidden" name="id_cuadrilla" value="<?php echo $idCuadrillaUsuario; ?>">
                    <?php endif; ?>

                    <div class="form-group">
                        <label>Fecha Ejecución <span class="required">*</span></label>
                        <input type="date" name="fecha_ejecucion" id="fecha_ejecucion" class="form-control"
                            value="<?php echo date('Y-m-d'); ?>" required>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Inicio <span class="required">*</span></label>
                            <input type="time" name="hora_inicio" id="hora_inicio" class="form-control"
                                value="08:00" required onchange="calcularTiempo()">
                        </div>
                        <div class="form-group">
                            <label>Fin <span class="required">*</span></label>
                            <input type="time" name="hora_fin" id="hora_fin" class="form-control" value="17:00"
                                required onchange="calcularTiempo()">
                        </div>
                    </div>

                    <div class="time-result">
                        <div class="time-value" id="tiempoCalculado">9h 00m</div>
                        <div class="time-label">Tiempo de Ejecución</div>
                    </div>
                </div>
            </div>

            <!-- Columna 2: Trabajo Realizado -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-hard-hat"></i> Trabajo Realizado
                    </h3>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label>Tipología <span class="required">*</span></label>
                        <select name="id_tipologia" id="id_tipologia" class="form-control" required
                            onchange="updateUnidadMedida()">
                            <option value="">Seleccione tipo...</option>
                            <?php foreach ($tipologias as $t): ?>
                                    <option value="<?php echo $t['id_tipologia']; ?>"
                                        data-unidad="<?php echo $t['unidad_medida']; ?>">
                                        <?php echo htmlspecialchars($t['nombre']); ?>
                                        <?php if ($t['codigo_trabajo']): ?>(<?php echo $t['codigo_trabajo']; ?>)<?php endif; ?>
                                    </option>
                            <?php endforeach; ?>
                        </select>
                    </div>

                    <div class="metrics-section">
                        <div class="metrics-title">Métricas de Obra</div>
                        <div class="metrics-grid">
                            <div class="form-group metric-input">
                                <label>Largo (m)</label>
                                <input type="number" name="largo" id="largo" class="form-control" step="0.01"
                                    min="0" value="0" onchange="calcularVolumen()">
                            </div>
                            <div class="form-group metric-input">
                                <label>Ancho (m)</label>
                                <input type="number" name="ancho" id="ancho" class="form-control" step="0.01"
                                    min="0" value="0" onchange="calcularVolumen()">
                            </div>
                            <div class="form-group metric-input">
                                <label>Prof. (m)</label>
                                <input type="number" name="profundidad" id="profundidad" class="form-control"
                                    step="0.01" min="0" value="0" onchange="calcularVolumen()">
                            </div>
                        </div>

                        <div class="volume-result">
                            <div class="volume-value" id="volumenCalculado">0.00</div>
                            <div class="volume-unit" id="unidadVolumen">M²</div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Vehículo Utilizado</label>
                        <select name="id_vehiculo" id="id_vehiculo" class="form-control">
                            <option value="">Ninguno / No aplica</option>
                            <?php foreach ($vehiculos as $v): ?>
                                    <option value="<?php echo $v['id_vehiculo']; ?>">
                                        <?php echo htmlspecialchars($v['patente']); ?> -
                                        <?php echo htmlspecialchars($v['marca'] . ' ' . $v['modelo']); ?>
                                    </option>
                            <?php endforeach; ?>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Columna 3: Personal Interviniente -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-users"></i> Personal
                    </h3>
                </div>
                <div class="card-body">
                    <div class="multi-select" id="personalSelect">
                        <?php foreach ($personal as $p): ?>
                                <label class="multi-select-item" data-id="<?php echo $p['id_personal']; ?>">
                                    <input type="checkbox" name="personal[]" value="<?php echo $p['id_personal']; ?>">
                                    <i class="fas fa-user"></i>
                                    <?php echo htmlspecialchars($p['nombre_apellido']); ?>
                                    <small style="opacity: 0.7;">(<?php echo $p['rol']; ?>)</small>
                                </label>
                        <?php endforeach; ?>
                    </div>
                </div>
            </div>
        </div>

        <!-- Fila 2: Fotos (2/3) + Materiales (1/3) -->
        <div class="form-bottom">
            <!-- Evidencia Fotográfica -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-camera"></i> Evidencia Fotográfica <span class="required">*</span>
                    </h3>
                </div>
                <div class="card-body">
                    <div class="photos-grid">
                        <div class="photo-slot" id="slotInicio">
                            <input type="file" name="foto_inicio" accept="image/*" capture="environment"
                                onchange="previewPhoto(this, 'Inicio')">
                            <button type="button" class="remove-photo" onclick="removePhoto('Inicio')">&times;</button>
                            <i class="fas fa-camera"></i>
                            <span class="label">INICIO</span>
                            <span class="sublabel">Antes de trabajar</span>
                        </div>

                        <div class="photo-slot" id="slotProceso">
                            <input type="file" name="foto_proceso" accept="image/*" capture="environment"
                                onchange="previewPhoto(this, 'Proceso')">
                            <button type="button" class="remove-photo" onclick="removePhoto('Proceso')">&times;</button>
                            <i class="fas fa-camera"></i>
                            <span class="label">PROCESO</span>
                            <span class="sublabel">Durante el trabajo</span>
                        </div>

                        <div class="photo-slot" id="slotFin">
                            <input type="file" name="foto_fin" accept="image/*" capture="environment"
                                onchange="previewPhoto(this, 'Fin')">
                            <button type="button" class="remove-photo" onclick="removePhoto('Fin')">&times;</button>
                            <i class="fas fa-camera"></i>
                            <span class="label">FIN</span>
                            <span class="sublabel">Trabajo terminado</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Materiales Consumidos -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-boxes"></i> Materiales
                    </h3>
                </div>
                <div class="card-body" style="padding: 0;">
                    <div class="materials-grid">
                        <div class="materials-header">
                            <span>Material</span>
                            <span>Stock</span>
                            <span>Cant</span>
                            <span></span>
                        </div>
                        <div id="materialesContainer">
                            <!-- Rows dinámicas -->
                        </div>
                        <button type="button" class="btn-add-row" onclick="addMaterialRow()">
                            <i class="fas fa-plus"></i> Agregar Material
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Fila 3: Observaciones y Acciones -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-comment-alt"></i> Observaciones y Envío
                </h3>
            </div>
            <div class="card-body">
                <div class="form-group" style="margin-bottom: var(--spacing-md);">
                    <textarea name="observaciones" id="observaciones" class="form-control" rows="2"
                        placeholder="Notas adicionales sobre el trabajo realizado..."></textarea>
                </div>

                <div style="display: flex; gap: var(--spacing-md);">
                    <button type="button" class="btn btn-outline" onclick="guardarBorrador()" style="flex: 1;">
                        <i class="fas fa-save"></i> Guardar Borrador
                    </button>
                    <button type="submit" class="btn btn-success btn-lg" style="flex: 2;">
                        <i class="fas fa-paper-plane"></i> Enviar Parte
                    </button>
                </div>
            </div>
        </div>
    </form>

    <!-- Tabla de Partes Recientes -->
    <div class="card" style="margin-top: var(--spacing-lg);">
        <div class="card-header">
            <h3 class="card-title">
                <i class="fas fa-clipboard-list"></i> Partes Recientes
            </h3>
        </div>
        <div class="card-body" style="padding: 0;">
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>ODT</th>
                            <th>Trabajo</th>
                            <th>Volumen</th>
                            <th>Tiempo</th>
                            <th>Fotos</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <?php if (empty($partes)): ?>
                                <tr>
                                    <td colspan="8" style="text-align: center; padding: 40px; color: var(--text-muted);">
                                        <i class="fas fa-clipboard" style="font-size: 2rem; opacity: 0.5; display: block; margin-bottom: 10px;"></i>
                                        No hay partes registrados
                                    </td>
                                </tr>
                        <?php else: ?>
                                <?php foreach ($partes as $p): ?>
                                        <tr data-id="<?php echo $p['id_parte']; ?>">
                                            <td><?php echo date('d/m/Y', strtotime($p['fecha_ejecucion'])); ?></td>
                                            <td><strong><?php echo htmlspecialchars($p['nro_odt_assa']); ?></strong></td>
                                            <td><?php echo htmlspecialchars($p['tipologia_nombre'] ?? 'N/A'); ?></td>
                                            <td>
                                                <?php echo number_format($p['volumen_calculado'] ?? 0, 2); ?>
                                                <?php echo $p['unidad_volumen'] ?? ''; ?>
                                            </td>
                                            <td>
                                                <?php echo floor(($p['tiempo_ejecucion_real'] ?? 0) / 60); ?>h
                                                <?php echo ($p['tiempo_ejecucion_real'] ?? 0) % 60; ?>m
                                            </td>
                                            <td>
                                                <span style="color: <?php echo ($p['cant_fotos'] >= 3) ? 'var(--color-success)' : 'var(--color-warning)'; ?>">
                                                    <?php echo $p['cant_fotos']; ?>/3
                                                </span>
                                            </td>
                                            <td>
                                                <span class="status-badge status-<?php echo $p['estado']; ?>">
                                                    <?php echo $p['estado']; ?>
                                                </span>
                                            </td>
                                            <td>
                                                <button class="btn-icon view" onclick="loadParte(<?php echo $p['id_parte']; ?>)" title="Ver">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </td>
                                        </tr>
                                <?php endforeach; ?>
                        <?php endif; ?>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    // ============================================================================
    // VARIABLES GLOBALES
    // ============================================================================
    const materiales = <?php echo json_encode($materiales); ?>;
    let materialRowCount = 0;

    // ============================================================================
    // CÁLCULOS AUTOMÁTICOS
    // ============================================================================

    function calcularTiempo() {
        const inicio = document.getElementById('hora_inicio').value;
        const fin = document.getElementById('hora_fin').value;

        if (inicio && fin) {
            const [hi, mi] = inicio.split(':').map(Number);
            const [hf, mf] = fin.split(':').map(Number);

            let minutos = (hf * 60 + mf) - (hi * 60 + mi);
            if (minutos < 0) minutos += 24 * 60; // Si cruza medianoche

            const horas = Math.floor(minutos / 60);
            const mins = minutos % 60;

            document.getElementById('tiempoCalculado').textContent = `${horas}h ${mins.toString().padStart(2, '0')}m`;
        }
    }

    function calcularVolumen() {
        const largo = parseFloat(document.getElementById('largo').value) || 0;
        const ancho = parseFloat(document.getElementById('ancho').value) || 0;
        const profundidad = parseFloat(document.getElementById('profundidad').value) || 0;

        let volumen, unidad;

        if (profundidad > 0) {
            volumen = largo * ancho * profundidad;
            unidad = 'M³';
        } else {
            volumen = largo * ancho;
            unidad = 'M²';
        }

        document.getElementById('volumenCalculado').textContent = volumen.toFixed(2);
        document.getElementById('unidadVolumen').textContent = unidad;
    }

    function updateUnidadMedida() {
        const select = document.getElementById('id_tipologia');
        const option = select.options[select.selectedIndex];
        const unidad = option?.dataset.unidad || '';

        // Podría usarse para preconfigurar profundidad según tipo
    }

    // ============================================================================
    // MATERIALES DINÁMICOS
    // ============================================================================

    function addMaterialRow() {
        const container = document.getElementById('materialesContainer');
        const rowId = materialRowCount++;

        const row = document.createElement('div');
        row.className = 'material-row';
        row.id = `materialRow_${rowId}`;
        row.innerHTML = `
        <select name="materiales[${rowId}][id]" class="form-control" onchange="updateStockDisplay(this, ${rowId})">
            <option value="">Seleccione...</option>
            ${materiales.map(m => `
                <option value="${m.id_material}" data-stock="${m.stock_disponible}" data-unidad="${m.unidad_medida || ''}">
                    ${m.nombre}
                </option>
            `).join('')}
        </select>
        <span class="stock-display" id="stock_${rowId}" style="text-align: center; color: var(--text-muted);">-</span>
        <input type="number" name="materiales[${rowId}][cantidad]" class="form-control" 
               step="0.01" min="0.01" placeholder="0">
        <button type="button" class="btn-remove" onclick="removeMaterialRow(${rowId})">
            <i class="fas fa-times"></i>
        </button>
    `;

        container.appendChild(row);
    }

    function updateStockDisplay(select, rowId) {
        const option = select.options[select.selectedIndex];
        const stock = option?.dataset.stock || '-';
        const unidad = option?.dataset.unidad || '';
        document.getElementById(`stock_${rowId}`).textContent = stock + ' ' + unidad;
    }

    function removeMaterialRow(rowId) {
        const row = document.getElementById(`materialRow_${rowId}`);
        if (row) row.remove();
    }

    // ============================================================================
    // PERSONAL MULTI-SELECT
    // ============================================================================

    document.querySelectorAll('.multi-select-item').forEach(item => {
        item.addEventListener('click', function (e) {
            if (e.target.tagName !== 'INPUT') {
                const checkbox = this.querySelector('input');
                checkbox.checked = !checkbox.checked;
                this.classList.toggle('selected', checkbox.checked);
            }
        });

        const checkbox = item.querySelector('input');
        checkbox.addEventListener('change', function () {
            item.classList.toggle('selected', this.checked);
        });
    });

    // ============================================================================
    // FOTOS
    // ============================================================================

    function previewPhoto(input, tipo) {
        const slot = document.getElementById(`slot${tipo}`);

        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function (e) {
                // Limpiar contenido existente
                const existingImg = slot.querySelector('img');
                if (existingImg) existingImg.remove();

                // Crear imagen
                const img = document.createElement('img');
                img.src = e.target.result;
                slot.appendChild(img);
                slot.classList.add('has-image');
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    function removePhoto(tipo) {
        const slot = document.getElementById(`slot${tipo}`);
        const img = slot.querySelector('img');
        const input = slot.querySelector('input');

        if (img) img.remove();
        if (input) input.value = '';
        slot.classList.remove('has-image');
    }

    // ============================================================================
    // FORMULARIO
    // ============================================================================

    function resetForm() {
        document.getElementById('formParte').reset();
        document.getElementById('id_parte').value = '';
        document.getElementById('materialesContainer').innerHTML = '';
        materialRowCount = 0;

        document.querySelectorAll('.multi-select-item').forEach(item => {
            item.classList.remove('selected');
            item.querySelector('input').checked = false;
        });

        ['Inicio', 'Proceso', 'Fin'].forEach(tipo => removePhoto(tipo));

        calcularTiempo();
        calcularVolumen();
    }

    async function guardarBorrador() {
        await submitForm('Borrador');
    }

    document.getElementById('formParte').addEventListener('submit', async function (e) {
        e.preventDefault();

        // Validar fotos
        const fotoInicio = document.querySelector('input[name="foto_inicio"]').files.length;
        const fotoProceso = document.querySelector('input[name="foto_proceso"]').files.length;
        const fotoFin = document.querySelector('input[name="foto_fin"]').files.length;

        if (fotoInicio === 0 || fotoProceso === 0 || fotoFin === 0) {
            showToast('Debe subir las 3 fotos obligatorias (Inicio, Proceso, Fin)', 'warning');
            return;
        }

        await submitForm('Enviado');
    });

    async function submitForm(estado) {
        const form = document.getElementById('formParte');
        const formData = new FormData(form);
        formData.append('estado', estado);

        try {
            const response = await fetch('api/save_parte.php', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (data.success) {
                showToast(estado === 'Borrador' ? 'Borrador guardado' : 'Parte enviado correctamente', 'success');
                location.reload();
            } else {
                showToast('Error: ' + data.error, 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            showToast('Error de conexión', 'error');
        }
    }

    async function loadParte(id) {
        // TODO: Implementar carga de parte existente
        showToast('Cargando parte #' + id, 'info');
    }

    // Inicialización
    document.addEventListener('DOMContentLoaded', function () {
        calcularTiempo();
        calcularVolumen();
    });
</script>

<?php require_once '../../includes/footer.php'; ?>

================================================================================
 MODULE: PERSONAL
 FILE: personal\delete.php
================================================================================
<?php
// [!] ARQUITECTURA: Endpoint de eliminación de personal con auditoría
// [→] EDITAR AQUÍ: Rutas de inclusión si cambia la estructura
require_once '../../config/database.php';
require_once '../../includes/auth.php';

// [✓] AUDITORÍA CRUD: Verificación de sesión obligatoria
verificarSesion();

$id = $_GET['id'] ?? null;

if (!$id) {
    header('Location: index.php');
    exit;
}

try {
    // [!] ARQUITECTURA: Obtener nombre antes de eliminar para auditoría
    $infoStmt = $pdo->prepare("SELECT nombre_apellido FROM personal WHERE id_personal = ?");
    $infoStmt->execute([$id]);
    $nombre = $infoStmt->fetchColumn();

    $stmt = $pdo->prepare("DELETE FROM personal WHERE id_personal = ?");
    $stmt->execute([$id]);

    if ($stmt->rowCount() > 0) {
        $_SESSION['success'] = 'Personal eliminado correctamente.';
        // [✓] AUDITORÍA CRUD: Registrar eliminación
        registrarAccion('ELIMINAR', 'personal', "Personal eliminado: $nombre", $id);
    } else {
        $_SESSION['error'] = 'No se encontró el registro a eliminar.';
    }
} catch (PDOException $e) {
    $_SESSION['error'] = 'Error al eliminar: ' . $e->getMessage();
}

header('Location: index.php');
exit;


================================================================================
 MODULE: PERSONAL
 FILE: personal\form.php
================================================================================
<?php
require_once '../../config/database.php';
require_once '../../includes/header.php';

// Check if editing
$id = $_GET['id'] ?? null;
$personal = null;
$isEdit = false;

if ($id) {
    $stmt = $pdo->prepare("SELECT * FROM personal WHERE id_personal = ?");
    $stmt->execute([$id]);
    $personal = $stmt->fetch(PDO::FETCH_ASSOC);
    $isEdit = (bool)$personal;
}

// Fetch cuadrillas for dropdown
$cuadrillas = $pdo->query("SELECT * FROM cuadrillas WHERE estado_operativo = 'Activa' ORDER BY nombre_cuadrilla")->fetchAll(PDO::FETCH_ASSOC);

$roles = ['Oficial', 'Ayudante', 'Administrativo', 'Supervisor', 'Chofer'];
$grupos_sanguineos = ['A+', 'A-', 'B+', 'B-', 'AB+', 'AB-', 'O+', 'O-'];
$talles_ropa = ['XS', 'S', 'M', 'L', 'XL', 'XXL', 'XXXL'];
?>

<div class="container-fluid" style="padding: 0 20px; max-width: 900px;">

    <!-- Header -->
    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 25px;">
        <a href="index.php" class="btn btn-outline" style="padding: 8px 12px;">
            <i class="fas fa-arrow-left"></i>
        </a>
        <div>
            <h2 style="margin: 0;">
                <i class="fas fa-<?php echo $isEdit ? 'user-edit' : 'user-plus'; ?>"></i>
                <?php echo $isEdit ? 'Editar Personal' : 'Nuevo Personal'; ?>
            </h2>
            <p style="margin: 5px 0 0; color: #666;">Legajo Digital del Empleado</p>
        </div>
    </div>

    <!-- Form Card with Tabs -->
    <div class="card" style="border-top: 4px solid var(--color-primary);">
        
        <!-- Tab Navigation -->
        <div class="tab-nav">
            <button class="tab-btn active" onclick="showTab('basico')">
                <i class="fas fa-user"></i> Datos Básicos
            </button>
            <button class="tab-btn" onclick="showTab('seguridad')">
                <i class="fas fa-shield-alt"></i> Seguridad / EPP
            </button>
            <button class="tab-btn" onclick="showTab('salud')">
                <i class="fas fa-heartbeat"></i> Salud
            </button>
            <button class="tab-btn" onclick="showTab('admin')">
                <i class="fas fa-folder-open"></i> Administrativo
            </button>
        </div>

        <form action="save.php" method="POST" id="personalForm">
            <?php if ($isEdit): ?>
                <input type="hidden" name="id_personal" value="<?php echo $personal['id_personal']; ?>">
            <?php endif; ?>

            <!-- TAB: Datos Básicos -->
            <div class="tab-content active" id="tab-basico">
                <h4 class="section-title"><i class="fas fa-id-card"></i> Información Personal</h4>
                
                <div class="form-row two-cols">
                    <div class="form-group">
                        <label for="nombre_apellido">Nombre y Apellido *</label>
                        <input type="text" name="nombre_apellido" id="nombre_apellido" required
                               class="form-control" placeholder="Ej: Juan Pérez"
                               value="<?php echo htmlspecialchars($personal['nombre_apellido'] ?? ''); ?>">
                    </div>
                    <div class="form-group">
                        <label for="dni">DNI *</label>
                        <input type="text" name="dni" id="dni" required
                               class="form-control" placeholder="Ej: 30123456"
                               value="<?php echo htmlspecialchars($personal['dni'] ?? ''); ?>">
                    </div>
                </div>

                <div class="form-row two-cols">
                    <div class="form-group">
                        <label for="telefono_personal">Teléfono Personal</label>
                        <input type="text" name="telefono_personal" id="telefono_personal"
                               class="form-control" placeholder="Ej: 11-3456-7890"
                               value="<?php echo htmlspecialchars($personal['telefono_personal'] ?? ''); ?>">
                    </div>
                    <div class="form-group">
                        <label for="domicilio">Domicilio</label>
                        <input type="text" name="domicilio" id="domicilio"
                               class="form-control" placeholder="Calle, Número, Localidad"
                               value="<?php echo htmlspecialchars($personal['domicilio'] ?? ''); ?>">
                    </div>
                </div>

                <h4 class="section-title"><i class="fas fa-hard-hat"></i> Asignación Laboral</h4>

                <div class="form-row two-cols">
                    <div class="form-group">
                        <label for="rol">Rol *</label>
                        <select name="rol" id="rol" required class="form-control">
                            <option value="">Seleccionar...</option>
                            <?php foreach ($roles as $r): ?>
                                <option value="<?php echo $r; ?>" <?php echo ($personal['rol'] ?? '') === $r ? 'selected' : ''; ?>>
                                    <?php echo $r; ?>
                                </option>
                            <?php endforeach; ?>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="id_cuadrilla">Cuadrilla Asignada</label>
                        <select name="id_cuadrilla" id="id_cuadrilla" class="form-control">
                            <option value="">Sin asignar</option>
                            <?php foreach ($cuadrillas as $c): ?>
                                <option value="<?php echo $c['id_cuadrilla']; ?>" 
                                        <?php echo ($personal['id_cuadrilla'] ?? '') == $c['id_cuadrilla'] ? 'selected' : ''; ?>>
                                    <?php echo $c['nombre_cuadrilla']; ?>
                                </option>
                            <?php endforeach; ?>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="fecha_ingreso">Fecha de Ingreso</label>
                        <input type="date" name="fecha_ingreso" id="fecha_ingreso" class="form-control"
                               value="<?php echo $personal['fecha_ingreso'] ?? ''; ?>">
                    </div>
                </div>
            </div>

            <!-- TAB: Seguridad / EPP -->
            <div class="tab-content" id="tab-seguridad">
                <h4 class="section-title"><i class="fas fa-vest"></i> Elementos de Protección Personal</h4>

                <div class="form-row two-cols">
                    <div class="form-group">
                        <label for="talle_ropa">Talle Ropa</label>
                        <select name="talle_ropa" id="talle_ropa" class="form-control">
                            <option value="">Seleccionar...</option>
                            <?php foreach ($talles_ropa as $t): ?>
                                <option value="<?php echo $t; ?>" <?php echo ($personal['talle_ropa'] ?? '') === $t ? 'selected' : ''; ?>>
                                    <?php echo $t; ?>
                                </option>
                            <?php endforeach; ?>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="talle_calzado">Talle Calzado</label>
                        <input type="text" name="talle_calzado" id="talle_calzado"
                               class="form-control" placeholder="Ej: 42"
                               value="<?php echo htmlspecialchars($personal['talle_calzado'] ?? ''); ?>">
                    </div>
                </div>

                <div class="form-row two-cols">
                    <div class="form-group">
                        <label for="fecha_ultima_entrega_epp">Última Entrega EPP</label>
                        <input type="date" name="fecha_ultima_entrega_epp" id="fecha_ultima_entrega_epp" class="form-control"
                               value="<?php echo $personal['fecha_ultima_entrega_epp'] ?? ''; ?>">
                    </div>
                    <div class="form-group">
                        <label for="seguro_art">N° Seguro ART</label>
                        <input type="text" name="seguro_art" id="seguro_art"
                               class="form-control" placeholder="Número de póliza"
                               value="<?php echo htmlspecialchars($personal['seguro_art'] ?? ''); ?>">
                    </div>
                </div>

                <h4 class="section-title"><i class="fas fa-car"></i> Documentación Vehículo</h4>

                <div class="form-row">
                    <div class="form-group" style="max-width: 300px;">
                        <label for="vencimiento_carnet_conducir">Vencimiento Carnet de Conducir</label>
                        <input type="date" name="vencimiento_carnet_conducir" id="vencimiento_carnet_conducir" class="form-control"
                               value="<?php echo $personal['vencimiento_carnet_conducir'] ?? ''; ?>">
                    </div>
                </div>
            </div>

            <!-- TAB: Salud -->
            <div class="tab-content" id="tab-salud">
                <h4 class="section-title"><i class="fas fa-notes-medical"></i> Información Médica</h4>

                <div class="form-row two-cols">
                    <div class="form-group">
                        <label for="grupo_sanguineo">Grupo Sanguíneo</label>
                        <select name="grupo_sanguineo" id="grupo_sanguineo" class="form-control">
                            <option value="">Seleccionar...</option>
                            <?php foreach ($grupos_sanguineos as $gs): ?>
                                <option value="<?php echo $gs; ?>" <?php echo ($personal['grupo_sanguineo'] ?? '') === $gs ? 'selected' : ''; ?>>
                                    <?php echo $gs; ?>
                                </option>
                            <?php endforeach; ?>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="numero_emergencia">Teléfono de Emergencia</label>
                        <input type="text" name="numero_emergencia" id="numero_emergencia"
                               class="form-control" placeholder="Contacto en caso de emergencia"
                               value="<?php echo htmlspecialchars($personal['numero_emergencia'] ?? ''); ?>">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="alergias_condiciones">Alergias / Condiciones Médicas</label>
                        <textarea name="alergias_condiciones" id="alergias_condiciones" rows="3"
                                  class="form-control" placeholder="Describir alergias, medicamentos, condiciones relevantes..."><?php echo htmlspecialchars($personal['alergias_condiciones'] ?? ''); ?></textarea>
                    </div>
                </div>
            </div>

            <!-- TAB: Administrativo -->
            <div class="tab-content" id="tab-admin">
                <h4 class="section-title"><i class="fas fa-university"></i> Datos Bancarios</h4>

                <div class="form-row">
                    <div class="form-group">
                        <label for="cbu_alias">CBU / Alias</label>
                        <input type="text" name="cbu_alias" id="cbu_alias"
                               class="form-control" placeholder="CBU o Alias para transferencias"
                               value="<?php echo htmlspecialchars($personal['cbu_alias'] ?? ''); ?>">
                    </div>
                </div>

                <h4 class="section-title"><i class="fas fa-link"></i> Documentación Digital</h4>

                <div class="form-row">
                    <div class="form-group">
                        <label for="link_legajo_digital">Link Legajo Digital (Google Drive, etc.)</label>
                        <input type="url" name="link_legajo_digital" id="link_legajo_digital"
                               class="form-control" placeholder="https://drive.google.com/..."
                               value="<?php echo htmlspecialchars($personal['link_legajo_digital'] ?? ''); ?>">
                    </div>
                </div>
            </div>

            <!-- Form Actions (Always visible) -->
            <div class="form-actions">
                <a href="index.php" class="btn btn-outline">Cancelar</a>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> <?php echo $isEdit ? 'Guardar Cambios' : 'Crear Personal'; ?>
                </button>
            </div>
        </form>
    </div>
</div>

<style>
    .tab-nav {
        display: flex;
        gap: 5px;
        border-bottom: 2px solid #eee;
        padding-bottom: 0;
        margin-bottom: 25px;
        flex-wrap: wrap;
    }
    
    .tab-btn {
        background: none;
        border: none;
        padding: 12px 20px;
        font-size: 0.9em;
        color: #666;
        cursor: pointer;
        border-bottom: 3px solid transparent;
        margin-bottom: -2px;
        transition: all 0.2s;
    }
    .tab-btn:hover { color: var(--color-primary); }
    .tab-btn.active {
        color: var(--color-primary);
        border-bottom-color: var(--color-primary);
        font-weight: 600;
    }
    .tab-btn i { margin-right: 6px; }
    
    .tab-content {
        display: none;
        animation: fadeIn 0.3s;
    }
    .tab-content.active { display: block; }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-5px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .section-title {
        color: #333;
        font-size: 1em;
        margin: 25px 0 15px;
        padding-bottom: 8px;
        border-bottom: 1px solid #eee;
    }
    .section-title:first-child { margin-top: 0; }
    .section-title i { color: var(--color-primary); margin-right: 8px; }
    
    .form-row { margin-bottom: 15px; }
    .form-row.two-cols { 
        display: grid; 
        grid-template-columns: 1fr 1fr; 
        gap: 20px; 
    }
    @media (max-width: 600px) {
        .form-row.two-cols { grid-template-columns: 1fr; }
    }
    
    .form-group label {
        display: block;
        margin-bottom: 6px;
        font-weight: 500;
        color: #555;
        font-size: 0.9em;
    }
    
    .form-control {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 0.95em;
        transition: border-color 0.2s;
    }
    .form-control:focus {
        outline: none;
        border-color: var(--color-primary);
    }
    
    textarea.form-control { resize: vertical; min-height: 80px; }
    
    .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid #eee;
    }
</style>

<script>
    function showTab(tabId) {
        // Hide all tabs
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        
        // Show selected tab
        document.getElementById('tab-' + tabId).classList.add('active');
        event.target.closest('.tab-btn').classList.add('active');
    }
</script>

<?php require_once '../../includes/footer.php'; ?>

================================================================================
 MODULE: PERSONAL
 FILE: personal\index.php
================================================================================
<?php
require_once '../../config/database.php';
require_once '../../includes/header.php';

// Fetch Personal with Cuadrilla names
$sql = "SELECT p.*, c.nombre_cuadrilla 
        FROM personal p
        LEFT JOIN cuadrillas c ON p.id_cuadrilla = c.id_cuadrilla
        ORDER BY p.nombre_apellido ASC";
$personal = $pdo->query($sql)->fetchAll(PDO::FETCH_ASSOC);

// Get unique roles and cuadrillas for filters
$roles = ['Oficial', 'Ayudante', 'Administrativo', 'Supervisor', 'Chofer'];
$cuadrillas = $pdo->query("SELECT * FROM cuadrillas ORDER BY nombre_cuadrilla")->fetchAll(PDO::FETCH_ASSOC);

// Metrics
$total_personal = count($personal);
$by_role = [];
$alertas = 0;
$hoy = date('Y-m-d');
$en_30_dias = date('Y-m-d', strtotime('+30 days'));

foreach ($personal as &$p) {
    $by_role[$p['rol']] = ($by_role[$p['rol']] ?? 0) + 1;

    // Check for alerts
    $p['_alertas'] = [];
    if (!empty($p['vencimiento_carnet_conducir']) && $p['vencimiento_carnet_conducir'] <= $en_30_dias) {
        $p['_alertas'][] = 'Carnet ' . ($p['vencimiento_carnet_conducir'] <= $hoy ? 'vencido' : 'por vencer');
        $alertas++;
    }
}
unset($p);
?>

<div class="container-fluid" style="padding: 0 20px;">

    <!-- Header -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
        <div>
            <h2 style="margin: 0;"><i class="fas fa-users"></i> Gestión de Personal</h2>
            <p style="margin: 5px 0 0; color: #666;">Legajo Digital de Empleados</p>
        </div>
        <a href="form.php" class="btn btn-primary"><i class="fas fa-user-plus"></i> Nuevo Personal</a>
    </div>

    <!-- Metrics Cards -->
    <div class="metrics-row">
        <div class="metric-mini">
            <i class="fas fa-users" style="color: #1976d2;"></i>
            <span class="metric-val"><?php echo $total_personal; ?></span>
            <span class="metric-lbl">Total</span>
        </div>
        <div class="metric-mini">
            <i class="fas fa-hard-hat" style="color: #388e3c;"></i>
            <span class="metric-val"><?php echo $by_role['Oficial'] ?? 0; ?></span>
            <span class="metric-lbl">Oficiales</span>
        </div>
        <div class="metric-mini">
            <i class="fas fa-hands-helping" style="color: #f57c00;"></i>
            <span class="metric-val"><?php echo $by_role['Ayudante'] ?? 0; ?></span>
            <span class="metric-lbl">Ayudantes</span>
        </div>
        <div class="metric-mini">
            <i class="fas fa-user-tie" style="color: #7b1fa2;"></i>
            <span
                class="metric-val"><?php echo ($by_role['Supervisor'] ?? 0) + ($by_role['Administrativo'] ?? 0); ?></span>
            <span class="metric-lbl">Admin/Sup</span>
        </div>
        <?php if ($alertas > 0): ?>
            <div class="metric-mini" style="background: #fff3e0; border-left: 3px solid #ff9800;">
                <i class="fas fa-exclamation-triangle" style="color: #ff9800;"></i>
                <span class="metric-val" style="color: #e65100;"><?php echo $alertas; ?></span>
                <span class="metric-lbl">Alertas</span>
            </div>
        <?php endif; ?>
    </div>

    <!-- Main Card -->
    <div class="card" style="border-top: 4px solid var(--color-primary);">

        <!-- Filters -->
        <div class="filter-bar">
            <div class="filter-group">
                <label>Buscar</label>
                <input type="text" id="searchInput" onkeyup="filterTable()" placeholder="Nombre o DNI..."
                    class="form-control-sm">
            </div>
            <div class="filter-group">
                <label>Rol</label>
                <select id="filterRol" onchange="filterTable()" class="form-control-sm">
                    <option value="">Todos</option>
                    <?php foreach ($roles as $r): ?>
                        <option value="<?php echo $r; ?>"><?php echo $r; ?></option>
                    <?php endforeach; ?>
                </select>
            </div>
            <div class="filter-group">
                <label>Cuadrilla</label>
                <select id="filterCuadrilla" onchange="filterTable()" class="form-control-sm">
                    <option value="">Todas</option>
                    <option value="SIN_ASIGNAR">Sin Asignar</option>
                    <?php foreach ($cuadrillas as $c): ?>
                        <option value="<?php echo $c['nombre_cuadrilla']; ?>"><?php echo $c['nombre_cuadrilla']; ?></option>
                    <?php endforeach; ?>
                </select>
            </div>
            <div class="filter-group" style="flex: 0 0 auto;">
                <button onclick="resetFilters()" class="btn btn-outline btn-sm" title="Limpiar Filtros">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </div>

        <!-- Table -->
        <div style="overflow-x: auto;">
            <table class="table" id="personalTable">
                <thead>
                    <tr>
                        <th>Nombre y Apellido</th>
                        <th>DNI</th>
                        <th>Rol</th>
                        <th>Cuadrilla</th>
                        <th>Teléfono</th>
                        <th class="text-center">Estado</th>
                        <th class="text-center">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <?php if (empty($personal)): ?>
                        <tr>
                            <td colspan="7" class="text-center" style="padding: 40px; color: #999;">
                                <i class="fas fa-user-slash" style="font-size: 2em; margin-bottom: 10px;"></i><br>
                                No hay personal registrado
                            </td>
                        </tr>
                    <?php else: ?>
                        <?php foreach ($personal as $p): ?>
                            <tr data-name="<?php echo strtolower($p['nombre_apellido'] . ' ' . $p['dni']); ?>"
                                data-rol="<?php echo $p['rol']; ?>"
                                data-cuadrilla="<?php echo $p['nombre_cuadrilla'] ?? 'SIN_ASIGNAR'; ?>">
                                <td>
                                    <div style="font-weight: 500;"><?php echo htmlspecialchars($p['nombre_apellido']); ?></div>
                                    <?php if (!empty($p['fecha_ingreso'])): ?>
                                        <small style="color: #888;">Ingreso:
                                            <?php echo date('d/m/Y', strtotime($p['fecha_ingreso'])); ?></small>
                                    <?php endif; ?>
                                </td>
                                <td><code><?php echo htmlspecialchars($p['dni']); ?></code></td>
                                <td>
                                    <span class="badge-rol <?php echo strtolower($p['rol']); ?>">
                                        <?php echo $p['rol']; ?>
                                    </span>
                                </td>
                                <td>
                                    <?php if ($p['nombre_cuadrilla']): ?>
                                        <span class="badge-cuadrilla">
                                            <i class="fas fa-hard-hat"></i> <?php echo $p['nombre_cuadrilla']; ?>
                                        </span>
                                    <?php else: ?>
                                        <span style="color: #999;">Sin asignar</span>
                                    <?php endif; ?>
                                </td>
                                <td>
                                    <?php if ($p['telefono_personal']): ?>
                                        <a href="tel:<?php echo $p['telefono_personal']; ?>" style="color: #666;">
                                            <i class="fas fa-phone"></i> <?php echo $p['telefono_personal']; ?>
                                        </a>
                                    <?php else: ?>
                                        <span style="color: #ccc;">—</span>
                                    <?php endif; ?>
                                </td>
                                <td class="text-center">
                                    <?php if (!empty($p['_alertas'])): ?>
                                        <span class="badge-alert" title="<?php echo implode(', ', $p['_alertas']); ?>">
                                            <i class="fas fa-exclamation-triangle"></i>
                                        </span>
                                    <?php else: ?>
                                        <span class="badge-ok"><i class="fas fa-check"></i></span>
                                    <?php endif; ?>
                                </td>
                                <td class="text-center">
                                    <a href="form.php?id=<?php echo $p['id_personal']; ?>" class="btn-icon" title="Editar">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <button
                                        onclick="confirmDelete(<?php echo $p['id_personal']; ?>, '<?php echo addslashes($p['nombre_apellido']); ?>')"
                                        class="btn-icon btn-danger" title="Eliminar">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        <?php endforeach; ?>
                    <?php endif; ?>
                </tbody>
            </table>
        </div>
        <div id="noResults" style="display:none; padding: 20px; text-align: center; color: #999;">
            No se encontró personal con los filtros aplicados.
        </div>
    </div>
</div>

<style>
    .metrics-row {
        display: flex;
        gap: 15px;
        margin-bottom: 25px;
        flex-wrap: wrap;
    }

    .metric-mini {
        background: white;
        border-radius: 10px;
        padding: 15px 20px;
        display: flex;
        align-items: center;
        gap: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        min-width: 130px;
    }

    .metric-mini i {
        font-size: 1.3em;
    }

    .metric-val {
        font-size: 1.4em;
        font-weight: 700;
        color: #333;
    }

    .metric-lbl {
        font-size: 0.8em;
        color: #888;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
        min-width: 150px;
    }

    .filter-group label {
        font-size: 0.8em;
        font-weight: bold;
        color: #666;
        margin-bottom: 4px;
    }

    .form-control-sm {
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 0.9em;
    }

    .badge-rol {
        padding: 4px 10px;
        border-radius: 15px;
        font-size: 0.8em;
        font-weight: 500;
    }

    .badge-rol.oficial {
        background: #e8f5e9;
        color: #2e7d32;
    }

    .badge-rol.ayudante {
        background: #fff3e0;
        color: #ef6c00;
    }

    .badge-rol.supervisor {
        background: #f3e5f5;
        color: #7b1fa2;
    }

    .badge-rol.administrativo {
        background: #e0f7fa;
        color: #00838f;
    }

    .badge-rol.chofer {
        background: #e8eaf6;
        color: #3949ab;
    }

    .badge-cuadrilla {
        background: #e3f2fd;
        color: #1565c0;
        padding: 4px 10px;
        border-radius: 15px;
        font-size: 0.85em;
    }

    .badge-alert {
        background: #fff3e0;
        color: #ff9800;
        padding: 4px 8px;
        border-radius: 50%;
    }

    .badge-ok {
        color: #4caf50;
    }

    .btn-icon {
        background: none;
        border: 1px solid #eee;
        border-radius: 6px;
        padding: 6px 10px;
        color: var(--color-primary);
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        margin: 0 2px;
        transition: all 0.2s;
    }

    .btn-icon:hover {
        background: var(--color-primary);
        color: white;
    }

    .btn-icon.btn-danger {
        color: #dc3545;
        border-color: #fdd;
    }

    .btn-icon.btn-danger:hover {
        background: #dc3545;
        color: white;
    }

    .text-center {
        text-align: center;
    }
</style>

<script>
    function filterTable() {
        const search = document.getElementById('searchInput').value.toLowerCase();
        const rol = document.getElementById('filterRol').value;
        const cuadrilla = document.getElementById('filterCuadrilla').value;

        const rows = document.querySelectorAll('#personalTable tbody tr[data-name]');
        let visible = 0;

        rows.forEach(row => {
            const matchSearch = row.dataset.name.includes(search);
            const matchRol = !rol || row.dataset.rol === rol;
            const matchCuadrilla = !cuadrilla || row.dataset.cuadrilla === cuadrilla;

            const show = matchSearch && matchRol && matchCuadrilla;
            row.style.display = show ? '' : 'none';
            if (show) visible++;
        });

        document.getElementById('noResults').style.display = visible === 0 ? 'block' : 'none';
    }

    function resetFilters() {
        document.getElementById('searchInput').value = '';
        document.getElementById('filterRol').value = '';
        document.getElementById('filterCuadrilla').value = '';
        filterTable();
    }

    function confirmDelete(id, nombre) {
        if (confirm('¿Eliminar a "' + nombre + '"?\n\nEsta acción no se puede deshacer.')) {
            window.location.href = 'delete.php?id=' + id;
        }
    }
</script>

<?php require_once '../../includes/footer.php'; ?>

================================================================================
 MODULE: PERSONAL
 FILE: personal\save.php
================================================================================
<?php
// [!] ARQUITECTURA: Endpoint de guardado de personal con seguridad
// [→] EDITAR AQUÍ: Rutas de inclusión si cambia la estructura
require_once '../../config/database.php';
require_once '../../includes/auth.php';

// [✓] AUDITORÍA CRUD: Verificación de sesión obligatoria
verificarSesion();

if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
    header('Location: index.php');
    exit;
}

// Basic Data
$id = $_POST['id_personal'] ?? null;
$nombre_apellido = trim($_POST['nombre_apellido'] ?? '');
$dni = trim($_POST['dni'] ?? '');
$telefono = trim($_POST['telefono_personal'] ?? '');
$domicilio = trim($_POST['domicilio'] ?? '');
$rol = $_POST['rol'] ?? 'Ayudante';
$id_cuadrilla = $_POST['id_cuadrilla'] ?: null;
$fecha_ingreso = $_POST['fecha_ingreso'] ?: null;

// Security/EPP Data
$talle_ropa = $_POST['talle_ropa'] ?? null;
$talle_calzado = trim($_POST['talle_calzado'] ?? '');
$fecha_ultima_entrega_epp = $_POST['fecha_ultima_entrega_epp'] ?: null;
$seguro_art = trim($_POST['seguro_art'] ?? '');
$vencimiento_carnet_conducir = $_POST['vencimiento_carnet_conducir'] ?: null;

// Health Data
$grupo_sanguineo = $_POST['grupo_sanguineo'] ?? null;
$numero_emergencia = trim($_POST['numero_emergencia'] ?? '');
$alergias_condiciones = trim($_POST['alergias_condiciones'] ?? '');

// Administrative Data
$cbu_alias = trim($_POST['cbu_alias'] ?? '');
$link_legajo_digital = trim($_POST['link_legajo_digital'] ?? '');

// Validation
if (empty($nombre_apellido) || empty($dni) || empty($rol)) {
    $_SESSION['error'] = 'Nombre, DNI y Rol son obligatorios.';
    header('Location: form.php' . ($id ? "?id=$id" : ''));
    exit;
}

try {
    if ($id) {
        // Update
        $sql = "UPDATE personal SET 
                    nombre_apellido = ?, 
                    dni = ?, 
                    telefono_personal = ?,
                    domicilio = ?,
                    rol = ?, 
                    id_cuadrilla = ?,
                    fecha_ingreso = ?,
                    talle_ropa = ?,
                    talle_calzado = ?,
                    fecha_ultima_entrega_epp = ?,
                    seguro_art = ?,
                    vencimiento_carnet_conducir = ?,
                    grupo_sanguineo = ?,
                    numero_emergencia = ?,
                    alergias_condiciones = ?,
                    cbu_alias = ?,
                    link_legajo_digital = ?
                WHERE id_personal = ?";
        $stmt = $pdo->prepare($sql);
        $stmt->execute([
            $nombre_apellido,
            $dni,
            $telefono,
            $domicilio,
            $rol,
            $id_cuadrilla,
            $fecha_ingreso,
            $talle_ropa,
            $talle_calzado,
            $fecha_ultima_entrega_epp,
            $seguro_art,
            $vencimiento_carnet_conducir,
            $grupo_sanguineo,
            $numero_emergencia,
            $alergias_condiciones,
            $cbu_alias,
            $link_legajo_digital,
            $id
        ]);
        $_SESSION['success'] = 'Personal actualizado correctamente.';

        // [✓] AUDITORÍA CRUD: Registrar edición
        registrarAccion('EDITAR', 'personal', "Personal editado: $nombre_apellido", $id);
    } else {
        // Insert
        $sql = "INSERT INTO personal (
                    nombre_apellido, dni, telefono_personal, domicilio, rol, id_cuadrilla, fecha_ingreso,
                    talle_ropa, talle_calzado, fecha_ultima_entrega_epp, seguro_art, vencimiento_carnet_conducir,
                    grupo_sanguineo, numero_emergencia, alergias_condiciones,
                    cbu_alias, link_legajo_digital
                ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)";
        $stmt = $pdo->prepare($sql);
        $stmt->execute([
            $nombre_apellido,
            $dni,
            $telefono,
            $domicilio,
            $rol,
            $id_cuadrilla,
            $fecha_ingreso,
            $talle_ropa,
            $talle_calzado,
            $fecha_ultima_entrega_epp,
            $seguro_art,
            $vencimiento_carnet_conducir,
            $grupo_sanguineo,
            $numero_emergencia,
            $alergias_condiciones,
            $cbu_alias,
            $link_legajo_digital
        ]);
        $_SESSION['success'] = 'Personal registrado correctamente.';

        // [✓] AUDITORÍA CRUD: Registrar creación
        $newId = $pdo->lastInsertId();
        registrarAccion('CREAR', 'personal', "Personal creado: $nombre_apellido", $newId);
    }
} catch (PDOException $e) {
    if (strpos($e->getMessage(), 'Duplicate entry') !== false && strpos($e->getMessage(), 'dni') !== false) {
        $_SESSION['error'] = 'El DNI ya está registrado en el sistema.';
        header('Location: form.php' . ($id ? "?id=$id" : ''));
        exit;
    }
    $_SESSION['error'] = 'Error al guardar: ' . $e->getMessage();
    header('Location: form.php' . ($id ? "?id=$id" : ''));
    exit;
}

header('Location: index.php');
exit;


================================================================================
 MODULE: PROVEEDORES
 FILE: proveedores\delete.php
================================================================================
<?php
/**
 * Módulo: Proveedores
 * Endpoint para eliminar
 * 
 * [!] ARQUITECTURA: Verifica integridad antes de eliminar
 * [→] EDITAR AQUÍ: Rutas de inclusión si cambia la estructura
 */
require_once '../../config/database.php';
require_once '../../includes/auth.php';

// [✓] AUDITORÍA CRUD: Verificación de sesión obligatoria
verificarSesion();

$id = $_GET['id'] ?? null;

if (!$id || !is_numeric($id)) {
    header('Location: index.php?msg=error');
    exit;
}

$id = intval($id);

try {
    // [!] ARQUITECTURA: Obtener datos antes de eliminar
    $infoStmt = $pdo->prepare("SELECT razon_social FROM proveedores WHERE id_proveedor = ?");
    $infoStmt->execute([$id]);
    $razon = $infoStmt->fetchColumn();

    if (!$razon) {
        header('Location: index.php?msg=error');
        exit;
    }

    // [!] ARQUITECTURA: Verificar integridad referencial
    $checkStmt = $pdo->prepare("SELECT COUNT(*) FROM maestro_materiales WHERE id_contacto_primario IN (SELECT id_contacto FROM proveedores_contactos WHERE id_proveedor = ?) OR id_contacto_secundario IN (SELECT id_contacto FROM proveedores_contactos WHERE id_proveedor = ?)");
    $checkStmt->execute([$id, $id]);
    $materialesCount = $checkStmt->fetchColumn();

    if ($materialesCount > 0) {
        $_SESSION['error'] = "No se puede eliminar: el proveedor tiene $materialesCount material(es) asociado(s).";
        header('Location: index.php?msg=error');
        exit;
    }

    // Eliminar contactos primero (FK)
    $pdo->prepare("DELETE FROM proveedores_contactos WHERE id_proveedor = ?")->execute([$id]);

    // Eliminar proveedor
    $stmt = $pdo->prepare("DELETE FROM proveedores WHERE id_proveedor = ?");
    $stmt->execute([$id]);

    // [✓] AUDITORÍA CRUD: Registrar eliminación
    registrarAccion('ELIMINAR', 'proveedores', "Proveedor eliminado: $razon", $id);

    header('Location: index.php?msg=deleted');

} catch (PDOException $e) {
    // [!] ARQUITECTURA: No exponer errores SQL
    error_log("Error en proveedores/delete.php: " . $e->getMessage());
    $_SESSION['error'] = 'Error al eliminar el proveedor.';
    header('Location: index.php?msg=error');
}

exit;
?>

================================================================================
 MODULE: PROVEEDORES
 FILE: proveedores\form.php
================================================================================
<?php
require_once '../../config/database.php';
require_once '../../includes/header.php';

$id = $_GET['id'] ?? null;
$prov = null;
$contact = null;

// Variables para pre-llenar los selects si existen en observaciones
$selected_pagos = '';
$selected_dias = '';
$selected_horario = '';
$selected_entrega = '';
$obs_text = ''; // Initialize to avoid warning

if ($id) {
    // Fetch Provider
    $stmt = $pdo->prepare("SELECT * FROM proveedores WHERE id_proveedor = ?");
    $stmt->execute([$id]);
    $prov = $stmt->fetch(PDO::FETCH_ASSOC);

    // Fetch First Contact
    $stmt2 = $pdo->prepare("SELECT * FROM proveedores_contactos WHERE id_proveedor = ? LIMIT 1");
    $stmt2->execute([$id]);
    $contact = $stmt2->fetch(PDO::FETCH_ASSOC);

    // Parse Observations to try and pre-select dropdowns (Simple heuristic)
    // Format expecting: "Pagos: X | Días: Y | Horario: Z | Entrega: W | Obs: ..."
    $obs_text = $contact['observaciones'] ?? '';
}
?>

<div class="card" style="max-width: 800px; margin: 0 auto;">
    <h1><?php echo $id ? 'Editar' : 'Nuevo'; ?> Proveedor</h1>

    <form action="save.php" method="POST">
        <?php if ($id): ?>
            <input type="hidden" name="id_proveedor" value="<?php echo $id; ?>">
            <input type="hidden" name="id_contacto" value="<?php echo $contact['id_contacto'] ?? ''; ?>">
        <?php endif; ?>

        <!-- Datos Empresa -->
        <h3
            style="color: var(--color-primary); border-bottom: 2px solid var(--color-primary-light); margin-bottom: 15px;">
            <i class="fas fa-building"></i> Datos Empresa
        </h3>
        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div>
                <label style="font-weight: 500;">Razón Social *</label>
                <input type="text" name="razon_social" required value="<?php echo $prov['razon_social'] ?? ''; ?>"
                    style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
            </div>
            <div>
                <label style="font-weight: 500;">CUIT</label>
                <input type="text" name="cuit" value="<?php echo $prov['cuit'] ?? ''; ?>" placeholder="20-12345678-9"
                    style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
            </div>
        </div>
        
        <div style="margin-bottom: 15px;">
             <label style="font-weight: 500;">Dirección Física</label>
             <input type="text" name="direccion" value="<?php echo $prov['direccion'] ?? ''; ?>"
                 placeholder="Calle, Altura, Ciudad"
                 style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
        </div>

        <!-- Datos Contacto -->
        <h3 style="color: var(--color-neutral-dark); border-bottom: 2px solid #ccc; margin-bottom: 15px;">
            <i class="fas fa-user-tie"></i> Comercial
        </h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div>
                <label style="font-weight: 500;">Vendedor</label>
                <input type="text" name="nombre_vendedor" value="<?php echo $contact['nombre_vendedor'] ?? ''; ?>"
                    style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
            </div>
            <div>
                <label style="font-weight: 500;">Teléfono</label>
                <input type="text" name="telefono_contacto" value="<?php echo $contact['telefono_contacto'] ?? ''; ?>"
                    style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
            </div>
            <div>
                <label style="font-weight: 500;">Email</label>
                <input type="email" name="email_vendedor" value="<?php echo $contact['email_vendedor'] ?? ''; ?>"
                    style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
            </div>
        </div>

        <!-- Logística y Pagos (Desplegables) -->
        <h3 style="color: var(--color-success); border-bottom: 2px solid #ccc; margin-bottom: 15px;">
            <i class="fas fa-handshake"></i> Logística y Pagos
        </h3>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div>
                <label style="font-weight: 500;">Condición de Pago</label>
                <select name="condicion_pago"
                    style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
                    <option value="">-- Seleccionar --</option>
                    <option value="Contado Efectivo">Contado Efectivo (Caja Chica)</option>
                    <option value="Transferencia Inmediata">Transferencia Inmediata</option>
                    <option value="Cheque 30 Días">Cheque 30 Días</option>
                    <option value="Cheque 30/60 Días">Cheque 30/60 Días</option>
                    <option value="Cuenta Corriente Mensual">Cuenta Corriente Mensual</option>
                </select>
            </div>
            <div>
                <label style="font-weight: 500;">Modalidad de Entrega</label>
                <select name="modalidad_entrega"
                    style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
                    <option value="">-- Seleccionar --</option>
                    <option value="Retiro en Local">Retiro en Local (Vamos nosotros)</option>
                    <option value="Envío a Obra">Envío a Obra (Flete incluido)</option>
                    <option value="Envío a Obra (Flete aparte)">Envío a Obra (Flete aparte)</option>
                    <option value="Envío a Oficina (Acopio)">Envío a Oficina (Acopio)</option>
                </select>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div>
                <label style="font-weight: 500;">Días de Atención</label>
                <select name="dias_atencion"
                    style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
                    <option value="Lun a Vie">Lunes a Viernes</option>
                    <option value="Lun a Sab (Mediodía)">Lun a Sab (Mediodía)</option>
                    <option value="Lun a Sab (Completo)">Lun a Sab (Completo)</option>
                </select>
            </div>
            <div>
                <label style="font-weight: 500;">Horarios</label>
                <select name="horarios_atencion"
                    style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
                    <option value="Corrido (08 a 17)">Corrido (08:00 a 17:00)</option>
                    <option value="Comercial (08-12 / 15-19)">Comercial (08-12 / 15-19)</option>
                    <option value="Construcción (07-15)">Construcción (07:00 a 15:00)</option>
                    <option value="Solo Mañana">Solo Mañana</option>
                </select>
            </div>
        </div>

        <div style="margin-bottom: 20px;">
            <label style="font-weight: 500;">Notas Adicionales</label>
            <textarea name="notas_extra" rows="2" placeholder="Cualquier otro detalle..."
                style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px;"><?php
                // Show raw obs if it doesn't look formatted, otherwise empty to avoid clutter
                echo (!strpos($obs_text, '|')) ? $obs_text : '';
                ?></textarea>
        </div>

        <div style="text-align: right;">
            <a href="index.php" class="btn btn-outline" style="margin-right: 10px;">Cancelar</a>
            <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Guardar Proveedor</button>
        </div>
    </form>
</div>
<?php require_once '../../includes/footer.php'; ?>

================================================================================
 MODULE: PROVEEDORES
 FILE: proveedores\index.php
================================================================================
<?php
require_once '../../config/database.php';
require_once '../../includes/header.php';

// Fetch Providers with their Primary Contact Info
$provs = $pdo->query("SELECT p.*, c.nombre_vendedor, c.telefono_contacto, c.email_vendedor 
                      FROM proveedores p 
                      LEFT JOIN proveedores_contactos c ON p.id_proveedor = c.id_proveedor 
                      GROUP BY p.id_proveedor 
                      ORDER BY p.razon_social")->fetchAll(PDO::FETCH_ASSOC);
?>

<div class="container-fluid" style="padding: 0 20px;">
    <div class="card">
        <div
            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-lg);">
            <h1><i class="fas fa-truck"></i> Gestión de Proveedores</h1>
            <a href="form.php" class="btn btn-primary"><i class="fas fa-plus"></i> Nuevo Proveedor</a>
        </div>

        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background: var(--color-primary-dark); color: white;">
                    <th style="padding: 10px; text-align: left;">Empresa</th>
                    <th style="padding: 10px; text-align: left;">Dirección</th>
                    <th style="padding: 10px; text-align: left;">Contacto Principal</th>
                    <th style="padding: 10px; text-align: left;">Teléfono / Email</th>
                    <th style="padding: 10px; text-align: center;">Acciones</th>
                </tr>
            </thead>
            <tbody>
                <?php foreach ($provs as $p): ?>
                    <tr style="border-bottom: 1px solid #ddd;">
                        <td style="padding: 10px;">
                            <strong><?php echo $p['razon_social']; ?></strong><br>
                            <span style="font-size:0.8em; color:#666;">CUIT: <?php echo $p['cuit'] ?? '-'; ?></span>
                        </td>
                        <td style="padding: 10px;"><?php echo $p['direccion'] ?? '-'; ?></td>
                        <td style="padding: 10px;"><?php echo $p['nombre_vendedor'] ?? '-'; ?></td>
                        <td style="padding: 10px;">
                            <div><i class="fas fa-phone"></i> <?php echo $p['telefono_contacto'] ?? '-'; ?></div>
                            <div style="font-size:0.9em;"><i class="fas fa-envelope"></i>
                                <?php echo $p['email_vendedor'] ?? '-'; ?></div>
                        </td>
                        <td style="padding: 10px; text-align: center;">
                            <a href="form.php?id=<?php echo $p['id_proveedor']; ?>" class="btn btn-outline"
                                style="padding: 5px 10px;"><i class="fas fa-edit"></i></a>
                        </td>
                    </tr>
                <?php endforeach; ?>
            </tbody>
        </table>
    </div>
</div>
<?php require_once '../../includes/footer.php'; ?>

================================================================================
 MODULE: PROVEEDORES
 FILE: proveedores\save.php
================================================================================
<?php
/**
 * Módulo: Proveedores
 * Endpoint para guardar (crear/actualizar)
 * 
 * [!] ARQUITECTURA: Maneja proveedor + contacto en una transacción
 * [→] EDITAR AQUÍ: Rutas de inclusión si cambia la estructura
 */
require_once '../../config/database.php';
require_once '../../includes/auth.php';

// [✓] AUDITORÍA CRUD: Verificación de sesión obligatoria
verificarSesion();

if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
    header('Location: index.php');
    exit;
}

// Datos del Proveedor
$id_prov = $_POST['id_proveedor'] ?? null;
$razon = trim($_POST['razon_social'] ?? '');
$cuit = trim($_POST['cuit'] ?? '');
$direccion = trim($_POST['direccion'] ?? '');

// Datos del Contacto
$id_cont = $_POST['id_contacto'] ?? null;
$nom = trim($_POST['nombre_vendedor'] ?? '');
$tel = trim($_POST['telefono_contacto'] ?? '');
$email = trim($_POST['email_vendedor'] ?? '');

// Logística
$pago = $_POST['condicion_pago'] ?? '';
$entrega = $_POST['modalidad_entrega'] ?? '';
$dias = $_POST['dias_atencion'] ?? '';
$horas = $_POST['horarios_atencion'] ?? '';
$extra = trim($_POST['notas_extra'] ?? '');

// [!] ARQUITECTURA: Compilar observaciones
$obs_parts = [];
if ($pago)
    $obs_parts[] = "Pago: $pago";
if ($entrega)
    $obs_parts[] = "Entrega: $entrega";
if ($dias || $horas)
    $obs_parts[] = "Horario: $dias $horas";
if ($extra)
    $obs_parts[] = "Notas: $extra";
$observaciones_final = implode(" | ", $obs_parts);

// Validación
if (empty($razon)) {
    $_SESSION['error'] = 'La razón social es obligatoria.';
    header('Location: form.php' . ($id_prov ? "?id=$id_prov" : ''));
    exit;
}

try {
    $pdo->beginTransaction();

    if ($id_prov) {
        // UPDATE
        $stmt = $pdo->prepare("UPDATE proveedores SET razon_social = ?, cuit = ?, direccion = ? WHERE id_proveedor = ?");
        $stmt->execute([$razon, $cuit, $direccion, $id_prov]);

        if ($id_cont) {
            $stmt = $pdo->prepare("UPDATE proveedores_contactos SET nombre_vendedor = ?, telefono_contacto = ?, email_vendedor = ?, observaciones = ? WHERE id_contacto = ?");
            $stmt->execute([$nom, $tel, $email, $observaciones_final, $id_cont]);
        }

        // [✓] AUDITORÍA CRUD: Registrar edición
        registrarAccion('EDITAR', 'proveedores', "Proveedor editado: $razon", $id_prov);

    } else {
        // INSERT
        $stmt = $pdo->prepare("INSERT INTO proveedores (razon_social, cuit, direccion) VALUES (?, ?, ?)");
        $stmt->execute([$razon, $cuit, $direccion]);
        $id_prov = $pdo->lastInsertId();

        if (!empty($nom) || !empty($email)) {
            $stmt = $pdo->prepare("INSERT INTO proveedores_contactos (id_proveedor, nombre_vendedor, telefono_contacto, email_vendedor, observaciones) VALUES (?, ?, ?, ?, ?)");
            $stmt->execute([$id_prov, $nom, $tel, $email, $observaciones_final]);
        }

        // [✓] AUDITORÍA CRUD: Registrar creación
        registrarAccion('CREAR', 'proveedores', "Proveedor creado: $razon", $id_prov);
    }

    $pdo->commit();
    header("Location: index.php?msg=saved");

} catch (PDOException $e) {
    $pdo->rollBack();
    // [!] ARQUITECTURA: No exponer errores SQL
    error_log("Error en proveedores/save.php: " . $e->getMessage());
    $_SESSION['error'] = 'Error al guardar el proveedor.';
    header('Location: form.php' . ($id_prov ? "?id=$id_prov" : ''));
}

exit;
?>

================================================================================
 MODULE: REPORTES
 FILE: reportes\api\get_dashboard_kpis.php
================================================================================
<?php
require_once '../../../config/database.php';
header('Content-Type: application/json; charset=utf-8');

try {
        $response = [
                'certification' => 0,
                'certification_raw' => 0,
                'certification_percent' => 0,
                'stock_alerts' => 0,
                'purchase_alerts' => 0,
                'expiration_alerts' => 0,
                'urgent_tasks' => [],
                'pending_tasks' => []
        ];

        // 1. Certification (Certificación Proyectada)
        // Lógica: Sumatoria valor ODTs 'Finalizado' en mes en curso (por fecha_vencimiento)
        $meta_mensual = 20000000; // Meta hardcodeada: 20 Millones (Ajustable)

        $sql = "SELECT SUM(t.precio_unitario) as total 
            FROM odt_maestro o 
            JOIN tipos_trabajos t ON o.id_tipologia = t.id_tipologia 
            WHERE o.estado_gestion = 'Finalizado' 
            AND MONTH(o.fecha_vencimiento) = MONTH(CURRENT_DATE()) 
            AND YEAR(o.fecha_vencimiento) = YEAR(CURRENT_DATE())";

        $stmt = $pdo->query($sql);
        $current_cert = 0;
        if ($stmt) {
                $row = $stmt->fetch(PDO::FETCH_ASSOC);
                $current_cert = $row['total'] ?? 0;
        }

        $response['certification'] = number_format($current_cert, 2, ',', '.');
        $response['certification_raw'] = (float) $current_cert;
        $response['certification_percent'] = ($meta_mensual > 0) ? round(($current_cert / $meta_mensual) * 100) : 0;

        // 2. Stock Alert (Inventario Crítico)
        // Lógica: stock_oficina < punto_pedido
        $sql = "SELECT COUNT(*) as cnt FROM stock_saldos s 
            JOIN maestro_materiales m ON s.id_material = m.id_material 
            WHERE s.stock_oficina < m.punto_pedido";
        $stmt = $pdo->query($sql);
        $response['stock_alerts'] = $stmt->fetchColumn();

        // 3. Purchase Alert (Compras Pendientes de Ingreso)
        // Lógica: 'Compra_Material' sin usuario_recepcion (Confirmación física)
        $sql = "SELECT COUNT(*) as cnt FROM movimientos 
            WHERE tipo_movimiento = 'Compra_Material' 
            AND (usuario_recepcion IS NULL OR usuario_recepcion = '')";
        $stmt = $pdo->query($sql);
        $response['purchase_alerts'] = $stmt->fetchColumn();

        // 4. Expiration Alert (Vencimientos < 15 días)
        // Vehículos (VTV, Seguro) y Personal (Carnet de Conducir)
        $days = 15;

        // Check Vehículos
        $sql_veh = "SELECT COUNT(*) FROM vehiculos 
                WHERE (vencimiento_vtv IS NOT NULL AND vencimiento_vtv < DATE_ADD(CURDATE(), INTERVAL $days DAY) AND vencimiento_vtv >= CURDATE())
                OR (vencimiento_seguro IS NOT NULL AND vencimiento_seguro < DATE_ADD(CURDATE(), INTERVAL $days DAY) AND vencimiento_seguro >= CURDATE())";
        $veh_alerts = $pdo->query($sql_veh)->fetchColumn();

        // Check Personal
        $sql_pers = "SELECT COUNT(*) FROM personal 
                 WHERE vencimiento_carnet_conducir IS NOT NULL 
                 AND vencimiento_carnet_conducir < DATE_ADD(CURDATE(), INTERVAL $days DAY) 
                 AND vencimiento_carnet_conducir >= CURDATE()";
        $pers_alerts = $pdo->query($sql_pers)->fetchColumn();

        $response['expiration_alerts'] = $veh_alerts + $pers_alerts;

        // 0. Auto-generar Tareas Recurrentes si es necesario
        require_once __DIR__ . '/../../../includes/tasks_generator.php'; // Asegurar ruta correcta
        generarTareasPendientes($pdo);

        // 5. Panel A: Urgent Tasks (Hoy)
        // UNION: ODTs Urgentes (Programadas Hoy) + Tareas Instancia Urgentes (No completadas y Vencidas/Hoy)

        // Parte 1: ODTs (Programadas para Hoy o Mañana)
        $sql_odt = "SELECT 
                    o.id_odt as id, 
                    CONCAT('ODT ', o.nro_odt_assa) as titulo, 
                    o.direccion as descripcion, 
                    t.nombre as tipo, 
                    'ODT' as source,
                    CASE WHEN o.prioridad = 'Urgente' THEN 1 ELSE 0 END as is_urgent,
                    o.estado_gestion as estado
                FROM odt_maestro o 
                LEFT JOIN programacion_semanal p ON o.id_odt = p.id_odt 
                LEFT JOIN tipos_trabajos t ON o.id_tipologia = t.id_tipologia 
                WHERE o.estado_gestion = 'Programado' 
                AND p.fecha_programada BETWEEN CURDATE() AND DATE_ADD(CURDATE(), INTERVAL 1 DAY)";

        // Parte 2: Tareas de Agenda (Vencen Hoy o Mañana)
        $sql_tasks = "SELECT 
                    id_tarea as id,
                    titulo,
                    descripcion,
                    'Tarea' as tipo,
                    'AGENDA' as source,
                    CASE WHEN importancia = 'Alta' THEN 1 ELSE 0 END as is_urgent,
                    estado
                  FROM tareas_instancia
                  WHERE estado IN ('Pendiente', 'En Curso')
                  AND fecha_vencimiento BETWEEN CURDATE() AND DATE_ADD(CURDATE(), INTERVAL 1 DAY)";

        // Ordenar: Primero los marcados explicitamente como urgentes (visual), luego por ID
        $sql_union = "($sql_odt) UNION ALL ($sql_tasks) ORDER BY is_urgent DESC, id ASC";
        $response['urgent_tasks'] = $pdo->query($sql_union)->fetchAll(PDO::FETCH_ASSOC);

        // 6. Panel B: Pending Tray (Sin Programar / Tareas Próximas)
        // UNION: ODTs Sin Programar + Tareas Pendientes (Normales)

        $sql_odt_pending = "SELECT 
                            o.id_odt as id, 
                            CONCAT('ODT ', o.nro_odt_assa) as titulo, 
                            o.fecha_vencimiento as fecha, 
                            t.nombre as tipo, 
                            o.prioridad,
                            'ODT' as source
                        FROM odt_maestro o 
                        LEFT JOIN tipos_trabajos t ON o.id_tipologia = t.id_tipologia 
                        WHERE o.estado_gestion = 'Sin Programar'";

        $sql_tasks_pending = "SELECT 
                            id_tarea as id,
                            titulo,
                            fecha_vencimiento as fecha,
                            'Tarea' as tipo,
                            importancia as prioridad,
                            'AGENDA' as source
                          FROM tareas_instancia
                          WHERE estado IN ('Pendiente', 'En Curso')
                          AND (importancia != 'Alta' OR fecha_vencimiento > CURDATE())";

        $sql_union_pending = "($sql_odt_pending) UNION ALL ($sql_tasks_pending) ORDER BY fecha ASC LIMIT 10";
        $response['pending_tasks'] = $pdo->query($sql_union_pending)->fetchAll(PDO::FETCH_ASSOC);

        echo json_encode($response);

} catch (Exception $e) {
        http_response_code(500);
        echo json_encode(['error' => $e->getMessage()]);
}


================================================================================
 MODULE: REPORTES
 FILE: reportes\index.php
================================================================================
<?php
/**
 * Módulo de Reportes - Dashboard
 * Solo accesible para Gerente
 * ERP Recursos Globales
 */

require_once '../../config/database.php';
require_once '../../includes/header.php';

// Verificar permiso para este módulo (Gerente, Coordinador ASSA, Administrativo ASSA)
verificarPermiso('reportes');

$rolActual = $_SESSION['usuario_rol'] ?? '';
$modificador = obtenerModificadorModulo('reportes', $rolActual);

// Obtener estadísticas generales (común para roles con acceso)
$stats = [];

// Total materiales
$stmt = $pdo->query("SELECT COUNT(*) as total FROM maestro_materiales");
$stats['materiales'] = $stmt->fetch()['total'];

// Total cuadrillas activas
$stmt = $pdo->query("SELECT COUNT(*) as total FROM cuadrillas WHERE estado_operativo = 'Activa'");
$stats['cuadrillas_activas'] = $stmt->fetch()['total'];

// Total personal
$stmt = $pdo->query("SELECT COUNT(*) as total FROM personal");
$stats['personal'] = $stmt->fetch()['total'];

// Movimientos del mes
$stmt = $pdo->query("SELECT COUNT(*) as total FROM movimientos WHERE MONTH(fecha_hora) = MONTH(CURRENT_DATE()) AND YEAR(fecha_hora) = YEAR(CURRENT_DATE())");
$stats['movimientos_mes'] = $stmt->fetch()['total'];

// Últimas acciones de auditoría
$auditoria = [];
try {
    $stmt = $pdo->query("
        SELECT a.*, u.nombre as usuario_nombre 
        FROM auditoria_acciones a
        JOIN usuarios u ON a.id_usuario = u.id_usuario
        ORDER BY a.created_at DESC
        LIMIT 20
    ");
    $auditoria = $stmt->fetchAll(PDO::FETCH_ASSOC);
} catch (PDOException $e) {
    // Tabla puede no existir aún
    $auditoria = [];
}

// Usuarios del sistema
$usuarios = [];
try {
    $stmt = $pdo->query("
        SELECT u.id_usuario, u.nombre, u.email, u.rol, u.estado, c.nombre_cuadrilla,
               (SELECT COUNT(*) FROM auditoria_acciones a WHERE a.id_usuario = u.id_usuario) as total_acciones
        FROM usuarios u
        LEFT JOIN cuadrillas c ON u.id_cuadrilla = c.id_cuadrilla
        ORDER BY u.nombre ASC
    ");
    $usuarios = $stmt->fetchAll(PDO::FETCH_ASSOC);
} catch (PDOException $e) {
    $usuarios = [];
}
?>

<div class="container-fluid" style="padding: 0 20px;">

    <!-- Header -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
        <div>
            <h2 style="margin: 0;"><i class="fas fa-chart-bar"></i> Dashboard de Reportes</h2>
            <p style="margin: 5px 0 0; color: #666;">
                <?php
                if ($rolActual === 'Gerente')
                    echo 'Panel exclusivo de gerencia - Visión general del sistema';
                elseif ($rolActual === 'Coordinador ASSA')
                    echo 'Panel Estratégico ASSA - Supervisión de Operativa';
                else
                    echo 'Panel Operativo - Gestión y Métricas ASSA';
                ?>
            </p>
        </div>
        <span class="<?php echo obtenerColorRol($rolActual); ?>" style="padding: 8px 15px; border-radius: 20px; font-weight: 600;">
            <i class="fas fa-user-shield"></i> Acceso: <?php echo $rolActual; ?>
        </span>
    </div>

    <?php if ($rolActual === 'Inspector ASSA'): ?>
        <!-- Vista mínima para Inspector -->
        <div class="card" style="text-align: center; padding: 50px;">
            <i class="fas fa-clipboard-list" style="font-size: 4em; color: var(--color-warning); margin-bottom: 20px;"></i>
            <h2>Módulo de Gestión de ODTs únicamente</h2>
            <p>Usted tiene acceso limitado a la carga y consulta de ODTs.</p>
            <a href="../odt/index.php" class="btn btn-primary btn-lg">Ir a Gestión de ODTs</a>
        </div>
    <?php else: ?>
        <!-- Dashboards para Administrativo, Coordinador y Gerente -->
        
        <?php if ($rolActual !== 'Administrativo ASSA'): ?>
            <!-- Metrics Cards Generales (Solo Gerente y Coordinador) -->
            <div class="metrics-grid"
                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                <div class="metric-card"
                    style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 12px;">
                    <div style="font-size: 2.5em; font-weight: 700;">
                        <?php echo $stats['materiales']; ?>
                    </div>
                    <div style="opacity: 0.9;"><i class="fas fa-boxes"></i> Materiales Registrados</div>
                </div>

                <div class="metric-card"
                    style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; padding: 25px; border-radius: 12px;">
                    <div style="font-size: 2.5em; font-weight: 700;">
                        <?php echo $stats['cuadrillas_activas']; ?>
                    </div>
                    <div style="opacity: 0.9;"><i class="fas fa-hard-hat"></i> Cuadrillas Activas</div>
                </div>

                <div class="metric-card"
                    style="background: linear-gradient(135deg, #fc4a1a 0%, #f7b733 100%); color: white; padding: 25px; border-radius: 12px;">
                    <div style="font-size: 2.5em; font-weight: 700;">
                        <?php echo $stats['personal']; ?>
                    </div>
                    <div style="opacity: 0.9;"><i class="fas fa-users"></i> Personal Total</div>
                </div>

                <div class="metric-card"
                    style="background: linear-gradient(135deg, #4776E6 0%, #8E54E9 100%); color: white; padding: 25px; border-radius: 12px;">
                    <div style="font-size: 2.5em; font-weight: 700;">
                        <?php echo $stats['movimientos_mes']; ?>
                    </div>
                    <div style="opacity: 0.9;"><i class="fas fa-exchange-alt"></i> Movimientos del Mes</div>
                </div>
            </div>
        <?php else: ?>
            <!-- Dashboard Administrativo ASSA (Métricas Operativas) -->
            <div class="metrics-grid"
                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                <!-- Aquí irían métricas de stock de agua y asistencia si existieran tablas específicas -->
                <div class="metric-card" style="background: var(--bg-card); border: 1px solid var(--color-success); padding: 20px; border-radius: 12px;">
                    <div style="font-size: 2em; color: var(--color-success); font-weight: 700;">ACTIVO</div>
                    <div style="color: var(--text-secondary);"><i class="fas fa-check-circle"></i> Estado del Sistema</div>
                </div>
                <div class="metric-card" style="background: var(--bg-card); border: 1px solid var(--color-info); padding: 20px; border-radius: 12px;">
                    <div style="font-size: 2em; color: var(--color-info); font-weight: 700;"><?php echo $stats['movimientos_mes']; ?></div>
                    <div style="color: var(--text-secondary);"><i class="fas fa-exchange-alt"></i> Movimientos Stock</div>
                </div>
            </div>
        <?php endif; ?>

        <div style="display: grid; grid-template-columns: <?php echo ($rolActual === 'Administrativo ASSA') ? '1fr' : '2fr 1fr'; ?>; gap: 25px;">
            
            <?php if ($rolActual !== 'Administrativo ASSA'): ?>
                <!-- Auditoría de Acciones (Solo Gerente y Coordinador) -->
        <div class="card" style="border-top: 4px solid var(--color-primary);">
            <h3 style="margin-top: 0;"><i class="fas fa-history"></i> Historial de Acciones</h3>

            <?php if (empty($auditoria)): ?>
                <div style="text-align: center; padding: 40px; color: #999;">
                    <i class="fas fa-clock" style="font-size: 3em; margin-bottom: 15px;"></i><br>
                    No hay acciones registradas aún.<br>
                    <small>Las acciones aparecerán aquí una vez que ejecutes el script SQL.</small>
                </div>
            <?php else: ?>
                <div style="overflow-x: auto;">
                    <table class="table" style="width: 100%;">
                        <thead>
                            <tr>
                                <th>Fecha/Hora</th>
                                <th>Usuario</th>
                                <th>Acción</th>
                                <th>Módulo</th>
                                <th>Descripción</th>
                            </tr>
                        </thead>
                        <tbody>
                            <?php foreach ($auditoria as $a): ?>
                                <tr>
                                    <td style="white-space: nowrap; font-size: 0.85em;">
                                        <?php echo date('d/m/Y H:i', strtotime($a['created_at'])); ?>
                                    </td>
                                    <td>
                                        <?php echo htmlspecialchars($a['usuario_nombre']); ?>
                                    </td>
                                    <td>
                                        <?php
                                        $badgeClass = 'badge-default';
                                        switch ($a['accion']) {
                                            case 'LOGIN':
                                                $badgeClass = 'badge-success';
                                                break;
                                            case 'LOGOUT':
                                                $badgeClass = 'badge-info';
                                                break;
                                            case 'CREAR':
                                                $badgeClass = 'badge-primary';
                                                break;
                                            case 'EDITAR':
                                                $badgeClass = 'badge-warning';
                                                break;
                                            case 'ELIMINAR':
                                                $badgeClass = 'badge-danger';
                                                break;
                                        }
                                        ?>
                                        <span class="badge <?php echo $badgeClass; ?>">
                                            <?php echo $a['accion']; ?>
                                        </span>
                                    </td>
                                    <td>
                                        <?php echo htmlspecialchars($a['modulo']); ?>
                                    </td>
                                    <td style="font-size: 0.85em; color: #666;">
                                        <?php echo htmlspecialchars(substr($a['descripcion'] ?? '', 0, 50)); ?>
                                    </td>
                                </tr>
                            <?php endforeach; ?>
                        </tbody>
                    </table>
                </div>
            <?php endif; ?>
        </div>

                <!-- Usuarios del Sistema (Solo Gerente y Coordinador) -->
                <?php if ($rolActual !== 'Administrativo ASSA'): ?>
                    <div class="card" style="border-top: 4px solid #28a745;">
                        <h3 style="margin-top: 0;"><i class="fas fa-users-cog"></i> Usuarios del Sistema</h3>

                        <?php if (empty($usuarios)): ?>
                            <div style="text-align: center; padding: 30px; color: #999;">
                                <i class="fas fa-user-plus" style="font-size: 2em;"></i><br>
                                Sin usuarios configurados
                            </div>
                        <?php else: ?>
                            <div class="user-list">
                                <?php foreach ($usuarios as $u): ?>
                                    <div class="user-item"
                                        style="display: flex; align-items: center; gap: 12px; padding: 12px 0; border-bottom: 1px solid #f0f0f0;">
                                        <div class="user-avatar"
                                            style="width: 40px; height: 40px; background: var(--color-primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600;">
                                            <?php echo strtoupper(substr($u['nombre'], 0, 1)); ?>
                                        </div>
                                        <div style="flex: 1;">
                                            <div style="font-weight: 500;">
                                                <?php echo htmlspecialchars($u['nombre']); ?>
                                            </div>
                                            <div style="font-size: 0.8em; color: #888;">
                                                <?php
                                                $rolDisp = $u['rol'];
                                                if ($rolDisp === 'JefeCuadrilla') {
                                                    $rolDisp = 'Jefe: ' . ($u['nombre_cuadrilla'] ?? 'Sin asignar');
                                                }
                                                echo $rolDisp;
                                                ?>
                                            </div>
                                        </div>
                                        <div style="text-align: right; font-size: 0.8em;">
                                            <span style="color: <?php echo $u['estado'] ? '#28a745' : '#dc3545'; ?>;">
                                                <i class="fas fa-circle" style="font-size: 0.6em;"></i>
                                                <?php echo $u['estado'] ? 'Activo' : 'Inactivo'; ?>
                                            </span>
                                            <div style="color: #888; font-size: 0.9em;">
                                                <?php echo $u['total_acciones']; ?> acciones
                                            </div>
                                        </div>
                                    </div>
                                <?php endforeach; ?>
                            </div>
                        <?php endif; ?>
                    </div>
                <?php endif; ?>
            <?php endif; ?>
        </div>
    <?php endif; ?>

</div>

<style>
    .badge {
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 0.75em;
        font-weight: 500;
    }

    .badge-success {
        background: #d4edda;
        color: #155724;
    }

    .badge-info {
        background: #d1ecf1;
        color: #0c5460;
    }

    .badge-primary {
        background: #cce5ff;
        color: #004085;
    }

    .badge-warning {
        background: #fff3cd;
        color: #856404;
    }

    .badge-danger {
        background: #f8d7da;
        color: #721c24;
    }

    .badge-default {
        background: #e9ecef;
        color: #495057;
    }

    .badge-gerente {
        background: linear-gradient(135deg, #ffd700 0%, #ffb700 100%);
        color: #333;
    }

    .table {
        border-collapse: collapse;
    }

    .table th,
    .table td {
        padding: 10px 12px;
        text-align: left;
        border-bottom: 1px solid #f0f0f0;
    }

    .table th {
        background: #f8f9fa;
        font-weight: 600;
        font-size: 0.85em;
        color: #666;
    }

    .table tbody tr:hover {
        background: #f8f9fa;
    }
</style>

<?php require_once '../../includes/footer.php'; ?>

================================================================================
 MODULE: STOCK
 FILE: stock\index.php
================================================================================
<?php
require_once '../../config/database.php';
require_once '../../includes/header.php';

// 1. Fetch Office Stock (Static Panel)
$sql_office = "SELECT m.id_material, m.nombre, m.codigo, m.unidad_medida, 
               COALESCE(s.stock_oficina, 0) as stock_oficina
        FROM maestro_materiales m
        LEFT JOIN stock_saldos s ON m.id_material = s.id_material
        ORDER BY m.nombre ASC";
$office_stock = $pdo->query($sql_office)->fetchAll(PDO::FETCH_ASSOC);

// 2. Fetch Active Squads Meta Data (Name, Vehicle)
$sql_squads_meta = "SELECT c.id_cuadrilla, c.nombre_cuadrilla, c.id_vehiculo_asignado, 
                           v.marca, v.modelo, v.patente
                    FROM cuadrillas c
                    LEFT JOIN vehiculos v ON c.id_vehiculo_asignado = v.id_vehiculo
                    WHERE c.estado_operativo = 'Activa'
                    ORDER BY c.nombre_cuadrilla";
$squads_meta = $pdo->query($sql_squads_meta)->fetchAll(PDO::FETCH_ASSOC);

// 3. Fetch Today's Fuel Consumption Grouped by Vehicle
// We sum both Dispatches (from Tank) AND Direct Purchases (combustibles_cargas to vehicle)
$today = date('Y-m-d');
$sql_fuel = "
    SELECT id_vehiculo, SUM(litros) as litros_hoy FROM (
        SELECT id_vehiculo, litros FROM combustibles_despachos WHERE DATE(fecha_hora) = '$today' AND id_vehiculo IS NOT NULL
        UNION ALL
        SELECT id_vehiculo, litros FROM combustibles_cargas WHERE DATE(fecha_hora) = '$today' AND destino_tipo = 'vehiculo' AND id_vehiculo IS NOT NULL
    ) as combined_fuel
    GROUP BY id_vehiculo";

$fuel_data = $pdo->query($sql_fuel)->fetchAll(PDO::FETCH_KEY_PAIR); // [id_vehiculo => litros]

// 4. Fetch Stock Items for Squads
$sql_squads_items = "SELECT sc.id_cuadrilla, m.nombre as material, sc.cantidad, m.unidad_medida
                     FROM stock_cuadrilla sc
                     JOIN maestro_materiales m ON sc.id_material = m.id_material
                     WHERE sc.cantidad > 0
                     ORDER BY m.nombre";
$raw_squad_items = $pdo->query($sql_squads_items)->fetchAll(PDO::FETCH_ASSOC);

// 5. Build Final Data Structure
$squads_data = [];
// Initialize with meta
foreach ($squads_meta as $meta) {
    $id = $meta['id_cuadrilla'];
    $vid = $meta['id_vehiculo_asignado'];

    $squads_data[$id] = [
        'name' => $meta['nombre_cuadrilla'],
        'vehicle' => $meta['patente'] ? ($meta['marca'] . ' ' . $meta['patente']) : null,
        'fuel_today' => ($vid && isset($fuel_data[$vid])) ? $fuel_data[$vid] : 0,
        'items' => []
    ];
}

// Attach items
foreach ($raw_squad_items as $item) {
    $id = $item['id_cuadrilla'];
    if (isset($squads_data[$id])) {
        $squads_data[$id]['items'][] = $item;
    }
}

// Fetch Dropdowns for Modal
$cuadrillas_all = $pdo->query("SELECT * FROM cuadrillas WHERE estado_operativo = 'Activa'")->fetchAll(PDO::FETCH_ASSOC);
// 3. Fetch Movements History (Merged from Movimientos Module)
// Fetch Limit increased for Dashboard context
$sql_movs = "SELECT mov.*, m.nombre as material, c.nombre_cuadrilla, p.razon_social as proveedor, o.nro_odt_assa 
        FROM movimientos mov
        JOIN maestro_materiales m ON mov.id_material = m.id_material
        LEFT JOIN cuadrillas c ON mov.id_cuadrilla = c.id_cuadrilla
        LEFT JOIN proveedores p ON mov.id_proveedor = p.id_proveedor
        LEFT JOIN odt_maestro o ON mov.id_odt = o.id_odt
        ORDER BY mov.fecha_hora DESC LIMIT 500";
$movimientos = $pdo->query($sql_movs)->fetchAll(PDO::FETCH_ASSOC);

// Unique Lists for Dropdown Filters (Movimientos)
$types = array_unique(array_column($movimientos, 'tipo_movimiento'));

// Derivar Orígenes y Destinos únicos para el Filtro
$origins = [];
$destinations = [];

foreach ($movimientos as $m) {
    if ($m['tipo_movimiento'] == 'Compra_Material') {
        $origins[] = $m['proveedor'];
        $destinations[] = 'Oficina Central';
    } elseif ($m['tipo_movimiento'] == 'Recepcion_ASSA_Oficina') {
        $origins[] = 'ASSA';
        $destinations[] = 'Oficina Central';
    } elseif ($m['tipo_movimiento'] == 'Entrega_Oficina_Cuadrilla') {
        $origins[] = 'Oficina Central';
        $destinations[] = $m['nombre_cuadrilla'];
    } elseif ($m['tipo_movimiento'] == 'Consumo_Cuadrilla_Obra') {
        $origins[] = $m['nombre_cuadrilla'];
        $destinations[] = 'Obra / Consumo';
    }
}
$origins = array_unique(array_filter($origins));
$destinations = array_unique(array_filter($destinations));
?>

<div class="container-fluid" style="padding: 0 20px;">

    <!-- Top Bar -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin: 0;"><i class="fas fa-boxes"></i> Stock</h2>
        <a href="../movimientos/form.php" class="btn btn-primary"><i class="fas fa-plus-circle"></i> Nueva Operación</a>
    </div>

    <!-- FUEL DASHBOARD (Integrated) -->
    <?php include '../combustibles/views/dashboard.php'; ?>

    <!-- MAIN GRID LAYOUT -->
    <div class="smart-dashboard-grid">

        <!-- PANEL A: OFICINA (Priority) -->
        <div class="card panel-office">
            <div class="panel-header">
                <h3><i class="fas fa-building"></i> Stock Oficina</h3>
                <input type="text" id="officeSearch" onkeyup="filterOffice()" placeholder="Buscar material..."
                    class="search-input">
            </div>

            <div class="table-container custom-scrollbar">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Material</th>
                            <th class="text-right">Stock</th>
                            <th class="text-center">Mover</th>
                        </tr>
                    </thead>
                    <tbody id="tableOffice">
                        <?php foreach ($office_stock as $item): ?>
                            <tr class="office-item"
                                data-name="<?php echo strtolower($item['nombre'] . ' ' . $item['codigo']); ?>">
                                <td>
                                    <div class="mat-name"><?php echo $item['nombre']; ?></div>
                                    <div class="mat-code"><?php echo $item['codigo']; ?></div>
                                </td>
                                <td class="text-right">
                                    <span
                                        class="stock-badge <?php echo $item['stock_oficina'] > 0 ? 'instock' : 'empty'; ?>">
                                        <?php echo number_format($item['stock_oficina'], 2); ?>
                                    </span>
                                    <small><?php echo $item['unidad_medida']; ?></small>
                                </td>
                                <td class="text-center">
                                    <?php if ($item['stock_oficina'] > 0): ?>
                                        <button
                                            onclick="openTransferModal(<?php echo $item['id_material']; ?>, '<?php echo $item['nombre']; ?>', <?php echo $item['stock_oficina']; ?>)"
                                            class="btn-icon" title="Transferir">
                                            <i class="fas fa-share"></i>
                                        </button>
                                    <?php endif; ?>
                                </td>
                            </tr>
                        <?php endforeach; ?>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- PANEL B: CUADRILLAS (Smart Carousel/Grid) -->
        <div class="panel-squads-container">
            <div class="panel-header-squads">
                <h3><i class="fas fa-shipping-fast"></i> En Tránsito / Cuadrillas (<?php echo count($squads_data); ?>
                    Activas)</h3>
            </div>

            <!-- Horizontal Scroll / Carousel for Cards -->
            <div class="squads-carousel custom-scrollbar">
                <?php if (empty($squads_data)): ?>
                    <div class="empty-state">
                        <i class="fas fa-check-circle"></i> Todo el material está en depósito central.
                    </div>
                <?php endif; ?>

                <?php foreach ($squads_data as $id_cuadrilla => $squad): ?>
                    <div class="squad-card fade-in">
                        <div class="squad-card-header">
                            <div>
                                <i class="fas fa-hard-hat"></i> <?php echo $squad['name']; ?>
                            </div>
                            <a href="../stock_cuadrilla/detalle.php?id=<?php echo $id_cuadrilla; ?>" class="btn-detail"
                                title="Ver Detalle">
                                <i class="fas fa-external-link-alt"></i>
                            </a>
                        </div>

                        <!-- NEW: Vehicle & Fuel Info -->
                        <?php if ($squad['vehicle']): ?>
                            <div
                                style="padding: 8px 15px; background: rgba(0,0,0,0.02); border-bottom: 1px solid rgba(0,0,0,0.05); font-size: 0.85em; display: flex; justify-content: space-between; align-items: center;">
                                <span title="Vehículo Asignado" style="color: #666;">
                                    <i class="fas fa-truck" style="margin-right: 4px;"></i> <?php echo $squad['vehicle']; ?>
                                </span>

                                <?php
                                if ($squad['fuel_today'] > 0):
                                    $fClass = 'success'; // > 15 (Green)
                                    if ($squad['fuel_today'] < 15)
                                        $fClass = 'warning'; // < 15 (Yellow)
                                    if ($squad['fuel_today'] < 10)
                                        $fClass = 'danger';  // < 10 (Red)
                                    ?>
                                    <span class="badge-fuel <?php echo $fClass; ?>" title="Carga Diaria">
                                        <i class="fas fa-gas-pump"></i> <?php echo number_format($squad['fuel_today'], 1); ?> L
                                    </span>
                                <?php else: ?>
                                    <span class="badge-fuel danger" title="Sin carga registrada hoy">
                                        <i class="fas fa-gas-pump"></i> 0.0 L
                                    </span>
                                <?php endif; ?>
                            </div>
                        <?php endif; ?>

                        <div class="squad-card-body custom-scrollbar">
                            <table class="mini-table">
                                <?php foreach ($squad['items'] as $mat): ?>
                                    <tr>
                                        <td><?php echo $mat['material']; ?></td>
                                        <td class="text-right">
                                            <strong><?php echo number_format($mat['cantidad'], 2); ?></strong>
                                            <?php echo $mat['unidad_medida']; ?>
                                        </td>
                                    </tr>
                                <?php endforeach; ?>
                            </table>
                        </div>
                    </div>
                <?php endforeach; ?>
            </div>
        </div>

    </div>
    <!-- END TOP PANELS -->

    <!-- SECTION: MOVIMIENTOS HISTORY (Integrated) -->
    <div class="card"
        style="box-shadow: 0 4px 12px rgba(0,0,0,0.08); border-radius: 8px; margin-top: 30px; border-top: 4px solid var(--color-neutral-dark);">

        <!-- HEADER & ACTIONS -->
        <div
            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #f0f0f0; padding: 15px;">
            <h3 style="margin: 0; color: var(--color-neutral-dark);"><i class="fas fa-history"></i> Historial de
                Movimientos</h3>
            <div style="display: flex; gap: 10px;">
                <button onclick="exportTable()" class="btn btn-outline" style="color: #217346; border-color: #217346;">
                    <i class="fas fa-file-excel"></i> Exportar a Excel
                </button>
            </div>
        </div>

        <!-- FILTERS BAR -->
        <div class="filter-bar">
            <div class="filter-group">
                <label>Fecha Desde</label>
                <input type="date" id="f_date_from" onchange="applyFilters()" class="form-control-sm">
            </div>
            <div class="filter-group">
                <label>Fecha Hasta</label>
                <input type="date" id="f_date_to" onchange="applyFilters()" class="form-control-sm">
            </div>
            <div class="filter-group">
                <label>Tipo Operación</label>
                <select id="f_type" onchange="applyFilters()" class="form-control-sm">
                    <option value="">Todos</option>
                    <option value="Compra_Material">🛒 Compra Material</option>
                    <option value="Recepcion_ASSA_Oficina">🏢 Recepción ASSA</option>
                    <option value="Entrega_Oficina_Cuadrilla">🚚 Entrega Cuadrilla</option>
                    <option value="Consumo_Cuadrilla_Obra">📉 Consumo (Cuadrilla -> Obra)</option>
                </select>
            </div>

            <!-- New Filter: Origin -->
            <div class="filter-group">
                <label>Origen</label>
                <select id="f_origin" onchange="applyFilters()" class="form-control-sm">
                    <option value="">Todos</option>
                    <?php foreach ($origins as $o): ?>
                        <option value="<?php echo htmlspecialchars($o); ?>"><?php echo htmlspecialchars($o); ?></option>
                    <?php endforeach; ?>
                </select>
            </div>

            <!-- New Filter: Destination -->
            <div class="filter-group">
                <label>Destino</label>
                <select id="f_dest" onchange="applyFilters()" class="form-control-sm">
                    <option value="">Todos</option>
                    <?php foreach ($destinations as $d): ?>
                        <option value="<?php echo htmlspecialchars($d); ?>"><?php echo htmlspecialchars($d); ?></option>
                    <?php endforeach; ?>
                </select>
            </div>

            <div class="filter-group" style="flex: 0 0 auto;">
                <button onclick="resetFilters()" class="btn btn-outline btn-sm" title="Limpiar Filtros">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </div>

        <!-- TABLE -->
        <div style="overflow-x: auto; padding: 0 15px 20px 15px;">
            <table style="width: 100%; border-collapse: collapse; font-size: 0.85em;" id="movesTable">
                <thead>
                    <tr style="background: #f1f3f5; color: #495057;">
                        <th style="padding: 12px; text-align: left;">Fecha</th>
                        <th style="padding: 12px; text-align: left;">Tipo</th>
                        <th style="padding: 12px; text-align: left;">Material</th>
                        <th style="padding: 12px; text-align: right;">Cant</th>
                        <th style="padding: 12px; text-align: left;">Origen</th> <!-- Split -->
                        <th style="padding: 12px; text-align: left;">Destino</th> <!-- Split -->
                        <th style="padding: 12px; text-align: left;">Doc / Usuarios</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <?php foreach ($movimientos as $mov):
                        // Visual Logic
                        $dateRaw = date('Y-m-d', strtotime($mov['fecha_hora']));
                        $typeRaw = $mov['tipo_movimiento'];
                        $squadRaw = $mov['nombre_cuadrilla'] ?? '';

                        // Logic for Origin/Dest
                        $originTxt = '-';
                        $destTxt = '-';

                        if ($typeRaw == 'Compra_Material') {
                            $originTxt = $mov['proveedor'] ?? 'Proveedor Ext.';
                            $destTxt = 'Oficina Central';
                        } elseif ($typeRaw == 'Recepcion_ASSA_Oficina') {
                            $originTxt = 'ASSA';
                            $destTxt = 'Oficina Central';
                        } elseif ($typeRaw == 'Entrega_Oficina_Cuadrilla') {
                            $originTxt = 'Oficina Central';
                            $destTxt = $mov['nombre_cuadrilla'];
                        } elseif ($typeRaw == 'Consumo_Cuadrilla_Obra') {
                            $originTxt = $mov['nombre_cuadrilla'];
                            $destTxt = 'Obra / Consumo';
                        }

                        // Icons & Colors
                        $color = '#333';
                        $icon = '';
                        $typeName = '';
                        if ($typeRaw == 'Compra_Material') {
                            $color = '#28a745';
                            $icon = '🛒';
                            $typeName = 'Compra';
                        } elseif ($typeRaw == 'Recepcion_ASSA_Oficina') {
                            $color = '#17a2b8';
                            $icon = '🏢';
                            $typeName = 'Recepción ASSA';
                        } elseif ($typeRaw == 'Entrega_Oficina_Cuadrilla') {
                            $color = '#007bff';
                            $icon = '🚚';
                            $typeName = 'Entrega';
                        } elseif ($typeRaw == 'Consumo_Cuadrilla_Obra') {
                            $color = '#6c757d';
                            $icon = '📉';
                            $typeName = 'Consumo';
                        } else {
                            $color = '#666';
                            $icon = '🔧';
                            $typeName = str_replace('_', ' ', $typeRaw);
                        }
                        ?>
                        <tr style="border-bottom: 1px solid #efefef;" data-date="<?php echo $dateRaw; ?>"
                            data-type="<?php echo $typeRaw; ?>" data-origin="<?php echo htmlspecialchars($originTxt); ?>"
                            data-dest="<?php echo htmlspecialchars($destTxt); ?>">

                            <td style="padding: 12px; color: #555;">
                                <?php echo date('d/m/Y H:i', strtotime($mov['fecha_hora'])); ?>
                            </td>
                            <td style="padding: 12px; font-weight: 600; color: <?php echo $color; ?>;">
                                <?php echo $icon . ' ' . $typeName; ?>
                            </td>
                            <td style="padding: 12px;"><strong><?php echo $mov['material']; ?></strong></td>
                            <td
                                style="padding: 12px; text-align: right; font-weight: bold; font-family: monospace; font-size: 1.1em;">
                                <?php echo $mov['cantidad']; ?>
                            </td>
                            <!-- Split Columns -->
                            <td style="padding: 12px;">
                                <span class="badge-prov"><?php echo $originTxt; ?></span>
                            </td>
                            <td style="padding: 12px;">
                                <span class="badge-squad"><?php echo $destTxt; ?></span>
                            </td>

                            <td style="padding: 12px; color: #777;">
                                <?php if ($mov['nro_documento'])
                                    echo "<div><i class='fas fa-file-alt'></i> " . $mov['nro_documento'] . "</div>"; ?>
                                <?php if ($mov['nro_odt_assa'])
                                    echo "<div style='margin-top:2px;'><span class='badge-odt'>ODT: " . $mov['nro_odt_assa'] . "</span></div>"; ?>

                                <div style="font-size: 0.85em; margin-top: 4px;">
                                    <?php if ($mov['usuario_despacho']): ?><span title="Despachó"><i
                                                class="fas fa-user-tag"></i>
                                            <?php echo $mov['usuario_despacho']; ?></span><?php endif; ?>
                                </div>
                            </td>
                        </tr>
                    <?php endforeach; ?>
                </tbody>
            </table>
            <div id="noResults" style="display:none; padding: 20px; text-align: center; color: #999;">No se encontraron
                movimientos con los filtros aplicados.</div>
        </div>
    </div>
</div>
<!-- SheetJS -->
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<style>
    /* Merged Styles for Movements Table */
    .filter-group {
        display: flex;
        flex-direction: column;
        min-width: 150px;
    }

    .filter-group label {
        font-size: 0.8em;
        font-weight: bold;
        color: #666;
        margin-bottom: 4px;
    }

    .form-control-sm {
        padding: 6px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 0.9em;
    }

    .badge-prov {
        background: #e8f5e9;
        color: #2e7d32;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.85em;
    }

    .badge-squad {
        background: #e3f2fd;
        color: #1565c0;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.85em;
    }

    .badge-fuel {
        padding: 2px 8px;
        border-radius: 10px;
        font-weight: 600;
        font-size: 0.9em;
        border: 1px solid transparent;
    }

    .badge-fuel.success {
        background: #e8f5e9;
        color: #2e7d32;
        border-color: #c8e6c9;
    }

    .badge-fuel.warning {
        background: #fff3e0;
        color: #e65100;
        border-color: #ffe0b2;
    }

    .badge-fuel.danger {
        background: #ffebee;
        color: #c62828;
        border-color: #ffcdd2;
    }

    .badge-odt {
        background: #fff3e0;
        color: #ef6c00;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.85em;
    }

    #tableBody tr:hover {
        background-color: #f9f9f9;
        cursor: default;
    }
</style>

<script>
    // --- Movements Logic ---
    function applyFilters() {
        const fDateFrom = document.getElementById('f_date_from').value;
        const fDateTo = document.getElementById('f_date_to').value;
        const fType = document.getElementById('f_type').value;
        const fOrigin = document.getElementById('f_origin').value;
        const fDest = document.getElementById('f_dest').value;

        const rows = document.querySelectorAll('#tableBody tr');
        let visibleCount = 0;

        rows.forEach(row => {
            const rowDate = row.dataset.date;
            const rowType = row.dataset.type;
            const rowOrigin = row.dataset.origin;
            const rowDest = row.dataset.dest;

            let show = true;
            if (fDateFrom && rowDate < fDateFrom) show = false;
            if (fDateTo && rowDate > fDateTo) show = false;
            if (fType && rowType !== fType) show = false;
            if (fOrigin && rowOrigin !== fOrigin) show = false;
            if (fDest && rowDest !== fDest) show = false;

            row.style.display = show ? '' : 'none';
            if (show) visibleCount++;
        });
        document.getElementById('noResults').style.display = visibleCount === 0 ? 'block' : 'none';
    }

    function resetFilters() {
        document.getElementById('f_date_from').value = '';
        document.getElementById('f_date_to').value = '';
        document.getElementById('f_type').value = '';
        document.getElementById('f_origin').value = '';
        document.getElementById('f_dest').value = '';
        applyFilters();
    }

    function exportTable() {
        const rows = document.querySelectorAll('#tableBody tr');
        const data = [];
        // Header Updated
        data.push(["Fecha", "Tipo Movimiento", "Material", "Cantidad", "Origen", "Destino", "Documento", "Usuarios"]);

        rows.forEach(row => {
            if (row.style.display !== 'none') {
                const cells = row.querySelectorAll('td');
                data.push([
                    cells[0].innerText.trim(),
                    cells[1].innerText.trim(),
                    cells[2].innerText.trim(),
                    cells[3].innerText.trim(),
                    cells[4].innerText.trim(), // Origen
                    cells[5].innerText.trim(), // Destino
                    cells[6].innerText.split('\n')[0].trim(), // Documento
                    cells[6].innerText.replace(cells[6].innerText.split('\n')[0].trim(), '').trim() // User
                ]);
            }
        });

        const ws = XLSX.utils.aoa_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Movimientos");
        XLSX.writeFile(wb, `Stock_Movimientos_${new Date().toISOString().split('T')[0]}.xlsx`);
    }
</script>
<div id="transferModal" class="modal-overlay">
    <div class="modal-content">
        <h3>Transferencia Rápida</h3>
        <p>Enviando: <strong id="modalMatName" class="highlight-text"></strong></p>

        <form action="../movimientos/save.php" method="POST">
            <input type="hidden" name="tipo_movimiento" value="Entrega_Oficina_Cuadrilla">
            <input type="hidden" name="id_material[]" id="modalMatId">
            <input type="hidden" name="nro_documento" value="FAST-TRANSFER">
            <input type="hidden" name="usuario_despacho" value="Sistema (Quick)">
            <input type="hidden" name="fecha_movimiento" value="<?php echo date('Y-m-d'); ?>">
            <input type="hidden" name="usuario_recepcion" value="">
            <input type="hidden" name="redirect_to_remito" value="1">

            <div class="form-group">
                <label>Destino</label>
                <select name="id_cuadrilla" required class="form-control">
                    <?php foreach ($cuadrillas_all as $c): ?>
                        <option value="<?php echo $c['id_cuadrilla']; ?>"><?php echo $c['nombre_cuadrilla']; ?></option>
                    <?php endforeach; ?>
                </select>
            </div>

            <div class="form-group">
                <label>Cantidad (Máx: <span id="modalMaxQty"></span>)</label>
                <input type="number" step="0.01" name="cantidad[]" id="modalQty" required class="form-control">
            </div>

            <div class="modal-actions">
                <button type="button" class="btn btn-outline" onclick="closeModal()">Cancelar</button>
                <button type="submit" class="btn btn-primary">Confirmar</button>
            </div>
        </form>
    </div>
</div>

<style>
    /* Smart Dashboard CSS - Themed */
    .smart-dashboard-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        align-items: start;
    }

    /* Office Panel */
    .panel-office {
        background: var(--bg-card);
        color: var(--text-primary);
        border-radius: 8px;
        box-shadow: var(--shadow-md);
        display: flex;
        flex-direction: column;
        border-top: 4px solid var(--color-primary);
        border: 1px solid rgba(100, 181, 246, 0.15);
    }

    .panel-header {
        padding: 15px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .panel-header h3 {
        margin: 0;
        font-size: 1.1rem;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .table-container {
        flex-grow: 1;
    }

    .table th {
        background: var(--bg-secondary);
        color: var(--text-secondary);
        font-weight: 600;
        font-size: 0.85rem;
        padding: 10px 15px;
    }

    .table td {
        padding: 12px 15px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    /* Squads Panel */
    .panel-squads-container {
        display: flex;
        flex-direction: column;
    }

    .panel-header-squads {
        margin-bottom: 15px;
    }

    .panel-header-squads h3 {
        color: var(--text-primary);
        font-size: 1.1rem;
        margin: 0;
    }

    .squads-carousel {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        grid-auto-rows: max-content;
        gap: 15px;
        padding-bottom: 20px;
        align-content: start;
    }

    .squad-card {
        background: var(--bg-card);
        color: var(--text-primary);
        border-radius: 8px;
        box-shadow: var(--shadow-sm);
        display: flex;
        flex-direction: column;
        border-left: 4px solid var(--accent-primary);
        transition: transform 0.2s;
        border: 1px solid rgba(100, 181, 246, 0.1);
        max-height: 300px;
    }

    .squad-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
        border-color: var(--accent-primary);
    }

    .squad-card-header {
        background: var(--bg-secondary);
        padding: 10px 15px;
        font-weight: bold;
        color: var(--accent-primary);
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .btn-detail {
        background: var(--accent-primary);
        color: white;
        border: none;
        width: 28px;
        height: 28px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        text-decoration: none;
        transition: all 0.2s;
    }

    .btn-detail:hover {
        background: var(--color-primary);
        transform: scale(1.1);
    }

    .squad-card-body {
        padding: 10px;
        overflow-y: auto;
        flex-grow: 1;
    }

    .mini-table {
        width: 100%;
        font-size: 0.85em;
    }

    .mini-table td {
        padding: 4px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        color: var(--text-secondary);
    }

    .mini-table td strong {
        color: var(--text-primary);
    }

    /* Styles */
    .search-input {
        width: 100%;
        padding: 10px;
        border-radius: 6px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        background: var(--bg-tertiary);
        color: var(--text-primary);
        margin-top: 10px;
    }

    .search-input:focus {
        border-color: var(--accent-primary);
        outline: none;
    }

    .stock-badge {
        padding: 4px 10px;
        border-radius: 12px;
        font-weight: bold;
        font-size: 0.85rem;
        display: inline-block;
        min-width: 60px;
        text-align: center;
    }

    .stock-badge.instock {
        color: #2e7d32;
        /* Verde fuerte legible */
        background: #e8f5e9;
        /* Verde muy claro */
        border: 1px solid #c8e6c9;
    }

    .stock-badge.empty {
        color: #c62828;
        /* Rojo fuerte legible */
        background: #ffebee;
        /* Rojo muy claro */
        border: 1px solid #ffcdd2;
    }

    /* Unidad de medida */
    small {
        color: var(--text-secondary) !important;
        font-weight: 500;
        margin-left: 4px;
        font-size: 0.8rem;
    }

    .mat-name {
        font-weight: 500;
        font-size: 0.95em;
        color: var(--text-primary);
    }

    .mat-code {
        font-size: 0.75em;
        color: var(--text-muted);
    }

    .btn-icon {
        background: var(--bg-tertiary);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 6px;
        color: var(--text-secondary);
        padding: 4px 8px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-icon:hover {
        background: var(--accent-primary);
        color: white;
        border-color: var(--accent-primary);
    }

    /* Modal */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        z-index: 999;
        backdrop-filter: blur(4px);
    }

    .modal-content {
        background: var(--bg-card);
        color: var(--text-primary);
        width: 400px;
        margin: 10% auto;
        padding: 25px;
        border-radius: 12px;
        box-shadow: var(--shadow-lg);
        border: 1px solid rgba(100, 181, 246, 0.2);
    }

    .modal-content h3 {
        margin-top: 0;
        color: var(--text-primary);
    }

    .modal-content p {
        color: var(--text-secondary);
    }

    .highlight-text {
        color: var(--accent-primary);
    }

    .modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 20px;
    }

    .form-control {
        width: 100%;
        padding: 10px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 6px;
        margin-top: 5px;
        background: var(--bg-tertiary);
        color: var(--text-primary);
    }

    .form-control:focus {
        border-color: var(--accent-primary);
        outline: none;
    }

    .form-group {
        margin-bottom: 15px;
    }

    .form-group label {
        color: var(--text-secondary);
        font-size: 0.9rem;
    }

    /* Custom Scrollbar */
    .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
        height: 6px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 3px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
    }

    /* Merged Styles for Movements Table */
    .filter-group {
        display: flex;
        flex-direction: column;
        min-width: 150px;
    }

    .filter-group label {
        font-size: 0.8em;
        font-weight: bold;
        color: var(--text-secondary);
        margin-bottom: 4px;
    }

    .form-control-sm {
        padding: 6px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 4px;
        font-size: 0.9em;
        background: var(--bg-tertiary);
        color: var(--text-primary);
    }

    .badge-prov {
        background: rgba(46, 125, 50, 0.15);
        color: #66bb6a;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.85em;
        border: 1px solid rgba(46, 125, 50, 0.3);
    }

    .badge-squad {
        background: rgba(21, 101, 192, 0.15);
        color: #42a5f5;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.85em;
        border: 1px solid rgba(21, 101, 192, 0.3);
    }

    .badge-odt {
        background: rgba(239, 108, 0, 0.15);
        color: #ffa726;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.85em;
        border: 1px solid rgba(239, 108, 0, 0.3);
    }

    #tableBody tr:hover {
        background-color: var(--bg-secondary);
        cursor: default;
    }

    /* MODO CLARO - Override específico */
    [data-theme="light"] .panel-office,
    [data-theme="light"] .squad-card,
    [data-theme="light"] .modal-content {
        background: #ffffff;
        border: 1px solid #e2e8f0;
        color: #333;
    }

    [data-theme="light"] .panel-header,
    [data-theme="light"] .panel-header-squads h3,
    [data-theme="light"] .modal-content h3 {
        color: #333;
    }

    [data-theme="light"] .table th {
        background: #f8f9fa;
        color: #555;
    }

    [data-theme="light"] .table td,
    [data-theme="light"] .squad-card-header,
    [data-theme="light"] .mini-table td {
        border-color: #f0f0f0;
        color: #333;
    }

    [data-theme="light"] .search-input,
    [data-theme="light"] .form-control,
    [data-theme="light"] .form-control-sm {
        background: #ffffff;
        border: 1px solid #ddd;
        color: #333;
    }

    [data-theme="light"] .squad-card-header {
        background: #f4f8f9;
        color: cadetblue;
    }

    [data-theme="light"] small,
    [data-theme="light"] .mat-code,
    [data-theme="light"] .filter-group label {
        color: #666 !important;
    }

    [data-theme="light"] .btn-icon {
        background: #fff;
        border-color: #ddd;
        color: #666;
    }

    [data-theme="light"] .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #ccc;
    }

    [data-theme="light"] .badge-prov {
        background: #e8f5e9;
        color: #2e7d32;
        border: none;
    }

    [data-theme="light"] .badge-squad {
        background: #e3f2fd;
        color: #1565c0;
        border: none;
    }

    [data-theme="light"] .badge-odt {
        background: #fff3e0;
        color: #ef6c00;
        border: none;
    }
</style>

<script>
    function filterOffice() {
        const term = document.getElementById('officeSearch').value.toLowerCase();
        const rows = document.querySelectorAll('.office-item');
        rows.forEach(row => {
            row.style.display = row.dataset.name.includes(term) ? '' : 'none';
        });
    }

    function openTransferModal(id, name, max) {
        document.getElementById('transferModal').style.display = 'block';
        document.getElementById('modalMatId').value = id;
        document.getElementById('modalMatName').innerText = name;
        document.getElementById('modalMaxQty').innerText = max;
        document.getElementById('modalQty').max = max;
        document.getElementById('modalQty').value = '';
    }

    function closeModal() {
        document.getElementById('transferModal').style.display = 'none';
    }

    // Close modal on outside click
    window.onclick = function (event) {
        if (event.target == document.getElementById('transferModal')) {
            closeModal();
        }
    }
</script>

<?php require_once '../../includes/footer.php'; ?>

================================================================================
 MODULE: STOCK_CUADRILLA
 FILE: stock_cuadrilla\detalle.php
================================================================================
<?php
require_once '../../config/database.php';
require_once '../../includes/header.php';

// Get Cuadrilla ID
$id_cuadrilla = $_GET['id'] ?? null;

if (!$id_cuadrilla) {
    header('Location: /APP-Prueba/modules/stock/index.php');
    exit;
}

// 1. Cuadrilla Basic Info
$stmt = $pdo->prepare("SELECT * FROM cuadrillas WHERE id_cuadrilla = ?");
$stmt->execute([$id_cuadrilla]);
$cuadrilla = $stmt->fetch(PDO::FETCH_ASSOC);

if (!$cuadrilla) {
    echo "<div class='card'><p>Cuadrilla no encontrada.</p></div>";
    require_once '../../includes/footer.php';
    exit;
}

// 2. Stock Actual de la Cuadrilla
$sql_stock = "SELECT m.id_material, m.nombre, m.codigo, m.unidad_medida, sc.cantidad
              FROM stock_cuadrilla sc
              JOIN maestro_materiales m ON sc.id_material = m.id_material
              WHERE sc.id_cuadrilla = ? AND sc.cantidad > 0
              ORDER BY m.nombre";
$stmt_stock = $pdo->prepare($sql_stock);
$stmt_stock->execute([$id_cuadrilla]);
$stock_items = $stmt_stock->fetchAll(PDO::FETCH_ASSOC);

// 3. Movimientos Recientes (últimos 30 días)
$sql_movs = "SELECT mov.*, m.nombre as material, m.codigo
             FROM movimientos mov
             JOIN maestro_materiales m ON mov.id_material = m.id_material
             WHERE mov.id_cuadrilla = ?
             ORDER BY mov.fecha_hora DESC
             LIMIT 50";
$stmt_movs = $pdo->prepare($sql_movs);
$stmt_movs->execute([$id_cuadrilla]);
$movimientos = $stmt_movs->fetchAll(PDO::FETCH_ASSOC);

// 4. Métricas
$total_materiales = count($stock_items);
$total_unidades = array_sum(array_column($stock_items, 'cantidad'));
$total_entregas = 0;
$total_consumos = 0;
foreach ($movimientos as $mov) {
    if ($mov['tipo_movimiento'] == 'Entrega_Oficina_Cuadrilla')
        $total_entregas++;
    if ($mov['tipo_movimiento'] == 'Consumo_Cuadrilla_Obra')
        $total_consumos++;
}
?>

<div class="container-fluid" style="padding: 0 20px;">

    <!-- Back Button & Header -->
    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 25px;">
        <a href="/APP-Prueba/modules/stock/index.php" class="btn btn-outline" style="padding: 8px 12px;">
            <i class="fas fa-arrow-left"></i>
        </a>
        <div>
            <h2 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-hard-hat" style="color: var(--color-primary);"></i>
                <?php echo htmlspecialchars($cuadrilla['nombre_cuadrilla']); ?>
                <span
                    class="badge-status <?php echo $cuadrilla['estado_operativo'] == 'Activa' ? 'active' : 'inactive'; ?>">
                    <?php echo $cuadrilla['estado_operativo']; ?>
                </span>
            </h2>
            <?php if (!empty($cuadrilla['encargado'] ?? null)): ?>
                <p style="margin: 5px 0 0; color: #666;">
                    <i class="fas fa-user-tie"></i> Encargado: <strong>
                        <?php echo htmlspecialchars($cuadrilla['encargado']); ?>
                    </strong>
                </p>
            <?php endif; ?>
        </div>
    </div>

    <!-- Metrics Cards -->
    <div class="metrics-grid">
        <div class="metric-card">
            <div class="metric-icon" style="background: #e3f2fd;"><i class="fas fa-boxes" style="color: #1976d2;"></i>
            </div>
            <div class="metric-data">
                <span class="metric-value">
                    <?php echo $total_materiales; ?>
                </span>
                <span class="metric-label">Tipos de Material</span>
            </div>
        </div>
        <div class="metric-card">
            <div class="metric-icon" style="background: #e8f5e9;"><i class="fas fa-cubes" style="color: #388e3c;"></i>
            </div>
            <div class="metric-data">
                <span class="metric-value">
                    <?php echo number_format($total_unidades, 1); ?>
                </span>
                <span class="metric-label">Unidades Totales</span>
            </div>
        </div>
        <div class="metric-card">
            <div class="metric-icon" style="background: #fff3e0;"><i class="fas fa-truck" style="color: #f57c00;"></i>
            </div>
            <div class="metric-data">
                <span class="metric-value">
                    <?php echo $total_entregas; ?>
                </span>
                <span class="metric-label">Entregas Recibidas</span>
            </div>
        </div>
        <div class="metric-card">
            <div class="metric-icon" style="background: #fce4ec;"><i class="fas fa-tools" style="color: #c2185b;"></i>
            </div>
            <div class="metric-data">
                <span class="metric-value">
                    <?php echo $total_consumos; ?>
                </span>
                <span class="metric-label">Consumos en Obra</span>
            </div>
        </div>
    </div>

    <!-- Content Grid: Stock + Movements -->
    <div class="detail-grid">

        <!-- Stock Actual -->
        <div class="card" style="border-top: 4px solid var(--color-primary);">
            <div class="panel-header">
                <h3><i class="fas fa-warehouse"></i> Stock Actual</h3>
            </div>

            <?php if (empty($stock_items)): ?>
                <div class="empty-state-mini">
                    <i class="fas fa-check-circle"></i>
                    <p>Sin materiales en posesión</p>
                </div>
            <?php else: ?>
                <div class="table-container custom-scrollbar" style="max-height: 400px; overflow-y: auto;">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Material</th>
                                <th class="text-right">Cantidad</th>
                            </tr>
                        </thead>
                        <tbody>
                            <?php foreach ($stock_items as $item): ?>
                                <tr>
                                    <td>
                                        <div class="mat-name">
                                            <?php echo $item['nombre']; ?>
                                        </div>
                                        <div class="mat-code">
                                            <?php echo $item['codigo']; ?>
                                        </div>
                                    </td>
                                    <td class="text-right">
                                        <strong>
                                            <?php echo number_format($item['cantidad'], 2); ?>
                                        </strong>
                                        <small>
                                            <?php echo $item['unidad_medida']; ?>
                                        </small>
                                    </td>
                                </tr>
                            <?php endforeach; ?>
                        </tbody>
                    </table>
                </div>
            <?php endif; ?>
        </div>

        <!-- Movimientos Recientes -->
        <div class="card" style="border-top: 4px solid #6c757d;">
            <div class="panel-header">
                <h3><i class="fas fa-history"></i> Movimientos Recientes</h3>
            </div>

            <?php if (empty($movimientos)): ?>
                <div class="empty-state-mini">
                    <i class="fas fa-inbox"></i>
                    <p>Sin movimientos registrados</p>
                </div>
            <?php else: ?>
                <div class="table-container custom-scrollbar" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Tipo</th>
                                <th>Material</th>
                                <th class="text-right">Cant</th>
                            </tr>
                        </thead>
                        <tbody>
                            <?php foreach ($movimientos as $mov):
                                $icon = '';
                                $color = '#666';
                                $typeName = '';
                                if ($mov['tipo_movimiento'] == 'Entrega_Oficina_Cuadrilla') {
                                    $icon = '📥';
                                    $color = '#28a745';
                                    $typeName = 'Recibido';
                                } elseif ($mov['tipo_movimiento'] == 'Consumo_Cuadrilla_Obra') {
                                    $icon = '🔧';
                                    $color = '#dc3545';
                                    $typeName = 'Consumo';
                                } else {
                                    $icon = '🔄';
                                    $typeName = str_replace('_', ' ', $mov['tipo_movimiento']);
                                }
                                ?>
                                <tr>
                                    <td style="font-size: 0.85em; color: #666;">
                                        <?php echo date('d/m/y H:i', strtotime($mov['fecha_hora'])); ?>
                                    </td>
                                    <td style="font-weight: 500; color: <?php echo $color; ?>;">
                                        <?php echo $icon . ' ' . $typeName; ?>
                                    </td>
                                    <td>
                                        <?php echo $mov['material']; ?>
                                    </td>
                                    <td class="text-right" style="font-weight: bold;">
                                        <?php echo $mov['cantidad']; ?>
                                    </td>
                                </tr>
                            <?php endforeach; ?>
                        </tbody>
                    </table>
                </div>
            <?php endif; ?>
        </div>

    </div>
</div>

<style>
    .badge-status {
        font-size: 0.7em;
        padding: 4px 10px;
        border-radius: 20px;
        font-weight: 500;
    }

    .badge-status.active {
        background: #d4edda;
        color: #155724;
    }

    .badge-status.inactive {
        background: #f8d7da;
        color: #721c24;
    }

    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 15px;
        margin-bottom: 25px;
    }

    .metric-card {
        background: white;
        border-radius: 10px;
        padding: 15px;
        display: flex;
        align-items: center;
        gap: 15px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    }

    .metric-icon {
        width: 50px;
        height: 50px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.3em;
    }

    .metric-data {
        display: flex;
        flex-direction: column;
    }

    .metric-value {
        font-size: 1.5em;
        font-weight: 700;
        color: #333;
    }

    .metric-label {
        font-size: 0.8em;
        color: #888;
    }

    .detail-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }

    @media (max-width: 900px) {
        .detail-grid {
            grid-template-columns: 1fr;
        }
    }

    .panel-header {
        padding: 15px;
        border-bottom: 1px solid #eee;
    }

    .panel-header h3 {
        margin: 0;
        font-size: 1.1em;
        color: #333;
    }

    .empty-state-mini {
        padding: 40px;
        text-align: center;
        color: #aaa;
    }

    .empty-state-mini i {
        font-size: 2em;
        margin-bottom: 10px;
    }

    .table-sm td,
    .table-sm th {
        padding: 8px 10px;
        font-size: 0.9em;
    }

    .mat-name {
        font-weight: 500;
    }

    .mat-code {
        font-size: 0.75em;
        color: #888;
    }

    .text-right {
        text-align: right;
    }
</style>

<?php require_once '../../includes/footer.php'; ?>

================================================================================
 MODULE: STOCK_CUADRILLA
 FILE: stock_cuadrilla\index.php
================================================================================
<?php
require_once '../../config/database.php';
require_once '../../includes/header.php';

// Fetch Stock per Squad
$sql = "SELECT c.nombre_cuadrilla, m.nombre as material, m.unidad_medida, sc.cantidad 
        FROM stock_cuadrilla sc
        JOIN cuadrillas c ON sc.id_cuadrilla = c.id_cuadrilla
        JOIN maestro_materiales m ON sc.id_material = m.id_material
        ORDER BY c.nombre_cuadrilla, m.nombre";
$stmt = $pdo->query($sql);
$stocks = $stmt->fetchAll(PDO::FETCH_GROUP); // Group by Cuadrilla Name naturally if first column? 
// Actually FETCH_GROUP groups by first column. So Key = Nombre Cuadrilla, Value = Array of rows.

?>

<div class="card">
    <h1><i class="fas fa-truck-pickup"></i> Stock en Cuadrillas</h1>
    <p style="color: #666; margin-bottom: 20px;">Materiales actualmente en poder de los equipos móviles (No consumidos).
    </p>

    <?php if (empty($stocks)): ?>
        <p>No hay materiales asignados a cuadrillas actualmente.</p>
    <?php endif; ?>

    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
        <?php foreach ($stocks as $cuadrilla => $items): ?>
            <div
                style="border: 1px solid #ddd; border-radius: 8px; overflow: hidden; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                <div style="background: var(--color-primary); color: white; padding: 10px 15px; font-weight: bold;">
                    <i class="fas fa-hard-hat"></i>
                    <?php echo htmlspecialchars($cuadrilla); ?>
                </div>
                <table style="width: 100%; border-collapse: collapse;">
                    <?php foreach ($items as $item): ?>
                        <tr style="border-bottom: 1px solid #eee;">
                            <td style="padding: 10px;">
                                <?php echo htmlspecialchars($item['material']); ?>
                            </td>
                            <td style="padding: 10px; text-align: right; font-weight: 500;">
                                <?php echo number_format($item['cantidad'], 2); ?> <span style="font-size: 0.8em; color: #888;">
                                    <?php echo $item['unidad_medida']; ?>
                                </span>
                            </td>
                        </tr>
                    <?php endforeach; ?>
                </table>
            </div>
        <?php endforeach; ?>
    </div>
</div>

<?php require_once '../../includes/footer.php'; ?>

================================================================================
 MODULE: TAREAS
 FILE: tareas\complete_task.php
================================================================================
<?php
require_once '../../config/database.php';
session_start();

$id = $_GET['id'] ?? null;
$status = $_GET['status'] ?? 'Completada'; // Default legacy fallback
$userId = $_SESSION['usuario_id'] ?? 1;

if ($id) {
    if ($status === 'Completada') {
        $stmt = $pdo->prepare("UPDATE tareas_instancia SET estado = ?, fecha_completada = NOW(), id_responsable = ? WHERE id_tarea = ?");
        $stmt->execute([$status, $userId, $id]);
    } else {
        // Para Pendiente o En Curso, limpiamos fecha_completada si estaba completa
        $stmt = $pdo->prepare("UPDATE tareas_instancia SET estado = ?, fecha_completada = NULL, id_responsable = ? WHERE id_tarea = ?");
        $stmt->execute([$status, $userId, $id]);
    }
}

$redirect = $_GET['redirect'] ?? 'module';

if ($redirect === 'dashboard') {
    header("Location: ../../index.php");
} else {
    header("Location: index.php?view=" . ($_GET['view'] ?? 'list'));
}
exit;


================================================================================
 MODULE: TAREAS
 FILE: tareas\form.php
================================================================================
<?php
require_once '../../config/database.php';
require_once '../../includes/header.php';

// Check Permissions
if (!in_array($_SESSION['usuario_rol'], ['Gerente', 'Administrativo', 'Coordinador ASSA'])) {
    echo "<div class='container'><div class='alert alert-danger'>Acceso denegado.</div></div>";
    require_once '../../includes/footer.php';
    exit;
}

// Handle Form Submission
$isEdit = false;
$id = $_GET['id'] ?? null;
$tarea = [
    'titulo' => '',
    'descripcion' => '',
    'importancia' => 'Baja',
    'tipo_recurrencia' => 'Unica',
    'parametro_recurrencia' => '',
    'fecha_inicio' => date('Y-m-d'),
    'fecha_fin' => ''
];

if ($id) {
    $stmt = $pdo->prepare("SELECT * FROM tareas_definicion WHERE id_definicion = ?");
    $stmt->execute([$id]);
    $tarea = $stmt->fetch(PDO::FETCH_ASSOC);
    $isEdit = true;
}

?>

<div class="container" style="max-width: 800px; padding-top: 20px;">
    <div class="card">
        <div class="card-header">
            <h2><i class="fas fa-check-double"></i>
                <?php echo $isEdit ? 'Editar Tarea Programada' : 'Nueva Tarea'; ?>
            </h2>
        </div>
        <div class="card-body">
            <form action="save.php" method="POST">
                <?php if ($isEdit): ?>
                    <input type="hidden" name="id_definicion" value="<?php echo $id; ?>">
                <?php endif; ?>

                <div class="form-group mb-3">
                    <label>Título de la Tarea <span class="text-danger">*</span></label>
                    <input type="text" name="titulo" class="form-control" required
                        value="<?php echo htmlspecialchars($tarea['titulo']); ?>">
                </div>

                <div class="form-group mb-3">
                    <label>Descripción</label>
                    <textarea name="descripcion" class="form-control"
                        rows="3"><?php echo htmlspecialchars($tarea['descripcion']); ?></textarea>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label>Importancia</label>
                        <select name="importancia" class="form-control">
                            <option value="Baja" <?php echo $tarea['importancia'] == 'Baja' ? 'selected' : ''; ?>>Baja
                            </option>
                            <option value="Alta" <?php echo $tarea['importancia'] == 'Alta' ? 'selected' : ''; ?>>Alta
                            </option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label>Tipo de Recurrencia</label>
                        <select name="tipo_recurrencia" id="tipoRecurrencia" class="form-control"
                            onchange="toggleRecurrenceOptions()">
                            <option value="Unica" <?php echo $tarea['tipo_recurrencia'] == 'Unica' ? 'selected' : ''; ?>>
                                Única (Una sola vez)</option>
                            <option value="Diaria" <?php echo $tarea['tipo_recurrencia'] == 'Diaria' ? 'selected' : ''; ?>>Diaria (Todos los días)</option>
                            <option value="Semanal" <?php echo $tarea['tipo_recurrencia'] == 'Semanal' ? 'selected' : ''; ?>>Semanal</option>
                            <option value="Mensual" <?php echo $tarea['tipo_recurrencia'] == 'Mensual' ? 'selected' : ''; ?>>Mensual</option>
                        </select>
                    </div>
                </div>

                <!-- Opciones Dinámicas -->
                <div id="recurrenceOptions"
                    style="display: none; background: var(--bg-secondary); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <div class="row">
                        <div class="col-md-12" id="weeklyOptions" style="display: none;">
                            <label>Día de la Semana</label>
                            <select name="parametro_semanal" class="form-control">
                                <option value="1">Lunes</option>
                                <option value="2">Martes</option>
                                <option value="3">Miércoles</option>
                                <option value="4">Jueves</option>
                                <option value="5">Viernes</option>
                                <option value="6">Sábado</option>
                                <option value="7">Domingo</option>
                            </select>
                        </div>
                        <div class="col-md-12" id="monthlyOptions" style="display: none;">
                            <label>Día del Mes (1-31)</label>
                            <input type="number" name="parametro_mensual" class="form-control" min="1" max="31"
                                value="1">
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-md-6">
                            <label>Fecha Inicio</label>
                            <input type="date" name="fecha_inicio" class="form-control" required
                                value="<?php echo $tarea['fecha_inicio']; ?>">
                        </div>
                        <div class="col-md-6">
                            <label>Fecha Fin (Opcional)</label>
                            <input type="date" name="fecha_fin" class="form-control"
                                value="<?php echo $tarea['fecha_fin']; ?>">
                            <small class="text-muted">Dejar vacío para indefinido</small>
                        </div>
                    </div>
                </div>

                <!-- Fecha única -->
                <div id="singleDateOption" class="mb-3">
                    <label>Fecha de Vencimiento</label>
                    <input type="date" name="fecha_unica" class="form-control"
                        value="<?php echo $tarea['fecha_inicio']; ?>">
                </div>

                <div class="d-flex justify-content-end gap-2 mt-4">
                    <a href="index.php" class="btn btn-outline">Cancelar</a>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Guardar Tarea</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    function toggleRecurrenceOptions() {
        const type = document.getElementById('tipoRecurrencia').value;
        const recOpts = document.getElementById('recurrenceOptions');
        const singleOpt = document.getElementById('singleDateOption');
        const weekOpt = document.getElementById('weeklyOptions');
        const monthOpt = document.getElementById('monthlyOptions');

        if (type === 'Unica') {
            recOpts.style.display = 'none';
            singleOpt.style.display = 'block';
        } else {
            recOpts.style.display = 'block';
            singleOpt.style.display = 'none'; // La fecha de inicio va en el bloque recurrente if needed, or use logic

            // Hide specific params first
            weekOpt.style.display = 'none';
            monthOpt.style.display = 'none';

            if (type === 'Semanal') weekOpt.style.display = 'block';
            if (type === 'Mensual') monthOpt.style.display = 'block';
        }
    }

    // Init
    toggleRecurrenceOptions();
</script>

<?php require_once '../../includes/footer.php'; ?>

================================================================================
 MODULE: TAREAS
 FILE: tareas\index.php
================================================================================
<?php
require_once '../../config/database.php';
require_once '../../includes/header.php';
require_once '../../includes/tasks_generator.php';

// Auto-generar tareas recurrentes al cargar
generarTareasPendientes($pdo);

// Filtros
// Filtros
$view = $_GET['view'] ?? 'calendar'; // calendar OR list
$month = $_GET['month'] ?? date('m');
$year = $_GET['year'] ?? date('Y');
$importance = $_GET['importance'] ?? 'all';
$recurrence = $_GET['recurrence'] ?? 'all';

// Obtener tareas del mes
$startDate = "$year-$month-01";
$endDate = date('Y-m-t', strtotime($startDate));

$sql = "SELECT ti.*, td.tipo_recurrencia 
        FROM tareas_instancia ti
        JOIN tareas_definicion td ON ti.id_definicion = td.id_definicion
        WHERE ti.fecha_vencimiento BETWEEN ? AND ?";

$params = [$startDate, $endDate];

if ($importance !== 'all') {
    $sql .= " AND ti.importancia = ?";
    $params[] = $importance;
}

// Filtro de recurrencia (si es 'recurrent' busca Recurrencia != 'Unica', si es 'unique' busca 'Unica')
if ($recurrence === 'recurrent') {
    $sql .= " AND td.tipo_recurrencia != 'Unica'";
} elseif ($recurrence === 'unique') {
    $sql .= " AND td.tipo_recurrencia = 'Unica'";
}

$sql .= " ORDER BY ti.fecha_vencimiento ASC";

$stmt = $pdo->prepare($sql);
$stmt->execute($params);
$tareas = $stmt->fetchAll(PDO::FETCH_ASSOC);

// Agrupar por día para calendario - ELIMINADO POR SOLICITUD
// $calendarData = [];
?>

<div class="container-fluid" style="padding: 20px;">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="d-flex align-items-center gap-3">
            <h1 class="m-0"><i class="fas fa-calendar-alt text-primary"></i> Gestión de Tareas</h1>
            <div class="btn-group shadow-sm">
                <a href="?month=<?php echo date('m', strtotime("$startDate -1 month")); ?>&year=<?php echo date('Y', strtotime("$startDate -1 month")); ?>&importance=<?php echo $importance; ?>&recurrence=<?php echo $recurrence; ?>"
                    class="btn btn-light border"><i class="fas fa-chevron-left"></i></a>
                <span class="btn btn-light border disabled text-dark font-weight-bold"
                    style="opacity: 1; min-width: 150px;">
                    <?php setlocale(LC_TIME, 'es_ES.UTF-8', 'es_ES', 'Spanish_Spain');
                    echo strftime('%B %Y', strtotime($startDate)); ?>
                </span>
                <a href="?month=<?php echo date('m', strtotime("$startDate +1 month")); ?>&year=<?php echo date('Y', strtotime("$startDate +1 month")); ?>&importance=<?php echo $importance; ?>&recurrence=<?php echo $recurrence; ?>"
                    class="btn btn-light border"><i class="fas fa-chevron-right"></i></a>
            </div>
        </div>

        <div class="d-flex gap-2 align-items-center">
            <!-- Filtros -->
            <form class="d-flex gap-2" method="GET">
                <!-- Se mantiene view=calendar por compatibilidad if needed, or remove -->
                <input type="hidden" name="month" value="<?php echo $month; ?>">
                <input type="hidden" name="year" value="<?php echo $year; ?>">

                <select name="importance" class="form-control" onchange="this.form.submit()">
                    <option value="all">Todas</option>
                    <option value="Alta" <?php echo $importance == 'Alta' ? 'selected' : ''; ?>>🔥 Alta Importancia
                    </option>
                    <option value="Baja" <?php echo $importance == 'Baja' ? 'selected' : ''; ?>>Importancia Baja</option>
                </select>

                <select name="recurrence" class="form-control" onchange="this.form.submit()">
                    <option value="all">Todas las Recurrencias</option>
                    <option value="recurrent" <?php echo $recurrence == 'recurrent' ? 'selected' : ''; ?>>↻ Recurrentes
                    </option>
                    <option value="unique" <?php echo $recurrence == 'unique' ? 'selected' : ''; ?>>• Únicas</option>
                </select>
            </form>

            <a href="form.php" class="btn btn-success"><i class="fas fa-plus"></i> Nueva Tarea</a>
        </div>
    </div>

    <div class="row">
        <!-- VISTA LISTA (Principal) -->
        <div class="col-12">
            <div class="card h-100">
                <div class="card-header bg-white border-0 py-3">
                    <h5 class="card-title m-0"><i class="fas fa-list"></i> Listado de Tareas</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="bg-light">
                                <tr>
                                    <th>Fecha</th>
                                    <th>Importancia</th>
                                    <th>Tarea</th>
                                    <th>Recurrencia</th>
                                    <th>Estado</th>
                                    <th>Acción</th>
                                </tr>
                            </thead>
                            <tbody>
                                <?php if (count($tareas) > 0): ?>
                                    <?php foreach ($tareas as $t): ?>
                                        <tr>
                                            <td class="align-middle">
                                                <strong><?php echo date('d/m', strtotime($t['fecha_vencimiento'])); ?></strong>
                                                <small class="d-block text-muted"><?php setlocale(LC_TIME, 'es_ES');
                                                echo strftime('%A', strtotime($t['fecha_vencimiento'])); ?></small>
                                            </td>
                                            <td class="align-middle">
                                                <?php if ($t['importancia'] == 'Alta'): ?>
                                                    <span class="badge badge-danger"><i class="fas fa-fire"></i> Alta</span>
                                                <?php else: ?>
                                                    <span class="badge badge-secondary">Baja</span>
                                                <?php endif; ?>
                                            </td>
                                            <td class="align-middle">
                                                <span class="fw-bold"><?php echo htmlspecialchars($t['titulo']); ?></span>
                                            </td>
                                            <td class="align-middle">
                                                <?php if ($t['tipo_recurrencia'] != 'Unica'): ?>
                                                    <span class="badge badge-info"><i class="fas fa-sync-alt"></i>
                                                        <?php echo $t['tipo_recurrencia']; ?></span>
                                                <?php else: ?>
                                                    <span class="text-muted"><small>Única</small></span>
                                                <?php endif; ?>
                                            </td>
                                            <td class="align-middle">
                                                <span
                                                    class="badge <?php echo $t['estado'] == 'Completada' ? 'badge-success' : ($t['estado'] == 'En Curso' ? 'badge-info' : 'badge-warning'); ?>">
                                                    <?php echo $t['estado']; ?>
                                                </span>
                                            </td>
                                            <td class="align-middle">
                                                <?php if ($t['estado'] != 'Completada'): ?>
                                                    <a href="complete_task.php?id=<?php echo $t['id_tarea']; ?>"
                                                        class="btn btn-sm btn-success rounded-circle" title="Completar"><i
                                                            class="fas fa-check"></i></a>
                                                <?php endif; ?>
                                            </td>
                                        </tr>
                                    <?php endforeach; ?>
                                <?php else: ?>
                                    <tr>
                                        <td colspan="6" class="text-center py-4 text-muted">
                                            <i class="fas fa-calendar-times fa-2x mb-2"></i><br>
                                            No hay tareas para este período.
                                        </td>
                                    </tr>
                                <?php endif; ?>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>
</div>

<script>
    function viewTask(id) {
        if (confirm('¿Marcar tarea como completada?')) {
            window.location.href = 'complete_task.php?id=' + id;
        }
    }
</script>

<?php require_once '../../includes/footer.php'; ?>

================================================================================
 MODULE: TAREAS
 FILE: tareas\save.php
================================================================================
<?php
require_once '../../config/database.php';
session_start();

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $id_definicion = $_POST['id_definicion'] ?? null;
    $titulo = $_POST['titulo'];
    $descripcion = $_POST['descripcion'];
    $importancia = $_POST['importancia'];
    $tipo = $_POST['tipo_recurrencia'];
    $id_creador = $_SESSION['usuario_id'] ?? 1; // Fallback admin

    try {
        $parametro = null;
        $fecha_inicio = null;
        $fecha_fin = null;

        if ($tipo === 'Unica') {
            $fecha_inicio = $_POST['fecha_unica'];
            // Para tareas únicas, fecha_fin es igual a inicio para simplificar logica
            $fecha_fin = $fecha_inicio;
        } else {
            $fecha_inicio = $_POST['fecha_inicio'];
            $fecha_fin = !empty($_POST['fecha_fin']) ? $_POST['fecha_fin'] : null;

            if ($tipo === 'Semanal')
                $parametro = $_POST['parametro_semanal'];
            if ($tipo === 'Mensual')
                $parametro = $_POST['parametro_mensual'];
        }

        if ($id_definicion) {
            // Update
            $sql = "UPDATE tareas_definicion SET titulo=?, descripcion=?, importancia=?, tipo_recurrencia=?, parametro_recurrencia=?, fecha_inicio=?, fecha_fin=? WHERE id_definicion=?";
            $stmt = $pdo->prepare($sql);
            $stmt->execute([$titulo, $descripcion, $importancia, $tipo, $parametro, $fecha_inicio, $fecha_fin, $id_definicion]);
        } else {
            // Insert
            $sql = "INSERT INTO tareas_definicion (titulo, descripcion, importancia, tipo_recurrencia, parametro_recurrencia, fecha_inicio, fecha_fin, id_creador) VALUES (?, ?, ?, ?, ?, ?, ?, ?)";
            $stmt = $pdo->prepare($sql);
            $stmt->execute([$titulo, $descripcion, $importancia, $tipo, $parametro, $fecha_inicio, $fecha_fin, $id_creador]);

            // Si es Única, generamos la instancia YA MISMO
            if ($tipo === 'Unica') {
                $id_def = $pdo->lastInsertId();
                $sqlInst = "INSERT INTO tareas_instancia (id_definicion, titulo, descripcion, fecha_vencimiento, importancia) VALUES (?, ?, ?, ?, ?)";
                $pdo->prepare($sqlInst)->execute([$id_def, $titulo, $descripcion, $fecha_inicio, $importancia]);

                // Marcar como generado
                $pdo->prepare("UPDATE tareas_definicion SET ultimo_generado = ? WHERE id_definicion = ?")->execute([$fecha_inicio, $id_def]);
            }
        }

        header("Location: index.php?msg=saved");
        exit;

    } catch (PDOException $e) {
        header("Location: form.php?msg=error&details=" . urlencode($e->getMessage()));
        exit;
    }
}


================================================================================
 MODULE: TIPOS_TRABAJOS
 FILE: tipos_trabajos\delete.php
================================================================================
<?php
/**
 * Módulo: Tipos de Trabajos
 * Endpoint para eliminar
 */
require_once '../../config/database.php';
require_once '../../includes/auth.php';

// Verificar sesión
verificarSesion();

$id = $_GET['id'] ?? null;

if (!$id) {
    header("Location: index.php");
    exit();
}

try {
    // Obtener datos antes de eliminar para el log
    $infoStmt = $pdo->prepare("SELECT codigo_trabajo, nombre FROM tipos_trabajos WHERE id_tipologia = ?");
    $infoStmt->execute([$id]);
    $trabajo = $infoStmt->fetch(PDO::FETCH_ASSOC);

    if (!$trabajo) {
        header("Location: index.php?msg=error");
        exit();
    }

    // TODO: Verificar si hay dependencias (órdenes de trabajo que usen este tipo)
    // Por ahora solo eliminamos

    // Eliminar
    $stmt = $pdo->prepare("DELETE FROM tipos_trabajos WHERE id_tipologia = ?");
    $stmt->execute([$id]);

    // Registrar auditoría
    registrarAccion('ELIMINAR', 'tipos_trabajos', "Tipo de trabajo eliminado: [{$trabajo['codigo_trabajo']}] {$trabajo['nombre']}", $id);

    header("Location: index.php?msg=deleted");

} catch (PDOException $e) {
    error_log("Error en tipos_trabajos/delete.php: " . $e->getMessage());
    header("Location: index.php?msg=error");
}

exit();
?>

================================================================================
 MODULE: TIPOS_TRABAJOS
 FILE: tipos_trabajos\form.php
================================================================================
<?php
/**
 * Módulo: Tipos de Trabajos
 * Formulario de creación/edición
 */
require_once '../../config/database.php';
require_once '../../includes/header.php';

$id = $_GET['id'] ?? null;
$trabajo = null;

if ($id) {
    $stmt = $pdo->prepare("SELECT * FROM tipos_trabajos WHERE id_tipologia = ?");
    $stmt->execute([$id]);
    $trabajo = $stmt->fetch(PDO::FETCH_ASSOC);

    if (!$trabajo) {
        header("Location: index.php?msg=error");
        exit();
    }
}
?>

<div class="card" style="max-width: 900px; margin: 0 auto;">
    <div style="display: flex; align-items: center; gap: var(--spacing-md); margin-bottom: var(--spacing-lg);">
        <a href="index.php" style="color: var(--color-neutral); font-size: 1.2em;"><i class="fas fa-arrow-left"></i></a>
        <h1 style="margin: 0;"><i class="fas fa-hard-hat"></i> <?php echo $id ? 'Editar' : 'Nuevo'; ?> Tipo de Trabajo
        </h1>
    </div>

    <form action="save.php" method="POST">
        <?php if ($id): ?>
            <input type="hidden" name="id_tipologia" value="<?php echo $id; ?>">
        <?php endif; ?>

        <!-- Sección: Identificación -->
        <h3 style="border-bottom: 2px solid var(--color-primary); padding-bottom: 8px; color: var(--color-primary);">
            <i class="fas fa-tag"></i> Identificación
        </h3>

        <div
            style="display: grid; grid-template-columns: 1fr 2fr; gap: var(--spacing-md); margin-bottom: var(--spacing-lg);">
            <div>
                <label style="display: block; font-weight: 500; margin-bottom: 4px;">
                    Código de Trabajo * <small style="color: #666;">(Ej: 3.1, 22.5)</small>
                </label>
                <input type="text" name="codigo_trabajo" required
                    value="<?php echo htmlspecialchars($trabajo['codigo_trabajo'] ?? ''); ?>" placeholder="Ej: 3.1"
                    style="">
            </div>
            <div>
                <label style="display: block; font-weight: 500; margin-bottom: 4px;">Nombre del Trabajo *</label>
                <input type="text" name="nombre" required
                    value="<?php echo htmlspecialchars($trabajo['nombre'] ?? ''); ?>"
                    placeholder="Ej: Reparación de veredas comunes" style="">
            </div>
        </div>

        <!-- Sección: Descripciones -->
        <h3 style="border-bottom: 2px solid var(--color-primary); padding-bottom: 8px; color: var(--color-primary);">
            <i class="fas fa-align-left"></i> Descripciones
        </h3>

        <div style="margin-bottom: var(--spacing-md);">
            <label style="display: block; font-weight: 500; margin-bottom: 4px;">Descripción Breve</label>
            <input type="text" name="descripcion_breve"
                value="<?php echo htmlspecialchars($trabajo['descripcion_breve'] ?? ''); ?>"
                placeholder="Descripción corta para listados y reportes" maxlength="255" style="">
        </div>

        <div style="margin-bottom: var(--spacing-lg);">
            <label style="display: block; font-weight: 500; margin-bottom: 4px;">Descripción Larga</label>
            <textarea name="descripcion_larga" rows="3"
                placeholder="Descripción detallada del trabajo, incluyendo especificaciones técnicas..."
                style=""><?php echo htmlspecialchars($trabajo['descripcion_larga'] ?? ''); ?></textarea>
        </div>

        <!-- Sección: Parámetros -->
        <h3 style="border-bottom: 2px solid var(--color-primary); padding-bottom: 8px; color: var(--color-primary);">
            <i class="fas fa-cogs"></i> Parámetros
        </h3>

        <div
            style="display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--spacing-md); margin-bottom: var(--spacing-lg);">
            <div>
                <label style="display: block; font-weight: 500; margin-bottom: 4px;">Unidad de Medida *</label>
                <select name="unidad_medida" required style="">
                    <option value="">Seleccione...</option>
                    <?php
                    $unidades = [
                        'M2' => 'M² (Metro Cuadrado)',
                        'M3' => 'M³ (Metro Cúbico)',
                        'ML' => 'ML (Metro Lineal)',
                        'U' => 'U (Unidad)'
                    ];
                    foreach ($unidades as $val => $label) {
                        $sel = ($trabajo['unidad_medida'] ?? '') == $val ? 'selected' : '';
                        echo "<option value='$val' $sel>$label</option>";
                    }
                    ?>
                </select>
            </div>
            <div>
                <label style="display: block; font-weight: 500; margin-bottom: 4px;">Tiempo Límite (días)</label>
                <input type="number" name="tiempo_limite_dias" min="0"
                    value="<?php echo $trabajo['tiempo_limite_dias'] ?? ''; ?>" placeholder="Ej: 30" style="">
            </div>
            <div>
                <label style="display: block; font-weight: 500; margin-bottom: 4px;">Precio Unitario (OM 2026)</label>
                <div style="position: relative;">
                    <span class="input-prefix">$</span>
                    <input type="number" step="0.01" name="precio_unitario"
                        value="<?php echo $trabajo['precio_unitario'] ?? ''; ?>" placeholder="0.00" style="">
                </div>
            </div>
        </div>

        <!-- Estado -->
        <div class="status-box">
            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" name="estado" value="1" <?php echo ($trabajo['estado'] ?? 1) ? 'checked' : ''; ?>
                    style="width: 20px; height: 20px;">
                <span style="font-weight: 500;">Tipo de trabajo activo</span>
                <small style="color: #666;">(Los inactivos no aparecen en listados de selección)</small>
            </label>
        </div>

        <!-- Botones -->
        <div
            style="display: flex; justify-content: space-between; align-items: center; padding-top: var(--spacing-md); border-top: 1px solid #eee;">
            <a href="index.php" class="btn btn-outline">
                <i class="fas fa-times"></i> Cancelar
            </a>
            <button type="submit" class="btn btn-primary" style="padding: 12px 30px;">
                <i class="fas fa-save"></i> Guardar Tipo de Trabajo
            </button>
        </div>
    </form>
</div>

<style>
    /* Estilos del Formulario - Tema */
    .card {
        background: var(--bg-card);
        color: var(--text-primary);
        box-shadow: var(--shadow-md);
        border: 1px solid rgba(100, 181, 246, 0.15);
        padding: 25px;
        border-radius: 12px;
    }

    /* Inputs y Selects */
    input[type="text"],
    input[type="email"],
    input[type="password"],
    input[type="number"],
    select,
    textarea {
        width: 100%;
        padding: 12px 14px !important;
        background: var(--bg-tertiary) !important;
        border: 1px solid rgba(255, 255, 255, 0.1) !important;
        border-radius: 8px !important;
        color: var(--text-primary) !important;
        font-size: 0.95rem;
        outline: none;
        transition: all 0.2s;
        font-family: inherit;
    }

    input:focus,
    select:focus,
    textarea:focus {
        border-color: var(--color-primary) !important;
        box-shadow: 0 0 0 3px rgba(100, 181, 246, 0.2);
        background: var(--bg-secondary) !important;
    }

    label {
        color: var(--text-secondary);
        font-size: 0.9rem;
    }

    small {
        color: var(--text-muted) !important;
    }

    /* Caja de Estado (Checkbox) */
    .status-box {
        background: var(--bg-tertiary);
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        border: 1px solid rgba(255, 255, 255, 0.05);
    }

    /* Headers de secciones */
    h1,
    h3 {
        color: var(--text-primary);
    }

    /* Precios */
    .input-prefix {
        position: absolute;
        left: 10px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-muted);
        z-index: 2;
    }

    input[name="precio_unitario"] {
        padding-left: 25px !important;
    }

    /* MODO CLARO */
    [data-theme="light"] input,
    [data-theme="light"] select,
    [data-theme="light"] textarea {
        background: #ffffff !important;
        border: 1px solid #ddd !important;
        color: #333 !important;
    }

    [data-theme="light"] input:focus,
    [data-theme="light"] select:focus,
    [data-theme="light"] textarea:focus {
        border-color: var(--color-primary) !important;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
    }

    [data-theme="light"] .status-box {
        background: #f8f9fa;
        border: 1px solid #e2e8f0;
    }

    [data-theme="light"] .card {
        background: #ffffff;
        border: 1px solid #e2e8f0;
        color: #333;
    }
</style>

<?php require_once '../../includes/footer.php'; ?>

================================================================================
 MODULE: TIPOS_TRABAJOS
 FILE: tipos_trabajos\index.php
================================================================================
<?php
/**
 * Módulo: Tipos de Trabajos
 * Listado principal con filtros y métricas
 */
require_once '../../config/database.php';
require_once '../../includes/header.php';

// Filtros
$filtroUnidad = $_GET['unidad'] ?? '';
$busqueda = $_GET['buscar'] ?? '';

// Query con filtros
$where = "WHERE 1=1";
$params = [];

if ($filtroUnidad) {
    $where .= " AND unidad_medida = ?";
    $params[] = $filtroUnidad;
}

if ($busqueda) {
    $where .= " AND (nombre LIKE ? OR codigo_trabajo LIKE ? OR descripcion_breve LIKE ?)";
    $busquedaParam = "%{$busqueda}%";
    $params[] = $busquedaParam;
    $params[] = $busquedaParam;
    $params[] = $busquedaParam;
}

$query = "SELECT * FROM tipos_trabajos $where ORDER BY codigo_trabajo ASC";
$stmt = $pdo->prepare($query);
$stmt->execute($params);
$trabajos = $stmt->fetchAll(PDO::FETCH_ASSOC);
?>

<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-lg);">
        <h1><i class="fas fa-hard-hat"></i> Tipos de Trabajos</h1>
        <a href="form.php" class="btn btn-primary"><i class="fas fa-plus"></i> Nuevo Tipo</a>
    </div>

    <!-- Filtros -->
    <form method="GET" class="filter-bar">
        <div class="filter-group">
            <label>Buscar</label>
            <input type="text" name="buscar" value="<?php echo htmlspecialchars($busqueda); ?>"
                placeholder="Código, nombre o descripción..." class="form-control-sm">
        </div>
        <div class="filter-group">
            <label>Unidad</label>
            <select name="unidad" class="form-control-sm">
                <option value="">Todas</option>
                <option value="M2" <?php echo $filtroUnidad === 'M2' ? 'selected' : ''; ?>>M² (Superficie)</option>
                <option value="M3" <?php echo $filtroUnidad === 'M3' ? 'selected' : ''; ?>>M³ (Volumen)</option>
                <option value="ML" <?php echo $filtroUnidad === 'ML' ? 'selected' : ''; ?>>ML (Lineal)</option>
                <option value="U" <?php echo $filtroUnidad === 'U' ? 'selected' : ''; ?>>U (Unidad)</option>
            </select>
        </div>
        <div class="filter-group" style="flex: 0 0 auto; display: flex; gap: 8px;">
            <button type="submit" class="btn btn-primary" title="Buscar">
                <i class="fas fa-search"></i>
            </button>
            <?php if ($filtroUnidad || $busqueda): ?>
                <a href="index.php" class="btn btn-outline" title="Limpiar Filtros">
                    <i class="fas fa-sync-alt"></i>
                </a>
            <?php endif; ?>
        </div>
    </form>

    <!-- Feedback Messages -->
    <?php if (isset($_GET['msg'])): ?>
        <div
            style="padding: var(--spacing-md); margin-bottom: var(--spacing-md); border-radius: var(--border-radius-md); 
            background: <?php echo $_GET['msg'] == 'saved' ? '#d4edda' : ($_GET['msg'] == 'deleted' ? '#fff3cd' : '#f8d7da'); ?>; 
            color: <?php echo $_GET['msg'] == 'saved' ? '#155724' : ($_GET['msg'] == 'deleted' ? '#856404' : '#721c24'); ?>;">
            <?php
            if ($_GET['msg'] == 'saved')
                echo "<i class='fas fa-check-circle'></i> Tipo de trabajo guardado correctamente.";
            if ($_GET['msg'] == 'deleted')
                echo "<i class='fas fa-trash'></i> Tipo de trabajo eliminado.";
            if ($_GET['msg'] == 'error')
                echo "<i class='fas fa-exclamation-circle'></i> Ha ocurrido un error.";
            ?>
        </div>
    <?php endif; ?>

    <!-- Tabla -->
    <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background: var(--color-primary-dark); color: white;">
                    <th style="padding: var(--spacing-md); text-align: left; width: 80px;">Código</th>
                    <th style="padding: var(--spacing-md); text-align: left;">Nombre</th>
                    <th style="padding: var(--spacing-md); text-align: left;">Descripción</th>
                    <th style="padding: var(--spacing-md); text-align: center; width: 80px;">Unidad</th>
                    <th style="padding: var(--spacing-md); text-align: center; width: 100px;">Tiempo Límite</th>
                    <th style="padding: var(--spacing-md); text-align: right; width: 150px; white-space: nowrap;">Precio
                        OM</th>
                    <th style="padding: var(--spacing-md); text-align: center; width: 80px;">Estado</th>
                    <th style="padding: var(--spacing-md); text-align: center; width: 100px;">Acciones</th>
                </tr>
            </thead>
            <tbody>
                <?php foreach ($trabajos as $trabajo): ?>
                    <tr style="border-bottom: 1px solid var(--color-neutral-light);">
                        <td style="padding: var(--spacing-md);">
                            <span
                                style="background: #e3f2fd; color: #1565c0; padding: 2px 8px; border-radius: 4px; font-weight: bold; font-size: 0.85em;">
                                <?php echo htmlspecialchars($trabajo['codigo_trabajo']); ?>
                            </span>
                        </td>
                        <td style="padding: var(--spacing-md); font-weight: 500;">
                            <?php echo htmlspecialchars($trabajo['nombre']); ?>
                        </td>
                        <td style="padding: var(--spacing-md); color: #666; font-size: 0.9em;">
                            <?php echo htmlspecialchars($trabajo['descripcion_breve'] ?? '-'); ?>
                        </td>
                        <td style="padding: var(--spacing-md); text-align: center;">
                            <?php
                            $unidadColors = ['M2' => '#10b981', 'M3' => '#3b82f6', 'ML' => '#f59e0b', 'U' => '#6366f1'];
                            $color = $unidadColors[$trabajo['unidad_medida']] ?? '#6b7280';
                            ?>
                            <span
                                style="background: <?php echo $color; ?>; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8em;">
                                <?php echo $trabajo['unidad_medida']; ?>
                            </span>
                        </td>
                        <td style="padding: var(--spacing-md); text-align: center;">
                            <?php echo $trabajo['tiempo_limite_dias'] ? $trabajo['tiempo_limite_dias'] . ' días' : '-'; ?>
                        </td>
                        <td style="padding: var(--spacing-md); text-align: right; font-weight: 500;">
                            <?php echo $trabajo['precio_unitario'] ? '$ ' . number_format($trabajo['precio_unitario'], 2, ',', '.') : '-'; ?>
                        </td>
                        <td style="padding: var(--spacing-md); text-align: center;">
                            <?php if ($trabajo['estado']): ?>
                                <span
                                    style="background: #d1fae5; color: #059669; padding: 2px 8px; border-radius: 4px; font-size: 0.8em;">Activo</span>
                            <?php else: ?>
                                <span
                                    style="background: #fee2e2; color: #dc2626; padding: 2px 8px; border-radius: 4px; font-size: 0.8em;">Inactivo</span>
                            <?php endif; ?>
                        </td>
                        <td style="padding: var(--spacing-md); text-align: center;">
                            <a href="form.php?id=<?php echo $trabajo['id_tipologia']; ?>" class="btn btn-outline"
                                style="padding: 4px 8px; font-size: 0.9em;"><i class="fas fa-edit"></i></a>
                            <a href="delete.php?id=<?php echo $trabajo['id_tipologia']; ?>"
                                onclick="return confirm('¿Está seguro de eliminar este tipo de trabajo?');"
                                class="btn btn-outline"
                                style="padding: 4px 8px; font-size: 0.9em; border-color: var(--color-danger); color: var(--color-danger);">
                                <i class="fas fa-trash"></i></a>
                        </td>
                    </tr>
                <?php endforeach; ?>
                <?php if (empty($trabajos)): ?>
                    <tr>
                        <td colspan="7"
                            style="padding: var(--spacing-lg); text-align: center; color: var(--color-neutral);">
                            <i class="fas fa-search"
                                style="font-size: 2em; opacity: 0.5; display: block; margin-bottom: 10px;"></i>
                            No hay tipos de trabajos registrados.
                        </td>
                    </tr>
                <?php endif; ?>
            </tbody>
        </table>
    </div>
</div>

<?php require_once '../../includes/footer.php'; ?>

================================================================================
 MODULE: TIPOS_TRABAJOS
 FILE: tipos_trabajos\save.php
================================================================================
<?php
/**
 * Módulo: Tipos de Trabajos
 * Endpoint para guardar (crear/actualizar)
 */
require_once '../../config/database.php';
require_once '../../includes/auth.php';

// Verificar sesión
verificarSesion();

if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
    header("Location: index.php");
    exit();
}

// Recoger datos del formulario
$id = $_POST['id_tipologia'] ?? null;
$codigo_trabajo = trim($_POST['codigo_trabajo']);
$nombre = trim($_POST['nombre']);
$descripcion_breve = trim($_POST['descripcion_breve'] ?? '');
$descripcion_larga = trim($_POST['descripcion_larga'] ?? '');
$unidad_medida = $_POST['unidad_medida'];
$tiempo_limite_dias = !empty($_POST['tiempo_limite_dias']) ? (int) $_POST['tiempo_limite_dias'] : null;
$precio_unitario = !empty($_POST['precio_unitario']) ? (float) $_POST['precio_unitario'] : null;
$estado = isset($_POST['estado']) ? 1 : 0;

// Validaciones básicas
if (empty($codigo_trabajo) || empty($nombre) || empty($unidad_medida)) {
    header("Location: form.php" . ($id ? "?id=$id" : "") . "&msg=error");
    exit();
}

try {
    // Verificar código único (excepto para el registro actual)
    $checkSql = "SELECT id_tipologia FROM tipos_trabajos WHERE codigo_trabajo = ?";
    $checkParams = [$codigo_trabajo];
    if ($id) {
        $checkSql .= " AND id_tipologia != ?";
        $checkParams[] = $id;
    }
    $checkStmt = $pdo->prepare($checkSql);
    $checkStmt->execute($checkParams);

    if ($checkStmt->fetch()) {
        // Código duplicado
        header("Location: form.php" . ($id ? "?id=$id" : "") . "&msg=duplicate");
        exit();
    }

    if ($id) {
        // UPDATE
        $sql = "UPDATE tipos_trabajos SET 
                codigo_trabajo = ?, 
                nombre = ?, 
                descripcion_breve = ?, 
                descripcion_larga = ?, 
                unidad_medida = ?, 
                tiempo_limite_dias = ?, 
                precio_unitario = ?, 
                estado = ?,
                updated_at = CURRENT_TIMESTAMP
                WHERE id_tipologia = ?";

        $stmt = $pdo->prepare($sql);
        $stmt->execute([
            $codigo_trabajo,
            $nombre,
            $descripcion_breve ?: null,
            $descripcion_larga ?: null,
            $unidad_medida,
            $tiempo_limite_dias,
            $precio_unitario,
            $estado,
            $id
        ]);

        // Auditoría
        registrarAccion('EDITAR', 'tipos_trabajos', "Tipo de trabajo editado: [$codigo_trabajo] $nombre", $id);

    } else {
        // INSERT
        $sql = "INSERT INTO tipos_trabajos 
                (codigo_trabajo, nombre, descripcion_breve, descripcion_larga, unidad_medida, tiempo_limite_dias, precio_unitario, estado) 
                VALUES (?, ?, ?, ?, ?, ?, ?, ?)";

        $stmt = $pdo->prepare($sql);
        $stmt->execute([
            $codigo_trabajo,
            $nombre,
            $descripcion_breve ?: null,
            $descripcion_larga ?: null,
            $unidad_medida,
            $tiempo_limite_dias,
            $precio_unitario,
            $estado
        ]);

        $newId = $pdo->lastInsertId();

        // Auditoría
        registrarAccion('CREAR', 'tipos_trabajos', "Tipo de trabajo creado: [$codigo_trabajo] $nombre", $newId);
    }

    header("Location: index.php?msg=saved");
    exit();

} catch (PDOException $e) {
    error_log("Error en tipos_trabajos/save.php: " . $e->getMessage());
    header("Location: index.php?msg=error");
    exit();
}
?>

================================================================================
 MODULE: USUARIOS
 FILE: usuarios\delete.php
================================================================================
<?php
/**
 * Módulo: Usuarios del Sistema
 * Endpoint para eliminar
 */
require_once '../../config/database.php';
require_once '../../includes/auth.php';

// Verificar sesión y permisos
verificarSesion();
if (!tienePermiso('usuarios')) {
    header("Location: /APP-Prueba/index.php?msg=forbidden");
    exit();
}

$id = $_GET['id'] ?? null;

if (!$id) {
    header("Location: index.php");
    exit();
}

// No permitir eliminar el propio usuario
if ($id == ($_SESSION['user_id'] ?? 0)) {
    header("Location: index.php?msg=self");
    exit();
}

try {
    // Obtener datos antes de eliminar
    $infoStmt = $pdo->prepare("SELECT nombre, email FROM usuarios WHERE id_usuario = ?");
    $infoStmt->execute([$id]);
    $usuario = $infoStmt->fetch(PDO::FETCH_ASSOC);

    if (!$usuario) {
        header("Location: index.php?msg=error");
        exit();
    }

    // Eliminar
    $stmt = $pdo->prepare("DELETE FROM usuarios WHERE id_usuario = ?");
    $stmt->execute([$id]);

    // Auditoría
    registrarAccion('ELIMINAR', 'usuarios', "Usuario eliminado: {$usuario['nombre']} ({$usuario['email']})", $id);

    header("Location: index.php?msg=deleted");

} catch (PDOException $e) {
    error_log("Error en usuarios/delete.php: " . $e->getMessage());
    header("Location: index.php?msg=error");
}

exit();
?>

================================================================================
 MODULE: USUARIOS
 FILE: usuarios\form.php
================================================================================
<?php
/**
 * Módulo: Usuarios del Sistema
 * Formulario de creación/edición
 */
require_once '../../config/database.php';
require_once '../../includes/header.php';

// Solo Gerente puede acceder
if (!tienePermiso('usuarios')) {
    header("Location: /APP-Prueba/index.php?msg=forbidden");
    exit();
}

$id = $_GET['id'] ?? null;
$usuario = null;

if ($id) {
    $stmt = $pdo->prepare("SELECT * FROM usuarios WHERE id_usuario = ?");
    $stmt->execute([$id]);
    $usuario = $stmt->fetch(PDO::FETCH_ASSOC);
    
    if (!$usuario) {
        header("Location: index.php?msg=error");
        exit();
    }
}

// Get cuadrillas for dropdown
$cuadrillas = $pdo->query("SELECT * FROM cuadrillas WHERE estado_operativo = 'Activa' ORDER BY nombre_cuadrilla")->fetchAll(PDO::FETCH_ASSOC);
?>

<div class="card" style="max-width: 700px; margin: 0 auto;">
    <div style="display: flex; align-items: center; gap: var(--spacing-md); margin-bottom: var(--spacing-lg);">
        <a href="index.php" style="color: var(--color-neutral); font-size: 1.2em;"><i class="fas fa-arrow-left"></i></a>
        <h1 style="margin: 0;"><i class="fas fa-user-cog"></i> <?php echo $id ? 'Editar' : 'Nuevo'; ?> Usuario</h1>
    </div>

    <?php if (isset($_GET['msg']) && $_GET['msg'] == 'duplicate'): ?>
        <div style="padding: 12px; margin-bottom: 20px; background: #f8d7da; color: #721c24; border-radius: 8px;">
            <i class="fas fa-exclamation-circle"></i> Ya existe un usuario con ese email.
        </div>
    <?php endif; ?>

    <form action="save.php" method="POST">
        <?php if ($id): ?>
            <!-- [✓] AUDITORÍA: El ID se envía como campo oculto para el WHERE de save.php -->
            <input type="hidden" name="id_usuario" value="<?php echo $id; ?>">
        <?php endif; ?>

        <!-- Datos Básicos -->
        <h3 style="border-bottom: 2px solid var(--color-primary); padding-bottom: 8px; color: var(--color-primary);">
            <i class="fas fa-user"></i> Información del Usuario
        </h3>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
            <div>
                <label style="display: block; font-weight: 500; margin-bottom: 4px;">Nombre Completo *</label>
                <input type="text" name="nombre" required 
                       value="<?php echo htmlspecialchars($usuario['nombre'] ?? ''); ?>"
                       placeholder="Ej: Juan Pérez"
                       style="">
            </div>
            <div>
                <label style="display: block; font-weight: 500; margin-bottom: 4px;">Email *</label>
                <input type="email" name="email" required 
                       value="<?php echo htmlspecialchars($usuario['email'] ?? ''); ?>"
                       placeholder="usuario@empresa.com"
                       style="">
            </div>
        </div>

        <!-- Contraseña -->
        <div style="margin-bottom: 20px;">
            <label style="display: block; font-weight: 500; margin-bottom: 4px;">
                Contraseña <?php echo $id ? '(dejar vacío para mantener)' : '*'; ?>
            </label>
            <input type="password" name="password" <?php echo $id ? '' : 'required'; ?>
                   placeholder="<?php echo $id ? '••••••••' : 'Mínimo 6 caracteres'; ?>"
                   minlength="6"
                   style="">
        </div>

        <!-- Rol y Cuadrilla -->
        <h3 style="border-bottom: 2px solid var(--color-primary); padding-bottom: 8px; color: var(--color-primary);">
            <i class="fas fa-shield-alt"></i> Permisos y Asignación
        </h3>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
            <div>
                <label style="display: block; font-weight: 500; margin-bottom: 4px;">Rol *</label>
                <select name="rol" id="selectRol" required onchange="toggleCuadrilla()"
                        style="">
                    <option value="">Seleccione...</option>
                    <option value="Gerente" <?php echo ($usuario['rol'] ?? '') === 'Gerente' ? 'selected' : ''; ?>>
                        Gerente (Acceso Total)
                    </option>
                    <option value="Coordinador ASSA" <?php echo ($usuario['rol'] ?? '') === 'Coordinador ASSA' ? 'selected' : ''; ?>>
                        Coordinador ASSA
                    </option>
                    <option value="Administrativo" <?php echo ($usuario['rol'] ?? '') === 'Administrativo' ? 'selected' : ''; ?>>
                        Administrativo (General)
                    </option>
                    <option value="Administrativo ASSA" <?php echo ($usuario['rol'] ?? '') === 'Administrativo ASSA' ? 'selected' : ''; ?>>
                        Administrativo ASSA
                    </option>
                    <option value="Inspector ASSA" <?php echo ($usuario['rol'] ?? '') === 'Inspector ASSA' ? 'selected' : ''; ?>>
                        Inspector ASSA
                    </option>
                    <option value="JefeCuadrilla" <?php echo ($usuario['rol'] ?? '') === 'JefeCuadrilla' ? 'selected' : ''; ?>>
                        Jefe de Cuadrilla (Operativo)
                    </option>
                </select>
                <!-- [✓] AUDITORÍA: Validación de campo ROL para integridad referencial -->
                <div id="rolError" style="color: var(--color-danger); font-size: 0.8rem; margin-top: 4px; display: none;">
                    * Debe seleccionar un rol válido
                </div>
            </div>
            <div id="cuadrillaContainer" style="<?php echo ($usuario['rol'] ?? '') !== 'JefeCuadrilla' ? 'opacity: 0.5;' : ''; ?>">
                <label style="display: block; font-weight: 500; margin-bottom: 4px;">Cuadrilla Asignada</label>
                <select name="id_cuadrilla" id="selectCuadrilla"
                        style=""
                        <?php echo ($usuario['rol'] ?? '') !== 'JefeCuadrilla' ? 'disabled' : ''; ?>>
                    <option value="">Sin asignar</option>
                    <?php foreach ($cuadrillas as $c): ?>
                        <option value="<?php echo $c['id_cuadrilla']; ?>" 
                                <?php echo ($usuario['id_cuadrilla'] ?? '') == $c['id_cuadrilla'] ? 'selected' : ''; ?>>
                            <?php echo $c['nombre_cuadrilla']; ?>
                        </option>
                    <?php endforeach; ?>
                </select>
                <small style="color: #666;">Solo para Jefe de Cuadrilla</small>
            </div>
        </div>

        <!-- Estado -->
        <div class="status-box">
            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" name="estado" value="1" 
                       <?php echo ($usuario['estado'] ?? 1) ? 'checked' : ''; ?>
                       style="width: 20px; height: 20px;">
                <span style="font-weight: 500;">Usuario activo</span>
                <small style="color: #666;">(Los inactivos no pueden iniciar sesión)</small>
            </label>
        </div>

        <!-- Botones -->
        <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 15px; border-top: 1px solid #eee;">
            <a href="index.php" class="btn btn-outline">
                <i class="fas fa-times"></i> Cancelar
            </a>
            <button type="submit" class="btn btn-primary" style="padding: 12px 30px;">
                <i class="fas fa-save"></i> Guardar Usuario
            </button>
        </div>
    </form>
</div>

<script>
    function toggleCuadrilla() {
        const rol = document.getElementById('selectRol').value;
        const container = document.getElementById('cuadrillaContainer');
        const select = document.getElementById('selectCuadrilla');
        
        if (rol === 'JefeCuadrilla') {
            container.style.opacity = '1';
            select.disabled = false;
        } else {
            container.style.opacity = '0.5';
            select.disabled = true;
            select.value = '';
        }
    }

    // [✓] AUDIT: Protocolo de validación frontend y feedback visual
    document.querySelector('form').addEventListener('submit', function(e) {
        const rol = document.getElementById('selectRol').value;
        const rolError = document.getElementById('rolError');
        
        if (!rol) {
            e.preventDefault();
            rolError.style.display = 'block';
            showToast('⚠ Error: Debe asignar un rol al usuario', 'error');
            return;
        }

        const btn = this.querySelector('button[type="submit"]');
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
        btn.disabled = true;
    });
</script>

<style>
    /* Estilos del Formulario - Tema */
    .card {
        background: var(--bg-card);
        color: var(--text-primary);
        box-shadow: var(--shadow-md);
        border: 1px solid rgba(100, 181, 246, 0.15);
        padding: 25px;
        border-radius: 12px;
    }

    /* Inputs y Selects */
    input[type="text"],
    input[type="email"],
    input[type="password"],
    select {
        width: 100%;
        padding: 12px 14px !important;
        background: var(--bg-tertiary) !important;
        border: 1px solid rgba(255, 255, 255, 0.1) !important;
        border-radius: 8px !important;
        color: var(--text-primary) !important;
        font-size: 0.95rem;
        outline: none;
        transition: all 0.2s;
    }

    input:focus,
    select:focus {
        border-color: var(--color-primary) !important;
        box-shadow: 0 0 0 3px rgba(100, 181, 246, 0.2);
        background: var(--bg-secondary) !important;
    }

    label {
        color: var(--text-secondary);
        font-size: 0.9rem;
    }

    small {
        color: var(--text-muted) !important;
    }

    /* Caja de Estado (Checkbox) */
    .status-box {
        background: var(--bg-tertiary);
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        border: 1px solid rgba(255, 255, 255, 0.05);
    }

    /* Headers de secciones */
    h1, h3 {
        color: var(--text-primary);
    }

    /* MODO CLARO */
    [data-theme="light"] input,
    [data-theme="light"] select {
        background: #ffffff !important;
        border: 1px solid #ddd !important;
        color: #333 !important;
    }

    [data-theme="light"] input:focus,
    [data-theme="light"] select:focus {
        border-color: var(--color-primary) !important;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
    }

    [data-theme="light"] .status-box {
        background: #f8f9fa;
        border: 1px solid #e2e8f0;
    }
    
    [data-theme="light"] .card {
        background: #ffffff;
        border: 1px solid #e2e8f0;
        color: #333;
    }
</style>

<?php require_once '../../includes/footer.php'; ?>


================================================================================
 MODULE: USUARIOS
 FILE: usuarios\index.php
================================================================================
<?php
/**
 * Módulo: Usuarios del Sistema
 * Listado de usuarios con roles y estados
 */
require_once '../../config/database.php';
require_once '../../includes/header.php';

// Solo Gerente puede acceder a este módulo
if (!tienePermiso('usuarios')) {
    header("Location: /APP-Prueba/index.php?msg=forbidden");
    exit();
}

// Fetch usuarios with cuadrilla names
$sql = "SELECT u.*, c.nombre_cuadrilla 
        FROM usuarios u
        LEFT JOIN cuadrillas c ON u.id_cuadrilla = c.id_cuadrilla
        ORDER BY u.nombre ASC";
$usuarios = $pdo->query($sql)->fetchAll(PDO::FETCH_ASSOC);

// Get cuadrillas for filter
$cuadrillas = $pdo->query("SELECT * FROM cuadrillas ORDER BY nombre_cuadrilla")->fetchAll(PDO::FETCH_ASSOC);

// Metrics
$total = count($usuarios);
$activos = count(array_filter($usuarios, fn($u) => $u['estado'] == 1));
$gerentes = count(array_filter($usuarios, fn($u) => $u['rol'] === 'Gerente'));
$administrativos = count(array_filter($usuarios, fn($u) => $u['rol'] === 'Administrativo' || $u['rol'] === 'Administrativo ASSA'));
$jefes = count(array_filter($usuarios, fn($u) => $u['rol'] === 'JefeCuadrilla'));
$inspectores = count(array_filter($usuarios, fn($u) => $u['rol'] === 'Inspector ASSA'));
$coordinadores = count(array_filter($usuarios, fn($u) => $u['rol'] === 'Coordinador ASSA'));
?>

<div class="container-fluid" style="padding: 0 20px;">

    <!-- Header -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
        <div>
            <h2 style="margin: 0;"><i class="fas fa-users-cog"></i> Usuarios del Sistema</h2>
            <p style="margin: 5px 0 0; color: #666;">Gestión de accesos y roles</p>
        </div>
        <a href="form.php" class="btn btn-primary"><i class="fas fa-user-plus"></i> Nuevo Usuario</a>
    </div>

    <!-- Metrics Cards -->
    <div class="metrics-row">
        <!-- Total -->
        <div class="metric-mini">
            <div class="metric-icon primary">
                <i class="fas fa-users"></i>
            </div>
            <div class="metric-content">
                <span class="metric-val"><?php echo $total; ?></span>
                <span class="metric-lbl">Total</span>
            </div>
        </div>

        <!-- Activos -->
        <div class="metric-mini">
            <div class="metric-icon success">
                <i class="fas fa-user-check"></i>
            </div>
            <div class="metric-content">
                <span class="metric-val"><?php echo $activos; ?></span>
                <span class="metric-lbl">Activos</span>
            </div>
        </div>

        <!-- Gerentes -->
        <div class="metric-mini">
            <div class="metric-icon warning">
                <i class="fas fa-user-tie"></i>
            </div>
            <div class="metric-content">
                <span class="metric-val"><?php echo $gerentes; ?></span>
                <span class="metric-lbl">Gerentes</span>
            </div>
        </div>

        <!-- Administrativos -->
        <div class="metric-mini">
            <div class="metric-icon info">
                <i class="fas fa-laptop-code"></i>
            </div>
            <div class="metric-content">
                <span class="metric-val"><?php echo $administrativos; ?></span>
                <span class="metric-lbl">Administrativos</span>
            </div>
        </div>

        <!-- Jefes -->
        <div class="metric-mini">
            <div class="metric-icon danger">
                <i class="fas fa-hard-hat"></i>
            </div>
            <div class="metric-content">
                <span class="metric-val"><?php echo $jefes; ?></span>
                <span class="metric-lbl">Jefes Cuadrilla</span>
            </div>
        </div>
    </div>

    <!-- Dynamic Toasts will handle messages -->

    <!-- Main Card -->
    <div class="card" style="border-top: 4px solid var(--color-primary);">

        <!-- Filters -->
        <div class="filter-bar">
            <div class="filter-group">
                <label>Buscar</label>
                <input type="text" id="searchInput" onkeyup="filterTable()" placeholder="Nombre o email..."
                    class="form-control-sm">
            </div>
            <div class="filter-group">
                <label>Rol</label>
                <select id="filterRol" onchange="filterTable()" class="form-control-sm">
                    <option value="">Todos</option>
                    <option value="Gerente">Gerente</option>
                    <option value="Coordinador ASSA">Coordinador ASSA</option>
                    <option value="Administrativo">Administrativo Gral.</option>
                    <option value="Administrativo ASSA">Administrativo ASSA</option>
                    <option value="Inspector ASSA">Inspector ASSA</option>
                    <option value="JefeCuadrilla">Jefe Cuadrilla</option>
                </select>
            </div>
            <div>
                <label
                    style="font-size: 0.8em; font-weight: bold; color: #666; display: block; margin-bottom: 4px;">Estado</label>
                <select id="filterEstado" onchange="filterTable()"
                    style="padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                    <option value="">Todos</option>
                    <option value="1">Activo</option>
                    <option value="0">Inactivo</option>
                </select>
            </div>
            <div style="display: flex; align-items: flex-end;">
                <button onclick="resetFilters()"
                    style="padding: 8px 12px; background: none; border: 1px solid #ddd; border-radius: 6px; cursor: pointer;">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </div>

        <!-- Table -->
        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse;" id="usuariosTable">
                <thead>
                    <tr style="background: var(--color-primary-dark); color: white;">
                        <th style="padding: 12px; text-align: left;">Nombre</th>
                        <th style="padding: 12px; text-align: left;">Email</th>
                        <th style="padding: 12px; text-align: center;">Rol</th>
                        <th style="padding: 12px; text-align: left;">Cuadrilla</th>
                        <th style="padding: 12px; text-align: center;">Estado</th>
                        <th style="padding: 12px; text-align: center;">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <?php if (empty($usuarios)): ?>
                        <tr>
                            <td colspan="6" style="padding: 40px; text-align: center; color: #999;">
                                <i class="fas fa-user-slash" style="font-size: 2em; margin-bottom: 10px;"></i><br>
                                No hay usuarios registrados
                            </td>
                        </tr>
                    <?php else: ?>
                        <?php foreach ($usuarios as $u): ?>
                            <tr data-search="<?php echo strtolower($u['nombre'] . ' ' . $u['email']); ?>"
                                data-rol="<?php echo $u['rol']; ?>" data-estado="<?php echo $u['estado']; ?>"
                                style="border-bottom: 1px solid #eee;">
                                <td style="padding: 12px;">
                                    <div style="font-weight: 500;"><?php echo htmlspecialchars($u['nombre']); ?></div>
                                </td>
                                <td style="padding: 12px;">
                                    <a href="mailto:<?php echo $u['email']; ?>" style="color: #1976d2;">
                                        <?php echo htmlspecialchars($u['email']); ?>
                                    </a>
                                </td>
                                <td style="padding: 12px; text-align: center;">
                                    <?php
                                    $rolColors = [
                                        'Gerente' => ['bg' => 'linear-gradient(135deg, #ffd700 0%, #ffb700 100%)', 'color' => '#333'],
                                        'Coordinador ASSA' => ['bg' => '#e0e7ff', 'color' => '#4338ca'],
                                        'Administrativo' => ['bg' => '#f1f5f9', 'color' => '#475569'],
                                        'Administrativo ASSA' => ['bg' => '#dcfce7', 'color' => '#166534'],
                                        'Inspector ASSA' => ['bg' => '#fef3c7', 'color' => '#92400e'],
                                        'JefeCuadrilla' => ['bg' => '#ffedd5', 'color' => '#9a3412']
                                    ];
                                    $rc = $rolColors[$u['rol']] ?? ['bg' => '#eee', 'color' => '#666'];
                                    $rolDisplay = $u['rol'];
                                    if ($u['rol'] === 'JefeCuadrilla')
                                        $rolDisplay = 'Jefe Cuadrilla';
                                    ?>
                                    <span
                                        style="background: <?php echo $rc['bg']; ?>; color: <?php echo $rc['color']; ?>; padding: 4px 12px; border-radius: 15px; font-size: 0.85em; font-weight: 500;">
                                        <?php echo $rolDisplay; ?>
                                    </span>
                                </td>
                                <td style="padding: 12px;">
                                    <?php if ($u['nombre_cuadrilla']): ?>
                                        <span
                                            style="background: #e3f2fd; color: #1565c0; padding: 4px 10px; border-radius: 15px; font-size: 0.85em;">
                                            <i class="fas fa-hard-hat"></i> <?php echo $u['nombre_cuadrilla']; ?>
                                        </span>
                                    <?php else: ?>
                                        <span style="color: #999;">—</span>
                                    <?php endif; ?>
                                </td>
                                <td style="padding: 12px; text-align: center;">
                                    <?php if ($u['estado']): ?>
                                        <span
                                            style="background: #d1fae5; color: #059669; padding: 4px 10px; border-radius: 15px; font-size: 0.8em;">Activo</span>
                                    <?php else: ?>
                                        <span
                                            style="background: #fee2e2; color: #dc2626; padding: 4px 10px; border-radius: 15px; font-size: 0.8em;">Inactivo</span>
                                    <?php endif; ?>
                                </td>
                                <td style="padding: 12px; text-align: center;">
                                    <a href="form.php?id=<?php echo $u['id_usuario']; ?>"
                                        style="padding: 6px 10px; border: 1px solid #eee; border-radius: 6px; color: var(--color-primary); text-decoration: none; display: inline-block; margin: 0 2px;"
                                        title="Editar">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <?php if ($u['id_usuario'] != ($_SESSION['usuario_id'] ?? 0)): ?>
                                        <button
                                            onclick="confirmDelete(<?php echo $u['id_usuario']; ?>, '<?php echo addslashes($u['nombre']); ?>')"
                                            style="padding: 6px 10px; border: 1px solid #fdd; border-radius: 6px; color: #dc3545; background: none; cursor: pointer;"
                                            title="Eliminar">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    <?php endif; ?>
                                </td>
                            </tr>
                        <?php endforeach; ?>
                    <?php endif; ?>
                </tbody>
            </table>
        </div>
        <div id="noResults" style="display:none; padding: 20px; text-align: center; color: #999;">
            No se encontraron usuarios con los filtros aplicados.
        </div>
    </div>
</div>

<script>
    function filterTable() {
        const search = document.getElementById('searchInput').value.toLowerCase();
        const rol = document.getElementById('filterRol').value;
        const estado = document.getElementById('filterEstado').value;

        const rows = document.querySelectorAll('#usuariosTable tbody tr[data-search]');
        let visible = 0;

        rows.forEach(row => {
            const matchSearch = row.dataset.search.includes(search);
            const matchRol = !rol || row.dataset.rol === rol;
            const matchEstado = estado === '' || row.dataset.estado === estado;

            const show = matchSearch && matchRol && matchEstado;
            row.style.display = show ? '' : 'none';
            if (show) visible++;
        });

        document.getElementById('noResults').style.display = visible === 0 ? 'block' : 'none';
    }

    function resetFilters() {
        document.getElementById('searchInput').value = '';
        document.getElementById('filterRol').value = '';
        document.getElementById('filterEstado').value = '';
        filterTable();
    }

    function confirmDelete(id, nombre) {
        if (confirm('¿Eliminar al usuario "' + nombre + '"?\n\nEsta acción no se puede deshacer.')) {
            window.location.href = 'delete.php?id=' + id;
        }
    }
</script>

<?php require_once '../../includes/footer.php'; ?>

================================================================================
 MODULE: USUARIOS
 FILE: usuarios\save.php
================================================================================
<?php
/**
 * Módulo: Usuarios del Sistema
 * Endpoint para guardar (crear/actualizar)
 */
require_once '../../config/database.php';
require_once '../../includes/auth.php';

// Verificar sesión y permisos
verificarSesion();
if (!tienePermiso('usuarios')) {
    header("Location: /APP-Prueba/index.php?msg=forbidden");
    exit();
}

if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
    header("Location: index.php");
    exit();
}

// Recoger datos
$id = $_POST['id_usuario'] ?? null;
$nombre = trim($_POST['nombre']);
$email = trim($_POST['email']);
$password = $_POST['password'] ?? '';
$rol = $_POST['rol'];
$id_cuadrilla = !empty($_POST['id_cuadrilla']) ? (int) $_POST['id_cuadrilla'] : null;
$estado = isset($_POST['estado']) ? 1 : 0;

// Validaciones
if (empty($nombre) || empty($email) || empty($rol)) {
    header("Location: form.php" . ($id ? "?id=$id" : "") . "&msg=error");
    exit();
}

// Si es nuevo usuario, la contraseña es obligatoria
if (!$id && empty($password)) {
    header("Location: form.php&msg=error");
    exit();
}

// Si no es Jefe de Cuadrilla, limpiar la cuadrilla
if ($rol !== 'JefeCuadrilla') {
    $id_cuadrilla = null;
}

try {
    // [!] ARCH: Auditoría Preventiva de correo duplicado
    $checkSql = "SELECT id_usuario FROM usuarios WHERE email = ?";
    $checkParams = [$email];
    if ($id) {
        $checkSql .= " AND id_usuario != ?";
        $checkParams[] = $id;
    }
    $checkStmt = $pdo->prepare($checkSql);
    $checkStmt->execute($checkParams);

    if ($checkStmt->fetch()) {
        header("Location: form.php" . ($id ? "?id=$id" : "") . "&msg=duplicate");
        exit();
    }

    if ($id) {
        // [✓] AUDITORÍA CRUD: El comando SQL UPDATE DEBE incluir el campo 'rol'
        if (!empty($password)) {
            // [→] EDITAR AQUÍ: Con cambio de contraseña
            $sql = "UPDATE usuarios SET 
                    nombre = ?, 
                    email = ?, 
                    password_hash = ?,
                    rol = ?, 
                    id_cuadrilla = ?, 
                    estado = ?
                    WHERE id_usuario = ?";

            $stmt = $pdo->prepare($sql);
            $result = $stmt->execute([
                $nombre,
                $email,
                password_hash($password, PASSWORD_BCRYPT),
                $rol,
                $id_cuadrilla,
                $estado,
                $id
            ]);
        } else {
            // [→] EDITAR AQUÍ: Sin cambio de contraseña - El ROL es crítico para el RBAC
            $sql = "UPDATE usuarios SET 
                    nombre = ?, 
                    email = ?, 
                    rol = ?, 
                    id_cuadrilla = ?, 
                    estado = ?
                    WHERE id_usuario = ?";

            $stmt = $pdo->prepare($sql);
            $result = $stmt->execute([
                $nombre,
                $email,
                $rol,
                $id_cuadrilla,
                $estado,
                $id
            ]);
        }

        // AUDIT: Verificar persistencia del ciclo UPDATE -> READ
        if (!$result) {
            throw new PDOException("Fallo en persistencia: El registro no se actualizó.");
        }

        registrarAccion('EDITAR', 'usuarios', "Usuario editado (Rol: $rol): $nombre ($email)", $id);

    } else {
        // [!] ARCH: Inserción de nuevo usuario con auditoría de origen
        $sql = "INSERT INTO usuarios (nombre, email, password_hash, rol, id_cuadrilla, estado) 
                VALUES (?, ?, ?, ?, ?, ?)";

        $stmt = $pdo->prepare($sql);
        $stmt->execute([
            $nombre,
            $email,
            password_hash($password, PASSWORD_BCRYPT),
            $rol,
            $id_cuadrilla,
            $estado
        ]);

        $newId = $pdo->lastInsertId();
        registrarAccion('CREAR', 'usuarios', "Usuario creado: $nombre ($email)", $newId);
    }

    header("Location: index.php?msg=saved");
    exit();

} catch (PDOException $e) {
    // [✓] AUDITORÍA SENIOR: Captura del error específico de SQL para feedback visual
    error_log("Error crítico en usuarios/save.php: " . $e->getMessage());
    $errorMsg = base64_encode($e->getMessage()); // Encode to safely pass in URL if needed
    header("Location: index.php?msg=error&detail=" . $errorMsg);
    exit();
}
?>

================================================================================
 MODULE: VEHICULOS
 FILE: vehiculos\delete.php
================================================================================
<?php
// [!] ARQUITECTURA: Endpoint de eliminación con verificación de integridad
// [→] EDITAR AQUÍ: Rutas de inclusión si cambia la estructura
require_once '../../config/database.php';
require_once '../../includes/auth.php';

// [✓] AUDITORÍA CRUD: Verificación de sesión obligatoria
verificarSesion();

if (!isset($_GET['id']) || !is_numeric($_GET['id'])) {
    header("Location: index.php?msg=error");
    exit;
}

$id = intval($_GET['id']);

try {
    // Check if vehicle is assigned to a cuadrilla
    $checkStmt = $pdo->prepare("SELECT c.nombre_cuadrilla FROM cuadrillas c WHERE c.id_vehiculo_asignado = ?");
    $checkStmt->execute([$id]);
    $cuadrilla = $checkStmt->fetchColumn();

    if ($cuadrilla) {
        $error = urlencode("No se puede eliminar: el vehículo está asignado a la cuadrilla '$cuadrilla'");
        header("Location: index.php?msg=error&details=$error");
        exit;
    }

    // [!] ARQUITECTURA: Obtener datos antes de eliminar para auditoría
    $infoStmt = $pdo->prepare("SELECT patente FROM vehiculos WHERE id_vehiculo = ?");
    $infoStmt->execute([$id]);
    $patente = $infoStmt->fetchColumn();

    // Delete
    $stmt = $pdo->prepare("DELETE FROM vehiculos WHERE id_vehiculo = ?");
    $stmt->execute([$id]);

    // [✓] AUDITORÍA CRUD: Registrar eliminación
    registrarAccion('ELIMINAR', 'vehiculos', "Vehículo eliminado: $patente", $id);

    header("Location: index.php?msg=deleted");

} catch (PDOException $e) {
    $error = urlencode($e->getMessage());
    header("Location: index.php?msg=error&details=$error");
}
?>

================================================================================
 MODULE: VEHICULOS
 FILE: vehiculos\form.php
================================================================================
<?php
require_once '../../config/database.php';
require_once '../../includes/header.php';

// Check if editing
$isEdit = isset($_GET['id']) && is_numeric($_GET['id']);
$vehiculo = null;

if ($isEdit) {
    $stmt = $pdo->prepare("SELECT * FROM vehiculos WHERE id_vehiculo = ?");
    $stmt->execute([$_GET['id']]);
    $vehiculo = $stmt->fetch(PDO::FETCH_ASSOC);

    if (!$vehiculo) {
        header("Location: index.php?msg=not_found");
        exit;
    }
}

// Options
$tipos = ['Camioneta', 'Utilitario', 'Camión', 'Moto', 'Retropala', 'Generador', 'Otro'];
$estados = ['Operativo', 'En Taller', 'Baja'];
$niveles_aceite = ['OK', 'Bajo', 'Crítico'];
$niveles_combustible = ['Lleno', 'Medio', 'Bajo', 'Reserva'];
$estados_frenos = ['OK', 'Desgastados', 'Cambiar'];
?>

<div class="card" style="max-width: 900px; margin: 0 auto;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
        <h2 style="margin: 0;">
            <i class="fas fa-<?php echo $isEdit ? 'edit' : 'plus-circle'; ?>"></i>
            <?php echo $isEdit ? 'Editar Vehículo' : 'Nuevo Vehículo'; ?>
        </h2>
        <a href="index.php" class="btn btn-outline"><i class="fas fa-arrow-left"></i> Volver</a>
    </div>

    <?php if (isset($_GET['msg']) && $_GET['msg'] == 'error'): ?>
        <div class="alert alert-danger"
            style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <strong>Error:</strong>
            <?php echo htmlspecialchars($_GET['details'] ?? 'No se pudo guardar'); ?>
        </div>
    <?php endif; ?>

    <form action="save.php" method="POST" id="vehiculoForm">
        <input type="hidden" name="id_vehiculo" value="<?php echo $vehiculo['id_vehiculo'] ?? ''; ?>">

        <!-- SECCIÓN 1: IDENTIFICACIÓN -->
        <div class="form-section">
            <h3><i class="fas fa-id-card"></i> 1. Identificación</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label>Patente / Nº Serie *</label>
                    <input type="text" name="patente" required
                        value="<?php echo htmlspecialchars($vehiculo['patente'] ?? ''); ?>"
                        placeholder="ABC123 o S/N-0001" style="text-transform: uppercase;">
                </div>
                <div class="form-group">
                    <label>Tipo *</label>
                    <select name="tipo" required>
                        <?php foreach ($tipos as $t): ?>
                            <option value="<?php echo $t; ?>" <?php echo ($vehiculo['tipo'] ?? '') == $t ? 'selected' : ''; ?>>
                                <?php echo $t; ?>
                            </option>
                        <?php endforeach; ?>
                    </select>
                </div>
                <div class="form-group">
                    <label>Marca</label>
                    <input type="text" name="marca" value="<?php echo htmlspecialchars($vehiculo['marca'] ?? ''); ?>"
                        placeholder="Ej: Ford, Fiat, Toyota">
                </div>
                <div class="form-group">
                    <label>Modelo</label>
                    <input type="text" name="modelo" value="<?php echo htmlspecialchars($vehiculo['modelo'] ?? ''); ?>"
                        placeholder="Ej: Ranger, Ducato">
                </div>
                <div class="form-group">
                    <label>Año</label>
                    <input type="number" name="anio" min="1990" max="2030"
                        value="<?php echo $vehiculo['anio'] ?? ''; ?>" placeholder="2024">
                </div>
                <div class="form-group">
                    <label>Estado</label>
                    <select name="estado">
                        <?php foreach ($estados as $e): ?>
                            <option value="<?php echo $e; ?>" <?php echo ($vehiculo['estado'] ?? 'Operativo') == $e ? 'selected' : ''; ?>>
                                <?php echo $e; ?>
                            </option>
                        <?php endforeach; ?>
                    </select>
                </div>
            </div>
        </div>

        <!-- SECCIÓN 2: DOCUMENTACIÓN -->
        <div class="form-section">
            <h3><i class="fas fa-file-alt"></i> 2. Documentación</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label>Vencimiento VTV</label>
                    <input type="date" name="vencimiento_vtv" value="<?php echo $vehiculo['vencimiento_vtv'] ?? ''; ?>">
                </div>
                <div class="form-group">
                    <label>Vencimiento Seguro</label>
                    <input type="date" name="vencimiento_seguro"
                        value="<?php echo $vehiculo['vencimiento_seguro'] ?? ''; ?>">
                </div>
            </div>
        </div>

        <!-- SECCIÓN 3: CONTROL DIARIO -->
        <div class="form-section">
            <h3><i class="fas fa-clipboard-check"></i> 3. Control Diario</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label>Nivel de Aceite</label>
                    <select name="nivel_aceite">
                        <?php foreach ($niveles_aceite as $n): ?>
                            <option value="<?php echo $n; ?>" <?php echo ($vehiculo['nivel_aceite'] ?? 'OK') == $n ? 'selected' : ''; ?>>
                                <?php
                                $icons = ['OK' => '✅', 'Bajo' => '⚠️', 'Crítico' => '🔴'];
                                echo ($icons[$n] ?? '') . ' ' . $n;
                                ?>
                            </option>
                        <?php endforeach; ?>
                    </select>
                </div>
                <div class="form-group">
                    <label>Nivel de Combustible</label>
                    <select name="nivel_combustible">
                        <?php foreach ($niveles_combustible as $n): ?>
                            <option value="<?php echo $n; ?>" <?php echo ($vehiculo['nivel_combustible'] ?? 'Medio') == $n ? 'selected' : ''; ?>>
                                <?php
                                $icons = ['Lleno' => '🟢', 'Medio' => '🟡', 'Bajo' => '🟠', 'Reserva' => '🔴'];
                                echo ($icons[$n] ?? '') . ' ' . $n;
                                ?>
                            </option>
                        <?php endforeach; ?>
                    </select>
                </div>
                <div class="form-group">
                    <label>Estado de Frenos</label>
                    <select name="estado_frenos">
                        <?php foreach ($estados_frenos as $e): ?>
                            <option value="<?php echo $e; ?>" <?php echo ($vehiculo['estado_frenos'] ?? 'OK') == $e ? 'selected' : ''; ?>>
                                <?php
                                $icons = ['OK' => '✅', 'Desgastados' => '⚠️', 'Cambiar' => '🔴'];
                                echo ($icons[$e] ?? '') . ' ' . $e;
                                ?>
                            </option>
                        <?php endforeach; ?>
                    </select>
                </div>
            </div>
        </div>

        <!-- SECCIÓN 4: MANTENIMIENTO -->
        <div class="form-section">
            <h3><i class="fas fa-wrench"></i> 4. Mantenimiento</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label>Km Actual</label>
                    <input type="number" name="km_actual" min="0" value="<?php echo $vehiculo['km_actual'] ?? ''; ?>"
                        placeholder="Ej: 125000">
                </div>
                <div class="form-group">
                    <label>Próximo Service (Km)</label>
                    <input type="number" name="proximo_service_km" min="0"
                        value="<?php echo $vehiculo['proximo_service_km'] ?? ''; ?>" placeholder="Ej: 130000">
                </div>
                <div class="form-group">
                    <label>Fecha Último Inventario</label>
                    <input type="date" name="fecha_ultimo_inventario"
                        value="<?php echo $vehiculo['fecha_ultimo_inventario'] ?? ''; ?>">
                </div>
                <div class="form-group">
                    <label>Costo de Reposición ($)</label>
                    <input type="number" name="costo_reposicion" step="0.01" min="0"
                        value="<?php echo $vehiculo['costo_reposicion'] ?? ''; ?>" placeholder="Ej: 15000000">
                </div>
            </div>
        </div>

        <!-- SECCIÓN 5: OBSERVACIONES -->
        <div class="form-section">
            <h3><i class="fas fa-sticky-note"></i> 5. Observaciones</h3>
            <div class="form-group" style="margin-bottom: 0;">
                <textarea name="observaciones" rows="3"
                    placeholder="Notas adicionales sobre el vehículo..."><?php echo htmlspecialchars($vehiculo['observaciones'] ?? ''); ?></textarea>
            </div>
        </div>

        <!-- BOTONES -->
        <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 25px;">
            <a href="index.php" class="btn btn-outline">Cancelar</a>
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i>
                <?php echo $isEdit ? 'Guardar Cambios' : 'Crear Vehículo'; ?>
            </button>
        </div>
    </form>
</div>

<style>
    /* Container for sections */
    .form-section {
        background: var(--bg-card);
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        border: 1px solid rgba(100, 181, 246, 0.15);
        border-left: 4px solid var(--color-primary);
        box-shadow: var(--shadow-sm);
    }

    [data-theme="light"] .form-section {
        background: #f8f9fa;
        border: 1px solid #e2e8f0;
        border-left: 4px solid var(--color-primary);
    }

    .form-section h3 {
        margin: 0 0 15px 0;
        font-size: 1.1em;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 10px;
    }

    [data-theme="light"] .form-section h3 {
        color: #2c3e50;
    }

    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
    }

    .form-group {
        display: flex;
        flex-direction: column;
    }

    .form-group label {
        font-size: 0.85em;
        font-weight: 600;
        color: var(--text-secondary);
        margin-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    [data-theme="light"] .form-group label {
        color: #555;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
        padding: 12px 14px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        font-size: 0.95em;
        background: var(--bg-tertiary);
        color: var(--text-primary);
        transition: all 0.2s;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: var(--color-primary);
        box-shadow: 0 0 0 3px rgba(100, 181, 246, 0.2);
        background: var(--bg-secondary);
    }

    .form-group textarea {
        resize: vertical;
        min-height: 80px;
    }

    /* Light Mode Overrides for Inputs */
    [data-theme="light"] .form-group input,
    [data-theme="light"] .form-group select,
    [data-theme="light"] .form-group textarea {
        background: #ffffff;
        border: 1px solid #d1d5db;
        color: #333;
    }

    [data-theme="light"] .form-group input:focus,
    [data-theme="light"] .form-group select:focus,
    [data-theme="light"] .form-group textarea:focus {
        border-color: var(--accent-primary);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
    }
</style>

<?php require_once '../../includes/footer.php'; ?>

================================================================================
 MODULE: VEHICULOS
 FILE: vehiculos\index.php
================================================================================
<?php
require_once '../../config/database.php';
require_once '../../includes/header.php';

// Fetch Vehicles with Cuadrilla assignment
$sql = "SELECT v.*, c.nombre_cuadrilla 
        FROM vehiculos v
        LEFT JOIN cuadrillas c ON c.id_vehiculo_asignado = v.id_vehiculo
        ORDER BY v.patente ASC";
$vehiculos = $pdo->query($sql)->fetchAll(PDO::FETCH_ASSOC);

// Constants
$tipos = ['Camioneta', 'Utilitario', 'Camión', 'Moto'];
$estados = ['Operativo', 'En Taller', 'Baja'];

// Metrics
$total = count($vehiculos);
$operativos = 0;
$en_taller = 0;
$alertas = 0;
$hoy = date('Y-m-d');
$en_30_dias = date('Y-m-d', strtotime('+30 days'));

foreach ($vehiculos as &$v) {
    if ($v['estado'] === 'Operativo')
        $operativos++;
    if ($v['estado'] === 'En Taller')
        $en_taller++;

    // Check for alerts
    $v['_alertas'] = [];
    if (!empty($v['vencimiento_vtv']) && $v['vencimiento_vtv'] <= $en_30_dias) {
        $v['_alertas'][] = 'VTV ' . ($v['vencimiento_vtv'] <= $hoy ? 'vencida' : 'por vencer');
        if ($v['vencimiento_vtv'] <= $hoy)
            $alertas++;
    }
    if (!empty($v['vencimiento_seguro']) && $v['vencimiento_seguro'] <= $en_30_dias) {
        $v['_alertas'][] = 'Seguro ' . ($v['vencimiento_seguro'] <= $hoy ? 'vencido' : 'por vencer');
        if ($v['vencimiento_seguro'] <= $hoy)
            $alertas++;
    }
}
unset($v);
?>

<div class="container-fluid" style="padding: 0 20px;">

    <!-- Header -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
        <div>
            <h2 style="margin: 0;"><i class="fas fa-truck"></i> Gestión de Vehículos</h2>
            <p style="margin: 5px 0 0; color: #666;">Flota y Documentación</p>
        </div>
        <a href="form.php" class="btn btn-primary"><i class="fas fa-plus-circle"></i> Nuevo Vehículo</a>
    </div>

    <!-- KPI Cards con Glow -->
    <div class="metrics-row">
        <div class="metric-mini">
            <div class="metric-icon primary">
                <i class="fas fa-truck"></i>
            </div>
            <div class="metric-content">
                <span class="metric-val"><?php echo $total; ?></span>
                <span class="metric-lbl">Total Vehículos</span>
            </div>
        </div>
        <div class="metric-mini">
            <div class="metric-icon success">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="metric-content">
                <span class="metric-val"><?php echo $operativos; ?></span>
                <span class="metric-lbl">Operativos</span>
            </div>
        </div>
        <div class="metric-mini">
            <div class="metric-icon warning">
                <i class="fas fa-wrench"></i>
            </div>
            <div class="metric-content">
                <span class="metric-val"><?php echo $en_taller; ?></span>
                <span class="metric-lbl">En Taller</span>
            </div>
        </div>
        <?php if ($alertas > 0): ?>
            <div class="metric-mini">
                <div class="metric-icon danger">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="metric-content">
                    <span class="metric-val"><?php echo $alertas; ?></span>
                    <span class="metric-lbl">Vencidos</span>
                </div>
            </div>
        <?php endif; ?>
    </div>

    <!-- Main Card -->
    <div class="card" style="border-top: 4px solid var(--color-primary);">

        <!-- Filters -->
        <div class="filter-bar"
            style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; gap: 15px; flex-wrap: wrap;">
            <div class="filter-group">
                <label>Buscar</label>
                <input type="text" id="searchInput" onkeyup="filterTable()" placeholder="Patente..."
                    class="form-control-sm">
            </div>
            <div class="filter-group">
                <label>Tipo</label>
                <select id="filterTipo" onchange="filterTable()" class="form-control-sm">
                    <option value="">Todos</option>
                    <?php foreach ($tipos as $t): ?>
                        <option value="<?php echo $t; ?>"><?php echo $t; ?></option>
                    <?php endforeach; ?>
                </select>
            </div>
            <div class="filter-group">
                <label>Estado</label>
                <select id="filterEstado" onchange="filterTable()" class="form-control-sm">
                    <option value="">Todos</option>
                    <?php foreach ($estados as $e): ?>
                        <option value="<?php echo $e; ?>"><?php echo $e; ?></option>
                    <?php endforeach; ?>
                </select>
            </div>
            <div class="filter-group" style="display: flex; align-items: flex-end;">
                <button onclick="resetFilters()" class="btn btn-outline btn-sm" title="Limpiar Filtros">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </div>

        <!-- Table -->
        <div style="overflow-x: auto;">
            <table class="table" id="vehiculosTable">
                <thead>
                    <tr>
                        <th>Patente</th>
                        <th>Vehículo</th>
                        <th>Tipo</th>
                        <th>Estado</th>
                        <th>VTV</th>
                        <th>Seguro</th>
                        <th>Cuadrilla</th>
                        <th class="text-center">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <?php if (empty($vehiculos)): ?>
                        <tr>
                            <td colspan="8" class="text-center" style="padding: 40px; color: #999;">
                                <i class="fas fa-truck" style="font-size: 2em; margin-bottom: 10px;"></i><br>
                                No hay vehículos registrados
                            </td>
                        </tr>
                    <?php else: ?>
                        <?php foreach ($vehiculos as $v): ?>
                            <tr data-patente="<?php echo strtolower($v['patente']); ?>" data-tipo="<?php echo $v['tipo']; ?>"
                                data-estado="<?php echo $v['estado']; ?>">
                                <td>
                                    <code
                                        style="font-size: 1.1em; font-weight: bold;"><?php echo htmlspecialchars($v['patente']); ?></code>
                                </td>
                                <td>
                                    <div style="font-weight: 500;">
                                        <?php echo htmlspecialchars($v['marca'] . ' ' . $v['modelo']); ?>
                                    </div>
                                    <?php if ($v['anio']): ?>
                                        <small style="color: #888;"><?php echo $v['anio']; ?></small>
                                    <?php endif; ?>
                                </td>
                                <td>
                                    <span class="badge-tipo <?php echo strtolower($v['tipo']); ?>">
                                        <?php
                                        $iconos = ['Camioneta' => 'fa-truck-pickup', 'Utilitario' => 'fa-shuttle-van', 'Camión' => 'fa-truck', 'Moto' => 'fa-motorcycle'];
                                        echo '<i class="fas ' . ($iconos[$v['tipo']] ?? 'fa-car') . '"></i> ';
                                        echo $v['tipo'];
                                        ?>
                                    </span>
                                </td>
                                <td>
                                    <span class="badge-estado <?php echo strtolower(str_replace(' ', '-', $v['estado'])); ?>">
                                        <?php echo $v['estado']; ?>
                                    </span>
                                </td>
                                <td>
                                    <?php if ($v['vencimiento_vtv']):
                                        $vtvClass = '';
                                        if ($v['vencimiento_vtv'] <= $hoy)
                                            $vtvClass = 'vencido';
                                        elseif ($v['vencimiento_vtv'] <= $en_30_dias)
                                            $vtvClass = 'por-vencer';
                                        ?>
                                        <span class="fecha-venc <?php echo $vtvClass; ?>">
                                            <?php echo date('d/m/Y', strtotime($v['vencimiento_vtv'])); ?>
                                        </span>
                                    <?php else: ?>
                                        <span style="color: #ccc;">—</span>
                                    <?php endif; ?>
                                </td>
                                <td>
                                    <?php if ($v['vencimiento_seguro']):
                                        $segClass = '';
                                        if ($v['vencimiento_seguro'] <= $hoy)
                                            $segClass = 'vencido';
                                        elseif ($v['vencimiento_seguro'] <= $en_30_dias)
                                            $segClass = 'por-vencer';
                                        ?>
                                        <span class="fecha-venc <?php echo $segClass; ?>">
                                            <?php echo date('d/m/Y', strtotime($v['vencimiento_seguro'])); ?>
                                        </span>
                                    <?php else: ?>
                                        <span style="color: #ccc;">—</span>
                                    <?php endif; ?>
                                </td>
                                <td>
                                    <?php if ($v['nombre_cuadrilla']): ?>
                                        <span class="badge-cuadrilla">
                                            <i class="fas fa-hard-hat"></i> <?php echo $v['nombre_cuadrilla']; ?>
                                        </span>
                                    <?php else: ?>
                                        <span style="color: #999;">Sin asignar</span>
                                    <?php endif; ?>
                                </td>
                                <td class="text-center">
                                    <a href="form.php?id=<?php echo $v['id_vehiculo']; ?>" class="btn-icon" title="Editar">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <button
                                        onclick="confirmDelete(<?php echo $v['id_vehiculo']; ?>, '<?php echo addslashes($v['patente']); ?>')"
                                        class="btn-icon btn-danger" title="Eliminar">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        <?php endforeach; ?>
                    <?php endif; ?>
                </tbody>
            </table>
        </div>
        <div id="noResults" style="display:none; padding: 20px; text-align: center; color: #999;">
            No se encontraron vehículos con los filtros aplicados.
        </div>
    </div>
</div>

<style>
    .metrics-row {
        display: flex;
        gap: 15px;
        margin-bottom: 25px;
        flex-wrap: wrap;
    }

    .metric-mini {
        background: white;
        border-radius: 10px;
        padding: 15px 20px;
        display: flex;
        align-items: center;
        gap: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        min-width: 130px;
    }

    .metric-mini i {
        font-size: 1.3em;
    }

    .metric-val {
        font-size: 1.4em;
        font-weight: 700;
        color: #333;
    }

    .metric-lbl {
        font-size: 0.8em;
        color: #888;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
        min-width: 150px;
    }

    .filter-group label {
        font-size: 0.8em;
        font-weight: bold;
        color: #666;
        margin-bottom: 4px;
    }

    .form-control-sm {
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 0.9em;
    }

    .badge-tipo {
        padding: 4px 10px;
        border-radius: 15px;
        font-size: 0.8em;
        font-weight: 500;
    }

    .badge-tipo.camioneta {
        background: #e3f2fd;
        color: #1565c0;
    }

    .badge-tipo.utilitario {
        background: #f3e5f5;
        color: #7b1fa2;
    }

    .badge-tipo.camión {
        background: #fff3e0;
        color: #ef6c00;
    }

    .badge-tipo.moto {
        background: #e8f5e9;
        color: #2e7d32;
    }

    .badge-estado {
        padding: 4px 10px;
        border-radius: 15px;
        font-size: 0.8em;
        font-weight: 500;
    }

    .badge-estado.operativo {
        background: #e8f5e9;
        color: #2e7d32;
    }

    .badge-estado.en-taller {
        background: #fff3e0;
        color: #ef6c00;
    }

    .badge-estado.baja {
        background: #ffebee;
        color: #c62828;
    }

    .badge-cuadrilla {
        background: #e3f2fd;
        color: #1565c0;
        padding: 4px 10px;
        border-radius: 15px;
        font-size: 0.85em;
    }

    .fecha-venc {
        font-size: 0.9em;
    }

    .fecha-venc.vencido {
        color: #c62828;
        font-weight: bold;
        background: #ffebee;
        padding: 2px 6px;
        border-radius: 4px;
    }

    .fecha-venc.por-vencer {
        color: #ef6c00;
        background: #fff3e0;
        padding: 2px 6px;
        border-radius: 4px;
    }

    .btn-icon {
        background: none;
        border: 1px solid #eee;
        border-radius: 6px;
        padding: 6px 10px;
        color: var(--color-primary);
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        margin: 0 2px;
        transition: all 0.2s;
    }

    .btn-icon:hover {
        background: var(--color-primary);
        color: white;
    }

    .btn-icon.btn-danger {
        color: #dc3545;
        border-color: #fdd;
    }

    .btn-icon.btn-danger:hover {
        background: #dc3545;
        color: white;
    }

    .text-center {
        text-align: center;
    }

    /* ==========================================
       RESPONSIVE VEHÍCULOS - MÓVIL
       ========================================== */
    @media (max-width: 767px) {

        /* Métricas en 2 columnas */
        .metrics-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .metric-mini {
            min-width: auto;
            padding: 12px 15px;
            flex-direction: column;
            text-align: center;
            gap: 5px;
        }

        .metric-val {
            font-size: 1.2em;
        }

        .metric-lbl {
            font-size: 0.7em;
        }

        /* Filtros verticales */
        .filter-bar {
            flex-direction: column !important;
            gap: 10px !important;
            padding: 12px !important;
        }

        .filter-group {
            min-width: 100%;
        }

        .form-control-sm {
            width: 100%;
            padding: 12px;
            font-size: 16px;
        }

        /* Tabla a cards en móvil */
        .table thead {
            display: none;
        }

        .table tbody tr {
            display: block;
            margin-bottom: 15px;
            background: white;
            border: 1px solid #eee;
            border-radius: 8px;
            border-left: 4px solid var(--color-primary);
            padding: 15px;
        }

        .table tbody tr td {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f5f5f5;
        }

        .table tbody tr td:last-child {
            border-bottom: none;
            justify-content: flex-end;
            gap: 10px;
            padding-top: 12px;
        }

        .table tbody tr td::before {
            content: attr(data-label);
            font-weight: 600;
            color: #666;
            font-size: 0.85em;
        }

        /* Botones táctiles */
        .btn-icon {
            padding: 10px 14px;
            min-height: 44px;
            min-width: 44px;
        }

        /* Header de página móvil */
        .container-fluid>div:first-child {
            flex-direction: column !important;
            align-items: flex-start !important;
            gap: 15px !important;
        }

        .container-fluid h2 {
            font-size: 1.3rem;
        }

        .container-fluid p {
            font-size: 0.85em;
        }
    }
</style>

<script>
    function filterTable() {
        const search = document.getElementById('searchInput').value.toLowerCase();
        const tipo = document.getElementById('filterTipo').value;
        const estado = document.getElementById('filterEstado').value;

        const rows = document.querySelectorAll('#vehiculosTable tbody tr[data-patente]');
        let visible = 0;

        rows.forEach(row => {
            const matchSearch = row.dataset.patente.includes(search);
            const matchTipo = !tipo || row.dataset.tipo === tipo;
            const matchEstado = !estado || row.dataset.estado === estado;

            const show = matchSearch && matchTipo && matchEstado;
            row.style.display = show ? '' : 'none';
            if (show) visible++;
        });

        document.getElementById('noResults').style.display = visible === 0 ? 'block' : 'none';
    }

    function resetFilters() {
        document.getElementById('searchInput').value = '';
        document.getElementById('filterTipo').value = '';
        document.getElementById('filterEstado').value = '';
        filterTable();
    }

    function confirmDelete(id, patente) {
        if (confirm('¿Eliminar vehículo "' + patente + '"?\n\nEsta acción no se puede deshacer.')) {
            window.location.href = 'delete.php?id=' + id;
        }
    }
</script>

<?php require_once '../../includes/footer.php'; ?>

================================================================================
 MODULE: VEHICULOS
 FILE: vehiculos\save.php
================================================================================
<?php
// [!] ARQUITECTURA: Endpoint de guardado con verificación de sesión y auditoría
// [→] EDITAR AQUÍ: Rutas de inclusión si cambia la estructura
require_once '../../config/database.php';
require_once '../../includes/auth.php';

// [✓] AUDITORÍA CRUD: Verificación de sesión obligatoria
verificarSesion();

if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
    header("Location: index.php");
    exit;
}

try {
    $isEdit = !empty($_POST['id_vehiculo']);

    // Prepare data
    $data = [
        'patente' => strtoupper(trim($_POST['patente'])),
        'tipo' => $_POST['tipo'],
        'marca' => trim($_POST['marca']) ?: null,
        'modelo' => trim($_POST['modelo']) ?: null,
        'anio' => !empty($_POST['anio']) ? intval($_POST['anio']) : null,
        'estado' => $_POST['estado'],
        'vencimiento_vtv' => !empty($_POST['vencimiento_vtv']) ? $_POST['vencimiento_vtv'] : null,
        'vencimiento_seguro' => !empty($_POST['vencimiento_seguro']) ? $_POST['vencimiento_seguro'] : null,
        'nivel_aceite' => $_POST['nivel_aceite'] ?? 'OK',
        'nivel_combustible' => $_POST['nivel_combustible'] ?? 'Medio',
        'estado_frenos' => $_POST['estado_frenos'] ?? 'OK',
        'km_actual' => !empty($_POST['km_actual']) ? intval($_POST['km_actual']) : 0,
        'proximo_service_km' => !empty($_POST['proximo_service_km']) ? intval($_POST['proximo_service_km']) : null,
        'fecha_ultimo_inventario' => !empty($_POST['fecha_ultimo_inventario']) ? $_POST['fecha_ultimo_inventario'] : null,
        'costo_reposicion' => !empty($_POST['costo_reposicion']) ? floatval($_POST['costo_reposicion']) : null,
        'observaciones' => trim($_POST['observaciones']) ?: null
    ];

    if ($isEdit) {
        // UPDATE
        $sql = "UPDATE vehiculos SET 
                patente = :patente,
                tipo = :tipo,
                marca = :marca,
                modelo = :modelo,
                anio = :anio,
                estado = :estado,
                vencimiento_vtv = :vencimiento_vtv,
                vencimiento_seguro = :vencimiento_seguro,
                nivel_aceite = :nivel_aceite,
                nivel_combustible = :nivel_combustible,
                estado_frenos = :estado_frenos,
                km_actual = :km_actual,
                proximo_service_km = :proximo_service_km,
                fecha_ultimo_inventario = :fecha_ultimo_inventario,
                costo_reposicion = :costo_reposicion,
                observaciones = :observaciones
                WHERE id_vehiculo = :id_vehiculo";

        $data['id_vehiculo'] = $_POST['id_vehiculo'];

    } else {
        // INSERT
        $sql = "INSERT INTO vehiculos (
                    patente, tipo, marca, modelo, anio, estado,
                    vencimiento_vtv, vencimiento_seguro,
                    nivel_aceite, nivel_combustible, estado_frenos,
                    km_actual, proximo_service_km, fecha_ultimo_inventario,
                    costo_reposicion, observaciones
                ) VALUES (
                    :patente, :tipo, :marca, :modelo, :anio, :estado,
                    :vencimiento_vtv, :vencimiento_seguro,
                    :nivel_aceite, :nivel_combustible, :estado_frenos,
                    :km_actual, :proximo_service_km, :fecha_ultimo_inventario,
                    :costo_reposicion, :observaciones
                )";
    }

    $stmt = $pdo->prepare($sql);
    $stmt->execute($data);

    // [✓] AUDITORÍA CRUD: Registrar acción
    if ($isEdit) {
        registrarAccion('EDITAR', 'vehiculos', "Vehículo editado: " . $data['patente'], $_POST['id_vehiculo']);
    } else {
        $newId = $pdo->lastInsertId();
        registrarAccion('CREAR', 'vehiculos', "Vehículo creado: " . $data['patente'], $newId);
    }

    header("Location: index.php?msg=success");

} catch (PDOException $e) {
    // Check for duplicate patente
    if ($e->getCode() == 23000) {
        $error = urlencode("La patente ya existe en el sistema.");
    } else {
        $error = urlencode($e->getMessage());
    }

    $redirect = isset($_POST['id_vehiculo']) && $_POST['id_vehiculo']
        ? "form.php?id=" . $_POST['id_vehiculo']
        : "form.php";

    header("Location: $redirect&msg=error&details=$error");
}
?>

